var an=Object.defineProperty;var rn=(e,t,n)=>t in e?an(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var q=(e,t,n)=>(rn(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();var X=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ln(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var w={},pt={},R={};Object.defineProperty(R,"__esModule",{value:!0});R.isSvgTag=R.applyChildren=R.setElementStyle=void 0;function cn(e,t){let n;const s=Object.keys(t);for(n of s)e.style[n]=t[n]}R.setElementStyle=cn;function Qe(e,t){t instanceof HTMLElement?e.appendChild(t):typeof t=="string"||typeof t=="number"?e.appendChild(document.createTextNode(t.toString())):console.warn("Unknown type to append: ",t)}function gt(e,t){for(const n of t)if(!(!n&&n!==0))if(Array.isArray(n))for(const s of n)Array.isArray(s)?gt(e,s):Qe(e,s);else Qe(e,n)}R.applyChildren=gt;function un(e){return["a","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","path","pattern","polygon","polyline","radialGradient","rect","script","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"].includes(e)}R.isSvgTag=un;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.h=e.xlinkNS=void 0;const t=R;e.xlinkNS="http://www.w3.org/1999/xlink";function n(s,i,...o){if(typeof s=="function")return s(Object.assign(Object.assign({},i),{children:o}));const a=t.isSvgTag(s),r=a?document.createElementNS("http://www.w3.org/2000/svg",s):document.createElement(s);if(i){i.style&&typeof i.style!="string"&&(t.setElementStyle(r,i.style),delete i.style);for(const l of Object.keys(i)){const c=i[l];if(l.startsWith("on")){const f=l.replace(/Capture$/,""),h=l!==f,v=f.toLowerCase().substring(2);r.addEventListener(v,c,h)}else a&&l.startsWith("xlink:")?r.setAttributeNS(e.xlinkNS,l,c):c===!0?r.setAttribute(l,l):(c||c===0)&&r.setAttribute(l,c.toString())}}return t.applyChildren(r,o),r}e.h=n})(pt);var vt={};Object.defineProperty(vt,"__esModule",{value:!0});(function(e){var t=X&&X.__createBinding||(Object.create?function(s,i,o,a){a===void 0&&(a=o),Object.defineProperty(s,a,{enumerable:!0,get:function(){return i[o]}})}:function(s,i,o,a){a===void 0&&(a=o),s[a]=i[o]}),n=X&&X.__exportStar||function(s,i){for(var o in s)o!=="default"&&!Object.prototype.hasOwnProperty.call(i,o)&&t(i,s,o)};Object.defineProperty(e,"__esModule",{value:!0}),n(pt,e),n(vt,e)})(w);const be=({x:e,y:t})=>{var s,i;const{tileMap:n}=p;return((i=(s=n.walkableTileMatrix)==null?void 0:s[e])==null?void 0:i[t])===0},Xe=({x:e,y:t},n)=>{const{tileMap:s}=p;s.walkableTileMatrix[e][t]=n},dn="modulepreload",fn=function(e){return"/tiles/"+e},Ze={},hn=function(t,n,s){return!n||n.length===0?t():Promise.all(n.map(i=>{if(i=fn(i),i in Ze)return;Ze[i]=!0;const o=i.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${a}`))return;const r=document.createElement("link");if(r.rel=o?"stylesheet":dn,o||(r.as="script",r.crossOrigin=""),r.href=i,document.head.appendChild(r),o)return new Promise((l,c)=>{r.addEventListener("load",l),r.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>t())},pn=(e,t)=>{const n=e[t];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((s,i)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(i.bind(null,new Error("Unknown variable dynamic import: "+t)))})},O=e=>new Promise(t=>{let n=new Image;n.onload=()=>t(n),n.src=e}),F={},C="/tiles/src/images/";F.load=async()=>{const e=O(`${C}terracotta1.png`),t=O(`${C}terracotta2.png`),n=O(`${C}terracotta3.png`),s=O(`${C}terracotta4.png`),i=O(`${C}cube1.png`),o=O(`${C}cube2.png`),a=O(`${C}cube3.png`),r=O(`${C}grass1.png`),l=O(`${C}grass2.png`),c=O(`${C}grass3.png`),f=O(`${C}grass4.png`),h=O(`${C}water1.png`),v=O(`${C}water2.png`),m=O(`${C}mountain1.png`),k=O(`${C}mountain2.png`),y=O(`${C}mountain3.png`),u=O(`${C}mountain1-top.png`),d=O(`${C}mountain2-top.png`),g=O(`${C}mountain3-top.png`),b=O(`${C}trees1.png`),A=O(`${C}trees2.png`),M=O(`${C}trees3.png`),x=O(`${C}trees4.png`),N=O(`${C}trees1-top.png`),T=O(`${C}trees2-top.png`),D=O(`${C}trees3-top.png`),B=O(`${C}trees4-top.png`),Q=O(`${C}pt-angel.png`),sn=O(`${C}pt-despoiler.png`),on=O(`${C}pt-sheild.png`);F.terracotta=[{yOffset:0,data:await e},{yOffset:0,data:await t},{yOffset:0,data:await n},{yOffset:0,data:await s}],F.cube=[{yOffset:33,data:await i},{yOffset:33,data:await o},{yOffset:33,data:await a}],F.grass=[{yOffset:2,data:await r},{yOffset:2,data:await l},{yOffset:2,data:await c},{yOffset:2,data:await f}],F.water=[{yOffset:-3,data:await h},{yOffset:-3,data:await v}],F.mountain=[{yOffset:14,data:await m},{yOffset:12,data:await k},{yOffset:14,data:await y}],F.mountainTop=[{yOffset:14,data:await u},{yOffset:12,data:await d},{yOffset:14,data:await g}],F.forest=[{yOffset:15,data:await b},{yOffset:15,data:await A},{yOffset:15,data:await M},{yOffset:15,data:await x}],F.forestTop=[{yOffset:15,data:await N},{yOffset:15,data:await T},{yOffset:15,data:await D},{yOffset:15,data:await B}],F.playerTokens={angel:{yOffset:51,data:await Q},despoiler:{yOffset:51,data:await sn},sheild:{yOffset:48,data:await on}}};const ve=new OffscreenCanvas(0,0),et=ve.getContext("2d"),gn=(e,t)=>{const{data:n,data:{width:s,height:i},yOffset:o}=e;ve.width=s,ve.height=i;const a=n;return et.filter=`hue-rotate(${t}deg)`,et.drawImage(a,0,0),{data:ve,yOffset:o}},Le=(e,t,n)=>{const s=F[e][n];return gn(s,t)},re=e=>Math.floor(Math.random()*F[e].length),vn=({xTiles:e,yTiles:t})=>{const n={tiles:[],walkableTileMatrix:[],xTiles:e,yTiles:t};for(let s=0;s<e;s++){n.tiles[s]=[],n.walkableTileMatrix[s]=[];for(let i=0;i<t;i++)n.tiles[s][i]={}}for(let s=0;s<e;s++)for(let i=0;i<t;i++)yt({x:s,y:i},n,"grass");return n},yt=(e,t,n,s,i=null)=>{const{floor:o,feature:a,walkable:r,type:l}=U[n],{x:c,y:f}=e,h=t.tiles[c][f];switch(l){case"void":h.floor=null,h.feature=null;break;case"obstacle":case"floor":h.floor={set:o,variant:i||re(o),color:(s==null?void 0:s[l])||0},h.feature=null;break;case"linked":const v=i||re(o);h.floor={set:o,variant:v,color:(s==null?void 0:s.floor)||0},h.feature={set:a,variant:v,color:(s==null?void 0:s.feature)||0};break;case"feature":h.feature={set:a,variant:i||re(a),color:(s==null?void 0:s.feature)||0},(h.type==="void"||h.type==="linked"||h.type==="obstacle")&&(h.floor={set:o,variant:re(o),color:s==null?void 0:s.feature});break}h.type=l,h.walkable=r,t.walkableTileMatrix[c][f]=r},yn=()=>{const{tileMap:e,entities:t}=p;return e.entityList=[],t.forEach(n=>{const{constructor:{name:s},tileIndex:i}=n;s==="unit"?e.unitStart=i:e.entityList.push({name:s,tileIndex:i})}),"data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e))},mn=async e=>{const t=JSON.stringify(await pn(Object.assign({"../../maps/vista.json":()=>hn(()=>import("./vista.a258ec57.js"),[])}),`../../maps/${e}.json`));return mt(t)},mt=e=>JSON.parse(e);let ye={};const bn=e=>{if(e.x!==ye.x||e.y!==ye.y){const{tileMap:t}=p,n=jn(),{set:s,colors:i,variant:o,type:a}=n,r=p.entityMap.entities[e.x][e.y];Object.keys(r).length!==0&&a!=="floor"||(yt(e,t,s,i,o),qi(e))}ye=e},wn=()=>{ye={}},P=64,S=32,le=32,Mn=32,tt=128,kn="rgba(255,255,255,0.1)",me="rgba(255,255,0,0.6)",An="yellow",xn="rgba(255,0,0,0.2)",On="yellow",nt=.8,it=.12,Cn=.18,Nn=.08,bt=P/2,wt=S/2,Wn=S/P,Tn=6.28319,_e=20,Sn=({x:e,y:t,strokeColor:n,fillColor:s})=>{const{ctx:i}=p,o=j({x:e,y:t});i.strokeStyle=n,i.fillStyle=s,i.beginPath(),i.moveTo(o.x,o.y+S/2),i.lineTo(o.x+P/2,o.y),i.lineTo(o.x+P,o.y+S/2),i.lineTo(o.x+P/2,o.y+S),i.closePath(),i.fill(),i.stroke()},U={mountain:{displayName:"Mountains",walkable:1,floor:"mountain",feature:"mountainTop",type:"linked"},forest:{displayName:"Forest",walkable:0,floor:"forest",feature:"forestTop",type:"linked"},terracotta:{displayName:"Terracotta Floor",walkable:0,floor:"terracotta",type:"floor"},grass:{displayName:"Grass",walkable:0,floor:"grass",type:"floor"},cube:{displayName:"Cube",walkable:1,feature:"cube",floor:"terracotta",type:"feature"},water:{displayName:"Water",walkable:1,floor:"water",type:"obstacle"},void:{displayName:"Void",walkable:1,type:"void"}},Mt=({x:e,y:t,image:n})=>{const{floorCtx:s}=p,i=j({x:e,y:t});s.drawImage(n.data,i.x,i.y-n.yOffset)},Fn=(e,t)=>{const{tileMap:n}=p,s=n.tiles[e][t];if(s.floor){const{set:i,color:o,variant:a}=s.floor;Mt({x:e,y:t,image:Le(i,o,a)})}},kt=({x:e,y:t})=>{const{origin:n}=p.view;return{x:Math.floor((e-n.x)/P-(t-n.y-S/2)/S),y:Math.floor((t-n.y-S/2)/S+(e-n.x)/P)}},j=({x:e,y:t})=>{const{origin:n}=p.view;return{x:e*P/2+t*P/2+n.x,y:t*S/2-e*S/2+n.y}},At=e=>{const{tileMap:t}=p,{x:n,y:s}=kt(e);return t.tiles[n]&&t.tiles[n][s]?{x:n,y:s}:null},te=(e,t)=>{const{x:n,y:s}=e;Sn({x:n,y:s,strokeColor:t,fillColor:kn})},Dn=5,$n=6,we=2,st=4,xt={},Ot={};let[E]=Object.keys(U),ne=U[E].type,ie,J=[];const Ct=e=>{E=(e==null?void 0:e.target.value)||E,ne=U[E].type,ie=F[E],spriteDisplay.replaceWith(Nt()),ne!=="void"&&Wt()},Nt=()=>{switch(ne){case"void":return w.h("div",{id:"spriteDisplay",class:"spriteDisplay--void"},w.h("div",{class:"brush"},w.h("div",{class:"void-brush"},"X"),w.h("span",null,"Delete tiles")));case"linked":const{floor:e,feature:t}=U[E];J={floor:e,feature:t};break;default:J={[ne]:E};break}return w.h("div",{id:"spriteDisplay"},w.h(En,null))},In=()=>Ot[E]={width:Math.max(...ie.map(e=>e.data.width))+Dn,height:Math.max(...ie.map(e=>e.data.height))+$n},Wt=()=>{const e=tilePainter.elements;Object.keys(J).forEach(t=>{const n=J[t],s=e[`${t}Hue`],i=document.getElementById(`${t}HueRotaion`),o=s.value;i.innerText=xt[n]=o,F[n].forEach((a,r)=>{const c=document.getElementById(`tileCanv${r}`).getContext("2d");c.filter=`hue-rotate(${o}deg)`;const f=F[n][r].data;c.drawImage(f,st,st)})})},Pn=e=>{const{tileSet:t,tiles:n,label:s,type:i}=e;return w.h("div",null,w.h("div",null,w.h("label",{for:`${i}Hue`},s,": "),w.h("span",{id:`${i}HueRotaion`},"0")),w.h("input",{id:`${i}Hue`,class:"hue-slider",type:"range",min:"-180",max:"180",step:"1","tile-type":i,value:xt[t]||0,onInput:()=>{Wt()}}))},_n=e=>{const{width:t,height:n,index:s}=e;return w.h("div",{class:"brush"},w.h("canvas",{id:`tileCanv${s}`,width:t+we,height:n+we}),w.h("input",{type:"radio",value:s,name:"tileVariant",style:{width:`${t}px`,height:`${n}px`}}))},En=()=>{const{width:e,height:t}=Ot[E]||In(),n=Object.keys(J);return w.h("div",null,w.h("div",{class:"sprite-brushes"},w.h("div",{class:"brush"},w.h("div",{class:"random-tile-brush",style:{width:`${e+we}px`,height:`${t+we}px`}},w.h("div",null,"?")),w.h("input",{checked:!0,type:"radio",value:"random",name:"tileVariant",style:{width:`${e}px`,height:`${t}px`}})),ie.map((s,i)=>w.h(_n,{width:e,height:t,index:i}))),n.map(s=>w.h(Pn,{tileSet:J[s],label:n.length>1?s+" Hue":"Hue",tiles:J,type:s})))},Bn=()=>(ie=F[E],w.h("form",{id:"tilePainter"},w.h("select",{id:"terrainType",name:"terrainType",onChange:Ct},Object.keys(U).map(e=>w.h("option",{selected:E===e,value:e},U[e].displayName))),w.h(Nt,null))),jn=()=>{var i;const e=tilePainter.elements,t={};Object.keys(J).forEach(o=>{const a=e[`${o}Hue`];t[o]=(a==null?void 0:a.value)||null});let n=null;const s=(i=e.tileVariant)==null?void 0:i.value;return s!=="random"&&(n=s||null),{set:terrainType.value,type:ne,variant:n,colors:t}},Ln=()=>w.h("div",{id:"ui"},p.mode==="editMode"?w.h(Bn,null):null),Rn=()=>{ui.replaceWith(Ln())},se={},Tt={keyDown:()=>{}};document.addEventListener("keydown",e=>{const{keyDown:t}=Tt;se[e.code]=!0,t(e.code,e)});document.addEventListener("keyup",e=>{se[e.code]=!1});const Jn=()=>{Object.keys(se).forEach(e=>{se[e]=!1})},Z=function(e){return se[e]||!1};var St={exports:{}},oe={exports:{}},Ft={exports:{}};(function(e){(function(){var t,n,s,i,o,a,r,l,c,f,h,v,m,k,y;s=Math.floor,f=Math.min,n=function(u,d){return u<d?-1:u>d?1:0},c=function(u,d,g,b,A){var M;if(g==null&&(g=0),A==null&&(A=n),g<0)throw new Error("lo must be non-negative");for(b==null&&(b=u.length);g<b;)M=s((g+b)/2),A(d,u[M])<0?b=M:g=M+1;return[].splice.apply(u,[g,g-g].concat(d)),d},a=function(u,d,g){return g==null&&(g=n),u.push(d),k(u,0,u.length-1,g)},o=function(u,d){var g,b;return d==null&&(d=n),g=u.pop(),u.length?(b=u[0],u[0]=g,y(u,0,d)):b=g,b},l=function(u,d,g){var b;return g==null&&(g=n),b=u[0],u[0]=d,y(u,0,g),b},r=function(u,d,g){var b;return g==null&&(g=n),u.length&&g(u[0],d)<0&&(b=[u[0],d],d=b[0],u[0]=b[1],y(u,0,g)),d},i=function(u,d){var g,b,A,M,x,N;for(d==null&&(d=n),M=function(){N=[];for(var T=0,D=s(u.length/2);0<=D?T<D:T>D;0<=D?T++:T--)N.push(T);return N}.apply(this).reverse(),x=[],b=0,A=M.length;b<A;b++)g=M[b],x.push(y(u,g,d));return x},m=function(u,d,g){var b;if(g==null&&(g=n),b=u.indexOf(d),b!==-1)return k(u,0,b,g),y(u,b,g)},h=function(u,d,g){var b,A,M,x,N;if(g==null&&(g=n),A=u.slice(0,d),!A.length)return A;for(i(A,g),N=u.slice(d),M=0,x=N.length;M<x;M++)b=N[M],r(A,b,g);return A.sort(g).reverse()},v=function(u,d,g){var b,A,M,x,N,T,D,B,Q;if(g==null&&(g=n),d*10<=u.length){if(M=u.slice(0,d).sort(g),!M.length)return M;for(A=M[M.length-1],D=u.slice(d),x=0,T=D.length;x<T;x++)b=D[x],g(b,A)<0&&(c(M,b,0,null,g),M.pop(),A=M[M.length-1]);return M}for(i(u,g),Q=[],N=0,B=f(d,u.length);0<=B?N<B:N>B;0<=B?++N:--N)Q.push(o(u,g));return Q},k=function(u,d,g,b){var A,M,x;for(b==null&&(b=n),A=u[g];g>d;){if(x=g-1>>1,M=u[x],b(A,M)<0){u[g]=M,g=x;continue}break}return u[g]=A},y=function(u,d,g){var b,A,M,x,N;for(g==null&&(g=n),A=u.length,N=d,M=u[d],b=2*d+1;b<A;)x=b+1,x<A&&!(g(u[b],u[x])<0)&&(b=x),u[d]=u[b],d=b,b=2*d+1;return u[d]=M,k(u,N,d,g)},t=function(){u.push=a,u.pop=o,u.replace=l,u.pushpop=r,u.heapify=i,u.updateItem=m,u.nlargest=h,u.nsmallest=v;function u(d){this.cmp=d!=null?d:n,this.nodes=[]}return u.prototype.push=function(d){return a(this.nodes,d,this.cmp)},u.prototype.pop=function(){return o(this.nodes,this.cmp)},u.prototype.peek=function(){return this.nodes[0]},u.prototype.contains=function(d){return this.nodes.indexOf(d)!==-1},u.prototype.replace=function(d){return l(this.nodes,d,this.cmp)},u.prototype.pushpop=function(d){return r(this.nodes,d,this.cmp)},u.prototype.heapify=function(){return i(this.nodes,this.cmp)},u.prototype.updateItem=function(d){return m(this.nodes,d,this.cmp)},u.prototype.clear=function(){return this.nodes=[]},u.prototype.empty=function(){return this.nodes.length===0},u.prototype.size=function(){return this.nodes.length},u.prototype.clone=function(){var d;return d=new u,d.nodes=this.nodes.slice(0),d},u.prototype.toArray=function(){return this.nodes.slice(0)},u.prototype.insert=u.prototype.push,u.prototype.top=u.prototype.peek,u.prototype.front=u.prototype.peek,u.prototype.has=u.prototype.contains,u.prototype.copy=u.prototype.clone,u}(),e!==null&&e.exports?e.exports=t:window.Heap=t}).call(X)})(Ft);(function(e){e.exports=Ft.exports})(oe);function Hn(e,t,n){this.x=e,this.y=t,this.walkable=n===void 0?!0:n}var Re=Hn,Un={Always:1,Never:2,IfAtMostOneObstacle:3,OnlyWhenNoObstacles:4},_=Un,Dt=Re,ce=_;function L(e,t,n){var s;typeof e!="object"?s=e:(t=e.length,s=e[0].length,n=e),this.width=s,this.height=t,this.nodes=this._buildNodes(s,t,n)}L.prototype._buildNodes=function(e,t,n){var s,i,o=new Array(t);for(s=0;s<t;++s)for(o[s]=new Array(e),i=0;i<e;++i)o[s][i]=new Dt(i,s);if(n===void 0)return o;if(n.length!==t||n[0].length!==e)throw new Error("Matrix size does not fit");for(s=0;s<t;++s)for(i=0;i<e;++i)n[s][i]&&(o[s][i].walkable=!1);return o};L.prototype.getNodeAt=function(e,t){return this.nodes[t][e]};L.prototype.isWalkableAt=function(e,t){return this.isInside(e,t)&&this.nodes[t][e].walkable};L.prototype.isInside=function(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height};L.prototype.setWalkableAt=function(e,t,n){this.nodes[t][e].walkable=n};L.prototype.getNeighbors=function(e,t){var n=e.x,s=e.y,i=[],o=!1,a=!1,r=!1,l=!1,c=!1,f=!1,h=!1,v=!1,m=this.nodes;if(this.isWalkableAt(n,s-1)&&(i.push(m[s-1][n]),o=!0),this.isWalkableAt(n+1,s)&&(i.push(m[s][n+1]),r=!0),this.isWalkableAt(n,s+1)&&(i.push(m[s+1][n]),c=!0),this.isWalkableAt(n-1,s)&&(i.push(m[s][n-1]),h=!0),t===ce.Never)return i;if(t===ce.OnlyWhenNoObstacles)a=h&&o,l=o&&r,f=r&&c,v=c&&h;else if(t===ce.IfAtMostOneObstacle)a=h||o,l=o||r,f=r||c,v=c||h;else if(t===ce.Always)a=!0,l=!0,f=!0,v=!0;else throw new Error("Incorrect value of diagonalMovement");return a&&this.isWalkableAt(n-1,s-1)&&i.push(m[s-1][n-1]),l&&this.isWalkableAt(n+1,s-1)&&i.push(m[s-1][n+1]),f&&this.isWalkableAt(n+1,s+1)&&i.push(m[s+1][n+1]),v&&this.isWalkableAt(n-1,s+1)&&i.push(m[s+1][n-1]),i};L.prototype.clone=function(){var e,t,n=this.width,s=this.height,i=this.nodes,o=new L(n,s),a=new Array(s);for(e=0;e<s;++e)for(a[e]=new Array(n),t=0;t<n;++t)a[e][t]=new Dt(t,e,i[e][t].walkable);return o.nodes=a,o};var qn=L,I={};function Ee(e){for(var t=[[e.x,e.y]];e.parent;)e=e.parent,t.push([e.x,e.y]);return t.reverse()}I.backtrace=Ee;function Vn(e,t){var n=Ee(e),s=Ee(t);return n.concat(s.reverse())}I.biBacktrace=Vn;function Gn(e){var t,n=0,s,i,o,a;for(t=1;t<e.length;++t)s=e[t-1],i=e[t],o=s[0]-i[0],a=s[1]-i[1],n+=Math.sqrt(o*o+a*a);return n}I.pathLength=Gn;function Je(e,t,n,s){var i=Math.abs,o=[],a,r,l,c,f,h;for(l=i(n-e),c=i(s-t),a=e<n?1:-1,r=t<s?1:-1,f=l-c;o.push([e,t]),!(e===n&&t===s);)h=2*f,h>-c&&(f=f-c,e=e+a),h<l&&(f=f+l,t=t+r);return o}I.interpolate=Je;function zn(e){var t=[],n=e.length,s,i,o,a,r,l;if(n<2)return t;for(r=0;r<n-1;++r)for(s=e[r],i=e[r+1],o=Je(s[0],s[1],i[0],i[1]),a=o.length,l=0;l<a-1;++l)t.push(o[l]);return t.push(e[n-1]),t}I.expandPath=zn;function Yn(e,t){var n=t.length,s=t[0][0],i=t[0][1],o=t[n-1][0],a=t[n-1][1],r,l,c,f,h,v,m,k,y,u,d;for(r=s,l=i,h=[[r,l]],v=2;v<n;++v){for(k=t[v],c=k[0],f=k[1],y=Je(r,l,c,f),d=!1,m=1;m<y.length;++m)if(u=y[m],!e.isWalkableAt(u[0],u[1])){d=!0;break}d&&(lastValidCoord=t[v-1],h.push(lastValidCoord),r=lastValidCoord[0],l=lastValidCoord[1])}return h.push([o,a]),h}I.smoothenPath=Yn;function Kn(e){if(e.length<3)return e;var t=[],n=e[0][0],s=e[0][1],i=e[1][0],o=e[1][1],a=i-n,r=o-s,l,c,f,h,v,m;for(v=Math.sqrt(a*a+r*r),a/=v,r/=v,t.push([n,s]),m=2;m<e.length;m++)l=i,c=o,f=a,h=r,i=e[m][0],o=e[m][1],a=i-l,r=o-c,v=Math.sqrt(a*a+r*r),a/=v,r/=v,(a!==f||r!==h)&&t.push([l,c]);return t.push([i,o]),t}I.compressPath=Kn;var ae={manhattan:function(e,t){return e+t},euclidean:function(e,t){return Math.sqrt(e*e+t*t)},octile:function(e,t){var n=Math.SQRT2-1;return e<t?n*e+t:n*t+e},chebyshev:function(e,t){return Math.max(e,t)}},Qn=oe.exports,Xn=I,Ne=ae,ue=_;function $t(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.heuristic=e.heuristic||Ne.manhattan,this.weight=e.weight||1,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=ue.OnlyWhenNoObstacles:this.diagonalMovement=ue.IfAtMostOneObstacle:this.diagonalMovement=ue.Never),this.diagonalMovement===ue.Never?this.heuristic=e.heuristic||Ne.manhattan:this.heuristic=e.heuristic||Ne.octile}$t.prototype.findPath=function(e,t,n,s,i){var o=new Qn(function(M,x){return M.f-x.f}),a=i.getNodeAt(e,t),r=i.getNodeAt(n,s),l=this.heuristic,c=this.diagonalMovement,f=this.weight,h=Math.abs,v=Math.SQRT2,m,k,y,u,d,g,b,A;for(a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(m=o.pop(),m.closed=!0,m===r)return Xn.backtrace(r);for(k=i.getNeighbors(m,c),u=0,d=k.length;u<d;++u)y=k[u],!y.closed&&(g=y.x,b=y.y,A=m.g+(g-m.x===0||b-m.y===0?1:v),(!y.opened||A<y.g)&&(y.g=A,y.h=y.h||f*l(h(g-n),h(b-s)),y.f=y.g+y.h,y.parent=m,y.opened?o.updateItem(y):(o.push(y),y.opened=!0)))}return[]};var He=$t,It=He;function Me(e){It.call(this,e);var t=this.heuristic;this.heuristic=function(n,s){return t(n,s)*1e6}}Me.prototype=new It;Me.prototype.constructor=Me;var Zn=Me,ei=I,We=_;function Pt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=We.OnlyWhenNoObstacles:this.diagonalMovement=We.IfAtMostOneObstacle:this.diagonalMovement=We.Never)}Pt.prototype.findPath=function(e,t,n,s,i){var o=[],a=this.diagonalMovement,r=i.getNodeAt(e,t),l=i.getNodeAt(n,s),c,f,h,v,m;for(o.push(r),r.opened=!0;o.length;){if(h=o.shift(),h.closed=!0,h===l)return ei.backtrace(l);for(c=i.getNeighbors(h,a),v=0,m=c.length;v<m;++v)f=c[v],!(f.closed||f.opened)&&(o.push(f),f.opened=!0,f.parent=h)}return[]};var ti=Pt,_t=He;function ke(e){_t.call(this,e),this.heuristic=function(t,n){return 0}}ke.prototype=new _t;ke.prototype.constructor=ke;var ni=ke,ot=oe.exports,at=I,Te=ae,de=_;function Et(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||Te.manhattan,this.weight=e.weight||1,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=de.OnlyWhenNoObstacles:this.diagonalMovement=de.IfAtMostOneObstacle:this.diagonalMovement=de.Never),this.diagonalMovement===de.Never?this.heuristic=e.heuristic||Te.manhattan:this.heuristic=e.heuristic||Te.octile}Et.prototype.findPath=function(e,t,n,s,i){var o=function(D,B){return D.f-B.f},a=new ot(o),r=new ot(o),l=i.getNodeAt(e,t),c=i.getNodeAt(n,s),f=this.heuristic,h=this.diagonalMovement,v=this.weight,m=Math.abs,k=Math.SQRT2,y,u,d,g,b,A,M,x,N=1,T=2;for(l.g=0,l.f=0,a.push(l),l.opened=N,c.g=0,c.f=0,r.push(c),c.opened=T;!a.empty()&&!r.empty();){for(y=a.pop(),y.closed=!0,u=i.getNeighbors(y,h),g=0,b=u.length;g<b;++g)if(d=u[g],!d.closed){if(d.opened===T)return at.biBacktrace(y,d);A=d.x,M=d.y,x=y.g+(A-y.x===0||M-y.y===0?1:k),(!d.opened||x<d.g)&&(d.g=x,d.h=d.h||v*f(m(A-n),m(M-s)),d.f=d.g+d.h,d.parent=y,d.opened?a.updateItem(d):(a.push(d),d.opened=N))}for(y=r.pop(),y.closed=!0,u=i.getNeighbors(y,h),g=0,b=u.length;g<b;++g)if(d=u[g],!d.closed){if(d.opened===N)return at.biBacktrace(d,y);A=d.x,M=d.y,x=y.g+(A-y.x===0||M-y.y===0?1:k),(!d.opened||x<d.g)&&(d.g=x,d.h=d.h||v*f(m(A-e),m(M-t)),d.f=d.g+d.h,d.parent=y,d.opened?r.updateItem(d):(r.push(d),d.opened=T))}}return[]};var Ue=Et,Bt=Ue;function Ae(e){Bt.call(this,e);var t=this.heuristic;this.heuristic=function(n,s){return t(n,s)*1e6}}Ae.prototype=new Bt;Ae.prototype.constructor=Ae;var ii=Ae,rt=I,Se=_;function jt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Se.OnlyWhenNoObstacles:this.diagonalMovement=Se.IfAtMostOneObstacle:this.diagonalMovement=Se.Never)}jt.prototype.findPath=function(e,t,n,s,i){var o=i.getNodeAt(e,t),a=i.getNodeAt(n,s),r=[],l=[],c,f,h,v=this.diagonalMovement,m=0,k=1,y,u;for(r.push(o),o.opened=!0,o.by=m,l.push(a),a.opened=!0,a.by=k;r.length&&l.length;){for(h=r.shift(),h.closed=!0,c=i.getNeighbors(h,v),y=0,u=c.length;y<u;++y)if(f=c[y],!f.closed){if(f.opened){if(f.by===k)return rt.biBacktrace(h,f);continue}r.push(f),f.parent=h,f.opened=!0,f.by=m}for(h=l.shift(),h.closed=!0,c=i.getNeighbors(h,v),y=0,u=c.length;y<u;++y)if(f=c[y],!f.closed){if(f.opened){if(f.by===m)return rt.biBacktrace(f,h);continue}l.push(f),f.parent=h,f.opened=!0,f.by=k}}return[]};var si=jt,Lt=Ue;function xe(e){Lt.call(this,e),this.heuristic=function(t,n){return 0}}xe.prototype=new Lt;xe.prototype.constructor=xe;var oi=xe,Fe=ae,lt=Re,fe=_;function Rt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||Fe.manhattan,this.weight=e.weight||1,this.trackRecursion=e.trackRecursion||!1,this.timeLimit=e.timeLimit||1/0,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=fe.OnlyWhenNoObstacles:this.diagonalMovement=fe.IfAtMostOneObstacle:this.diagonalMovement=fe.Never),this.diagonalMovement===fe.Never?this.heuristic=e.heuristic||Fe.manhattan:this.heuristic=e.heuristic||Fe.octile}Rt.prototype.findPath=function(e,t,n,s,i){var o=new Date().getTime(),a=function(y,u){return this.heuristic(Math.abs(u.x-y.x),Math.abs(u.y-y.y))}.bind(this),r=function(y,u){return y.x===u.x||y.y===u.y?1:Math.SQRT2},l=function(y,u,d,g,b){if(this.timeLimit>0&&new Date().getTime()-o>this.timeLimit*1e3)return 1/0;var A=u+a(y,f)*this.weight;if(A>d)return A;if(y==f)return g[b]=[y.x,y.y],y;var M,x,N,T,D=i.getNeighbors(y,this.diagonalMovement);for(N=0,M=1/0;T=D[N];++N){if(this.trackRecursion&&(T.retainCount=T.retainCount+1||1,T.tested!==!0&&(T.tested=!0)),x=l(T,u+r(y,T),d,g,b+1),x instanceof lt)return g[b]=[y.x,y.y],x;this.trackRecursion&&--T.retainCount===0&&(T.tested=!1),x<M&&(M=x)}return M}.bind(this),c=i.getNodeAt(e,t),f=i.getNodeAt(n,s),h=a(c,f),v,m,k;for(v=0;;++v){if(m=[],k=l(c,0,h,m,0),k===1/0)return[];if(k instanceof lt)return m;h=k}return[]};var ai=Rt,ri=oe.exports,ct=I,Jt=ae;function qe(e){e=e||{},this.heuristic=e.heuristic||Jt.manhattan,this.trackJumpRecursion=e.trackJumpRecursion||!1}qe.prototype.findPath=function(e,t,n,s,i){var o=this.openList=new ri(function(c,f){return c.f-f.f}),a=this.startNode=i.getNodeAt(e,t),r=this.endNode=i.getNodeAt(n,s),l;for(this.grid=i,a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(l=o.pop(),l.closed=!0,l===r)return ct.expandPath(ct.backtrace(r));this._identifySuccessors(l)}return[]};qe.prototype._identifySuccessors=function(e){var t=this.grid,n=this.heuristic,s=this.openList,i=this.endNode.x,o=this.endNode.y,a,r,l,c,f,h=e.x,v=e.y,m,k,y,u,d,g=Math.abs;for(a=this._findNeighbors(e),c=0,f=a.length;c<f;++c)if(r=a[c],l=this._jump(r[0],r[1],h,v),l){if(m=l[0],k=l[1],d=t.getNodeAt(m,k),d.closed)continue;y=Jt.octile(g(m-h),g(k-v)),u=e.g+y,(!d.opened||u<d.g)&&(d.g=u,d.h=d.h||n(g(m-i),g(k-o)),d.f=d.g+d.h,d.parent=e,d.opened?s.updateItem(d):(s.push(d),d.opened=!0))}};var Ce=qe,Ht=Ce,li=_;function G(e){Ht.call(this,e)}G.prototype=new Ht;G.prototype.constructor=G;G.prototype._jump=function(e,t,n,s){var i=this.grid,o=e-n,a=t-s;if(!i.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(i.getNodeAt(e,t).tested=!0),i.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0){if(i.isWalkableAt(e,t-1)&&!i.isWalkableAt(e-o,t-1)||i.isWalkableAt(e,t+1)&&!i.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0){if(i.isWalkableAt(e-1,t)&&!i.isWalkableAt(e-1,t-a)||i.isWalkableAt(e+1,t)&&!i.isWalkableAt(e+1,t-a))return[e,t];if(this._jump(e+1,t,e,t)||this._jump(e-1,t,e,t))return[e,t]}else throw new Error("Only horizontal and vertical movements are allowed");return this._jump(e+o,t+a,e,t)};G.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,s=e.y,i=this.grid,o,a,r,l,c=[],f,h,v,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0?(i.isWalkableAt(n,s-1)&&c.push([n,s-1]),i.isWalkableAt(n,s+1)&&c.push([n,s+1]),i.isWalkableAt(n+r,s)&&c.push([n+r,s])):l!==0&&(i.isWalkableAt(n-1,s)&&c.push([n-1,s]),i.isWalkableAt(n+1,s)&&c.push([n+1,s]),i.isWalkableAt(n,s+l)&&c.push([n,s+l]));else for(f=i.getNeighbors(e,li.Never),v=0,m=f.length;v<m;++v)h=f[v],c.push([h.x,h.y]);return c};var ci=G,Ut=Ce,di=_;function z(e){Ut.call(this,e)}z.prototype=new Ut;z.prototype.constructor=z;z.prototype._jump=function(e,t,n,s){var i=this.grid,o=e-n,a=t-s;if(!i.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(i.getNodeAt(e,t).tested=!0),i.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(i.isWalkableAt(e-o,t+a)&&!i.isWalkableAt(e-o,t)||i.isWalkableAt(e+o,t-a)&&!i.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(i.isWalkableAt(e+o,t+1)&&!i.isWalkableAt(e,t+1)||i.isWalkableAt(e+o,t-1)&&!i.isWalkableAt(e,t-1))return[e,t]}else if(i.isWalkableAt(e+1,t+a)&&!i.isWalkableAt(e+1,t)||i.isWalkableAt(e-1,t+a)&&!i.isWalkableAt(e-1,t))return[e,t];return this._jump(e+o,t+a,e,t)};z.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,s=e.y,i=this.grid,o,a,r,l,c=[],f,h,v,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0?(i.isWalkableAt(n,s+l)&&c.push([n,s+l]),i.isWalkableAt(n+r,s)&&c.push([n+r,s]),i.isWalkableAt(n+r,s+l)&&c.push([n+r,s+l]),i.isWalkableAt(n-r,s)||c.push([n-r,s+l]),i.isWalkableAt(n,s-l)||c.push([n+r,s-l])):r===0?(i.isWalkableAt(n,s+l)&&c.push([n,s+l]),i.isWalkableAt(n+1,s)||c.push([n+1,s+l]),i.isWalkableAt(n-1,s)||c.push([n-1,s+l])):(i.isWalkableAt(n+r,s)&&c.push([n+r,s]),i.isWalkableAt(n,s+1)||c.push([n+r,s+1]),i.isWalkableAt(n,s-1)||c.push([n+r,s-1]));else for(f=i.getNeighbors(e,di.Always),v=0,m=f.length;v<m;++v)h=f[v],c.push([h.x,h.y]);return c};var fi=z,qt=Ce,hi=_;function Y(e){qt.call(this,e)}Y.prototype=new qt;Y.prototype.constructor=Y;Y.prototype._jump=function(e,t,n,s){var i=this.grid,o=e-n,a=t-s;if(!i.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(i.getNodeAt(e,t).tested=!0),i.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(i.isWalkableAt(e,t-1)&&!i.isWalkableAt(e-o,t-1)||i.isWalkableAt(e,t+1)&&!i.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0&&(i.isWalkableAt(e-1,t)&&!i.isWalkableAt(e-1,t-a)||i.isWalkableAt(e+1,t)&&!i.isWalkableAt(e+1,t-a)))return[e,t];return i.isWalkableAt(e+o,t)&&i.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};Y.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,s=e.y,i=this.grid,o,a,r,l,c=[],f,h,v,m;if(t)if(o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0)i.isWalkableAt(n,s+l)&&c.push([n,s+l]),i.isWalkableAt(n+r,s)&&c.push([n+r,s]),i.isWalkableAt(n,s+l)&&i.isWalkableAt(n+r,s)&&c.push([n+r,s+l]);else{var k;if(r!==0){k=i.isWalkableAt(n+r,s);var y=i.isWalkableAt(n,s+1),u=i.isWalkableAt(n,s-1);k&&(c.push([n+r,s]),y&&c.push([n+r,s+1]),u&&c.push([n+r,s-1])),y&&c.push([n,s+1]),u&&c.push([n,s-1])}else if(l!==0){k=i.isWalkableAt(n,s+l);var d=i.isWalkableAt(n+1,s),g=i.isWalkableAt(n-1,s);k&&(c.push([n,s+l]),d&&c.push([n+1,s+l]),g&&c.push([n-1,s+l])),d&&c.push([n+1,s]),g&&c.push([n-1,s])}}else for(f=i.getNeighbors(e,hi.OnlyWhenNoObstacles),v=0,m=f.length;v<m;++v)h=f[v],c.push([h.x,h.y]);return c};var pi=Y,Vt=Ce,gi=_;function K(e){Vt.call(this,e)}K.prototype=new Vt;K.prototype.constructor=K;K.prototype._jump=function(e,t,n,s){var i=this.grid,o=e-n,a=t-s;if(!i.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(i.getNodeAt(e,t).tested=!0),i.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(i.isWalkableAt(e-o,t+a)&&!i.isWalkableAt(e-o,t)||i.isWalkableAt(e+o,t-a)&&!i.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(i.isWalkableAt(e+o,t+1)&&!i.isWalkableAt(e,t+1)||i.isWalkableAt(e+o,t-1)&&!i.isWalkableAt(e,t-1))return[e,t]}else if(i.isWalkableAt(e+1,t+a)&&!i.isWalkableAt(e+1,t)||i.isWalkableAt(e-1,t+a)&&!i.isWalkableAt(e-1,t))return[e,t];return i.isWalkableAt(e+o,t)||i.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};K.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,s=e.y,i=this.grid,o,a,r,l,c=[],f,h,v,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0?(i.isWalkableAt(n,s+l)&&c.push([n,s+l]),i.isWalkableAt(n+r,s)&&c.push([n+r,s]),(i.isWalkableAt(n,s+l)||i.isWalkableAt(n+r,s))&&c.push([n+r,s+l]),!i.isWalkableAt(n-r,s)&&i.isWalkableAt(n,s+l)&&c.push([n-r,s+l]),!i.isWalkableAt(n,s-l)&&i.isWalkableAt(n+r,s)&&c.push([n+r,s-l])):r===0?i.isWalkableAt(n,s+l)&&(c.push([n,s+l]),i.isWalkableAt(n+1,s)||c.push([n+1,s+l]),i.isWalkableAt(n-1,s)||c.push([n-1,s+l])):i.isWalkableAt(n+r,s)&&(c.push([n+r,s]),i.isWalkableAt(n,s+1)||c.push([n+r,s+1]),i.isWalkableAt(n,s-1)||c.push([n+r,s-1]));else for(f=i.getNeighbors(e,gi.IfAtMostOneObstacle),v=0,m=f.length;v<m;++v)h=f[v],c.push([h.x,h.y]);return c};var vi=K,De=_,yi=ci,mi=fi,bi=pi,wi=vi;function Mi(e){return e=e||{},e.diagonalMovement===De.Never?new yi(e):e.diagonalMovement===De.Always?new mi(e):e.diagonalMovement===De.OnlyWhenNoObstacles?new bi(e):new wi(e)}var ki=Mi,Ai={Heap:oe.exports,Node:Re,Grid:qn,Util:I,DiagonalMovement:_,Heuristic:ae,AStarFinder:He,BestFirstFinder:Zn,BreadthFirstFinder:ti,DijkstraFinder:ni,BiAStarFinder:Ue,BiBestFirstFinder:ii,BiBreadthFirstFinder:si,BiDijkstraFinder:oi,IDAStarFinder:ai,JumpPointFinder:ki};(function(e){e.exports=Ai})(St);const Gt=ln(St.exports),xi=new Gt.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0}),Ve=(e,t)=>{const{walkableTileMatrix:n}=p.tileMap,s=new Gt.Grid(n);return xi.findPath(e.y,e.x,t.y,t.x,s)},Ge={},he=()=>{};Ge.set=()=>{const{hoveredTile:e,mouse:t,player:n}=p;Ct(),t.onMouseMove=()=>{t.buttonCode===1&&nn(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&n.requestMove(e.tileIndex),wn()},p.onFrameControls=s=>{tn(s),e.tileIndex=At({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?p.canvas.style.cursor="grabbing":p.canvas.style.cursor="pointer",e.path=Ve(n.tileIndex,e.tileIndex),t.buttonCode===3&&bn(e.tileIndex)):p.canvas.style.cursor="default"},p.effectsMiddle=()=>{e.tileIndex&&e.path.forEach(s=>{te({x:s[1],y:s[0]},An)})},p.effectsTop=()=>{e.tileIndex&&(e.path.forEach(s=>{te({x:s[1],y:s[0]},xn)}),te(e.tileIndex,me))}};Ge.unset=()=>{const{mouse:e,player:t}=p;t.unsetPath(),e.onMouseMove=he,e.onMouseUp=he,p.effectsMiddle=he,p.effectsTop=he};const Oe=(e,t,n,s)=>{const i=e.x+bt,o=e.y+wt;s.strokeStyle=t,s.beginPath(),s.ellipse(i,o,n,n*Wn,0,0,Tn),s.stroke()},$e=16,ut=.86,Oi="rgba(150, 150, 150, 0.8)",pe=(e,t,n,s)=>{const{ctx:i}=p,o=e.length;e.forEach((a,r)=>{const[l,c]=a,f=j({y:l,x:c});if(Oe(f,t,$e,i),n&&r===o-1){const h=f.x+bt,v=f.y+wt;i.beginPath(),i.moveTo(h,v),i.lineTo(h-$e/3,v-S*ut*1.5),i.lineTo(h,v-S*1.5),i.lineTo(h+$e/3,v-S*ut*1.5),i.closePath(),i.fillStyle=Oi,i.strokeStyle=s,i.fill(),i.stroke()}})},ze={},ge=()=>{};ze.set=()=>{const{hoveredTile:e,mouse:t,player:n,ctx:s}=p;t.onMouseMove=()=>{t.buttonCode===1&&nn(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&n.requestMove(e.tileIndex)},p.onFrameControls=i=>{tn(i),e.tileIndex=At({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?p.canvas.style.cursor="grabbing":p.canvas.style.cursor="pointer",e.path=Ve(n.tileIndex,e.tileIndex)):p.canvas.style.cursor="default"},p.effectsMiddle=()=>{n.isMoving?pe(n.path,"lime"):e.tileIndex&&pe(e.path,"lime")},p.effectsTop=()=>{if(n.isMoving){if(pe(n.path,"rgba(50, 205, 50, 0.5)",!0,"lime"),e.tileIndex)if(be(e.tileIndex)){const i=j(e.tileIndex);Oe(i,me,_e,s)}else te(e.tileIndex,me)}else if(e.tileIndex&&(pe(e.path,"rgba(50, 205, 50, 0.5)"),e.tileIndex))if(be(e.tileIndex)){const i=j(e.tileIndex);Oe(i,"lime",_e,s)}else te(e.tileIndex,me)}};ze.unset=()=>{const{mouse:e,player:t}=p;t.unsetPath(),e.onMouseMove=ge,e.onMouseUp=ge,p.effectsMiddle=ge,p.effectsTop=ge};const zt=()=>{const{paused:e,stop:t,restart:n}=$;e?(n(),document.body.classList.remove("paused")):(t(),document.body.classList.add("paused"))},Ci=()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():canvasRoot.requestFullscreen()};Tt.keyDown=e=>{switch(e){case"Space":zt();break;case"Enter":Z("ControlLeft")&&Ci();break;default:return}};document.addEventListener("visibilitychange",()=>{const{stop:e}=$;document.visibilityState==="hidden"?(e(),document.body.classList.add("paused")):document.visibilityState==="visible"&&Jn()});const dt={editMode:Ge,playMode:ze},Yt=e=>{dt[p.mode].unset(),p.mode=e,Rn(),dt[e].set()},Ni=()=>w.h("div",null,w.h("div",{id:"pauseMenu"},w.h("div",{class:"pause-menu-items"},w.h("p",null,"Paused"),w.h("ul",null,w.h("li",null,w.h("button",{onclick:zt},"Resume")),w.h("li",null,w.h("button",{id:"loadButton"},"Load")),w.h("li",null,w.h("button",{class:"save",id:"saveButton"},"Save"),w.h("input",{type:"text",id:"saveName",value:"tile-map"})))))),Wi=()=>w.h("div",{class:"toolbar"},w.h("form",{id:"mode",name:"mode",class:"margin-right-10"},w.h("input",{type:"radio",id:"playRadio",value:"playMode",class:"margin-right-10",name:"mode",checked:!0}),w.h("label",{for:"playRadio"},"Play Mode"),w.h("input",{type:"radio",id:"editModeRadio",value:"editMode",class:"margin-left-10 margin-right-10",name:"mode"}),w.h("label",{for:"editModeRadio"},"Edit Mode"))),Ti=()=>w.h("div",{class:"wrapper"},w.h(Wi,null),w.h("div",{id:"canvasRoot"},w.h("div",{id:"ui"}),w.h(Ni,null))),Kt=({xTiles:e,yTiles:t})=>{const{ctx:n,canvas:s}=p,i=(e+t)/2*S,o=(e+t)/2*P,a=i+Mn+tt;p.floorCanvas.width=p.entityCanvas.width=o,p.floorCanvas.height=p.entityCanvas.height=a;const r=i/2-S/4*(t-e)-S/2+tt,l={x:0,y:r},c={x:0,y:0},f=()=>{s.width=canvasRoot.clientWidth,s.height=canvasRoot.clientHeight,n.setTransform(1,0,0,1,c.x,c.y)};return onresize=()=>{f(),Fi()},{origin:l,xTiles:e,yTiles:t,translate:c,setApertureSize:f}},Si=e=>{const{ctx:t,canvas:n,floorCanvas:s,entityCanvas:i,view:o,effectsMiddle:a,effectsTop:r}=p,{translate:l}=o;t.clearRect(-l.x,-l.y,n.width,n.height),t.drawImage(s,0,0),a(),p.entities.forEach(c=>{c.update(e)}),t.drawImage(i,0,0),r()},Fi=()=>{const{ctx:e,canvas:t,floorCanvas:n,entityCanvas:s,view:i}=p,{translate:o}=i;e.clearRect(-o.x,-o.y,t.width,t.height),e.drawImage(n,0,0),e.drawImage(s,0,0)},Qt=e=>{const{onFrameControls:t}=p;t&&(t(e),p.monitor(e)),Si(e)},$={};let ee=0,Xt=0,Zt;$.start=e=>{Zt=e,Xt=requestAnimationFrame(t=>{Di(t,e)}),$.paused=!1};$.restart=()=>{$.start(Zt),$.paused=!1};$.stop=()=>{window.cancelAnimationFrame(Xt),ee=0,$.paused=!0};const Di=(e,t)=>{ee||(ee=e);const n=e-ee;ee=e,t(n),$.start(t)},$i=e=>{$.stop(),delete p.entites,delete p.tileMap,delete p.entityMap;const{xTiles:t,yTiles:n}=e;p.view=p.setView({xTiles:t,yTiles:n}),p.loadMap(e),$.start(Qt)},Ii=()=>{saveButton.onclick=()=>{const e=yn(),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",saveName.value+".json"),saveButton.after(t),t.click(),t.remove()},loadButton.onclick=()=>{const e=document.createElement("input");e.type="file",loadButton.after(e),e.onchange=()=>{const t=new FileReader;t.onload=n=>{const s=mt(n.target.result);$i(s)},t.readAsText(e.files[0])},e.click(),e.remove()}};let Pi=0;const _i=()=>Pi++,ft=(e,t)=>{const n=e+(Math.random()*t-t/2);return Math.floor(n)};class Ye{constructor({sprite:t,haloColor:n}){q(this,"addToScene",t=>{const{entityMap:n}=p,{id:s,render:i,redraw:o}=this;this.tileIndex=t,this.position=j(t),this.positionPrevious=this.position,this.redrawEntities=Vi,n.addEntity({tileIndex:t,id:s,render:i}),p.entities.push(this),o()});q(this,"render",()=>{const{entityCtx:t}=p,{sprite:n,position:s,haloColor:i}=this;Oe(s,i,_e,t),t.drawImage(n.data,Math.round(s.x),Math.round(s.y-n.yOffset))});q(this,"redraw",()=>{const{tileIndex:t,position:n,positionPrevious:s}=this;this.redrawEntities(t,n,s),this.positionPrevious={x:n.x,y:n.y}});this.sprite=t||F.playerTokens.sheild,this.haloColor=n||On,this.id=_i(),this.position={x:0,y:0}}update(){}}const en=(e,t)=>{const{entityMap:n}=p;let s=null,i,o,a;e.isMoving=!1;const r=h=>{if(e.isMoving){const v=t*h,m=v*Math.cos(s),k=v*Math.sin(s);e.position.x+=m,e.position.y+=k;const y=i.x-e.position.x,u=i.y-e.position.y,d=y>0!==o,g=u>0!==a;(d||g)&&(e.position.x=i.x,e.position.y=i.y,e.path.length>1?(e.path.shift(),c()):e.isMoving=!1),n.removeEntity({tileIndex:e.tileIndex,id:e.id}),e.tileIndex=kt({x:e.position.x+P/2,y:e.position.y+S/2}),n.addEntity({tileIndex:e.tileIndex,id:e.id,render:e.render})}},l=()=>{e.isMoving=!1,e.path=[]},c=()=>{const[h]=e.path,[v,m]=h,k={x:m,y:v};if(be(k)){i=j(k);const y=i.x-e.position.x,u=i.y-e.position.y;o=y>0,a=u>0,s=Math.atan2(u,y)}else l()};return{move:r,requestMove:h=>{const v=Ve(e.tileIndex,h),m=h.x===e.tileIndex.x&&h.y===e.tileIndex.y;!e.isMoving&&!m&&v.length&&(e.path=v,e.path.shift(),c(),e.isMoving=!0)},unsetPath:l}};class Ei extends Ye{constructor(){super({sprite:F.playerTokens.angel,haloColor:"lime"}),this.path=[];const t=en(this,Cn),n={editMode:t.move,playMode:t.move};this.update=s=>{n[p.mode](s),this.redraw()},this.requestMove=t.requestMove,this.unsetPath=t.unsetPath}}class Bi extends Ye{constructor(n){super(n);q(this,"pickPath",()=>{const{pathFinder:n,tileIndex:s}=this,i={x:ft(s.x,10),y:ft(s.y,10)};be(i)&&n.requestMove(i)});q(this,"update",n=>{const{pathFinder:s,pickPath:i,redraw:o,isMoving:a}=this;p.mode!=="editMode"&&(a||i(),s.move(n)),o()});this.path=[],this.pathFinder=en(this,Nn)}}const ji=e=>{const t={};t.entities=[];const{xTiles:n,yTiles:s}=e;for(let i=0;i<n;i++){t.entities[i]=[];for(let o=0;o<s;o++)t.entities[i][o]={}}return t.addEntity=({tileIndex:i,id:o,render:a})=>{t.entities[i.x][i.y][o]=a,Xe(i,1)},t.entityCheck=({x:i,y:o})=>{const a=t.entities[i][o];return Object.keys(a).length===0},t.removeEntity=({tileIndex:i,id:o})=>{const{x:a,y:r}=i,l=t.entities[a][r];if(delete l[o],Object.keys(l).length===0){const f=e.tiles[a][r].walkable;Xe(i,f)}},t},Ke=(e,t)=>{var o;const{tileMap:n,entityMap:s}=p,i=(o=n.tiles[e])==null?void 0:o[t];if(i){const{feature:a}=i,r=j({x:e,y:t}),l=s.entities[e][t];for(const c in l)l[c]();if(a){const{set:c,color:f,variant:h}=a,v=Le(c,f,h);p.entityCtx.drawImage(v.data,r.x,r.y-v.yOffset),p.entityCtx.globalAlpha=.5;for(const m in l)l[m]();p.entityCtx.globalAlpha=1}}},W={x:0,y:0,buttonCode:0,onMouseUp:null,onMouseMove:null,isDragged:!1,dragStart:{x:0,y:0},drag:{x:0,y:0}},Li=e=>(e.addEventListener("contextmenu",t=>t.preventDefault()),e.onmousemove=t=>{const{translate:n}=p.view,{left:s,top:i}=t.target.getBoundingClientRect();W.x=t.clientX-s-n.x,W.y=t.clientY-i-n.y,W.buttonCode===1&&(W.isDragged=!0,W.drag.x=W.dragStart.x-W.x-n.x,W.drag.y=W.dragStart.y-W.y-n.y),W.onMouseMove&&W.onMouseMove()},e.onmousedown=t=>{t.preventDefault(),W.buttonCode=t.which,W.dragStart.x=W.x,W.dragStart.y=W.y,W.drag.x=0,W.drag.y=0},document.onmouseup=()=>{W.onMouseUp&&W.onMouseUp(),W.isDragged=!1,W.buttonCode=0},e.onmouseleave=()=>{W.isDragged=!1,W.buttonCode=0},W),Ri=()=>{const{view:e}=p,{xTiles:t,yTiles:n}=e;for(let s=t-1;s>-1;s--)for(let i=0;i<n;i++)Fn(s,i),Ke(s,i)},V=150,H=70,Ji=100,Hi=()=>{const e=document.createElement("canvas"),t=e.getContext("2d",{willReadFrequently:!0});e.classList.add("monitor"),e.width=V,e.height=H,canvasRoot.appendChild(e),t.strokeStyle="#ff0000";let n=t.getImageData(0,0,V,H);return s=>{t.clearRect(0,0,V,H),t.putImageData(n,-1,0);const i=H-s/Ji*H;t.beginPath(),t.moveTo(V,H),t.lineTo(V,i),t.stroke(),n=t.getImageData(0,0,V,H)}},p={};p.start=async e=>{document.getElementById("root").replaceWith(Ti()),p.canvas=document.createElement("canvas"),p.ctx=p.canvas.getContext("2d"),canvasRoot.appendChild(p.canvas),p.monitor=Hi(),p.floorCanvas=new OffscreenCanvas(0,0),p.floorCtx=p.floorCanvas.getContext("2d"),p.entityCanvas=new OffscreenCanvas(0,0),p.entityCtx=p.entityCanvas.getContext("2d"),p.effectsMiddle=()=>{},p.effectsTop=()=>{},p.mouse=Li(p.canvas),p.view=Kt({xTiles:le,yTiles:le}),p.hoveredTile={path:null,tileIndex:null},p.mode="playMode",mode.onchange=()=>{const n=mode.elements.mode.value;Yt(n)},Ii();try{const n=await mn(e);p.loadMap(n)}catch{const n=vn({xTiles:le,yTiles:le});p.loadMap(n)}$.start(Qt)};p.loadMap=e=>{const{entityList:t,unitStart:n={x:1,y:1}}=e;p.tileMap=e,p.entityMap=ji(e),p.entities=[],p.player=new Ei,p.player.addToScene(n),t&&t.forEach(s=>{const{name:i,tileIndex:o}=s;switch(i){case"entity":new Ye({}).addToScene(o);break;case"npc":new Bi({sprite:F.playerTokens.despoiler,haloColor:"red"}).addToScene(o);break}}),Yt(p.mode),p.view.setApertureSize(),Ri()};p.setView=Kt;let Ie=0,Pe=0;const tn=e=>{const{translate:t}=p.view,n=Z("KeyW"),s=Z("KeyS"),i=Z("KeyD"),o=Z("KeyA");Ie+=it*e*(i-o),Pe+=it*e*(s-n),t.x-=Ie,t.y-=Pe,Ie*=nt,Pe*=nt,p.ctx.setTransform(1,0,0,1,t.x,t.y)},nn=(e,t)=>{const{translate:n}=p.view;n.x=e,n.y=t},Be=P,je=S*3,Ui=S*1.5,ht=(e,t)=>{const{x:n,y:s}=t;e.save(),e.beginPath(),e.rect(n,s,Be,je),e.clip(),e.clearRect(n,s,Be,je)},qi=e=>{const{floorCtx:t,entityCtx:n,tileMap:s}=p,i=j({x:e.x,y:e.y});i.y-=Ui,ht(t,i),ht(n,i),zi.forEach(o=>{var l;const a=o.x+e.x,r=o.y+e.y;if((l=s.tiles[a])!=null&&l[r]){const c=s.tiles[a][r];if(c.floor){const{set:f,color:h,variant:v}=c.floor;Mt({x:a,y:r,image:Le(f,h,v)})}Ke(a,r)}}),n.restore(),t.restore()},Vi=(e,t,n)=>{const{entityCtx:s}=p,i={x:Math.floor(Math.min(t.x,n.x)),y:Math.floor(Math.min(t.y,n.y)-S*2)},o=Math.ceil(Math.abs(t.x-n.x)+Be),a=Math.ceil(Math.abs(t.y-n.y)+je),{x:r,y:l}=i;s.save(),s.beginPath(),s.rect(r,l,o,a),s.clip(),s.clearRect(r,l,o,a),Gi.forEach(c=>{const f=c.x+e.x,h=c.y+e.y;Ke(f,h)}),s.restore()},Gi=[{x:3,y:-3},{x:3,y:-2},{x:3,y:-1},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:2,y:0},{x:1,y:-3},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:0},{x:-2,y:1},{x:-3,y:1},{x:-2,y:2},{x:-1,y:3},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],zi=[{x:3,y:-3},{x:3,y:-2},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:1},{x:-2,y:2},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Yi=async()=>{await F.load(),p.start("vista"),window.dump=()=>console.log(p)};Yi();
