var ln=Object.defineProperty;var cn=(e,t,n)=>t in e?ln(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var U=(e,t,n)=>(cn(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerpolicy&&(o.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?o.credentials="include":s.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();var K=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function un(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var w={},vt={},R={};Object.defineProperty(R,"__esModule",{value:!0});R.isSvgTag=R.applyChildren=R.setElementStyle=void 0;function dn(e,t){let n;const i=Object.keys(t);for(n of i)e.style[n]=t[n]}R.setElementStyle=dn;function Xe(e,t){t instanceof HTMLElement?e.appendChild(t):typeof t=="string"||typeof t=="number"?e.appendChild(document.createTextNode(t.toString())):console.warn("Unknown type to append: ",t)}function yt(e,t){for(const n of t)if(!(!n&&n!==0))if(Array.isArray(n))for(const i of n)Array.isArray(i)?yt(e,i):Xe(e,i);else Xe(e,n)}R.applyChildren=yt;function fn(e){return["a","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","path","pattern","polygon","polyline","radialGradient","rect","script","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"].includes(e)}R.isSvgTag=fn;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.h=e.xlinkNS=void 0;const t=R;e.xlinkNS="http://www.w3.org/1999/xlink";function n(i,s,...o){if(typeof i=="function")return i(Object.assign(Object.assign({},s),{children:o}));const a=t.isSvgTag(i),r=a?document.createElementNS("http://www.w3.org/2000/svg",i):document.createElement(i);if(s){s.style&&typeof s.style!="string"&&(t.setElementStyle(r,s.style),delete s.style);for(const l of Object.keys(s)){const c=s[l];if(l.startsWith("on")){const f=l.replace(/Capture$/,""),h=l!==f,y=f.toLowerCase().substring(2);r.addEventListener(y,c,h)}else a&&l.startsWith("xlink:")?r.setAttributeNS(e.xlinkNS,l,c):c===!0?r.setAttribute(l,l):(c||c===0)&&r.setAttribute(l,c.toString())}}return t.applyChildren(r,o),r}e.h=n})(vt);var mt={};Object.defineProperty(mt,"__esModule",{value:!0});(function(e){var t=K&&K.__createBinding||(Object.create?function(i,s,o,a){a===void 0&&(a=o),Object.defineProperty(i,a,{enumerable:!0,get:function(){return s[o]}})}:function(i,s,o,a){a===void 0&&(a=o),i[a]=s[o]}),n=K&&K.__exportStar||function(i,s){for(var o in i)o!=="default"&&!Object.prototype.hasOwnProperty.call(s,o)&&t(s,i,o)};Object.defineProperty(e,"__esModule",{value:!0}),n(vt,e),n(mt,e)})(w);const be=({x:e,y:t})=>{var i,s;const{tileMap:n}=p;return((s=(i=n.walkableTileMatrix)==null?void 0:i[e])==null?void 0:s[t])===0},Ze=({x:e,y:t},n)=>{const{tileMap:i}=p;i.walkableTileMatrix[e][t]=n},hn="modulepreload",pn=function(e){return"/tiles/"+e},et={},gn=function(t,n,i){return!n||n.length===0?t():Promise.all(n.map(s=>{if(s=pn(s),s in et)return;et[s]=!0;const o=s.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${s}"]${a}`))return;const r=document.createElement("link");if(r.rel=o?"stylesheet":hn,o||(r.as="script",r.crossOrigin=""),r.href=s,document.head.appendChild(r),o)return new Promise((l,c)=>{r.addEventListener("load",l),r.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${s}`)))})})).then(()=>t())},vn=(e,t)=>{const n=e[t];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((i,s)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(s.bind(null,new Error("Unknown variable dynamic import: "+t)))})},O=e=>new Promise(t=>{let n=new Image;n.onload=()=>t(n),n.src=e}),F={},C="/tiles/src/images/";F.load=async()=>{const e=O(`${C}terracotta1.png`),t=O(`${C}terracotta2.png`),n=O(`${C}terracotta3.png`),i=O(`${C}terracotta4.png`),s=O(`${C}cube1.png`),o=O(`${C}cube2.png`),a=O(`${C}cube3.png`),r=O(`${C}grass1.png`),l=O(`${C}grass2.png`),c=O(`${C}grass3.png`),f=O(`${C}grass4.png`),h=O(`${C}water1.png`),y=O(`${C}water2.png`),m=O(`${C}mountain1.png`),M=O(`${C}mountain2.png`),v=O(`${C}mountain3.png`),u=O(`${C}mountain1-top.png`),d=O(`${C}mountain2-top.png`),g=O(`${C}mountain3-top.png`),b=O(`${C}trees1.png`),x=O(`${C}trees2.png`),k=O(`${C}trees3.png`),A=O(`${C}trees4.png`),N=O(`${C}trees1-top.png`),W=O(`${C}trees2-top.png`),$=O(`${C}trees3-top.png`),B=O(`${C}trees4-top.png`),Y=O(`${C}pt-angel.png`),an=O(`${C}pt-despoiler.png`),rn=O(`${C}pt-sheild.png`);F.terracotta=[{yOffset:0,data:await e},{yOffset:0,data:await t},{yOffset:0,data:await n},{yOffset:0,data:await i}],F.cube=[{yOffset:33,data:await s},{yOffset:33,data:await o},{yOffset:33,data:await a}],F.grass=[{yOffset:2,data:await r},{yOffset:2,data:await l},{yOffset:2,data:await c},{yOffset:2,data:await f}],F.water=[{yOffset:-3,data:await h},{yOffset:-3,data:await y}],F.mountain=[{yOffset:14,data:await m},{yOffset:12,data:await M},{yOffset:14,data:await v}],F.mountainTop=[{yOffset:14,data:await u},{yOffset:12,data:await d},{yOffset:14,data:await g}],F.forest=[{yOffset:15,data:await b},{yOffset:15,data:await x},{yOffset:15,data:await k},{yOffset:15,data:await A}],F.forestTop=[{yOffset:15,data:await N},{yOffset:15,data:await W},{yOffset:15,data:await $},{yOffset:15,data:await B}],F.playerTokens={angel:{yOffset:51,data:await Y},despoiler:{yOffset:51,data:await an},sheild:{yOffset:48,data:await rn}}};const ve=new OffscreenCanvas(0,0),tt=ve.getContext("2d"),yn=(e,t)=>{const{data:n,data:{width:i,height:s},yOffset:o}=e;ve.width=i,ve.height=s;const a=n;return tt.filter=`hue-rotate(${t}deg)`,tt.drawImage(a,0,0),{data:ve,yOffset:o}},Je=(e,t,n)=>{const i=F[e][n];return yn(i,t)},oe=e=>Math.floor(Math.random()*F[e].length),mn=({xTiles:e,yTiles:t})=>{const n={tiles:[],walkableTileMatrix:[],xTiles:e,yTiles:t};for(let i=0;i<e;i++){n.tiles[i]=[],n.walkableTileMatrix[i]=[];for(let s=0;s<t;s++)n.tiles[i][s]={}}for(let i=0;i<e;i++)for(let s=0;s<t;s++)bt({x:i,y:s},n,"grass");return n},bt=(e,t,n,i,s=null)=>{const{floor:o,feature:a,walkable:r,type:l}=H[n],{x:c,y:f}=e,h=t.tiles[c][f];switch(l){case"void":h.floor=null,h.feature=null;break;case"obstacle":case"floor":h.floor={set:o,variant:s||oe(o),color:(i==null?void 0:i[l])||0},h.feature=null;break;case"linked":const y=s||oe(o);h.floor={set:o,variant:y,color:(i==null?void 0:i.floor)||0},h.feature={set:a,variant:y,color:(i==null?void 0:i.feature)||0};break;case"feature":h.feature={set:a,variant:s||oe(a),color:(i==null?void 0:i.feature)||0},(h.type==="void"||h.type==="linked"||h.type==="obstacle")&&(h.floor={set:o,variant:oe(o),color:i==null?void 0:i.feature});break}h.type=l,h.walkable=r,t.walkableTileMatrix[c][f]=r},bn=()=>{const{tileMap:e,entities:t}=p;return e.entityList=[],t.forEach(n=>{const{constructor:{name:i},tileIndex:s}=n;i==="unit"?e.unitStart=s:e.entityList.push({name:i,tileIndex:s})}),"data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e))},wn=async e=>{const t=JSON.stringify(await vn(Object.assign({"../../maps/vista.json":()=>gn(()=>import("./vista.a258ec57.js"),[])}),`../../maps/${e}.json`));return wt(t)},wt=e=>JSON.parse(e);let ye={};const Mn=e=>{if(e.x!==ye.x||e.y!==ye.y){const{tileMap:t}=p,n=Ln(),{set:i,colors:s,variant:o,type:a}=n,r=p.entityMap.entities[e.x][e.y];Object.keys(r).length!==0&&a!=="floor"||(bt(e,t,i,s,o),Vi(e))}ye=e},kn=()=>{ye={}},I=64,S=32,ae=32,xn=32,nt=128,An="rgba(255,255,255,0.1)",me="rgba(255,255,0,0.6)",On="yellow",Cn="rgba(255,0,0,0.2)",Nn="yellow",it=.8,st=.12,Tn=.18,Wn=.08,Mt=I/2,kt=S/2,Sn=S/I,Fn=6.28319,Be=20,$n=({x:e,y:t,strokeColor:n,fillColor:i})=>{const{ctxTop:s}=p,o=j({x:e,y:t});s.strokeStyle=n,s.fillStyle=i,s.beginPath(),s.moveTo(o.x,o.y+S/2),s.lineTo(o.x+I/2,o.y),s.lineTo(o.x+I,o.y+S/2),s.lineTo(o.x+I/2,o.y+S),s.closePath(),s.fill(),s.stroke()},H={mountain:{displayName:"Mountains",walkable:1,floor:"mountain",feature:"mountainTop",type:"linked"},forest:{displayName:"Forest",walkable:0,floor:"forest",feature:"forestTop",type:"linked"},terracotta:{displayName:"Terracotta Floor",walkable:0,floor:"terracotta",type:"floor"},grass:{displayName:"Grass",walkable:0,floor:"grass",type:"floor"},cube:{displayName:"Cube",walkable:1,feature:"cube",floor:"terracotta",type:"feature"},water:{displayName:"Water",walkable:1,floor:"water",type:"obstacle"},void:{displayName:"Void",walkable:1,type:"void"}},xt=({x:e,y:t,image:n})=>{const{floorCtx:i}=p,s=j({x:e,y:t});i.drawImage(n.data,s.x,s.y-n.yOffset)},ot=(e,t)=>{const{tileMap:n}=p,i=n.tiles[e][t];if(i.floor){const{set:s,color:o,variant:a}=i.floor;xt({x:e,y:t,image:Je(s,o,a)})}},At=({x:e,y:t})=>{const{origin:n}=p.view;return{x:Math.floor((e-n.x)/I-(t-n.y-S/2)/S),y:Math.floor((t-n.y-S/2)/S+(e-n.x)/I)}},j=({x:e,y:t})=>{const{origin:n}=p.view;return{x:e*I/2+t*I/2+n.x,y:t*S/2-e*S/2+n.y}},Ot=e=>{const{tileMap:t}=p,{x:n,y:i}=At(e);return t.tiles[n]&&t.tiles[n][i]?{x:n,y:i}:null},Z=(e,t)=>{const{x:n,y:i}=e;$n({x:n,y:i,strokeColor:t,fillColor:An})},Pn=5,Dn=6,we=2,at=4,Ct={},Nt={};let[E]=Object.keys(H),ee=H[E].type,te,J=[];const Tt=e=>{E=(e==null?void 0:e.target.value)||E,ee=H[E].type,te=F[E],spriteDisplay.replaceWith(Wt()),ee!=="void"&&St()},Wt=()=>{switch(ee){case"void":return w.h("div",{id:"spriteDisplay",class:"spriteDisplay--void"},w.h("div",{class:"brush"},w.h("div",{class:"void-brush"},"X"),w.h("span",null,"Delete tiles")));case"linked":const{floor:e,feature:t}=H[E];J={floor:e,feature:t};break;default:J={[ee]:E};break}return w.h("div",{id:"spriteDisplay"},w.h(Bn,null))},In=()=>Nt[E]={width:Math.max(...te.map(e=>e.data.width))+Pn,height:Math.max(...te.map(e=>e.data.height))+Dn},St=()=>{const e=tilePainter.elements;Object.keys(J).forEach(t=>{const n=J[t],i=e[`${t}Hue`],s=document.getElementById(`${t}HueRotaion`),o=i.value;s.innerText=Ct[n]=o,F[n].forEach((a,r)=>{const c=document.getElementById(`tileCanv${r}`).getContext("2d");c.filter=`hue-rotate(${o}deg)`;const f=F[n][r].data;c.drawImage(f,at,at)})})},_n=e=>{const{tileSet:t,tiles:n,label:i,type:s}=e;return w.h("div",null,w.h("div",null,w.h("label",{for:`${s}Hue`},i,": "),w.h("span",{id:`${s}HueRotaion`},"0")),w.h("input",{id:`${s}Hue`,class:"hue-slider",type:"range",min:"-180",max:"180",step:"1","tile-type":s,value:Ct[t]||0,onInput:()=>{St()}}))},En=e=>{const{width:t,height:n,index:i}=e;return w.h("div",{class:"brush"},w.h("canvas",{id:`tileCanv${i}`,width:t+we,height:n+we}),w.h("input",{type:"radio",value:i,name:"tileVariant",style:{width:`${t}px`,height:`${n}px`}}))},Bn=()=>{const{width:e,height:t}=Nt[E]||In(),n=Object.keys(J);return w.h("div",null,w.h("div",{class:"sprite-brushes"},w.h("div",{class:"brush"},w.h("div",{class:"random-tile-brush",style:{width:`${e+we}px`,height:`${t+we}px`}},w.h("div",null,"?")),w.h("input",{checked:!0,type:"radio",value:"random",name:"tileVariant",style:{width:`${e}px`,height:`${t}px`}})),te.map((i,s)=>w.h(En,{width:e,height:t,index:s}))),n.map(i=>w.h(_n,{tileSet:J[i],label:n.length>1?i+" Hue":"Hue",tiles:J,type:i})))},jn=()=>(te=F[E],w.h("form",{id:"tilePainter"},w.h("select",{id:"terrainType",name:"terrainType",onChange:Tt},Object.keys(H).map(e=>w.h("option",{selected:E===e,value:e},H[e].displayName))),w.h(Wt,null))),Ln=()=>{var s;const e=tilePainter.elements,t={};Object.keys(J).forEach(o=>{const a=e[`${o}Hue`];t[o]=(a==null?void 0:a.value)||null});let n=null;const i=(s=e.tileVariant)==null?void 0:s.value;return i!=="random"&&(n=i||null),{set:terrainType.value,type:ee,variant:n,colors:t}},Rn=()=>w.h("div",{id:"ui"},p.mode==="editMode"?w.h(jn,null):null),Jn=()=>{ui.replaceWith(Rn())},ne={},Ft={keyDown:()=>{}};document.addEventListener("keydown",e=>{const{keyDown:t}=Ft;ne[e.code]=!0,t(e.code,e)});document.addEventListener("keyup",e=>{ne[e.code]=!1});const Hn=()=>{Object.keys(ne).forEach(e=>{ne[e]=!1})},Q=function(e){return ne[e]||!1};var $t={exports:{}},ie={exports:{}},Pt={exports:{}};(function(e){(function(){var t,n,i,s,o,a,r,l,c,f,h,y,m,M,v;i=Math.floor,f=Math.min,n=function(u,d){return u<d?-1:u>d?1:0},c=function(u,d,g,b,x){var k;if(g==null&&(g=0),x==null&&(x=n),g<0)throw new Error("lo must be non-negative");for(b==null&&(b=u.length);g<b;)k=i((g+b)/2),x(d,u[k])<0?b=k:g=k+1;return[].splice.apply(u,[g,g-g].concat(d)),d},a=function(u,d,g){return g==null&&(g=n),u.push(d),M(u,0,u.length-1,g)},o=function(u,d){var g,b;return d==null&&(d=n),g=u.pop(),u.length?(b=u[0],u[0]=g,v(u,0,d)):b=g,b},l=function(u,d,g){var b;return g==null&&(g=n),b=u[0],u[0]=d,v(u,0,g),b},r=function(u,d,g){var b;return g==null&&(g=n),u.length&&g(u[0],d)<0&&(b=[u[0],d],d=b[0],u[0]=b[1],v(u,0,g)),d},s=function(u,d){var g,b,x,k,A,N;for(d==null&&(d=n),k=function(){N=[];for(var W=0,$=i(u.length/2);0<=$?W<$:W>$;0<=$?W++:W--)N.push(W);return N}.apply(this).reverse(),A=[],b=0,x=k.length;b<x;b++)g=k[b],A.push(v(u,g,d));return A},m=function(u,d,g){var b;if(g==null&&(g=n),b=u.indexOf(d),b!==-1)return M(u,0,b,g),v(u,b,g)},h=function(u,d,g){var b,x,k,A,N;if(g==null&&(g=n),x=u.slice(0,d),!x.length)return x;for(s(x,g),N=u.slice(d),k=0,A=N.length;k<A;k++)b=N[k],r(x,b,g);return x.sort(g).reverse()},y=function(u,d,g){var b,x,k,A,N,W,$,B,Y;if(g==null&&(g=n),d*10<=u.length){if(k=u.slice(0,d).sort(g),!k.length)return k;for(x=k[k.length-1],$=u.slice(d),A=0,W=$.length;A<W;A++)b=$[A],g(b,x)<0&&(c(k,b,0,null,g),k.pop(),x=k[k.length-1]);return k}for(s(u,g),Y=[],N=0,B=f(d,u.length);0<=B?N<B:N>B;0<=B?++N:--N)Y.push(o(u,g));return Y},M=function(u,d,g,b){var x,k,A;for(b==null&&(b=n),x=u[g];g>d;){if(A=g-1>>1,k=u[A],b(x,k)<0){u[g]=k,g=A;continue}break}return u[g]=x},v=function(u,d,g){var b,x,k,A,N;for(g==null&&(g=n),x=u.length,N=d,k=u[d],b=2*d+1;b<x;)A=b+1,A<x&&!(g(u[b],u[A])<0)&&(b=A),u[d]=u[b],d=b,b=2*d+1;return u[d]=k,M(u,N,d,g)},t=function(){u.push=a,u.pop=o,u.replace=l,u.pushpop=r,u.heapify=s,u.updateItem=m,u.nlargest=h,u.nsmallest=y;function u(d){this.cmp=d!=null?d:n,this.nodes=[]}return u.prototype.push=function(d){return a(this.nodes,d,this.cmp)},u.prototype.pop=function(){return o(this.nodes,this.cmp)},u.prototype.peek=function(){return this.nodes[0]},u.prototype.contains=function(d){return this.nodes.indexOf(d)!==-1},u.prototype.replace=function(d){return l(this.nodes,d,this.cmp)},u.prototype.pushpop=function(d){return r(this.nodes,d,this.cmp)},u.prototype.heapify=function(){return s(this.nodes,this.cmp)},u.prototype.updateItem=function(d){return m(this.nodes,d,this.cmp)},u.prototype.clear=function(){return this.nodes=[]},u.prototype.empty=function(){return this.nodes.length===0},u.prototype.size=function(){return this.nodes.length},u.prototype.clone=function(){var d;return d=new u,d.nodes=this.nodes.slice(0),d},u.prototype.toArray=function(){return this.nodes.slice(0)},u.prototype.insert=u.prototype.push,u.prototype.top=u.prototype.peek,u.prototype.front=u.prototype.peek,u.prototype.has=u.prototype.contains,u.prototype.copy=u.prototype.clone,u}(),e!==null&&e.exports?e.exports=t:window.Heap=t}).call(K)})(Pt);(function(e){e.exports=Pt.exports})(ie);function Un(e,t,n){this.x=e,this.y=t,this.walkable=n===void 0?!0:n}var He=Un,qn={Always:1,Never:2,IfAtMostOneObstacle:3,OnlyWhenNoObstacles:4},_=qn,Dt=He,re=_;function L(e,t,n){var i;typeof e!="object"?i=e:(t=e.length,i=e[0].length,n=e),this.width=i,this.height=t,this.nodes=this._buildNodes(i,t,n)}L.prototype._buildNodes=function(e,t,n){var i,s,o=new Array(t);for(i=0;i<t;++i)for(o[i]=new Array(e),s=0;s<e;++s)o[i][s]=new Dt(s,i);if(n===void 0)return o;if(n.length!==t||n[0].length!==e)throw new Error("Matrix size does not fit");for(i=0;i<t;++i)for(s=0;s<e;++s)n[i][s]&&(o[i][s].walkable=!1);return o};L.prototype.getNodeAt=function(e,t){return this.nodes[t][e]};L.prototype.isWalkableAt=function(e,t){return this.isInside(e,t)&&this.nodes[t][e].walkable};L.prototype.isInside=function(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height};L.prototype.setWalkableAt=function(e,t,n){this.nodes[t][e].walkable=n};L.prototype.getNeighbors=function(e,t){var n=e.x,i=e.y,s=[],o=!1,a=!1,r=!1,l=!1,c=!1,f=!1,h=!1,y=!1,m=this.nodes;if(this.isWalkableAt(n,i-1)&&(s.push(m[i-1][n]),o=!0),this.isWalkableAt(n+1,i)&&(s.push(m[i][n+1]),r=!0),this.isWalkableAt(n,i+1)&&(s.push(m[i+1][n]),c=!0),this.isWalkableAt(n-1,i)&&(s.push(m[i][n-1]),h=!0),t===re.Never)return s;if(t===re.OnlyWhenNoObstacles)a=h&&o,l=o&&r,f=r&&c,y=c&&h;else if(t===re.IfAtMostOneObstacle)a=h||o,l=o||r,f=r||c,y=c||h;else if(t===re.Always)a=!0,l=!0,f=!0,y=!0;else throw new Error("Incorrect value of diagonalMovement");return a&&this.isWalkableAt(n-1,i-1)&&s.push(m[i-1][n-1]),l&&this.isWalkableAt(n+1,i-1)&&s.push(m[i-1][n+1]),f&&this.isWalkableAt(n+1,i+1)&&s.push(m[i+1][n+1]),y&&this.isWalkableAt(n-1,i+1)&&s.push(m[i+1][n-1]),s};L.prototype.clone=function(){var e,t,n=this.width,i=this.height,s=this.nodes,o=new L(n,i),a=new Array(i);for(e=0;e<i;++e)for(a[e]=new Array(n),t=0;t<n;++t)a[e][t]=new Dt(t,e,s[e][t].walkable);return o.nodes=a,o};var Vn=L,D={};function je(e){for(var t=[[e.x,e.y]];e.parent;)e=e.parent,t.push([e.x,e.y]);return t.reverse()}D.backtrace=je;function Gn(e,t){var n=je(e),i=je(t);return n.concat(i.reverse())}D.biBacktrace=Gn;function zn(e){var t,n=0,i,s,o,a;for(t=1;t<e.length;++t)i=e[t-1],s=e[t],o=i[0]-s[0],a=i[1]-s[1],n+=Math.sqrt(o*o+a*a);return n}D.pathLength=zn;function Ue(e,t,n,i){var s=Math.abs,o=[],a,r,l,c,f,h;for(l=s(n-e),c=s(i-t),a=e<n?1:-1,r=t<i?1:-1,f=l-c;o.push([e,t]),!(e===n&&t===i);)h=2*f,h>-c&&(f=f-c,e=e+a),h<l&&(f=f+l,t=t+r);return o}D.interpolate=Ue;function Yn(e){var t=[],n=e.length,i,s,o,a,r,l;if(n<2)return t;for(r=0;r<n-1;++r)for(i=e[r],s=e[r+1],o=Ue(i[0],i[1],s[0],s[1]),a=o.length,l=0;l<a-1;++l)t.push(o[l]);return t.push(e[n-1]),t}D.expandPath=Yn;function Kn(e,t){var n=t.length,i=t[0][0],s=t[0][1],o=t[n-1][0],a=t[n-1][1],r,l,c,f,h,y,m,M,v,u,d;for(r=i,l=s,h=[[r,l]],y=2;y<n;++y){for(M=t[y],c=M[0],f=M[1],v=Ue(r,l,c,f),d=!1,m=1;m<v.length;++m)if(u=v[m],!e.isWalkableAt(u[0],u[1])){d=!0;break}d&&(lastValidCoord=t[y-1],h.push(lastValidCoord),r=lastValidCoord[0],l=lastValidCoord[1])}return h.push([o,a]),h}D.smoothenPath=Kn;function Qn(e){if(e.length<3)return e;var t=[],n=e[0][0],i=e[0][1],s=e[1][0],o=e[1][1],a=s-n,r=o-i,l,c,f,h,y,m;for(y=Math.sqrt(a*a+r*r),a/=y,r/=y,t.push([n,i]),m=2;m<e.length;m++)l=s,c=o,f=a,h=r,s=e[m][0],o=e[m][1],a=s-l,r=o-c,y=Math.sqrt(a*a+r*r),a/=y,r/=y,(a!==f||r!==h)&&t.push([l,c]);return t.push([s,o]),t}D.compressPath=Qn;var se={manhattan:function(e,t){return e+t},euclidean:function(e,t){return Math.sqrt(e*e+t*t)},octile:function(e,t){var n=Math.SQRT2-1;return e<t?n*e+t:n*t+e},chebyshev:function(e,t){return Math.max(e,t)}},Xn=ie.exports,Zn=D,Te=se,le=_;function It(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.heuristic=e.heuristic||Te.manhattan,this.weight=e.weight||1,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=le.OnlyWhenNoObstacles:this.diagonalMovement=le.IfAtMostOneObstacle:this.diagonalMovement=le.Never),this.diagonalMovement===le.Never?this.heuristic=e.heuristic||Te.manhattan:this.heuristic=e.heuristic||Te.octile}It.prototype.findPath=function(e,t,n,i,s){var o=new Xn(function(k,A){return k.f-A.f}),a=s.getNodeAt(e,t),r=s.getNodeAt(n,i),l=this.heuristic,c=this.diagonalMovement,f=this.weight,h=Math.abs,y=Math.SQRT2,m,M,v,u,d,g,b,x;for(a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(m=o.pop(),m.closed=!0,m===r)return Zn.backtrace(r);for(M=s.getNeighbors(m,c),u=0,d=M.length;u<d;++u)v=M[u],!v.closed&&(g=v.x,b=v.y,x=m.g+(g-m.x===0||b-m.y===0?1:y),(!v.opened||x<v.g)&&(v.g=x,v.h=v.h||f*l(h(g-n),h(b-i)),v.f=v.g+v.h,v.parent=m,v.opened?o.updateItem(v):(o.push(v),v.opened=!0)))}return[]};var qe=It,_t=qe;function Me(e){_t.call(this,e);var t=this.heuristic;this.heuristic=function(n,i){return t(n,i)*1e6}}Me.prototype=new _t;Me.prototype.constructor=Me;var ei=Me,ti=D,We=_;function Et(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=We.OnlyWhenNoObstacles:this.diagonalMovement=We.IfAtMostOneObstacle:this.diagonalMovement=We.Never)}Et.prototype.findPath=function(e,t,n,i,s){var o=[],a=this.diagonalMovement,r=s.getNodeAt(e,t),l=s.getNodeAt(n,i),c,f,h,y,m;for(o.push(r),r.opened=!0;o.length;){if(h=o.shift(),h.closed=!0,h===l)return ti.backtrace(l);for(c=s.getNeighbors(h,a),y=0,m=c.length;y<m;++y)f=c[y],!(f.closed||f.opened)&&(o.push(f),f.opened=!0,f.parent=h)}return[]};var ni=Et,Bt=qe;function ke(e){Bt.call(this,e),this.heuristic=function(t,n){return 0}}ke.prototype=new Bt;ke.prototype.constructor=ke;var ii=ke,rt=ie.exports,lt=D,Se=se,ce=_;function jt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||Se.manhattan,this.weight=e.weight||1,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=ce.OnlyWhenNoObstacles:this.diagonalMovement=ce.IfAtMostOneObstacle:this.diagonalMovement=ce.Never),this.diagonalMovement===ce.Never?this.heuristic=e.heuristic||Se.manhattan:this.heuristic=e.heuristic||Se.octile}jt.prototype.findPath=function(e,t,n,i,s){var o=function($,B){return $.f-B.f},a=new rt(o),r=new rt(o),l=s.getNodeAt(e,t),c=s.getNodeAt(n,i),f=this.heuristic,h=this.diagonalMovement,y=this.weight,m=Math.abs,M=Math.SQRT2,v,u,d,g,b,x,k,A,N=1,W=2;for(l.g=0,l.f=0,a.push(l),l.opened=N,c.g=0,c.f=0,r.push(c),c.opened=W;!a.empty()&&!r.empty();){for(v=a.pop(),v.closed=!0,u=s.getNeighbors(v,h),g=0,b=u.length;g<b;++g)if(d=u[g],!d.closed){if(d.opened===W)return lt.biBacktrace(v,d);x=d.x,k=d.y,A=v.g+(x-v.x===0||k-v.y===0?1:M),(!d.opened||A<d.g)&&(d.g=A,d.h=d.h||y*f(m(x-n),m(k-i)),d.f=d.g+d.h,d.parent=v,d.opened?a.updateItem(d):(a.push(d),d.opened=N))}for(v=r.pop(),v.closed=!0,u=s.getNeighbors(v,h),g=0,b=u.length;g<b;++g)if(d=u[g],!d.closed){if(d.opened===N)return lt.biBacktrace(d,v);x=d.x,k=d.y,A=v.g+(x-v.x===0||k-v.y===0?1:M),(!d.opened||A<d.g)&&(d.g=A,d.h=d.h||y*f(m(x-e),m(k-t)),d.f=d.g+d.h,d.parent=v,d.opened?r.updateItem(d):(r.push(d),d.opened=W))}}return[]};var Ve=jt,Lt=Ve;function xe(e){Lt.call(this,e);var t=this.heuristic;this.heuristic=function(n,i){return t(n,i)*1e6}}xe.prototype=new Lt;xe.prototype.constructor=xe;var si=xe,ct=D,Fe=_;function Rt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Fe.OnlyWhenNoObstacles:this.diagonalMovement=Fe.IfAtMostOneObstacle:this.diagonalMovement=Fe.Never)}Rt.prototype.findPath=function(e,t,n,i,s){var o=s.getNodeAt(e,t),a=s.getNodeAt(n,i),r=[],l=[],c,f,h,y=this.diagonalMovement,m=0,M=1,v,u;for(r.push(o),o.opened=!0,o.by=m,l.push(a),a.opened=!0,a.by=M;r.length&&l.length;){for(h=r.shift(),h.closed=!0,c=s.getNeighbors(h,y),v=0,u=c.length;v<u;++v)if(f=c[v],!f.closed){if(f.opened){if(f.by===M)return ct.biBacktrace(h,f);continue}r.push(f),f.parent=h,f.opened=!0,f.by=m}for(h=l.shift(),h.closed=!0,c=s.getNeighbors(h,y),v=0,u=c.length;v<u;++v)if(f=c[v],!f.closed){if(f.opened){if(f.by===m)return ct.biBacktrace(f,h);continue}l.push(f),f.parent=h,f.opened=!0,f.by=M}}return[]};var oi=Rt,Jt=Ve;function Ae(e){Jt.call(this,e),this.heuristic=function(t,n){return 0}}Ae.prototype=new Jt;Ae.prototype.constructor=Ae;var ai=Ae,$e=se,ut=He,ue=_;function Ht(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||$e.manhattan,this.weight=e.weight||1,this.trackRecursion=e.trackRecursion||!1,this.timeLimit=e.timeLimit||1/0,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=ue.OnlyWhenNoObstacles:this.diagonalMovement=ue.IfAtMostOneObstacle:this.diagonalMovement=ue.Never),this.diagonalMovement===ue.Never?this.heuristic=e.heuristic||$e.manhattan:this.heuristic=e.heuristic||$e.octile}Ht.prototype.findPath=function(e,t,n,i,s){var o=new Date().getTime(),a=function(v,u){return this.heuristic(Math.abs(u.x-v.x),Math.abs(u.y-v.y))}.bind(this),r=function(v,u){return v.x===u.x||v.y===u.y?1:Math.SQRT2},l=function(v,u,d,g,b){if(this.timeLimit>0&&new Date().getTime()-o>this.timeLimit*1e3)return 1/0;var x=u+a(v,f)*this.weight;if(x>d)return x;if(v==f)return g[b]=[v.x,v.y],v;var k,A,N,W,$=s.getNeighbors(v,this.diagonalMovement);for(N=0,k=1/0;W=$[N];++N){if(this.trackRecursion&&(W.retainCount=W.retainCount+1||1,W.tested!==!0&&(W.tested=!0)),A=l(W,u+r(v,W),d,g,b+1),A instanceof ut)return g[b]=[v.x,v.y],A;this.trackRecursion&&--W.retainCount===0&&(W.tested=!1),A<k&&(k=A)}return k}.bind(this),c=s.getNodeAt(e,t),f=s.getNodeAt(n,i),h=a(c,f),y,m,M;for(y=0;;++y){if(m=[],M=l(c,0,h,m,0),M===1/0)return[];if(M instanceof ut)return m;h=M}return[]};var ri=Ht,li=ie.exports,dt=D,Ut=se;function Ge(e){e=e||{},this.heuristic=e.heuristic||Ut.manhattan,this.trackJumpRecursion=e.trackJumpRecursion||!1}Ge.prototype.findPath=function(e,t,n,i,s){var o=this.openList=new li(function(c,f){return c.f-f.f}),a=this.startNode=s.getNodeAt(e,t),r=this.endNode=s.getNodeAt(n,i),l;for(this.grid=s,a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(l=o.pop(),l.closed=!0,l===r)return dt.expandPath(dt.backtrace(r));this._identifySuccessors(l)}return[]};Ge.prototype._identifySuccessors=function(e){var t=this.grid,n=this.heuristic,i=this.openList,s=this.endNode.x,o=this.endNode.y,a,r,l,c,f,h=e.x,y=e.y,m,M,v,u,d,g=Math.abs;for(a=this._findNeighbors(e),c=0,f=a.length;c<f;++c)if(r=a[c],l=this._jump(r[0],r[1],h,y),l){if(m=l[0],M=l[1],d=t.getNodeAt(m,M),d.closed)continue;v=Ut.octile(g(m-h),g(M-y)),u=e.g+v,(!d.opened||u<d.g)&&(d.g=u,d.h=d.h||n(g(m-s),g(M-o)),d.f=d.g+d.h,d.parent=e,d.opened?i.updateItem(d):(i.push(d),d.opened=!0))}};var Ne=Ge,qt=Ne,ci=_;function q(e){qt.call(this,e)}q.prototype=new qt;q.prototype.constructor=q;q.prototype._jump=function(e,t,n,i){var s=this.grid,o=e-n,a=t-i;if(!s.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(s.getNodeAt(e,t).tested=!0),s.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0){if(s.isWalkableAt(e,t-1)&&!s.isWalkableAt(e-o,t-1)||s.isWalkableAt(e,t+1)&&!s.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0){if(s.isWalkableAt(e-1,t)&&!s.isWalkableAt(e-1,t-a)||s.isWalkableAt(e+1,t)&&!s.isWalkableAt(e+1,t-a))return[e,t];if(this._jump(e+1,t,e,t)||this._jump(e-1,t,e,t))return[e,t]}else throw new Error("Only horizontal and vertical movements are allowed");return this._jump(e+o,t+a,e,t)};q.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,i=e.y,s=this.grid,o,a,r,l,c=[],f,h,y,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-a)/Math.max(Math.abs(i-a),1),r!==0?(s.isWalkableAt(n,i-1)&&c.push([n,i-1]),s.isWalkableAt(n,i+1)&&c.push([n,i+1]),s.isWalkableAt(n+r,i)&&c.push([n+r,i])):l!==0&&(s.isWalkableAt(n-1,i)&&c.push([n-1,i]),s.isWalkableAt(n+1,i)&&c.push([n+1,i]),s.isWalkableAt(n,i+l)&&c.push([n,i+l]));else for(f=s.getNeighbors(e,ci.Never),y=0,m=f.length;y<m;++y)h=f[y],c.push([h.x,h.y]);return c};var di=q,Vt=Ne,fi=_;function V(e){Vt.call(this,e)}V.prototype=new Vt;V.prototype.constructor=V;V.prototype._jump=function(e,t,n,i){var s=this.grid,o=e-n,a=t-i;if(!s.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(s.getNodeAt(e,t).tested=!0),s.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(s.isWalkableAt(e-o,t+a)&&!s.isWalkableAt(e-o,t)||s.isWalkableAt(e+o,t-a)&&!s.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(s.isWalkableAt(e+o,t+1)&&!s.isWalkableAt(e,t+1)||s.isWalkableAt(e+o,t-1)&&!s.isWalkableAt(e,t-1))return[e,t]}else if(s.isWalkableAt(e+1,t+a)&&!s.isWalkableAt(e+1,t)||s.isWalkableAt(e-1,t+a)&&!s.isWalkableAt(e-1,t))return[e,t];return this._jump(e+o,t+a,e,t)};V.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,i=e.y,s=this.grid,o,a,r,l,c=[],f,h,y,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-a)/Math.max(Math.abs(i-a),1),r!==0&&l!==0?(s.isWalkableAt(n,i+l)&&c.push([n,i+l]),s.isWalkableAt(n+r,i)&&c.push([n+r,i]),s.isWalkableAt(n+r,i+l)&&c.push([n+r,i+l]),s.isWalkableAt(n-r,i)||c.push([n-r,i+l]),s.isWalkableAt(n,i-l)||c.push([n+r,i-l])):r===0?(s.isWalkableAt(n,i+l)&&c.push([n,i+l]),s.isWalkableAt(n+1,i)||c.push([n+1,i+l]),s.isWalkableAt(n-1,i)||c.push([n-1,i+l])):(s.isWalkableAt(n+r,i)&&c.push([n+r,i]),s.isWalkableAt(n,i+1)||c.push([n+r,i+1]),s.isWalkableAt(n,i-1)||c.push([n+r,i-1]));else for(f=s.getNeighbors(e,fi.Always),y=0,m=f.length;y<m;++y)h=f[y],c.push([h.x,h.y]);return c};var hi=V,Gt=Ne,pi=_;function G(e){Gt.call(this,e)}G.prototype=new Gt;G.prototype.constructor=G;G.prototype._jump=function(e,t,n,i){var s=this.grid,o=e-n,a=t-i;if(!s.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(s.getNodeAt(e,t).tested=!0),s.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(s.isWalkableAt(e,t-1)&&!s.isWalkableAt(e-o,t-1)||s.isWalkableAt(e,t+1)&&!s.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0&&(s.isWalkableAt(e-1,t)&&!s.isWalkableAt(e-1,t-a)||s.isWalkableAt(e+1,t)&&!s.isWalkableAt(e+1,t-a)))return[e,t];return s.isWalkableAt(e+o,t)&&s.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};G.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,i=e.y,s=this.grid,o,a,r,l,c=[],f,h,y,m;if(t)if(o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-a)/Math.max(Math.abs(i-a),1),r!==0&&l!==0)s.isWalkableAt(n,i+l)&&c.push([n,i+l]),s.isWalkableAt(n+r,i)&&c.push([n+r,i]),s.isWalkableAt(n,i+l)&&s.isWalkableAt(n+r,i)&&c.push([n+r,i+l]);else{var M;if(r!==0){M=s.isWalkableAt(n+r,i);var v=s.isWalkableAt(n,i+1),u=s.isWalkableAt(n,i-1);M&&(c.push([n+r,i]),v&&c.push([n+r,i+1]),u&&c.push([n+r,i-1])),v&&c.push([n,i+1]),u&&c.push([n,i-1])}else if(l!==0){M=s.isWalkableAt(n,i+l);var d=s.isWalkableAt(n+1,i),g=s.isWalkableAt(n-1,i);M&&(c.push([n,i+l]),d&&c.push([n+1,i+l]),g&&c.push([n-1,i+l])),d&&c.push([n+1,i]),g&&c.push([n-1,i])}}else for(f=s.getNeighbors(e,pi.OnlyWhenNoObstacles),y=0,m=f.length;y<m;++y)h=f[y],c.push([h.x,h.y]);return c};var gi=G,zt=Ne,vi=_;function z(e){zt.call(this,e)}z.prototype=new zt;z.prototype.constructor=z;z.prototype._jump=function(e,t,n,i){var s=this.grid,o=e-n,a=t-i;if(!s.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(s.getNodeAt(e,t).tested=!0),s.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(s.isWalkableAt(e-o,t+a)&&!s.isWalkableAt(e-o,t)||s.isWalkableAt(e+o,t-a)&&!s.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(s.isWalkableAt(e+o,t+1)&&!s.isWalkableAt(e,t+1)||s.isWalkableAt(e+o,t-1)&&!s.isWalkableAt(e,t-1))return[e,t]}else if(s.isWalkableAt(e+1,t+a)&&!s.isWalkableAt(e+1,t)||s.isWalkableAt(e-1,t+a)&&!s.isWalkableAt(e-1,t))return[e,t];return s.isWalkableAt(e+o,t)||s.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};z.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,i=e.y,s=this.grid,o,a,r,l,c=[],f,h,y,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-a)/Math.max(Math.abs(i-a),1),r!==0&&l!==0?(s.isWalkableAt(n,i+l)&&c.push([n,i+l]),s.isWalkableAt(n+r,i)&&c.push([n+r,i]),(s.isWalkableAt(n,i+l)||s.isWalkableAt(n+r,i))&&c.push([n+r,i+l]),!s.isWalkableAt(n-r,i)&&s.isWalkableAt(n,i+l)&&c.push([n-r,i+l]),!s.isWalkableAt(n,i-l)&&s.isWalkableAt(n+r,i)&&c.push([n+r,i-l])):r===0?s.isWalkableAt(n,i+l)&&(c.push([n,i+l]),s.isWalkableAt(n+1,i)||c.push([n+1,i+l]),s.isWalkableAt(n-1,i)||c.push([n-1,i+l])):s.isWalkableAt(n+r,i)&&(c.push([n+r,i]),s.isWalkableAt(n,i+1)||c.push([n+r,i+1]),s.isWalkableAt(n,i-1)||c.push([n+r,i-1]));else for(f=s.getNeighbors(e,vi.IfAtMostOneObstacle),y=0,m=f.length;y<m;++y)h=f[y],c.push([h.x,h.y]);return c};var yi=z,Pe=_,mi=di,bi=hi,wi=gi,Mi=yi;function ki(e){return e=e||{},e.diagonalMovement===Pe.Never?new mi(e):e.diagonalMovement===Pe.Always?new bi(e):e.diagonalMovement===Pe.OnlyWhenNoObstacles?new wi(e):new Mi(e)}var xi=ki,Ai={Heap:ie.exports,Node:He,Grid:Vn,Util:D,DiagonalMovement:_,Heuristic:se,AStarFinder:qe,BestFirstFinder:ei,BreadthFirstFinder:ni,DijkstraFinder:ii,BiAStarFinder:Ve,BiBestFirstFinder:si,BiBreadthFirstFinder:oi,BiDijkstraFinder:ai,IDAStarFinder:ri,JumpPointFinder:xi};(function(e){e.exports=Ai})($t);const Yt=un($t.exports),Oi=new Yt.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0}),ze=(e,t)=>{const{walkableTileMatrix:n}=p.tileMap,i=new Yt.Grid(n);return Oi.findPath(e.y,e.x,t.y,t.x,i)},Ye={},de=()=>{};Ye.set=()=>{const{hoveredTile:e,mouse:t,player:n,canvasTop:i}=p;Tt(),t.onMouseMove=()=>{t.buttonCode===1&&on(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&n.requestMove(e.tileIndex),kn()},p.onFrameControls=s=>{sn(s),e.tileIndex=Ot({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?i.style.cursor="grabbing":i.style.cursor="pointer",e.path=ze(n.tileIndex,e.tileIndex),t.buttonCode===3&&Mn(e.tileIndex)):i.style.cursor="default"},p.effectsMiddle=()=>{e.tileIndex&&e.path.forEach(s=>{Z({x:s[1],y:s[0]},On)})},p.effectsTop=()=>{e.tileIndex&&(e.path.forEach(s=>{Z({x:s[1],y:s[0]},Cn)}),Z(e.tileIndex,me))}};Ye.unset=()=>{const{mouse:e,player:t}=p;t.unsetPath(),e.onMouseMove=de,e.onMouseUp=de,p.effectsMiddle=de,p.effectsTop=de};const Oe=(e,t,n,i)=>{const s=e.x+Mt,o=e.y+kt;i.strokeStyle=t,i.beginPath(),i.ellipse(s,o,n,n*Sn,0,0,Fn),i.stroke()},De=16,ft=.86,Ci="lime",Ni="rgba(150, 150, 150, 0.8)",fe=(e,t,n,i)=>{const s=e.length;e.forEach((o,a)=>{const[r,l]=o,c=j({y:r,x:l});if(Oe(c,t,De,i),n&&a===s-1){const f=c.x+Mt,h=c.y+kt;i.beginPath(),i.moveTo(f,h),i.lineTo(f-De/3,h-S*ft*1.5),i.lineTo(f,h-S*1.5),i.lineTo(f+De/3,h-S*ft*1.5),i.closePath(),i.fillStyle=Ni,i.strokeStyle=Ci,i.fill(),i.stroke()}})},Ke={},he=()=>{};Ke.set=()=>{const{hoveredTile:e,mouse:t,player:n,ctxMid:i,ctxTop:s,canvasTop:o}=p;t.onMouseMove=()=>{t.buttonCode===1&&on(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&n.requestMove(e.tileIndex)},p.onFrameControls=a=>{sn(a),e.tileIndex=Ot({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?o.style.cursor="grabbing":o.style.cursor="pointer",e.path=ze(n.tileIndex,e.tileIndex)):o.style.cursor="default"},p.effectsMiddle=()=>{n.isMoving?fe(n.path,"lime",!1,i):e.tileIndex&&fe(e.path,"lime",!1,i)},p.effectsTop=()=>{if(n.isMoving){if(fe(n.path,"rgba(50, 205, 50, 0.5)",!0,s),e.tileIndex)if(be(e.tileIndex)){const a=j(e.tileIndex);Oe(a,me,Be,s)}else Z(e.tileIndex,me)}else if(e.tileIndex&&(fe(e.path,"rgba(50, 205, 50, 0.5)",!1,s),e.tileIndex))if(be(e.tileIndex)){const a=j(e.tileIndex);Oe(a,"lime",Be,s)}else Z(e.tileIndex,me)}};Ke.unset=()=>{const{mouse:e,player:t}=p;t.unsetPath(),e.onMouseMove=he,e.onMouseUp=he,p.effectsMiddle=he,p.effectsTop=he};const Kt=()=>{const{paused:e,stop:t,restart:n}=P;e?(n(),document.body.classList.remove("paused")):(t(),document.body.classList.add("paused"))},Ti=()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():canvasRoot.requestFullscreen()};Ft.keyDown=e=>{switch(e){case"Space":Kt();break;case"Enter":Q("ControlLeft")&&Ti();break;default:return}};document.addEventListener("visibilitychange",()=>{const{stop:e}=P;document.visibilityState==="hidden"?(e(),document.body.classList.add("paused")):document.visibilityState==="visible"&&Hn()});const ht={editMode:Ye,playMode:Ke},Qt=e=>{ht[p.mode].unset(),p.mode=e,Jn(),ht[e].set()},Wi=()=>w.h("div",null,w.h("div",{id:"pauseMenu"},w.h("div",{class:"pause-menu-items"},w.h("p",null,"Paused"),w.h("ul",null,w.h("li",null,w.h("button",{onclick:Kt},"Resume")),w.h("li",null,w.h("button",{id:"loadButton"},"Load")),w.h("li",null,w.h("button",{class:"save",id:"saveButton"},"Save"),w.h("input",{type:"text",id:"saveName",value:"tile-map"})))))),Si=()=>w.h("div",{class:"toolbar"},w.h("form",{id:"mode",name:"mode",class:"margin-right-10"},w.h("input",{type:"radio",id:"playRadio",value:"playMode",class:"margin-right-10",name:"mode",checked:!0}),w.h("label",{for:"playRadio"},"Play Mode"),w.h("input",{type:"radio",id:"editModeRadio",value:"editMode",class:"margin-left-10 margin-right-10",name:"mode"}),w.h("label",{for:"editModeRadio"},"Edit Mode"))),Fi=()=>w.h("div",{class:"wrapper"},w.h(Si,null),w.h("div",{id:"canvasRoot"},w.h("canvas",{class:"layer-canvas",id:"floorCanvas"}),w.h("canvas",{class:"layer-canvas",id:"canvasMid"}),w.h("canvas",{class:"layer-canvas",id:"entityCanvas"}),w.h("canvas",{class:"layer-canvas",id:"canvasTop"}),w.h("div",{id:"ui"}),w.h(Wi,null))),Xt=({xTiles:e,yTiles:t})=>{const{ctxMid:n,ctxTop:i,canvasMid:s,entityCanvas:o,canvasTop:a,canvasRoot:r,floorCanvas:l}=p,c=(e+t)/2*S,f=(e+t)/2*I,h=c+xn+nt;l.width=o.width=f,l.height=o.height=h;const y=c/2-S/4*(t-e)-S/2+nt,m={x:0,y},M={x:0,y:0},v=()=>{s.width=a.width=r.clientWidth,s.height=a.height=r.clientHeight,n.setTransform(1,0,0,1,M.x,M.y),i.setTransform(1,0,0,1,M.x,M.y)};return onresize=()=>{v()},{origin:m,xTiles:e,yTiles:t,translate:M,setApertureSize:v}},$i=e=>{const{ctxMid:t,ctxTop:n,view:i,effectsMiddle:s,effectsTop:o,entities:a,canvasMid:{width:r,height:l}}=p,{translate:c}=i;a.forEach(f=>{f.update(e)}),t.clearRect(-c.x,-c.y,r,l),s(),n.clearRect(-c.x,-c.y,r,l),o()},Zt=e=>{const{onFrameControls:t}=p;t&&(t(e),p.monitor(e)),$i(e)},P={};let X=0,en=0,tn;P.start=e=>{tn=e,en=requestAnimationFrame(t=>{Pi(t,e)}),P.paused=!1};P.restart=()=>{P.start(tn),P.paused=!1};P.stop=()=>{window.cancelAnimationFrame(en),X=0,P.paused=!0};const Pi=(e,t)=>{X||(X=e);const n=e-X;X=e,t(n),P.start(t)},Di=e=>{P.stop(),delete p.entites,delete p.tileMap,delete p.entityMap;const{xTiles:t,yTiles:n}=e;p.view=p.setView({xTiles:t,yTiles:n}),p.loadMap(e),P.start(Zt)},Ii=()=>{saveButton.onclick=()=>{const e=bn(),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",saveName.value+".json"),saveButton.after(t),t.click(),t.remove()},loadButton.onclick=()=>{const e=document.createElement("input");e.type="file",loadButton.after(e),e.onchange=()=>{const t=new FileReader;t.onload=n=>{const i=wt(n.target.result);Di(i)},t.readAsText(e.files[0])},e.click(),e.remove()}};let _i=0;const Ei=()=>_i++,pt=(e,t)=>{const n=e+(Math.random()*t-t/2);return Math.floor(n)};class Qe{constructor({sprite:t,haloColor:n}){U(this,"addToScene",t=>{const{entityMap:n}=p,{id:i,render:s,redraw:o}=this;this.tileIndex=t,this.position=j(t),this.positionPrevious=this.position,this.redrawEntities=Gi,n.addEntity({tileIndex:t,id:i,render:s}),p.entities.push(this),o()});U(this,"render",()=>{const{entityCtx:t}=p,{sprite:n,position:i,haloColor:s}=this;Oe(i,s,Be,t),t.drawImage(n.data,Math.round(i.x),Math.round(i.y-n.yOffset))});U(this,"redraw",()=>{const{tileIndex:t,position:n,positionPrevious:i}=this;this.redrawEntities(t,n,i),this.positionPrevious={x:n.x,y:n.y}});this.sprite=t||F.playerTokens.sheild,this.haloColor=n||Nn,this.id=Ei(),this.position={x:0,y:0}}update(){}}const nn=(e,t)=>{const{entityMap:n}=p;let i=null,s,o,a;e.isMoving=!1;const r=h=>{if(e.isMoving){const y=t*h,m=y*Math.cos(i),M=y*Math.sin(i);e.position.x+=m,e.position.y+=M;const v=s.x-e.position.x,u=s.y-e.position.y,d=v>0!==o,g=u>0!==a;(d||g)&&(e.position.x=s.x,e.position.y=s.y,e.path.length>1?(e.path.shift(),c()):e.isMoving=!1),n.removeEntity({tileIndex:e.tileIndex,id:e.id}),e.tileIndex=At({x:e.position.x+I/2,y:e.position.y+S/2}),n.addEntity({tileIndex:e.tileIndex,id:e.id,render:e.render})}},l=()=>{e.isMoving=!1,e.path=[]},c=()=>{const[h]=e.path,[y,m]=h,M={x:m,y};if(be(M)){s=j(M);const v=s.x-e.position.x,u=s.y-e.position.y;o=v>0,a=u>0,i=Math.atan2(u,v)}else l()};return{move:r,requestMove:h=>{const y=ze(e.tileIndex,h),m=h.x===e.tileIndex.x&&h.y===e.tileIndex.y;!e.isMoving&&!m&&y.length&&(e.path=y,e.path.shift(),c(),e.isMoving=!0)},unsetPath:l}};class Bi extends Qe{constructor(){super({sprite:F.playerTokens.angel,haloColor:"lime"}),this.path=[];const t=nn(this,Tn),n={editMode:t.move,playMode:t.move};this.update=i=>{n[p.mode](i),this.redraw()},this.requestMove=t.requestMove,this.unsetPath=t.unsetPath}}class ji extends Qe{constructor(n){super(n);U(this,"pickPath",()=>{const{pathFinder:n,tileIndex:i}=this,s={x:pt(i.x,10),y:pt(i.y,10)};be(s)&&n.requestMove(s)});U(this,"update",n=>{const{pathFinder:i,pickPath:s,redraw:o,isMoving:a}=this;p.mode!=="editMode"&&(a||s(),i.move(n)),o()});this.path=[],this.pathFinder=nn(this,Wn)}}const Li=e=>{const t={};t.entities=[];const{xTiles:n,yTiles:i}=e;for(let s=0;s<n;s++){t.entities[s]=[];for(let o=0;o<i;o++)t.entities[s][o]={}}return t.addEntity=({tileIndex:s,id:o,render:a})=>{t.entities[s.x][s.y][o]=a,Ze(s,1)},t.entityCheck=({x:s,y:o})=>{const a=t.entities[s][o];return Object.keys(a).length===0},t.removeEntity=({tileIndex:s,id:o})=>{const{x:a,y:r}=s,l=t.entities[a][r];if(delete l[o],Object.keys(l).length===0){const f=e.tiles[a][r].walkable;Ze(s,f)}},t},Ce=(e,t)=>{var o;const{tileMap:n,entityMap:i}=p,s=(o=n.tiles[e])==null?void 0:o[t];if(s){const{feature:a}=s,r=j({x:e,y:t}),l=i.entities[e][t];for(const c in l)l[c]();if(a){const{set:c,color:f,variant:h}=a,y=Je(c,f,h);p.entityCtx.drawImage(y.data,r.x,r.y-y.yOffset),p.entityCtx.globalAlpha=.5;for(const m in l)l[m]();p.entityCtx.globalAlpha=1}}},T={x:0,y:0,buttonCode:0,onMouseUp:null,onMouseMove:null,isDragged:!1,dragStart:{x:0,y:0},drag:{x:0,y:0}},Ri=e=>(e.addEventListener("contextmenu",t=>t.preventDefault()),e.onmousemove=t=>{const{translate:n}=p.view,{left:i,top:s}=t.target.getBoundingClientRect();T.x=t.clientX-i-n.x,T.y=t.clientY-s-n.y,T.buttonCode===1&&(T.isDragged=!0,T.drag.x=T.dragStart.x-T.x-n.x,T.drag.y=T.dragStart.y-T.y-n.y),T.onMouseMove&&T.onMouseMove()},e.onmousedown=t=>{t.preventDefault(),T.buttonCode=t.which,T.dragStart.x=T.x,T.dragStart.y=T.y,T.drag.x=0,T.drag.y=0},document.onmouseup=()=>{T.onMouseUp&&T.onMouseUp(),T.isDragged=!1,T.buttonCode=0},e.onmouseleave=()=>{T.isDragged=!1,T.buttonCode=0},T),Ji=()=>{const{view:e,floorCanvas:t,entityCanvas:n}=p,{xTiles:i,yTiles:s}=e;for(let o=i-1;o>-1;o--)for(let a=0;a<s;a++)ot(o,a),Ce(o,a);t.addEventListener("contextrestored",()=>{for(let o=i-1;o>-1;o--)for(let a=0;a<s;a++)ot(o,a)}),n.addEventListener("contextrestored",()=>{for(let o=i-1;o>-1;o--)for(let a=0;a<s;a++)Ce(o,a)})},Ie=150,pe=70,Hi=100,Ui=()=>{const e=document.createElement("canvas"),t=e.getContext("2d");return e.classList.add("monitor"),e.width=Ie,e.height=pe,canvasRoot.appendChild(e),t.strokeStyle="#ff0000",n=>{t.globalCompositeOperation="copy",t.drawImage(e,-1,0),t.globalCompositeOperation="source-over";const i=pe-n/Hi*pe;t.beginPath(),t.moveTo(Ie,pe),t.lineTo(Ie,i),t.stroke()}},p={};p.start=async e=>{const t=document.getElementById("root");p.canvasRoot=Fi(),t.replaceWith(p.canvasRoot),p.floorCanvas=document.getElementById("floorCanvas"),p.floorCtx=p.floorCanvas.getContext("2d"),p.canvasMid=document.getElementById("canvasMid"),p.ctxMid=p.canvasMid.getContext("2d"),p.entityCanvas=document.getElementById("entityCanvas"),p.entityCtx=p.entityCanvas.getContext("2d"),p.canvasTop=document.getElementById("canvasTop"),p.ctxTop=p.canvasTop.getContext("2d"),p.monitor=Ui(),p.effectsMiddle=()=>{},p.effectsTop=()=>{},p.mouse=Ri(p.canvasTop),p.view=Xt({xTiles:ae,yTiles:ae}),p.hoveredTile={path:null,tileIndex:null},p.mode="playMode",mode.onchange=()=>{const n=mode.elements.mode.value;Qt(n)},Ii();try{const n=await wn(e);p.loadMap(n)}catch{const n=mn({xTiles:ae,yTiles:ae});p.loadMap(n)}P.start(Zt)};p.loadMap=e=>{const{entityList:t,unitStart:n={x:1,y:1}}=e;p.tileMap=e,p.entityMap=Li(e),p.entities=[],p.player=new Bi,p.player.addToScene(n),t&&t.forEach(i=>{const{name:s,tileIndex:o}=i;switch(s){case"entity":new Qe({}).addToScene(o);break;case"npc":new ji({sprite:F.playerTokens.despoiler,haloColor:"red"}).addToScene(o);break}}),Qt(p.mode),p.view.setApertureSize(),Ji()};p.setView=Xt;let _e=0,Ee=0;const ge={x:0,y:0},sn=e=>{const{ctxMid:t,ctxTop:n,floorCanvas:i,entityCanvas:s,view:{translate:o}}=p,a=Q("KeyW"),r=Q("KeyS"),l=Q("KeyD"),c=Q("KeyA");_e+=st*e*(l-c),Ee+=st*e*(r-a),o.x=Math.round(o.x-_e),o.y=Math.round(o.y-Ee),(o.x!==ge.x||o.y!==ge.y)&&(i.style.left=`${o.x}px`,i.style.top=`${o.y}px`,s.style.left=`${o.x}px`,s.style.top=`${o.y}px`,t.setTransform(1,0,0,1,o.x,o.y),n.setTransform(1,0,0,1,o.x,o.y),ge.x=o.x,ge.y=o.y),_e*=it,Ee*=it},on=(e,t)=>{const{view:{translate:n}}=p;n.x=e,n.y=t},Le=I,Re=S*3,qi=S*1.5,gt=(e,t)=>{const{x:n,y:i}=t;e.save(),e.beginPath(),e.rect(n,i,Le,Re),e.clip(),e.clearRect(n,i,Le,Re)},Vi=e=>{const{floorCtx:t,entityCtx:n,tileMap:i}=p,s=j({x:e.x,y:e.y});s.y-=qi,gt(t,s),gt(n,s),Yi.forEach(o=>{var l;const a=o.x+e.x,r=o.y+e.y;if((l=i.tiles[a])!=null&&l[r]){const c=i.tiles[a][r];if(c.floor){const{set:f,color:h,variant:y}=c.floor;xt({x:a,y:r,image:Je(f,h,y)})}Ce(a,r)}}),n.restore(),t.restore()},Gi=(e,t,n)=>{const{entityCtx:i}=p,s={x:Math.floor(Math.min(t.x,n.x)),y:Math.floor(Math.min(t.y,n.y)-S*2)},o=Math.ceil(Math.abs(t.x-n.x)+Le),a=Math.ceil(Math.abs(t.y-n.y)+Re),{x:r,y:l}=s;i.save(),i.beginPath(),i.rect(r,l,o,a),i.clip(),i.clearRect(r,l,o,a),zi.forEach(c=>{const f=c.x+e.x,h=c.y+e.y;Ce(f,h)}),i.restore()},zi=[{x:3,y:-3},{x:3,y:-2},{x:3,y:-1},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:2,y:0},{x:1,y:-3},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:0},{x:-2,y:1},{x:-3,y:1},{x:-2,y:2},{x:-1,y:3},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Yi=[{x:3,y:-3},{x:3,y:-2},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:1},{x:-2,y:2},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Ki=async()=>{await F.load(),p.start("vista"),window.dump=()=>console.log(p)};Ki();
