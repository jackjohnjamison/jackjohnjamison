var ln=Object.defineProperty;var cn=(e,t,n)=>t in e?ln(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var H=(e,t,n)=>(cn(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerpolicy&&(o.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?o.credentials="include":s.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();var K=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function un(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var w={},mt={},R={};Object.defineProperty(R,"__esModule",{value:!0});R.isSvgTag=R.applyChildren=R.setElementStyle=void 0;function dn(e,t){let n;const i=Object.keys(t);for(n of i)e.style[n]=t[n]}R.setElementStyle=dn;function et(e,t){t instanceof HTMLElement?e.appendChild(t):typeof t=="string"||typeof t=="number"?e.appendChild(document.createTextNode(t.toString())):console.warn("Unknown type to append: ",t)}function bt(e,t){for(const n of t)if(!(!n&&n!==0))if(Array.isArray(n))for(const i of n)Array.isArray(i)?bt(e,i):et(e,i);else et(e,n)}R.applyChildren=bt;function fn(e){return["a","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","path","pattern","polygon","polyline","radialGradient","rect","script","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"].includes(e)}R.isSvgTag=fn;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.h=e.xlinkNS=void 0;const t=R;e.xlinkNS="http://www.w3.org/1999/xlink";function n(i,s,...o){if(typeof i=="function")return i(Object.assign(Object.assign({},s),{children:o}));const a=t.isSvgTag(i),r=a?document.createElementNS("http://www.w3.org/2000/svg",i):document.createElement(i);if(s){s.style&&typeof s.style!="string"&&(t.setElementStyle(r,s.style),delete s.style);for(const l of Object.keys(s)){const c=s[l];if(l.startsWith("on")){const f=l.replace(/Capture$/,""),h=l!==f,m=f.toLowerCase().substring(2);r.addEventListener(m,c,h)}else a&&l.startsWith("xlink:")?r.setAttributeNS(e.xlinkNS,l,c):c===!0?r.setAttribute(l,l):(c||c===0)&&r.setAttribute(l,c.toString())}}return t.applyChildren(r,o),r}e.h=n})(mt);var wt={};Object.defineProperty(wt,"__esModule",{value:!0});(function(e){var t=K&&K.__createBinding||(Object.create?function(i,s,o,a){a===void 0&&(a=o),Object.defineProperty(i,a,{enumerable:!0,get:function(){return s[o]}})}:function(i,s,o,a){a===void 0&&(a=o),i[a]=s[o]}),n=K&&K.__exportStar||function(i,s){for(var o in i)o!=="default"&&!Object.prototype.hasOwnProperty.call(s,o)&&t(s,i,o)};Object.defineProperty(e,"__esModule",{value:!0}),n(mt,e),n(wt,e)})(w);const be=({x:e,y:t})=>{var i,s;const{pathGrid:n}=p.tileMap;return(s=(i=n.nodes[t])==null?void 0:i[e])==null?void 0:s.walkable},tt=({x:e,y:t},n)=>{const{pathGrid:i}=p.tileMap;i.setWalkableAt(e,t,n)},hn="modulepreload",pn=function(e){return"/tiles/"+e},nt={},gn=function(t,n,i){return!n||n.length===0?t():Promise.all(n.map(s=>{if(s=pn(s),s in nt)return;nt[s]=!0;const o=s.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${s}"]${a}`))return;const r=document.createElement("link");if(r.rel=o?"stylesheet":hn,o||(r.as="script",r.crossOrigin=""),r.href=s,document.head.appendChild(r),o)return new Promise((l,c)=>{r.addEventListener("load",l),r.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${s}`)))})})).then(()=>t())},yn=(e,t)=>{const n=e[t];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((i,s)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(s.bind(null,new Error("Unknown variable dynamic import: "+t)))})},O=e=>new Promise(t=>{let n=new Image;n.onload=()=>t(n),n.src=e}),I={},C="/tiles/src/images/";I.load=async()=>{const e=O(`${C}terracotta1.png`),t=O(`${C}terracotta2.png`),n=O(`${C}terracotta3.png`),i=O(`${C}terracotta4.png`),s=O(`${C}cube1.png`),o=O(`${C}cube2.png`),a=O(`${C}cube3.png`),r=O(`${C}grass1.png`),l=O(`${C}grass2.png`),c=O(`${C}grass3.png`),f=O(`${C}grass4.png`),h=O(`${C}water1.png`),m=O(`${C}water2.png`),v=O(`${C}mountain1.png`),k=O(`${C}mountain2.png`),y=O(`${C}mountain3.png`),u=O(`${C}mountain1-top.png`),d=O(`${C}mountain2-top.png`),g=O(`${C}mountain3-top.png`),b=O(`${C}trees1.png`),x=O(`${C}trees2.png`),M=O(`${C}trees3.png`),A=O(`${C}trees4.png`),N=O(`${C}trees1-top.png`),W=O(`${C}trees2-top.png`),P=O(`${C}trees3-top.png`),B=O(`${C}trees4-top.png`),Y=O(`${C}pt-angel.png`),an=O(`${C}pt-despoiler.png`),rn=O(`${C}pt-sheild.png`);I.terracotta=[{yOffset:0,data:await e},{yOffset:0,data:await t},{yOffset:0,data:await n},{yOffset:0,data:await i}],I.cube=[{yOffset:33,data:await s},{yOffset:33,data:await o},{yOffset:33,data:await a}],I.grass=[{yOffset:2,data:await r},{yOffset:2,data:await l},{yOffset:2,data:await c},{yOffset:2,data:await f}],I.water=[{yOffset:-3,data:await h},{yOffset:-3,data:await m}],I.mountain=[{yOffset:14,data:await v},{yOffset:12,data:await k},{yOffset:14,data:await y}],I.mountainTop=[{yOffset:14,data:await u},{yOffset:12,data:await d},{yOffset:14,data:await g}],I.forest=[{yOffset:15,data:await b},{yOffset:15,data:await x},{yOffset:15,data:await M},{yOffset:15,data:await A}],I.forestTop=[{yOffset:15,data:await N},{yOffset:15,data:await W},{yOffset:15,data:await P},{yOffset:15,data:await B}],I.playerTokens={angel:{yOffset:51,data:await Y},despoiler:{yOffset:51,data:await an},sheild:{yOffset:48,data:await rn}}};const ye=document.createElement("canvas"),it=ye.getContext("2d"),vn=(e,t)=>{const{data:n,data:{width:i,height:s},yOffset:o}=e;ye.width=i,ye.height=s;const a=n;return it.filter=`hue-rotate(${t}deg)`,it.drawImage(a,0,0),{data:ye,yOffset:o}},Je=(e,t,n)=>{const i=I[e][n];return vn(i,t)};var Mt={exports:{}},ie={exports:{}},kt={exports:{}};(function(e){(function(){var t,n,i,s,o,a,r,l,c,f,h,m,v,k,y;i=Math.floor,f=Math.min,n=function(u,d){return u<d?-1:u>d?1:0},c=function(u,d,g,b,x){var M;if(g==null&&(g=0),x==null&&(x=n),g<0)throw new Error("lo must be non-negative");for(b==null&&(b=u.length);g<b;)M=i((g+b)/2),x(d,u[M])<0?b=M:g=M+1;return[].splice.apply(u,[g,g-g].concat(d)),d},a=function(u,d,g){return g==null&&(g=n),u.push(d),k(u,0,u.length-1,g)},o=function(u,d){var g,b;return d==null&&(d=n),g=u.pop(),u.length?(b=u[0],u[0]=g,y(u,0,d)):b=g,b},l=function(u,d,g){var b;return g==null&&(g=n),b=u[0],u[0]=d,y(u,0,g),b},r=function(u,d,g){var b;return g==null&&(g=n),u.length&&g(u[0],d)<0&&(b=[u[0],d],d=b[0],u[0]=b[1],y(u,0,g)),d},s=function(u,d){var g,b,x,M,A,N;for(d==null&&(d=n),M=function(){N=[];for(var W=0,P=i(u.length/2);0<=P?W<P:W>P;0<=P?W++:W--)N.push(W);return N}.apply(this).reverse(),A=[],b=0,x=M.length;b<x;b++)g=M[b],A.push(y(u,g,d));return A},v=function(u,d,g){var b;if(g==null&&(g=n),b=u.indexOf(d),b!==-1)return k(u,0,b,g),y(u,b,g)},h=function(u,d,g){var b,x,M,A,N;if(g==null&&(g=n),x=u.slice(0,d),!x.length)return x;for(s(x,g),N=u.slice(d),M=0,A=N.length;M<A;M++)b=N[M],r(x,b,g);return x.sort(g).reverse()},m=function(u,d,g){var b,x,M,A,N,W,P,B,Y;if(g==null&&(g=n),d*10<=u.length){if(M=u.slice(0,d).sort(g),!M.length)return M;for(x=M[M.length-1],P=u.slice(d),A=0,W=P.length;A<W;A++)b=P[A],g(b,x)<0&&(c(M,b,0,null,g),M.pop(),x=M[M.length-1]);return M}for(s(u,g),Y=[],N=0,B=f(d,u.length);0<=B?N<B:N>B;0<=B?++N:--N)Y.push(o(u,g));return Y},k=function(u,d,g,b){var x,M,A;for(b==null&&(b=n),x=u[g];g>d;){if(A=g-1>>1,M=u[A],b(x,M)<0){u[g]=M,g=A;continue}break}return u[g]=x},y=function(u,d,g){var b,x,M,A,N;for(g==null&&(g=n),x=u.length,N=d,M=u[d],b=2*d+1;b<x;)A=b+1,A<x&&!(g(u[b],u[A])<0)&&(b=A),u[d]=u[b],d=b,b=2*d+1;return u[d]=M,k(u,N,d,g)},t=function(){u.push=a,u.pop=o,u.replace=l,u.pushpop=r,u.heapify=s,u.updateItem=v,u.nlargest=h,u.nsmallest=m;function u(d){this.cmp=d!=null?d:n,this.nodes=[]}return u.prototype.push=function(d){return a(this.nodes,d,this.cmp)},u.prototype.pop=function(){return o(this.nodes,this.cmp)},u.prototype.peek=function(){return this.nodes[0]},u.prototype.contains=function(d){return this.nodes.indexOf(d)!==-1},u.prototype.replace=function(d){return l(this.nodes,d,this.cmp)},u.prototype.pushpop=function(d){return r(this.nodes,d,this.cmp)},u.prototype.heapify=function(){return s(this.nodes,this.cmp)},u.prototype.updateItem=function(d){return v(this.nodes,d,this.cmp)},u.prototype.clear=function(){return this.nodes=[]},u.prototype.empty=function(){return this.nodes.length===0},u.prototype.size=function(){return this.nodes.length},u.prototype.clone=function(){var d;return d=new u,d.nodes=this.nodes.slice(0),d},u.prototype.toArray=function(){return this.nodes.slice(0)},u.prototype.insert=u.prototype.push,u.prototype.top=u.prototype.peek,u.prototype.front=u.prototype.peek,u.prototype.has=u.prototype.contains,u.prototype.copy=u.prototype.clone,u}(),e!==null&&e.exports?e.exports=t:window.Heap=t}).call(K)})(kt);(function(e){e.exports=kt.exports})(ie);function mn(e,t,n){this.x=e,this.y=t,this.walkable=n===void 0?!0:n}var He=mn,bn={Always:1,Never:2,IfAtMostOneObstacle:3,OnlyWhenNoObstacles:4},_=bn,xt=He,oe=_;function j(e,t,n){var i;typeof e!="object"?i=e:(t=e.length,i=e[0].length,n=e),this.width=i,this.height=t,this.nodes=this._buildNodes(i,t,n)}j.prototype._buildNodes=function(e,t,n){var i,s,o=new Array(t);for(i=0;i<t;++i)for(o[i]=new Array(e),s=0;s<e;++s)o[i][s]=new xt(s,i);if(n===void 0)return o;if(n.length!==t||n[0].length!==e)throw new Error("Matrix size does not fit");for(i=0;i<t;++i)for(s=0;s<e;++s)n[i][s]&&(o[i][s].walkable=!1);return o};j.prototype.getNodeAt=function(e,t){return this.nodes[t][e]};j.prototype.isWalkableAt=function(e,t){return this.isInside(e,t)&&this.nodes[t][e].walkable};j.prototype.isInside=function(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height};j.prototype.setWalkableAt=function(e,t,n){this.nodes[t][e].walkable=n};j.prototype.getNeighbors=function(e,t){var n=e.x,i=e.y,s=[],o=!1,a=!1,r=!1,l=!1,c=!1,f=!1,h=!1,m=!1,v=this.nodes;if(this.isWalkableAt(n,i-1)&&(s.push(v[i-1][n]),o=!0),this.isWalkableAt(n+1,i)&&(s.push(v[i][n+1]),r=!0),this.isWalkableAt(n,i+1)&&(s.push(v[i+1][n]),c=!0),this.isWalkableAt(n-1,i)&&(s.push(v[i][n-1]),h=!0),t===oe.Never)return s;if(t===oe.OnlyWhenNoObstacles)a=h&&o,l=o&&r,f=r&&c,m=c&&h;else if(t===oe.IfAtMostOneObstacle)a=h||o,l=o||r,f=r||c,m=c||h;else if(t===oe.Always)a=!0,l=!0,f=!0,m=!0;else throw new Error("Incorrect value of diagonalMovement");return a&&this.isWalkableAt(n-1,i-1)&&s.push(v[i-1][n-1]),l&&this.isWalkableAt(n+1,i-1)&&s.push(v[i-1][n+1]),f&&this.isWalkableAt(n+1,i+1)&&s.push(v[i+1][n+1]),m&&this.isWalkableAt(n-1,i+1)&&s.push(v[i+1][n-1]),s};j.prototype.clone=function(){var e,t,n=this.width,i=this.height,s=this.nodes,o=new j(n,i),a=new Array(i);for(e=0;e<i;++e)for(a[e]=new Array(n),t=0;t<n;++t)a[e][t]=new xt(t,e,s[e][t].walkable);return o.nodes=a,o};var wn=j,$={};function Be(e){for(var t=[[e.x,e.y]];e.parent;)e=e.parent,t.push([e.x,e.y]);return t.reverse()}$.backtrace=Be;function Mn(e,t){var n=Be(e),i=Be(t);return n.concat(i.reverse())}$.biBacktrace=Mn;function kn(e){var t,n=0,i,s,o,a;for(t=1;t<e.length;++t)i=e[t-1],s=e[t],o=i[0]-s[0],a=i[1]-s[1],n+=Math.sqrt(o*o+a*a);return n}$.pathLength=kn;function Ue(e,t,n,i){var s=Math.abs,o=[],a,r,l,c,f,h;for(l=s(n-e),c=s(i-t),a=e<n?1:-1,r=t<i?1:-1,f=l-c;o.push([e,t]),!(e===n&&t===i);)h=2*f,h>-c&&(f=f-c,e=e+a),h<l&&(f=f+l,t=t+r);return o}$.interpolate=Ue;function xn(e){var t=[],n=e.length,i,s,o,a,r,l;if(n<2)return t;for(r=0;r<n-1;++r)for(i=e[r],s=e[r+1],o=Ue(i[0],i[1],s[0],s[1]),a=o.length,l=0;l<a-1;++l)t.push(o[l]);return t.push(e[n-1]),t}$.expandPath=xn;function An(e,t){var n=t.length,i=t[0][0],s=t[0][1],o=t[n-1][0],a=t[n-1][1],r,l,c,f,h,m,v,k,y,u,d;for(r=i,l=s,h=[[r,l]],m=2;m<n;++m){for(k=t[m],c=k[0],f=k[1],y=Ue(r,l,c,f),d=!1,v=1;v<y.length;++v)if(u=y[v],!e.isWalkableAt(u[0],u[1])){d=!0;break}d&&(lastValidCoord=t[m-1],h.push(lastValidCoord),r=lastValidCoord[0],l=lastValidCoord[1])}return h.push([o,a]),h}$.smoothenPath=An;function On(e){if(e.length<3)return e;var t=[],n=e[0][0],i=e[0][1],s=e[1][0],o=e[1][1],a=s-n,r=o-i,l,c,f,h,m,v;for(m=Math.sqrt(a*a+r*r),a/=m,r/=m,t.push([n,i]),v=2;v<e.length;v++)l=s,c=o,f=a,h=r,s=e[v][0],o=e[v][1],a=s-l,r=o-c,m=Math.sqrt(a*a+r*r),a/=m,r/=m,(a!==f||r!==h)&&t.push([l,c]);return t.push([s,o]),t}$.compressPath=On;var se={manhattan:function(e,t){return e+t},euclidean:function(e,t){return Math.sqrt(e*e+t*t)},octile:function(e,t){var n=Math.SQRT2-1;return e<t?n*e+t:n*t+e},chebyshev:function(e,t){return Math.max(e,t)}},Cn=ie.exports,Nn=$,Te=se,ae=_;function At(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.heuristic=e.heuristic||Te.manhattan,this.weight=e.weight||1,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=ae.OnlyWhenNoObstacles:this.diagonalMovement=ae.IfAtMostOneObstacle:this.diagonalMovement=ae.Never),this.diagonalMovement===ae.Never?this.heuristic=e.heuristic||Te.manhattan:this.heuristic=e.heuristic||Te.octile}At.prototype.findPath=function(e,t,n,i,s){var o=new Cn(function(M,A){return M.f-A.f}),a=s.getNodeAt(e,t),r=s.getNodeAt(n,i),l=this.heuristic,c=this.diagonalMovement,f=this.weight,h=Math.abs,m=Math.SQRT2,v,k,y,u,d,g,b,x;for(a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(v=o.pop(),v.closed=!0,v===r)return Nn.backtrace(r);for(k=s.getNeighbors(v,c),u=0,d=k.length;u<d;++u)y=k[u],!y.closed&&(g=y.x,b=y.y,x=v.g+(g-v.x===0||b-v.y===0?1:m),(!y.opened||x<y.g)&&(y.g=x,y.h=y.h||f*l(h(g-n),h(b-i)),y.f=y.g+y.h,y.parent=v,y.opened?o.updateItem(y):(o.push(y),y.opened=!0)))}return[]};var Ge=At,Ot=Ge;function we(e){Ot.call(this,e);var t=this.heuristic;this.heuristic=function(n,i){return t(n,i)*1e6}}we.prototype=new Ot;we.prototype.constructor=we;var Tn=we,Wn=$,We=_;function Ct(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=We.OnlyWhenNoObstacles:this.diagonalMovement=We.IfAtMostOneObstacle:this.diagonalMovement=We.Never)}Ct.prototype.findPath=function(e,t,n,i,s){var o=[],a=this.diagonalMovement,r=s.getNodeAt(e,t),l=s.getNodeAt(n,i),c,f,h,m,v;for(o.push(r),r.opened=!0;o.length;){if(h=o.shift(),h.closed=!0,h===l)return Wn.backtrace(l);for(c=s.getNeighbors(h,a),m=0,v=c.length;m<v;++m)f=c[m],!(f.closed||f.opened)&&(o.push(f),f.opened=!0,f.parent=h)}return[]};var Sn=Ct,Nt=Ge;function Me(e){Nt.call(this,e),this.heuristic=function(t,n){return 0}}Me.prototype=new Nt;Me.prototype.constructor=Me;var In=Me,st=ie.exports,ot=$,Se=se,re=_;function Tt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||Se.manhattan,this.weight=e.weight||1,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=re.OnlyWhenNoObstacles:this.diagonalMovement=re.IfAtMostOneObstacle:this.diagonalMovement=re.Never),this.diagonalMovement===re.Never?this.heuristic=e.heuristic||Se.manhattan:this.heuristic=e.heuristic||Se.octile}Tt.prototype.findPath=function(e,t,n,i,s){var o=function(P,B){return P.f-B.f},a=new st(o),r=new st(o),l=s.getNodeAt(e,t),c=s.getNodeAt(n,i),f=this.heuristic,h=this.diagonalMovement,m=this.weight,v=Math.abs,k=Math.SQRT2,y,u,d,g,b,x,M,A,N=1,W=2;for(l.g=0,l.f=0,a.push(l),l.opened=N,c.g=0,c.f=0,r.push(c),c.opened=W;!a.empty()&&!r.empty();){for(y=a.pop(),y.closed=!0,u=s.getNeighbors(y,h),g=0,b=u.length;g<b;++g)if(d=u[g],!d.closed){if(d.opened===W)return ot.biBacktrace(y,d);x=d.x,M=d.y,A=y.g+(x-y.x===0||M-y.y===0?1:k),(!d.opened||A<d.g)&&(d.g=A,d.h=d.h||m*f(v(x-n),v(M-i)),d.f=d.g+d.h,d.parent=y,d.opened?a.updateItem(d):(a.push(d),d.opened=N))}for(y=r.pop(),y.closed=!0,u=s.getNeighbors(y,h),g=0,b=u.length;g<b;++g)if(d=u[g],!d.closed){if(d.opened===N)return ot.biBacktrace(d,y);x=d.x,M=d.y,A=y.g+(x-y.x===0||M-y.y===0?1:k),(!d.opened||A<d.g)&&(d.g=A,d.h=d.h||m*f(v(x-e),v(M-t)),d.f=d.g+d.h,d.parent=y,d.opened?r.updateItem(d):(r.push(d),d.opened=W))}}return[]};var qe=Tt,Wt=qe;function ke(e){Wt.call(this,e);var t=this.heuristic;this.heuristic=function(n,i){return t(n,i)*1e6}}ke.prototype=new Wt;ke.prototype.constructor=ke;var Pn=ke,at=$,Ie=_;function St(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Ie.OnlyWhenNoObstacles:this.diagonalMovement=Ie.IfAtMostOneObstacle:this.diagonalMovement=Ie.Never)}St.prototype.findPath=function(e,t,n,i,s){var o=s.getNodeAt(e,t),a=s.getNodeAt(n,i),r=[],l=[],c,f,h,m=this.diagonalMovement,v=0,k=1,y,u;for(r.push(o),o.opened=!0,o.by=v,l.push(a),a.opened=!0,a.by=k;r.length&&l.length;){for(h=r.shift(),h.closed=!0,c=s.getNeighbors(h,m),y=0,u=c.length;y<u;++y)if(f=c[y],!f.closed){if(f.opened){if(f.by===k)return at.biBacktrace(h,f);continue}r.push(f),f.parent=h,f.opened=!0,f.by=v}for(h=l.shift(),h.closed=!0,c=s.getNeighbors(h,m),y=0,u=c.length;y<u;++y)if(f=c[y],!f.closed){if(f.opened){if(f.by===v)return at.biBacktrace(f,h);continue}l.push(f),f.parent=h,f.opened=!0,f.by=k}}return[]};var Fn=St,It=qe;function xe(e){It.call(this,e),this.heuristic=function(t,n){return 0}}xe.prototype=new It;xe.prototype.constructor=xe;var $n=xe,Pe=se,rt=He,le=_;function Pt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||Pe.manhattan,this.weight=e.weight||1,this.trackRecursion=e.trackRecursion||!1,this.timeLimit=e.timeLimit||1/0,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=le.OnlyWhenNoObstacles:this.diagonalMovement=le.IfAtMostOneObstacle:this.diagonalMovement=le.Never),this.diagonalMovement===le.Never?this.heuristic=e.heuristic||Pe.manhattan:this.heuristic=e.heuristic||Pe.octile}Pt.prototype.findPath=function(e,t,n,i,s){var o=new Date().getTime(),a=function(y,u){return this.heuristic(Math.abs(u.x-y.x),Math.abs(u.y-y.y))}.bind(this),r=function(y,u){return y.x===u.x||y.y===u.y?1:Math.SQRT2},l=function(y,u,d,g,b){if(this.timeLimit>0&&new Date().getTime()-o>this.timeLimit*1e3)return 1/0;var x=u+a(y,f)*this.weight;if(x>d)return x;if(y==f)return g[b]=[y.x,y.y],y;var M,A,N,W,P=s.getNeighbors(y,this.diagonalMovement);for(N=0,M=1/0;W=P[N];++N){if(this.trackRecursion&&(W.retainCount=W.retainCount+1||1,W.tested!==!0&&(W.tested=!0)),A=l(W,u+r(y,W),d,g,b+1),A instanceof rt)return g[b]=[y.x,y.y],A;this.trackRecursion&&--W.retainCount===0&&(W.tested=!1),A<M&&(M=A)}return M}.bind(this),c=s.getNodeAt(e,t),f=s.getNodeAt(n,i),h=a(c,f),m,v,k;for(m=0;;++m){if(v=[],k=l(c,0,h,v,0),k===1/0)return[];if(k instanceof rt)return v;h=k}return[]};var Dn=Pt,_n=ie.exports,lt=$,Ft=se;function Ve(e){e=e||{},this.heuristic=e.heuristic||Ft.manhattan,this.trackJumpRecursion=e.trackJumpRecursion||!1}Ve.prototype.findPath=function(e,t,n,i,s){var o=this.openList=new _n(function(c,f){return c.f-f.f}),a=this.startNode=s.getNodeAt(e,t),r=this.endNode=s.getNodeAt(n,i),l;for(this.grid=s,a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(l=o.pop(),l.closed=!0,l===r)return lt.expandPath(lt.backtrace(r));this._identifySuccessors(l)}return[]};Ve.prototype._identifySuccessors=function(e){var t=this.grid,n=this.heuristic,i=this.openList,s=this.endNode.x,o=this.endNode.y,a,r,l,c,f,h=e.x,m=e.y,v,k,y,u,d,g=Math.abs;for(a=this._findNeighbors(e),c=0,f=a.length;c<f;++c)if(r=a[c],l=this._jump(r[0],r[1],h,m),l){if(v=l[0],k=l[1],d=t.getNodeAt(v,k),d.closed)continue;y=Ft.octile(g(v-h),g(k-m)),u=e.g+y,(!d.opened||u<d.g)&&(d.g=u,d.h=d.h||n(g(v-s),g(k-o)),d.f=d.g+d.h,d.parent=e,d.opened?i.updateItem(d):(i.push(d),d.opened=!0))}};var Ne=Ve,$t=Ne,En=_;function G(e){$t.call(this,e)}G.prototype=new $t;G.prototype.constructor=G;G.prototype._jump=function(e,t,n,i){var s=this.grid,o=e-n,a=t-i;if(!s.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(s.getNodeAt(e,t).tested=!0),s.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0){if(s.isWalkableAt(e,t-1)&&!s.isWalkableAt(e-o,t-1)||s.isWalkableAt(e,t+1)&&!s.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0){if(s.isWalkableAt(e-1,t)&&!s.isWalkableAt(e-1,t-a)||s.isWalkableAt(e+1,t)&&!s.isWalkableAt(e+1,t-a))return[e,t];if(this._jump(e+1,t,e,t)||this._jump(e-1,t,e,t))return[e,t]}else throw new Error("Only horizontal and vertical movements are allowed");return this._jump(e+o,t+a,e,t)};G.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,i=e.y,s=this.grid,o,a,r,l,c=[],f,h,m,v;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-a)/Math.max(Math.abs(i-a),1),r!==0?(s.isWalkableAt(n,i-1)&&c.push([n,i-1]),s.isWalkableAt(n,i+1)&&c.push([n,i+1]),s.isWalkableAt(n+r,i)&&c.push([n+r,i])):l!==0&&(s.isWalkableAt(n-1,i)&&c.push([n-1,i]),s.isWalkableAt(n+1,i)&&c.push([n+1,i]),s.isWalkableAt(n,i+l)&&c.push([n,i+l]));else for(f=s.getNeighbors(e,En.Never),m=0,v=f.length;m<v;++m)h=f[m],c.push([h.x,h.y]);return c};var Bn=G,Dt=Ne,jn=_;function q(e){Dt.call(this,e)}q.prototype=new Dt;q.prototype.constructor=q;q.prototype._jump=function(e,t,n,i){var s=this.grid,o=e-n,a=t-i;if(!s.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(s.getNodeAt(e,t).tested=!0),s.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(s.isWalkableAt(e-o,t+a)&&!s.isWalkableAt(e-o,t)||s.isWalkableAt(e+o,t-a)&&!s.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(s.isWalkableAt(e+o,t+1)&&!s.isWalkableAt(e,t+1)||s.isWalkableAt(e+o,t-1)&&!s.isWalkableAt(e,t-1))return[e,t]}else if(s.isWalkableAt(e+1,t+a)&&!s.isWalkableAt(e+1,t)||s.isWalkableAt(e-1,t+a)&&!s.isWalkableAt(e-1,t))return[e,t];return this._jump(e+o,t+a,e,t)};q.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,i=e.y,s=this.grid,o,a,r,l,c=[],f,h,m,v;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-a)/Math.max(Math.abs(i-a),1),r!==0&&l!==0?(s.isWalkableAt(n,i+l)&&c.push([n,i+l]),s.isWalkableAt(n+r,i)&&c.push([n+r,i]),s.isWalkableAt(n+r,i+l)&&c.push([n+r,i+l]),s.isWalkableAt(n-r,i)||c.push([n-r,i+l]),s.isWalkableAt(n,i-l)||c.push([n+r,i-l])):r===0?(s.isWalkableAt(n,i+l)&&c.push([n,i+l]),s.isWalkableAt(n+1,i)||c.push([n+1,i+l]),s.isWalkableAt(n-1,i)||c.push([n-1,i+l])):(s.isWalkableAt(n+r,i)&&c.push([n+r,i]),s.isWalkableAt(n,i+1)||c.push([n+r,i+1]),s.isWalkableAt(n,i-1)||c.push([n+r,i-1]));else for(f=s.getNeighbors(e,jn.Always),m=0,v=f.length;m<v;++m)h=f[m],c.push([h.x,h.y]);return c};var Ln=q,_t=Ne,Rn=_;function V(e){_t.call(this,e)}V.prototype=new _t;V.prototype.constructor=V;V.prototype._jump=function(e,t,n,i){var s=this.grid,o=e-n,a=t-i;if(!s.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(s.getNodeAt(e,t).tested=!0),s.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(s.isWalkableAt(e,t-1)&&!s.isWalkableAt(e-o,t-1)||s.isWalkableAt(e,t+1)&&!s.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0&&(s.isWalkableAt(e-1,t)&&!s.isWalkableAt(e-1,t-a)||s.isWalkableAt(e+1,t)&&!s.isWalkableAt(e+1,t-a)))return[e,t];return s.isWalkableAt(e+o,t)&&s.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};V.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,i=e.y,s=this.grid,o,a,r,l,c=[],f,h,m,v;if(t)if(o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-a)/Math.max(Math.abs(i-a),1),r!==0&&l!==0)s.isWalkableAt(n,i+l)&&c.push([n,i+l]),s.isWalkableAt(n+r,i)&&c.push([n+r,i]),s.isWalkableAt(n,i+l)&&s.isWalkableAt(n+r,i)&&c.push([n+r,i+l]);else{var k;if(r!==0){k=s.isWalkableAt(n+r,i);var y=s.isWalkableAt(n,i+1),u=s.isWalkableAt(n,i-1);k&&(c.push([n+r,i]),y&&c.push([n+r,i+1]),u&&c.push([n+r,i-1])),y&&c.push([n,i+1]),u&&c.push([n,i-1])}else if(l!==0){k=s.isWalkableAt(n,i+l);var d=s.isWalkableAt(n+1,i),g=s.isWalkableAt(n-1,i);k&&(c.push([n,i+l]),d&&c.push([n+1,i+l]),g&&c.push([n-1,i+l])),d&&c.push([n+1,i]),g&&c.push([n-1,i])}}else for(f=s.getNeighbors(e,Rn.OnlyWhenNoObstacles),m=0,v=f.length;m<v;++m)h=f[m],c.push([h.x,h.y]);return c};var Jn=V,Et=Ne,Hn=_;function z(e){Et.call(this,e)}z.prototype=new Et;z.prototype.constructor=z;z.prototype._jump=function(e,t,n,i){var s=this.grid,o=e-n,a=t-i;if(!s.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(s.getNodeAt(e,t).tested=!0),s.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(s.isWalkableAt(e-o,t+a)&&!s.isWalkableAt(e-o,t)||s.isWalkableAt(e+o,t-a)&&!s.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(s.isWalkableAt(e+o,t+1)&&!s.isWalkableAt(e,t+1)||s.isWalkableAt(e+o,t-1)&&!s.isWalkableAt(e,t-1))return[e,t]}else if(s.isWalkableAt(e+1,t+a)&&!s.isWalkableAt(e+1,t)||s.isWalkableAt(e-1,t+a)&&!s.isWalkableAt(e-1,t))return[e,t];return s.isWalkableAt(e+o,t)||s.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};z.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,i=e.y,s=this.grid,o,a,r,l,c=[],f,h,m,v;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-a)/Math.max(Math.abs(i-a),1),r!==0&&l!==0?(s.isWalkableAt(n,i+l)&&c.push([n,i+l]),s.isWalkableAt(n+r,i)&&c.push([n+r,i]),(s.isWalkableAt(n,i+l)||s.isWalkableAt(n+r,i))&&c.push([n+r,i+l]),!s.isWalkableAt(n-r,i)&&s.isWalkableAt(n,i+l)&&c.push([n-r,i+l]),!s.isWalkableAt(n,i-l)&&s.isWalkableAt(n+r,i)&&c.push([n+r,i-l])):r===0?s.isWalkableAt(n,i+l)&&(c.push([n,i+l]),s.isWalkableAt(n+1,i)||c.push([n+1,i+l]),s.isWalkableAt(n-1,i)||c.push([n-1,i+l])):s.isWalkableAt(n+r,i)&&(c.push([n+r,i]),s.isWalkableAt(n,i+1)||c.push([n+r,i+1]),s.isWalkableAt(n,i-1)||c.push([n+r,i-1]));else for(f=s.getNeighbors(e,Hn.IfAtMostOneObstacle),m=0,v=f.length;m<v;++m)h=f[m],c.push([h.x,h.y]);return c};var Un=z,Fe=_,Gn=Bn,qn=Ln,Vn=Jn,zn=Un;function Yn(e){return e=e||{},e.diagonalMovement===Fe.Never?new Gn(e):e.diagonalMovement===Fe.Always?new qn(e):e.diagonalMovement===Fe.OnlyWhenNoObstacles?new Vn(e):new zn(e)}var Kn=Yn,Qn={Heap:ie.exports,Node:He,Grid:wn,Util:$,DiagonalMovement:_,Heuristic:se,AStarFinder:Ge,BestFirstFinder:Tn,BreadthFirstFinder:Sn,DijkstraFinder:In,BiAStarFinder:qe,BiBestFirstFinder:Pn,BiBreadthFirstFinder:Fn,BiDijkstraFinder:$n,IDAStarFinder:Dn,JumpPointFinder:Kn};(function(e){e.exports=Qn})(Mt);const ze=un(Mt.exports),ce=e=>Math.floor(Math.random()*I[e].length),Xn=({xTiles:e,yTiles:t})=>{const n={tiles:[],pathGrid:new ze.Grid(e,t),xTiles:e,yTiles:t};for(let i=0;i<e;i++){n.tiles[i]=[];for(let s=0;s<t;s++)n.tiles[i][s]={}}for(let i=0;i<e;i++)for(let s=0;s<t;s++)Bt({x:i,y:s},n,"grass");return n},Bt=(e,t,n,i,s=null)=>{const{floor:o,feature:a,walkable:r,type:l}=U[n],{x:c,y:f}=e,h=t.tiles[c][f];switch(l){case"void":h.floor=null,h.feature=null;break;case"obstacle":case"floor":h.floor={set:o,variant:s||ce(o),color:(i==null?void 0:i[l])||0},h.feature=null;break;case"linked":const m=s||ce(o);h.floor={set:o,variant:m,color:(i==null?void 0:i.floor)||0},h.feature={set:a,variant:m,color:(i==null?void 0:i.feature)||0};break;case"feature":h.feature={set:a,variant:s||ce(a),color:(i==null?void 0:i.feature)||0},(h.type==="void"||h.type==="linked"||h.type==="obstacle")&&(h.floor={set:o,variant:ce(o),color:i==null?void 0:i.feature});break}h.type=l,t.pathGrid.setWalkableAt(c,f,r),h.walkable=r},Zn=(e,t)=>{if(e!=="pathGrid")return t},ei=()=>{const{tileMap:e,entities:t}=p;return e.entityList=[],t.forEach(n=>{const{constructor:{name:i},tileIndex:s}=n;i==="unit"?e.unitStart=s:e.entityList.push({name:i,tileIndex:s})}),"data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e,Zn))},ti=async e=>{const t=JSON.stringify(await yn(Object.assign({"../../maps/riddle.json":()=>gn(()=>import("./riddle.da2252d8.js"),[])}),`../../maps/${e}.json`));return jt(t)},jt=e=>{const t=JSON.parse(e);t.pathGrid=new ze.Grid(t.xTiles,t.yTiles);for(let n=0;n<t.xTiles;n++)for(let i=0;i<t.yTiles;i++){const s=t.tiles[n][i].walkable;t.pathGrid.setWalkableAt(n,i,s)}return t};let ve={};const ni=e=>{if(e.x!==ve.x||e.y!==ve.y){const{tileMap:t}=p,n=ki(),{set:i,colors:s,variant:o,type:a}=n,r=p.entityMap.entities[e.x][e.y];Object.keys(r).length!==0&&a!=="floor"||(Bt(e,t,i,s,o),Vi(e))}ve=e},ii=()=>{ve={}},D=64,S=32,ue=32,si=32,ct=128,oi="rgba(255,255,255,0.1)",me="rgba(255,255,0,0.6)",ai="yellow",ri="rgba(255,0,0,0.2)",li="yellow",ut=.8,dt=.12,ci=.18,di=.08,Lt=D/2,Rt=S/2,fi=S/D,hi=6.28319,je=20,pi=({x:e,y:t,strokeColor:n,fillColor:i})=>{const{ctxTop:s}=p,o=L({x:e,y:t});s.strokeStyle=n,s.fillStyle=i,s.beginPath(),s.moveTo(o.x,o.y+S/2),s.lineTo(o.x+D/2,o.y),s.lineTo(o.x+D,o.y+S/2),s.lineTo(o.x+D/2,o.y+S),s.closePath(),s.fill(),s.stroke()},U={mountain:{displayName:"Mountains",walkable:!1,floor:"mountain",feature:"mountainTop",type:"linked"},forest:{displayName:"Forest",walkable:!0,floor:"forest",feature:"forestTop",type:"linked"},terracotta:{displayName:"Terracotta Floor",walkable:!0,floor:"terracotta",type:"floor"},grass:{displayName:"Grass",walkable:!0,floor:"grass",type:"floor"},cube:{displayName:"Cube",walkable:!1,feature:"cube",floor:"terracotta",type:"feature"},water:{displayName:"Water",walkable:!1,floor:"water",type:"obstacle"},void:{displayName:"Void",walkable:!1,type:"void"}},Jt=({x:e,y:t,image:n})=>{const{floorCtx:i}=p,s=L({x:e,y:t});i.drawImage(n.data,s.x,s.y-n.yOffset)},ft=(e,t)=>{const{tileMap:n}=p,i=n.tiles[e][t];if(i.floor){const{set:s,color:o,variant:a}=i.floor;Jt({x:e,y:t,image:Je(s,o,a)})}},Ht=({x:e,y:t})=>{const{origin:n}=p.view;return{x:Math.floor((e-n.x)/D-(t-n.y-S/2)/S),y:Math.floor((t-n.y-S/2)/S+(e-n.x)/D)}},L=({x:e,y:t})=>{const{origin:n}=p.view;return{x:e*D/2+t*D/2+n.x,y:t*S/2-e*S/2+n.y}},Ut=e=>{const{tileMap:t}=p,{x:n,y:i}=Ht(e);return t.tiles[n]&&t.tiles[n][i]?{x:n,y:i}:null},Z=(e,t)=>{const{x:n,y:i}=e;pi({x:n,y:i,strokeColor:t,fillColor:oi})},gi=5,yi=6,Ae=2,ht=4,Gt={},qt={};let[E]=Object.keys(U),ee=U[E].type,te,J=[];const Vt=e=>{E=(e==null?void 0:e.target.value)||E,ee=U[E].type,te=I[E],spriteDisplay.replaceWith(zt()),ee!=="void"&&Yt()},zt=()=>{switch(ee){case"void":return w.h("div",{id:"spriteDisplay",class:"spriteDisplay--void"},w.h("div",{class:"brush"},w.h("div",{class:"void-brush"},"X"),w.h("span",null,"Delete tiles")));case"linked":const{floor:e,feature:t}=U[E];J={floor:e,feature:t};break;default:J={[ee]:E};break}return w.h("div",{id:"spriteDisplay"},w.h(wi,null))},vi=()=>qt[E]={width:Math.max(...te.map(e=>e.data.width))+gi,height:Math.max(...te.map(e=>e.data.height))+yi},Yt=()=>{const e=tilePainter.elements;Object.keys(J).forEach(t=>{const n=J[t],i=e[`${t}Hue`],s=document.getElementById(`${t}HueRotaion`),o=i.value;s.innerText=Gt[n]=o,I[n].forEach((a,r)=>{const c=document.getElementById(`tileCanv${r}`).getContext("2d");c.filter=`hue-rotate(${o}deg)`;const f=I[n][r].data;c.drawImage(f,ht,ht)})})},mi=e=>{const{tileSet:t,tiles:n,label:i,type:s}=e;return w.h("div",null,w.h("div",null,w.h("label",{for:`${s}Hue`},i,": "),w.h("span",{id:`${s}HueRotaion`},"0")),w.h("input",{id:`${s}Hue`,class:"hue-slider",type:"range",min:"-180",max:"180",step:"1","tile-type":s,value:Gt[t]||0,onInput:()=>{Yt()}}))},bi=e=>{const{width:t,height:n,index:i}=e;return w.h("div",{class:"brush"},w.h("canvas",{id:`tileCanv${i}`,width:t+Ae,height:n+Ae}),w.h("input",{type:"radio",value:i,name:"tileVariant",style:{width:`${t}px`,height:`${n}px`}}))},wi=()=>{const{width:e,height:t}=qt[E]||vi(),n=Object.keys(J);return w.h("div",null,w.h("div",{class:"sprite-brushes"},w.h("div",{class:"brush"},w.h("div",{class:"random-tile-brush",style:{width:`${e+Ae}px`,height:`${t+Ae}px`}},w.h("div",null,"?")),w.h("input",{checked:!0,type:"radio",value:"random",name:"tileVariant",style:{width:`${e}px`,height:`${t}px`}})),te.map((i,s)=>w.h(bi,{width:e,height:t,index:s}))),n.map(i=>w.h(mi,{tileSet:J[i],label:n.length>1?i+" Hue":"Hue",tiles:J,type:i})))},Mi=()=>(te=I[E],w.h("form",{id:"tilePainter"},w.h("select",{id:"terrainType",name:"terrainType",onChange:Vt},Object.keys(U).map(e=>w.h("option",{selected:E===e,value:e},U[e].displayName))),w.h(zt,null))),ki=()=>{var s;const e=tilePainter.elements,t={};Object.keys(J).forEach(o=>{const a=e[`${o}Hue`];t[o]=(a==null?void 0:a.value)||null});let n=null;const i=(s=e.tileVariant)==null?void 0:s.value;return i!=="random"&&(n=i||null),{set:terrainType.value,type:ee,variant:n,colors:t}},xi=()=>w.h("div",{id:"ui"},p.mode==="editMode"?w.h(Mi,null):null),Ai=()=>{ui.replaceWith(xi())},ne={},Kt={keyDown:()=>{}};document.addEventListener("keydown",e=>{const{keyDown:t}=Kt;ne[e.code]=!0,t(e.code,e)});document.addEventListener("keyup",e=>{ne[e.code]=!1});const Oi=()=>{Object.keys(ne).forEach(e=>{ne[e]=!1})},Q=function(e){return ne[e]||!1},Ci=new ze.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0}),Ye=(e,t)=>{const{pathGrid:n}=p.tileMap,i=n.clone();return Ci.findPath(e.x,e.y,t.x,t.y,i)},Ke={},de=()=>{};Ke.set=()=>{const{hoveredTile:e,mouse:t,player:n,canvasTop:i}=p;Vt(),t.onMouseMove=()=>{t.buttonCode===1&&Ze(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&n.requestMove(e.tileIndex),ii()},p.onFrameControls=s=>{on(s),e.tileIndex=Ut({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?i.style.cursor="grabbing":i.style.cursor="pointer",e.path=Ye(n.tileIndex,e.tileIndex),t.buttonCode===3&&ni(e.tileIndex)):i.style.cursor="default"},p.effectsMiddle=()=>{e.tileIndex&&e.path.forEach(s=>{Z({x:s[0],y:s[1]},ai)})},p.effectsTop=()=>{e.tileIndex&&(e.path.forEach(s=>{Z({x:s[0],y:s[1]},ri)}),Z(e.tileIndex,me))}};Ke.unset=()=>{const{mouse:e,player:t}=p;t.unsetPath(),e.onMouseMove=de,e.onMouseUp=de,p.effectsMiddle=de,p.effectsTop=de};const Oe=(e,t,n,i)=>{const s=e.x+Lt,o=e.y+Rt;i.strokeStyle=t,i.beginPath(),i.ellipse(s,o,n,n*fi,0,0,hi),i.stroke()},$e=16,pt=.86,Ni="lime",Ti="rgba(150, 150, 150, 0.8)",fe=(e,t,n,i)=>{const s=e.length;e.forEach((o,a)=>{const[r,l]=o,c=L({x:r,y:l});if(Oe(c,t,$e,i),n&&a===s-1){const f=c.x+Lt,h=c.y+Rt;i.beginPath(),i.moveTo(f,h),i.lineTo(f-$e/3,h-S*pt*1.5),i.lineTo(f,h-S*1.5),i.lineTo(f+$e/3,h-S*pt*1.5),i.closePath(),i.fillStyle=Ti,i.strokeStyle=Ni,i.fill(),i.stroke()}})},Qe={},he=()=>{};Qe.set=()=>{const{hoveredTile:e,mouse:t,player:n,ctxMid:i,ctxTop:s,canvasTop:o}=p;t.onMouseMove=()=>{t.buttonCode===1&&Ze(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&(n.requestMove(e.tileIndex),e.path.length=0)},p.onFrameControls=a=>{var r,l;on(a),e.tileIndex=Ut({x:t.x,y:t.y}),e.tileIndex?(e.tileIndex.x!==((r=e.tileIndexPrevious)==null?void 0:r.x)||e.tileIndex.y!==((l=e.tileIndexPrevious)==null?void 0:l.y))&&(t.isDragged?o.style.cursor="grabbing":o.style.cursor="pointer",n.isMoving||(e.path=Ye(n.tileIndex,e.tileIndex)),e.tileIndexPrevious={x:e.tileIndex.x,y:e.tileIndex.y}):o.style.cursor="default"},p.effectsMiddle=()=>{n.isMoving?fe(n.path,"lime",!1,i):e.tileIndex&&fe(e.path,"lime",!1,i)},p.effectsTop=()=>{if(n.isMoving){if(fe(n.path,"rgba(50, 205, 50, 0.5)",!0,s),e.tileIndex)if(be(e.tileIndex)){const a=L(e.tileIndex);Oe(a,me,je,s)}else Z(e.tileIndex,me)}else if(e.tileIndex&&(fe(e.path,"rgba(50, 205, 50, 0.5)",!1,s),e.tileIndex))if(be(e.tileIndex)){const a=L(e.tileIndex);Oe(a,"lime",je,s)}else Z(e.tileIndex,me)}};Qe.unset=()=>{const{mouse:e,player:t}=p;t.unsetPath(),e.onMouseMove=he,e.onMouseUp=he,p.effectsMiddle=he,p.effectsTop=he};const Qt=()=>{const{paused:e,stop:t,restart:n}=F;e?(n(),document.body.classList.remove("paused")):(t(),document.body.classList.add("paused"))},Wi=()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():canvasRoot.requestFullscreen()};Kt.keyDown=e=>{switch(e){case"Space":Qt();break;case"Enter":Q("ControlLeft")&&Wi();break;default:return}};document.addEventListener("visibilitychange",()=>{const{stop:e}=F;document.visibilityState==="hidden"?(e(),document.body.classList.add("paused")):document.visibilityState==="visible"&&Oi()});const gt={editMode:Ke,playMode:Qe},Xt=e=>{gt[p.mode].unset(),p.mode=e,Ai(),gt[e].set()},Si=()=>w.h("div",null,w.h("div",{id:"pauseMenu"},w.h("div",{class:"pause-menu-items"},w.h("p",null,"Paused"),w.h("ul",null,w.h("li",null,w.h("button",{onclick:Qt},"Resume")),w.h("li",null,w.h("button",{id:"loadButton"},"Load")),w.h("li",null,w.h("button",{class:"save",id:"saveButton"},"Save"),w.h("input",{type:"text",id:"saveName",value:"tile-map"})))))),Ii=()=>w.h("div",{class:"toolbar"},w.h("form",{id:"mode",name:"mode",class:"margin-right-10"},w.h("input",{type:"radio",id:"playRadio",value:"playMode",class:"margin-right-10",name:"mode",checked:!0}),w.h("label",{for:"playRadio"},"Play Mode"),w.h("input",{type:"radio",id:"editModeRadio",value:"editMode",class:"margin-left-10 margin-right-10",name:"mode"}),w.h("label",{for:"editModeRadio"},"Edit Mode"))),Pi=()=>w.h("div",{class:"wrapper"},w.h(Ii,null),w.h("div",{id:"canvasRoot"},w.h("canvas",{class:"layer-canvas",id:"floorCanvas"}),w.h("canvas",{class:"layer-canvas",id:"canvasMid"}),w.h("canvas",{class:"layer-canvas",id:"entityCanvas"}),w.h("canvas",{class:"layer-canvas",id:"canvasTop"}),w.h("div",{id:"ui"}),w.h(Si,null))),Zt=({xTiles:e,yTiles:t})=>{const{canvasRoot:n,floorCtx:i,ctxMid:s,entityCtx:o,ctxTop:a,floorCanvas:r,canvasMid:l,entityCanvas:c,canvasTop:f}=p,h=(e+t)/2*S,m=(e+t)/2*D,v=h+si+ct;r.width=c.width=m,r.height=c.height=v;const k=h/2-S/4*(t-e)-S/2+ct,y={x:0,y:k},u={x:0,y:0},d=()=>{l.width=f.width=n.clientWidth,l.height=f.height=n.clientHeight,s.setTransform(1,0,0,1,u.x,u.y),s.imageSmoothingEnabled=!1,a.setTransform(1,0,0,1,u.x,u.y),a.imageSmoothingEnabled=!1,i.imageSmoothingEnabled=!1,o.imageSmoothingEnabled=!1};return onresize=()=>{d()},{origin:y,xTiles:e,yTiles:t,translate:u,setApertureSize:d}},Fi=e=>{const{ctxMid:t,ctxTop:n,view:i,effectsMiddle:s,effectsTop:o,entities:a,canvasMid:{width:r,height:l}}=p,{translate:c}=i;a.forEach(f=>{f.update(e)}),t.clearRect(-c.x,-c.y,r,l),s(),n.clearRect(-c.x,-c.y,r,l),o()},en=e=>{const{onFrameControls:t}=p;t&&(t(e),p.monitor(e)),Fi(e)},F={};let X=0,tn=0,nn;F.start=e=>{nn=e,tn=requestAnimationFrame(t=>{$i(t,e)}),F.paused=!1};F.restart=()=>{F.start(nn),F.paused=!1};F.stop=()=>{window.cancelAnimationFrame(tn),X=0,F.paused=!0};const $i=(e,t)=>{X||(X=e);const n=e-X;X=e,t(n),F.start(t)},Di=e=>{F.stop(),delete p.entites,delete p.tileMap,delete p.entityMap;const{xTiles:t,yTiles:n}=e;p.view=p.setView({xTiles:t,yTiles:n}),p.loadMap(e),F.start(en)},_i=()=>{saveButton.onclick=()=>{const e=ei(),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",saveName.value+".json"),saveButton.after(t),t.click(),t.remove()},loadButton.onclick=()=>{const e=document.createElement("input");e.type="file",loadButton.after(e),e.onchange=()=>{const t=new FileReader;t.onload=n=>{const i=jt(n.target.result);Di(i)},t.readAsText(e.files[0])},e.click(),e.remove()}};let Ei=0;const Bi=()=>Ei++,yt=(e,t)=>{const n=e+(Math.random()*t-t/2);return Math.floor(n)};class Xe{constructor({sprite:t,haloColor:n}){H(this,"afterAdd",()=>{});H(this,"addToScene",t=>{const{entityMap:n}=p,{id:i,render:s,redraw:o,afterAdd:a}=this;this.tileIndex=t,this.position=L(t),this.positionPrevious=this.position,this.redrawEntities=zi,n.addEntity({tileIndex:t,id:i,render:s}),p.entities.push(this),a(),o()});H(this,"render",()=>{const{entityCtx:t}=p,{sprite:n,position:i,haloColor:s}=this;Oe(i,s,je,t),t.drawImage(n.data,Math.round(i.x),Math.round(i.y-n.yOffset))});H(this,"redraw",()=>{const{tileIndex:t,position:n,positionPrevious:i}=this;this.redrawEntities(t,n,i),this.positionPrevious={x:n.x,y:n.y}});this.sprite=t||I.playerTokens.sheild,this.haloColor=n||li,this.id=Bi(),this.position={x:0,y:0}}update(){}}const sn=(e,t)=>{const{entityMap:n}=p,i={};let s=null,o,a,r;e.isMoving=!1;const l=m=>{if(e.isMoving){const{position:v,tileIndex:k,path:y}=e,u=t*m,d=u*Math.cos(s),g=u*Math.sin(s);v.x+=d,v.y+=g;const b=o.x-v.x,x=o.y-v.y,M=b>0!==a,A=x>0!==r;(M||A)&&(v.x=o.x,v.y=o.y,y.length>1?(y.shift(),f()):e.isMoving=!1),e.tileIndex=Ht({x:v.x+D/2,y:v.y+S/2}),(k.x!==i.x||k.y!==i.y)&&(n.removeEntity({tileIndex:i,id:e.id}),n.addEntity({tileIndex:k,id:e.id,render:e.render}),i.x=k.x,i.y=k.y)}},c=()=>{e.isMoving=!1,e.path.length=0},f=()=>{const[m]=e.path,[v,k]=m,y={x:v,y:k};if(be(y)){o=L(y);const u=o.x-e.position.x,d=o.y-e.position.y;a=u>0,r=d>0,s=Math.atan2(d,u)}else c()};return{move:l,requestMove:m=>{const v=Ye(e.tileIndex,m),k=m.x===e.tileIndex.x&&m.y===e.tileIndex.y;!e.isMoving&&!k&&v.length&&(i.x=e.tileIndex.x,i.y=e.tileIndex.y,e.path=v,e.path.shift(),f(),e.isMoving=!0)},unsetPath:c}};class ji extends Xe{constructor(){super({sprite:I.playerTokens.angel,haloColor:"lime"}),this.path=[];const t=sn(this,ci),n={editMode:t.move,playMode:t.move};this.update=i=>{n[p.mode](i),this.redraw()},this.requestMove=t.requestMove,this.unsetPath=t.unsetPath}}class Li extends Xe{constructor(n){super(n);H(this,"pickPath",()=>{const{pathFinder:n,tileIndex:i}=this,s={x:yt(i.x,10),y:yt(i.y,10)};be(s)&&n.requestMove(s)});H(this,"update",n=>{const{pathFinder:i,pickPath:s,redraw:o,isMoving:a}=this;p.mode!=="editMode"&&(a||s(),i.move(n)),o()});this.path=[],this.pathFinder=sn(this,di)}}const Ri=e=>{const t={};t.entities=[];const{xTiles:n,yTiles:i}=e;for(let s=0;s<n;s++){t.entities[s]=[];for(let o=0;o<i;o++)t.entities[s][o]={}}return t.addEntity=({tileIndex:s,id:o,render:a})=>{t.entities[s.x][s.y][o]=a,tt(s,!1)},t.entityCheck=({x:s,y:o})=>{const a=t.entities[s][o];return Object.keys(a).length===0},t.removeEntity=({tileIndex:s,id:o})=>{const{x:a,y:r}=s,l=t.entities[a][r];if(delete l[o],Object.keys(l).length===0){const f=e.tiles[a][r].walkable;tt(s,f)}},t},Ce=(e,t)=>{var o;const{tileMap:n,entityMap:i}=p,s=(o=n.tiles[e])==null?void 0:o[t];if(s){const{feature:a}=s,r=L({x:e,y:t}),l=i.entities[e][t];for(const c in l)l[c]();if(a){const{set:c,color:f,variant:h}=a,m=Je(c,f,h);p.entityCtx.drawImage(m.data,r.x,r.y-m.yOffset),p.entityCtx.globalAlpha=.5;for(const v in l)l[v]();p.entityCtx.globalAlpha=1}}},T={x:0,y:0,buttonCode:0,onMouseUp:null,onMouseMove:null,isDragged:!1,dragStart:{x:0,y:0},drag:{x:0,y:0}},Ji=e=>(e.addEventListener("contextmenu",t=>t.preventDefault()),e.onmousemove=t=>{const{translate:n}=p.view,{left:i,top:s}=t.target.getBoundingClientRect();T.x=t.clientX-i-n.x,T.y=t.clientY-s-n.y,T.buttonCode===1&&(T.isDragged=!0,T.drag.x=T.dragStart.x-T.x-n.x,T.drag.y=T.dragStart.y-T.y-n.y),T.onMouseMove&&T.onMouseMove()},e.onmousedown=t=>{t.preventDefault(),T.buttonCode=t.which,T.dragStart.x=T.x,T.dragStart.y=T.y,T.drag.x=0,T.drag.y=0},document.onmouseup=()=>{T.onMouseUp&&T.onMouseUp(),T.isDragged=!1,T.buttonCode=0},e.onmouseleave=()=>{T.isDragged=!1,T.buttonCode=0},T);let De=0,_e=0;const pe={x:0,y:0},on=e=>{const{ctxMid:t,ctxTop:n,floorCanvas:i,entityCanvas:s,view:{translate:o}}=p,a=Q("KeyW"),r=Q("KeyS"),l=Q("KeyD"),c=Q("KeyA");De+=dt*e*(l-c),_e+=dt*e*(r-a),o.x=Math.round(o.x-De),o.y=Math.round(o.y-_e),(o.x!==pe.x||o.y!==pe.y)&&(i.style.left=`${o.x}px`,i.style.top=`${o.y}px`,s.style.left=`${o.x}px`,s.style.top=`${o.y}px`,t.setTransform(1,0,0,1,o.x,o.y),n.setTransform(1,0,0,1,o.x,o.y),pe.x=o.x,pe.y=o.y),De*=ut,_e*=ut},Ze=(e,t)=>{const{view:{translate:n}}=p;n.x=e,n.y=t},Hi=()=>{const{view:e,floorCanvas:t,entityCanvas:n}=p,{xTiles:i,yTiles:s}=e;for(let o=i-1;o>-1;o--)for(let a=0;a<s;a++)ft(o,a),Ce(o,a);t.addEventListener("contextrestored",()=>{for(let o=i-1;o>-1;o--)for(let a=0;a<s;a++)ft(o,a)}),n.addEventListener("contextrestored",()=>{for(let o=i-1;o>-1;o--)for(let a=0;a<s;a++)Ce(o,a)})},Ee=150,ge=70,Ui=100,Gi=()=>{const e=document.createElement("canvas"),t=e.getContext("2d");return e.classList.add("monitor"),e.width=Ee,e.height=ge,canvasRoot.appendChild(e),t.strokeStyle="#ff0000",n=>{t.globalCompositeOperation="copy",t.drawImage(e,-1,0),t.globalCompositeOperation="source-over";const i=ge-n/Ui*ge;t.beginPath(),t.moveTo(Ee,ge),t.lineTo(Ee,i),t.stroke()}},p={};p.start=async e=>{const t=document.getElementById("root");p.canvasRoot=Pi(),t.replaceWith(p.canvasRoot),p.floorCanvas=document.getElementById("floorCanvas"),p.floorCtx=p.floorCanvas.getContext("2d",{alpha:!1}),p.canvasMid=document.getElementById("canvasMid"),p.ctxMid=p.canvasMid.getContext("2d"),p.entityCanvas=document.getElementById("entityCanvas"),p.entityCtx=p.entityCanvas.getContext("2d"),p.canvasTop=document.getElementById("canvasTop"),p.ctxTop=p.canvasTop.getContext("2d"),p.monitor=Gi(),p.effectsMiddle=()=>{},p.effectsTop=()=>{},p.mouse=Ji(p.canvasTop),p.view=Zt({xTiles:ue,yTiles:ue}),p.hoveredTile={path:null,tileIndex:null,tileIndexPrevious:null},p.mode="playMode",mode.onchange=()=>{const n=mode.elements.mode.value;Xt(n)},_i();try{const n=await ti(e);p.loadMap(n)}catch{const n=Xn({xTiles:ue,yTiles:ue});p.loadMap(n)}F.start(en)};p.loadMap=e=>{const{entityList:t,unitStart:n={x:1,y:1}}=e;p.tileMap=e,p.entityMap=Ri(e),p.entities=[],p.player=new ji,p.player.addToScene(n),t&&t.forEach(o=>{const{name:a,tileIndex:r}=o;switch(a){case"entity":new Xe({}).addToScene(r);break;case"npc":new Li({sprite:I.playerTokens.despoiler,haloColor:"red"}).addToScene(r);break}}),Xt(p.mode),p.view.setApertureSize(),Hi();const i=Math.round(p.canvasTop.width/2-p.player.position.x),s=Math.round(p.canvasTop.height/2-p.player.position.y);Ze(i,s)};p.setView=Zt;const Le=D,Re=S*3,qi=S*1.5,vt=(e,t)=>{const{x:n,y:i}=t;e.save(),e.beginPath(),e.rect(n,i,Le,Re),e.clip(),e.clearRect(n,i,Le,Re)},Vi=e=>{const{floorCtx:t,entityCtx:n,tileMap:i}=p,s=L({x:e.x,y:e.y});s.y-=qi,vt(t,s),vt(n,s),Ki.forEach(o=>{var l;const a=o.x+e.x,r=o.y+e.y;if((l=i.tiles[a])!=null&&l[r]){const c=i.tiles[a][r];if(c.floor){const{set:f,color:h,variant:m}=c.floor;Jt({x:a,y:r,image:Je(f,h,m)})}Ce(a,r)}}),n.restore(),t.restore()},zi=(e,t,n)=>{const{entityCtx:i}=p,s={x:Math.floor(Math.min(t.x,n.x)),y:Math.floor(Math.min(t.y,n.y)-S*2)},o=Math.ceil(Math.abs(t.x-n.x)+Le),a=Math.ceil(Math.abs(t.y-n.y)+Re),{x:r,y:l}=s;i.save(),i.beginPath(),i.rect(r,l,o,a),i.clip(),i.clearRect(r,l,o,a),Yi.forEach(c=>{const f=c.x+e.x,h=c.y+e.y;Ce(f,h)}),i.restore()},Yi=[{x:3,y:-3},{x:3,y:-2},{x:3,y:-1},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:2,y:0},{x:1,y:-3},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:0},{x:-2,y:1},{x:-3,y:1},{x:-2,y:2},{x:-1,y:3},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Ki=[{x:3,y:-3},{x:3,y:-2},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:1},{x:-2,y:2},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Qi=async()=>{await I.load(),p.start("riddle"),window.dump=()=>console.log(p)};Qi();
