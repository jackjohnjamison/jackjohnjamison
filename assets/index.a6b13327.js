(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=i(n);fetch(n.href,o)}})();const ge=({x:e,y:t})=>{const{tileMap:i}=f;return i.walkableTileMatrix?.[e]?.[t]===0},Ye=({x:e,y:t},i)=>{const{tileMap:s}=f;s.walkableTileMatrix[e][t]=i},ti="modulepreload",ii=function(e){return"/"+e},Ke={},ni=function(t,i,s){return!i||i.length===0?t():Promise.all(i.map(n=>{if(n=ii(n),n in Ke)return;Ke[n]=!0;const o=n.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${n}"]${a}`))return;const r=document.createElement("link");if(r.rel=o?"stylesheet":ti,o||(r.as="script",r.crossOrigin=""),r.href=n,document.head.appendChild(r),o)return new Promise((l,c)=>{r.addEventListener("load",l),r.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>t())},si=(e,t)=>{const i=e[t];return i?typeof i=="function"?i():Promise.resolve(i):new Promise((s,n)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(n.bind(null,new Error("Unknown variable dynamic import: "+t)))})},O=e=>new Promise(t=>{let i=new Image;i.onload=()=>t(i),i.src=e}),E={terracotta:[{yOffset:0,data:await O("../../images/terracotta1.png")},{yOffset:0,data:await O("../../images/terracotta2.png")},{yOffset:0,data:await O("../../images/terracotta3.png")},{yOffset:0,data:await O("../../images/terracotta4.png")}],cube:[{yOffset:33,data:await O("../../images/cube1.png")},{yOffset:33,data:await O("../../images/cube2.png")},{yOffset:33,data:await O("../../images/cube3.png")}],grass:[{yOffset:2,data:await O("../../images/grass1.png")},{yOffset:2,data:await O("../../images/grass2.png")},{yOffset:2,data:await O("../../images/grass3.png")},{yOffset:2,data:await O("../../images/grass4.png")}],water:[{yOffset:-3,data:await O("../../images/water1.png")},{yOffset:-3,data:await O("../../images/water2.png")}],mountain:[{yOffset:14,data:await O("../../images/mountain1.png")},{yOffset:12,data:await O("../../images/mountain2.png")},{yOffset:14,data:await O("../../images/mountain3.png")}],mountainTop:[{yOffset:14,data:await O("../../images/mountain1-top.png")},{yOffset:12,data:await O("../../images/mountain2-top.png")},{yOffset:14,data:await O("../../images/mountain3-top.png")}],forest:[{yOffset:15,data:await O("../../images/trees1.png")},{yOffset:15,data:await O("../../images/trees2.png")},{yOffset:15,data:await O("../../images/trees3.png")},{yOffset:15,data:await O("../../images/trees4.png")}],forestTop:[{yOffset:15,data:await O("../../images/trees1-top.png")},{yOffset:15,data:await O("../../images/trees2-top.png")},{yOffset:15,data:await O("../../images/trees3-top.png")},{yOffset:15,data:await O("../../images/trees4-top.png")}],playerTokens:{angel:{yOffset:51,data:await O("../../images/pt-angel.png")},despoiler:{yOffset:51,data:await O("../../images/pt-despoiler.png")},sheild:{yOffset:48,data:await O("../../images/pt-sheild.png")}}},fe=new OffscreenCanvas(0,0),Qe=fe.getContext("2d"),oi=(e,t)=>{const{data:i,data:{width:s,height:n},yOffset:o}=e;fe.width=s,fe.height=n;const a=i;return Qe.filter=`hue-rotate(${t}deg)`,Qe.drawImage(a,0,0),{data:fe,yOffset:o}},Be=(e,t,i)=>{const s=E[e][i];return oi(s,t)},ne=e=>Math.floor(Math.random()*E[e].length),ai=({xTiles:e,yTiles:t})=>{const i={tiles:[],walkableTileMatrix:[],xTiles:e,yTiles:t};for(let s=0;s<e;s++){i.tiles[s]=[],i.walkableTileMatrix[s]=[];for(let n=0;n<t;n++)i.tiles[s][n]={}}for(let s=0;s<e;s++)for(let n=0;n<t;n++)ft({x:s,y:n},i,"grass");return i},ft=(e,t,i,s,n=null)=>{const{floor:o,feature:a,walkable:r,type:l}=H[i],{x:c,y:p}=e,h=t.tiles[c][p];switch(l){case"void":h.floor=null,h.feature=null;break;case"obstacle":case"floor":h.floor={set:o,variant:n||ne(o),color:s?.[l]||0},h.feature=null;break;case"linked":const y=n||ne(o);h.floor={set:o,variant:y,color:s?.floor||0},h.feature={set:a,variant:y,color:s?.feature||0};break;case"feature":h.feature={set:a,variant:n||ne(a),color:s?.feature||0},(h.type==="void"||h.type==="linked"||h.type==="obstacle")&&(h.floor={set:o,variant:ne(o),color:s?.feature});break}h.type=l,h.walkable=r,t.walkableTileMatrix[c][p]=r},ri=()=>{const{tileMap:e,entities:t}=f;return e.entityList=[],t.forEach(i=>{const{constructor:{name:s},tileIndex:n}=i;s==="unit"?e.unitStart=n:e.entityList.push({name:s,tileIndex:n})}),"data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e))},li=async e=>{const t=JSON.stringify(await si(Object.assign({"../../maps/vista.json":()=>ni(()=>import("./vista.a258ec57.js"),[])}),`../../maps/${e}.json`));return ht(t)},ht=e=>JSON.parse(e);var Y=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ci(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var w={},pt={},j={};Object.defineProperty(j,"__esModule",{value:!0});j.isSvgTag=j.applyChildren=j.setElementStyle=void 0;function di(e,t){let i;const s=Object.keys(t);for(i of s)e.style[i]=t[i]}j.setElementStyle=di;function Xe(e,t){t instanceof HTMLElement?e.appendChild(t):typeof t=="string"||typeof t=="number"?e.appendChild(document.createTextNode(t.toString())):console.warn("Unknown type to append: ",t)}function gt(e,t){for(const i of t)if(!(!i&&i!==0))if(Array.isArray(i))for(const s of i)Array.isArray(s)?gt(e,s):Xe(e,s);else Xe(e,i)}j.applyChildren=gt;function fi(e){return["a","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","path","pattern","polygon","polyline","radialGradient","rect","script","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"].includes(e)}j.isSvgTag=fi;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.h=e.xlinkNS=void 0;const t=j;e.xlinkNS="http://www.w3.org/1999/xlink";function i(s,n,...o){if(typeof s=="function")return s(Object.assign(Object.assign({},n),{children:o}));const a=t.isSvgTag(s),r=a?document.createElementNS("http://www.w3.org/2000/svg",s):document.createElement(s);if(n){n.style&&typeof n.style!="string"&&(t.setElementStyle(r,n.style),delete n.style);for(const l of Object.keys(n)){const c=n[l];if(l.startsWith("on")){const p=l.replace(/Capture$/,""),h=l!==p,y=p.toLowerCase().substring(2);r.addEventListener(y,c,h)}else a&&l.startsWith("xlink:")?r.setAttributeNS(e.xlinkNS,l,c):c===!0?r.setAttribute(l,l):(c||c===0)&&r.setAttribute(l,c.toString())}}return t.applyChildren(r,o),r}e.h=i})(pt);var vt={};Object.defineProperty(vt,"__esModule",{value:!0});(function(e){var t=Y&&Y.__createBinding||(Object.create?function(s,n,o,a){a===void 0&&(a=o),Object.defineProperty(s,a,{enumerable:!0,get:function(){return n[o]}})}:function(s,n,o,a){a===void 0&&(a=o),s[a]=n[o]}),i=Y&&Y.__exportStar||function(s,n){for(var o in s)o!=="default"&&!Object.prototype.hasOwnProperty.call(n,o)&&t(n,s,o)};Object.defineProperty(e,"__esModule",{value:!0}),i(pt,e),i(vt,e)})(w);const hi=5,pi=6,ve=2,Ze=4,yt={},mt={};let[_]=Object.keys(H),Z=H[_].type,ye=E[_],L=[];const bt=e=>{_=e?.target.value||_,Z=H[_].type,ye=E[_],spriteDisplay.replaceWith(wt()),Z!=="void"&&Mt()},wt=()=>{switch(Z){case"void":return w.h("div",{id:"spriteDisplay",class:"spriteDisplay--void"},w.h("div",{class:"brush"},w.h("div",{class:"void-brush"},"X"),w.h("span",null,"Delete tiles")));case"linked":const{floor:e,feature:t}=H[_];L={floor:e,feature:t};break;default:L={[Z]:_};break}return w.h("div",{id:"spriteDisplay"},w.h(mi,null))},gi=()=>mt[_]={width:Math.max(...ye.map(e=>e.data.width))+hi,height:Math.max(...ye.map(e=>e.data.height))+pi},Mt=()=>{const e=tilePainter.elements;Object.keys(L).forEach(t=>{const i=L[t],s=e[`${t}Hue`],n=document.getElementById(`${t}HueRotaion`),o=s.value;n.innerText=yt[i]=o,E[i].forEach((a,r)=>{const c=document.getElementById(`tileCanv${r}`).getContext("2d");c.filter=`hue-rotate(${o}deg)`;const p=E[i][r].data;c.drawImage(p,Ze,Ze)})})},vi=e=>{const{tileSet:t,tiles:i,label:s,type:n}=e;return w.h("div",null,w.h("div",null,w.h("label",{for:`${n}Hue`},s,": "),w.h("span",{id:`${n}HueRotaion`},"0")),w.h("input",{id:`${n}Hue`,class:"hue-slider",type:"range",min:"-180",max:"180",step:"1","tile-type":n,value:yt[t]||0,onInput:()=>{Mt()}}))},yi=e=>{const{width:t,height:i,index:s}=e;return w.h("div",{class:"brush"},w.h("canvas",{id:`tileCanv${s}`,width:t+ve,height:i+ve}),w.h("input",{type:"radio",value:s,name:"tileVariant",style:{width:`${t}px`,height:`${i}px`}}))},mi=()=>{const{width:e,height:t}=mt[_]||gi(),i=Object.keys(L);return w.h("div",null,w.h("div",{class:"sprite-brushes"},w.h("div",{class:"brush"},w.h("div",{class:"random-tile-brush",style:{width:`${e+ve}px`,height:`${t+ve}px`}},w.h("div",null,"?")),w.h("input",{checked:!0,type:"radio",value:"random",name:"tileVariant",style:{width:`${e}px`,height:`${t}px`}})),ye.map((s,n)=>w.h(yi,{width:e,height:t,index:n}))),i.map(s=>w.h(vi,{tileSet:L[s],label:i.length>1?s+" Hue":"Hue",tiles:L,type:s})))},bi=()=>w.h("form",{id:"tilePainter"},w.h("select",{id:"terrainType",name:"terrainType",onChange:bt},Object.keys(H).map(e=>w.h("option",{selected:_===e,value:e},H[e].displayName))),w.h(wt,null)),wi=()=>{const e=tilePainter.elements,t={};Object.keys(L).forEach(n=>{const o=e[`${n}Hue`];t[n]=o?.value||null});let i=null;const s=e.tileVariant?.value;return s!=="random"&&(i=s||null),{set:terrainType.value,type:Z,variant:i,colors:t}};let he={};const Mi=e=>{if(e.x!==he.x||e.y!==he.y){const{tileMap:t}=f,i=wi(),{set:s,colors:n,variant:o,type:a}=i,r=f.entityMap.entities[e.x][e.y];Object.keys(r).length!==0&&a!=="floor"||(ft(e,t,s,n,o),En(e))}he=e},ki=()=>{he={}},I=64,S=32,se=32,Ai=32,et=128,xi="rgba(255,255,255,0.1)",pe="rgba(255,255,0,0.6)",Oi="yellow",Ci="rgba(255,0,0,0.2)",Ni="yellow",tt=.8,it=.12,Wi=.18,Si=.08,kt=I/2,At=S/2,Ti=S/I,Fi=6.28319,Pe=20,Di=({x:e,y:t,strokeColor:i,fillColor:s})=>{const{ctx:n}=f,o=$({x:e,y:t});n.strokeStyle=i,n.fillStyle=s,n.beginPath(),n.moveTo(o.x,o.y+S/2),n.lineTo(o.x+I/2,o.y),n.lineTo(o.x+I,o.y+S/2),n.lineTo(o.x+I/2,o.y+S),n.closePath(),n.fill(),n.stroke()},H={mountain:{displayName:"Mountains",walkable:1,floor:"mountain",feature:"mountainTop",type:"linked"},forest:{displayName:"Forest",walkable:0,floor:"forest",feature:"forestTop",type:"linked"},terracotta:{displayName:"Terracotta Floor",walkable:0,floor:"terracotta",type:"floor"},grass:{displayName:"Grass",walkable:0,floor:"grass",type:"floor"},cube:{displayName:"Cube",walkable:1,feature:"cube",floor:"terracotta",type:"feature"},water:{displayName:"Water",walkable:1,floor:"water",type:"obstacle"},void:{displayName:"Void",walkable:1,type:"void"}},xt=({x:e,y:t,image:i})=>{const{floorCtx:s}=f,n=$({x:e,y:t});s.drawImage(i.data,n.x,n.y-i.yOffset)},Ii=(e,t)=>{const{tileMap:i}=f,s=i.tiles[e][t];if(s.floor){const{set:n,color:o,variant:a}=s.floor;xt({x:e,y:t,image:Be(n,o,a)})}},Ot=({x:e,y:t})=>{const{origin:i}=f.view;return{x:Math.floor((e-i.x)/I-(t-i.y-S/2)/S),y:Math.floor((t-i.y-S/2)/S+(e-i.x)/I)}},$=({x:e,y:t})=>{const{origin:i}=f.view;return{x:e*I/2+t*I/2+i.x,y:t*S/2-e*S/2+i.y}},Ct=e=>{const{tileMap:t}=f,{x:i,y:s}=Ot(e);return t.tiles[i]&&t.tiles[i][s]?{x:i,y:s}:null},X=(e,t)=>{const{x:i,y:s}=e;Di({x:i,y:s,strokeColor:t,fillColor:xi})},Nt=({xTiles:e,yTiles:t})=>{const{ctx:i,canvas:s}=f,n=(e+t)/2*S,o=(e+t)/2*I,a=n+Ai+et;f.floorCanvas.width=f.entityCanvas.width=o,f.floorCanvas.height=f.entityCanvas.height=a;const r=n/2-S/4*(t-e)-S/2+et,l={x:0,y:r},c={x:0,y:0},p=()=>{s.width=canvasRoot.clientWidth,s.height=canvasRoot.clientHeight,i.setTransform(1,0,0,1,c.x,c.y)};return onresize=()=>{p(),_i()},{origin:l,xTiles:e,yTiles:t,translate:c,setApertureSize:p}},Pi=e=>{const{ctx:t,canvas:i,floorCanvas:s,entityCanvas:n,view:o,effectsMiddle:a,effectsTop:r}=f,{translate:l}=o;t.clearRect(-l.x,-l.y,i.width,i.height),t.drawImage(s,0,0),a(),f.entities.forEach(c=>{c.update(e)}),t.drawImage(n,0,0),r()},_i=()=>{const{ctx:e,canvas:t,floorCanvas:i,entityCanvas:s,view:n}=f,{translate:o}=n;e.clearRect(-o.x,-o.y,t.width,t.height),e.drawImage(i,0,0),e.drawImage(s,0,0)},Wt=e=>{const{onFrameControls:t}=f;t&&(t(e),f.monitor(e)),Pi(e)},T={};let K=0,St=0,Tt;T.start=e=>{Tt=e,St=requestAnimationFrame(t=>{Ei(t,e)}),T.paused=!1};T.restart=()=>{T.start(Tt),T.paused=!1};T.stop=()=>{window.cancelAnimationFrame(St),K=0,T.paused=!0};const Ei=(e,t)=>{K||(K=e);const i=e-K;K=e,t(i),T.start(t)},$i=e=>{T.stop(),delete f.entites,delete f.tileMap,delete f.entityMap;const{xTiles:t,yTiles:i}=e;f.view=f.setView({xTiles:t,yTiles:i}),f.loadMap(e),T.start(Wt)},Bi=()=>{saveButton.onclick=()=>{const e=ri(),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",saveName.value+".json"),saveButton.after(t),t.click(),t.remove()},loadButton.onclick=()=>{const e=document.createElement("input");e.type="file",loadButton.after(e),e.onchange=()=>{const t=new FileReader;t.onload=i=>{const s=ht(i.target.result);$i(s)},t.readAsText(e.files[0])},e.click(),e.remove()}};let ji=0;const Li=()=>ji++,nt=(e,t)=>{const i=e+(Math.random()*t-t/2);return Math.floor(i)},me=(e,t,i,s)=>{const n=e.x+kt,o=e.y+At;s.strokeStyle=t,s.beginPath(),s.ellipse(n,o,i,i*Ti,0,0,Fi),s.stroke()},Oe=16,st=.86,Ri="rgba(150, 150, 150, 0.8)",oe=(e,t,i,s)=>{const{ctx:n}=f,o=e.length;e.forEach((a,r)=>{const[l,c]=a,p=$({y:l,x:c});if(me(p,t,Oe,n),i&&r===o-1){const h=p.x+kt,y=p.y+At;n.beginPath(),n.moveTo(h,y),n.lineTo(h-Oe/3,y-S*st*1.5),n.lineTo(h,y-S*1.5),n.lineTo(h+Oe/3,y-S*st*1.5),n.closePath(),n.fillStyle=Ri,n.strokeStyle=s,n.fill(),n.stroke()}})};class je{constructor({sprite:t,haloColor:i}){this.sprite=t||E.playerTokens.sheild,this.haloColor=i||Ni,this.id=Li(),this.position={x:0,y:0}}addToScene=t=>{const{entityMap:i}=f,{id:s,render:n,redraw:o}=this;this.tileIndex=t,this.position=$(t),this.positionPrevious=this.position,this.redrawEntities=$n,i.addEntity({tileIndex:t,id:s,render:n}),f.entities.push(this),o()};render=()=>{const{entityCtx:t}=f,{sprite:i,position:s,haloColor:n}=this;me(s,n,Pe,t),t.drawImage(i.data,Math.round(s.x),Math.round(s.y-i.yOffset))};redraw=()=>{const{tileIndex:t,position:i,positionPrevious:s}=this;this.redrawEntities(t,i,s),this.positionPrevious={x:i.x,y:i.y}};update(){}}var Ft={exports:{}},te={exports:{}},Dt={exports:{}};(function(e){(function(){var t,i,s,n,o,a,r,l,c,p,h,y,m,k,v;s=Math.floor,p=Math.min,i=function(u,d){return u<d?-1:u>d?1:0},c=function(u,d,g,b,A){var M;if(g==null&&(g=0),A==null&&(A=i),g<0)throw new Error("lo must be non-negative");for(b==null&&(b=u.length);g<b;)M=s((g+b)/2),A(d,u[M])<0?b=M:g=M+1;return[].splice.apply(u,[g,g-g].concat(d)),d},a=function(u,d,g){return g==null&&(g=i),u.push(d),k(u,0,u.length-1,g)},o=function(u,d){var g,b;return d==null&&(d=i),g=u.pop(),u.length?(b=u[0],u[0]=g,v(u,0,d)):b=g,b},l=function(u,d,g){var b;return g==null&&(g=i),b=u[0],u[0]=d,v(u,0,g),b},r=function(u,d,g){var b;return g==null&&(g=i),u.length&&g(u[0],d)<0&&(b=[u[0],d],d=b[0],u[0]=b[1],v(u,0,g)),d},n=function(u,d){var g,b,A,M,x,N;for(d==null&&(d=i),M=function(){N=[];for(var W=0,D=s(u.length/2);0<=D?W<D:W>D;0<=D?W++:W--)N.push(W);return N}.apply(this).reverse(),x=[],b=0,A=M.length;b<A;b++)g=M[b],x.push(v(u,g,d));return x},m=function(u,d,g){var b;if(g==null&&(g=i),b=u.indexOf(d),b!==-1)return k(u,0,b,g),v(u,b,g)},h=function(u,d,g){var b,A,M,x,N;if(g==null&&(g=i),A=u.slice(0,d),!A.length)return A;for(n(A,g),N=u.slice(d),M=0,x=N.length;M<x;M++)b=N[M],r(A,b,g);return A.sort(g).reverse()},y=function(u,d,g){var b,A,M,x,N,W,D,R,xe;if(g==null&&(g=i),d*10<=u.length){if(M=u.slice(0,d).sort(g),!M.length)return M;for(A=M[M.length-1],D=u.slice(d),x=0,W=D.length;x<W;x++)b=D[x],g(b,A)<0&&(c(M,b,0,null,g),M.pop(),A=M[M.length-1]);return M}for(n(u,g),xe=[],N=0,R=p(d,u.length);0<=R?N<R:N>R;0<=R?++N:--N)xe.push(o(u,g));return xe},k=function(u,d,g,b){var A,M,x;for(b==null&&(b=i),A=u[g];g>d;){if(x=g-1>>1,M=u[x],b(A,M)<0){u[g]=M,g=x;continue}break}return u[g]=A},v=function(u,d,g){var b,A,M,x,N;for(g==null&&(g=i),A=u.length,N=d,M=u[d],b=2*d+1;b<A;)x=b+1,x<A&&!(g(u[b],u[x])<0)&&(b=x),u[d]=u[b],d=b,b=2*d+1;return u[d]=M,k(u,N,d,g)},t=function(){u.push=a,u.pop=o,u.replace=l,u.pushpop=r,u.heapify=n,u.updateItem=m,u.nlargest=h,u.nsmallest=y;function u(d){this.cmp=d??i,this.nodes=[]}return u.prototype.push=function(d){return a(this.nodes,d,this.cmp)},u.prototype.pop=function(){return o(this.nodes,this.cmp)},u.prototype.peek=function(){return this.nodes[0]},u.prototype.contains=function(d){return this.nodes.indexOf(d)!==-1},u.prototype.replace=function(d){return l(this.nodes,d,this.cmp)},u.prototype.pushpop=function(d){return r(this.nodes,d,this.cmp)},u.prototype.heapify=function(){return n(this.nodes,this.cmp)},u.prototype.updateItem=function(d){return m(this.nodes,d,this.cmp)},u.prototype.clear=function(){return this.nodes=[]},u.prototype.empty=function(){return this.nodes.length===0},u.prototype.size=function(){return this.nodes.length},u.prototype.clone=function(){var d;return d=new u,d.nodes=this.nodes.slice(0),d},u.prototype.toArray=function(){return this.nodes.slice(0)},u.prototype.insert=u.prototype.push,u.prototype.top=u.prototype.peek,u.prototype.front=u.prototype.peek,u.prototype.has=u.prototype.contains,u.prototype.copy=u.prototype.clone,u}(),e!==null&&e.exports?e.exports=t:window.Heap=t}).call(Y)})(Dt);(function(e){e.exports=Dt.exports})(te);function Ji(e,t,i){this.x=e,this.y=t,this.walkable=i===void 0?!0:i}var Le=Ji,Hi={Always:1,Never:2,IfAtMostOneObstacle:3,OnlyWhenNoObstacles:4},P=Hi,It=Le,ae=P;function B(e,t,i){var s;typeof e!="object"?s=e:(t=e.length,s=e[0].length,i=e),this.width=s,this.height=t,this.nodes=this._buildNodes(s,t,i)}B.prototype._buildNodes=function(e,t,i){var s,n,o=new Array(t);for(s=0;s<t;++s)for(o[s]=new Array(e),n=0;n<e;++n)o[s][n]=new It(n,s);if(i===void 0)return o;if(i.length!==t||i[0].length!==e)throw new Error("Matrix size does not fit");for(s=0;s<t;++s)for(n=0;n<e;++n)i[s][n]&&(o[s][n].walkable=!1);return o};B.prototype.getNodeAt=function(e,t){return this.nodes[t][e]};B.prototype.isWalkableAt=function(e,t){return this.isInside(e,t)&&this.nodes[t][e].walkable};B.prototype.isInside=function(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height};B.prototype.setWalkableAt=function(e,t,i){this.nodes[t][e].walkable=i};B.prototype.getNeighbors=function(e,t){var i=e.x,s=e.y,n=[],o=!1,a=!1,r=!1,l=!1,c=!1,p=!1,h=!1,y=!1,m=this.nodes;if(this.isWalkableAt(i,s-1)&&(n.push(m[s-1][i]),o=!0),this.isWalkableAt(i+1,s)&&(n.push(m[s][i+1]),r=!0),this.isWalkableAt(i,s+1)&&(n.push(m[s+1][i]),c=!0),this.isWalkableAt(i-1,s)&&(n.push(m[s][i-1]),h=!0),t===ae.Never)return n;if(t===ae.OnlyWhenNoObstacles)a=h&&o,l=o&&r,p=r&&c,y=c&&h;else if(t===ae.IfAtMostOneObstacle)a=h||o,l=o||r,p=r||c,y=c||h;else if(t===ae.Always)a=!0,l=!0,p=!0,y=!0;else throw new Error("Incorrect value of diagonalMovement");return a&&this.isWalkableAt(i-1,s-1)&&n.push(m[s-1][i-1]),l&&this.isWalkableAt(i+1,s-1)&&n.push(m[s-1][i+1]),p&&this.isWalkableAt(i+1,s+1)&&n.push(m[s+1][i+1]),y&&this.isWalkableAt(i-1,s+1)&&n.push(m[s+1][i-1]),n};B.prototype.clone=function(){var e,t,i=this.width,s=this.height,n=this.nodes,o=new B(i,s),a=new Array(s);for(e=0;e<s;++e)for(a[e]=new Array(i),t=0;t<i;++t)a[e][t]=new It(t,e,n[e][t].walkable);return o.nodes=a,o};var Ui=B,F={};function _e(e){for(var t=[[e.x,e.y]];e.parent;)e=e.parent,t.push([e.x,e.y]);return t.reverse()}F.backtrace=_e;function qi(e,t){var i=_e(e),s=_e(t);return i.concat(s.reverse())}F.biBacktrace=qi;function Vi(e){var t,i=0,s,n,o,a;for(t=1;t<e.length;++t)s=e[t-1],n=e[t],o=s[0]-n[0],a=s[1]-n[1],i+=Math.sqrt(o*o+a*a);return i}F.pathLength=Vi;function Re(e,t,i,s){var n=Math.abs,o=[],a,r,l,c,p,h;for(l=n(i-e),c=n(s-t),a=e<i?1:-1,r=t<s?1:-1,p=l-c;o.push([e,t]),!(e===i&&t===s);)h=2*p,h>-c&&(p=p-c,e=e+a),h<l&&(p=p+l,t=t+r);return o}F.interpolate=Re;function Gi(e){var t=[],i=e.length,s,n,o,a,r,l;if(i<2)return t;for(r=0;r<i-1;++r)for(s=e[r],n=e[r+1],o=Re(s[0],s[1],n[0],n[1]),a=o.length,l=0;l<a-1;++l)t.push(o[l]);return t.push(e[i-1]),t}F.expandPath=Gi;function zi(e,t){var i=t.length,s=t[0][0],n=t[0][1],o=t[i-1][0],a=t[i-1][1],r,l,c,p,h,y,m,k,v,u,d;for(r=s,l=n,h=[[r,l]],y=2;y<i;++y){for(k=t[y],c=k[0],p=k[1],v=Re(r,l,c,p),d=!1,m=1;m<v.length;++m)if(u=v[m],!e.isWalkableAt(u[0],u[1])){d=!0;break}d&&(lastValidCoord=t[y-1],h.push(lastValidCoord),r=lastValidCoord[0],l=lastValidCoord[1])}return h.push([o,a]),h}F.smoothenPath=zi;function Yi(e){if(e.length<3)return e;var t=[],i=e[0][0],s=e[0][1],n=e[1][0],o=e[1][1],a=n-i,r=o-s,l,c,p,h,y,m;for(y=Math.sqrt(a*a+r*r),a/=y,r/=y,t.push([i,s]),m=2;m<e.length;m++)l=n,c=o,p=a,h=r,n=e[m][0],o=e[m][1],a=n-l,r=o-c,y=Math.sqrt(a*a+r*r),a/=y,r/=y,(a!==p||r!==h)&&t.push([l,c]);return t.push([n,o]),t}F.compressPath=Yi;var ie={manhattan:function(e,t){return e+t},euclidean:function(e,t){return Math.sqrt(e*e+t*t)},octile:function(e,t){var i=Math.SQRT2-1;return e<t?i*e+t:i*t+e},chebyshev:function(e,t){return Math.max(e,t)}},Ki=te.exports,Qi=F,Ce=ie,re=P;function Pt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.heuristic=e.heuristic||Ce.manhattan,this.weight=e.weight||1,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=re.OnlyWhenNoObstacles:this.diagonalMovement=re.IfAtMostOneObstacle:this.diagonalMovement=re.Never),this.diagonalMovement===re.Never?this.heuristic=e.heuristic||Ce.manhattan:this.heuristic=e.heuristic||Ce.octile}Pt.prototype.findPath=function(e,t,i,s,n){var o=new Ki(function(M,x){return M.f-x.f}),a=n.getNodeAt(e,t),r=n.getNodeAt(i,s),l=this.heuristic,c=this.diagonalMovement,p=this.weight,h=Math.abs,y=Math.SQRT2,m,k,v,u,d,g,b,A;for(a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(m=o.pop(),m.closed=!0,m===r)return Qi.backtrace(r);for(k=n.getNeighbors(m,c),u=0,d=k.length;u<d;++u)v=k[u],!v.closed&&(g=v.x,b=v.y,A=m.g+(g-m.x===0||b-m.y===0?1:y),(!v.opened||A<v.g)&&(v.g=A,v.h=v.h||p*l(h(g-i),h(b-s)),v.f=v.g+v.h,v.parent=m,v.opened?o.updateItem(v):(o.push(v),v.opened=!0)))}return[]};var Je=Pt,_t=Je;function be(e){_t.call(this,e);var t=this.heuristic;this.heuristic=function(i,s){return t(i,s)*1e6}}be.prototype=new _t;be.prototype.constructor=be;var Xi=be,Zi=F,Ne=P;function Et(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Ne.OnlyWhenNoObstacles:this.diagonalMovement=Ne.IfAtMostOneObstacle:this.diagonalMovement=Ne.Never)}Et.prototype.findPath=function(e,t,i,s,n){var o=[],a=this.diagonalMovement,r=n.getNodeAt(e,t),l=n.getNodeAt(i,s),c,p,h,y,m;for(o.push(r),r.opened=!0;o.length;){if(h=o.shift(),h.closed=!0,h===l)return Zi.backtrace(l);for(c=n.getNeighbors(h,a),y=0,m=c.length;y<m;++y)p=c[y],!(p.closed||p.opened)&&(o.push(p),p.opened=!0,p.parent=h)}return[]};var en=Et,$t=Je;function we(e){$t.call(this,e),this.heuristic=function(t,i){return 0}}we.prototype=new $t;we.prototype.constructor=we;var tn=we,ot=te.exports,at=F,We=ie,le=P;function Bt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||We.manhattan,this.weight=e.weight||1,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=le.OnlyWhenNoObstacles:this.diagonalMovement=le.IfAtMostOneObstacle:this.diagonalMovement=le.Never),this.diagonalMovement===le.Never?this.heuristic=e.heuristic||We.manhattan:this.heuristic=e.heuristic||We.octile}Bt.prototype.findPath=function(e,t,i,s,n){var o=function(D,R){return D.f-R.f},a=new ot(o),r=new ot(o),l=n.getNodeAt(e,t),c=n.getNodeAt(i,s),p=this.heuristic,h=this.diagonalMovement,y=this.weight,m=Math.abs,k=Math.SQRT2,v,u,d,g,b,A,M,x,N=1,W=2;for(l.g=0,l.f=0,a.push(l),l.opened=N,c.g=0,c.f=0,r.push(c),c.opened=W;!a.empty()&&!r.empty();){for(v=a.pop(),v.closed=!0,u=n.getNeighbors(v,h),g=0,b=u.length;g<b;++g)if(d=u[g],!d.closed){if(d.opened===W)return at.biBacktrace(v,d);A=d.x,M=d.y,x=v.g+(A-v.x===0||M-v.y===0?1:k),(!d.opened||x<d.g)&&(d.g=x,d.h=d.h||y*p(m(A-i),m(M-s)),d.f=d.g+d.h,d.parent=v,d.opened?a.updateItem(d):(a.push(d),d.opened=N))}for(v=r.pop(),v.closed=!0,u=n.getNeighbors(v,h),g=0,b=u.length;g<b;++g)if(d=u[g],!d.closed){if(d.opened===N)return at.biBacktrace(d,v);A=d.x,M=d.y,x=v.g+(A-v.x===0||M-v.y===0?1:k),(!d.opened||x<d.g)&&(d.g=x,d.h=d.h||y*p(m(A-e),m(M-t)),d.f=d.g+d.h,d.parent=v,d.opened?r.updateItem(d):(r.push(d),d.opened=W))}}return[]};var He=Bt,jt=He;function Me(e){jt.call(this,e);var t=this.heuristic;this.heuristic=function(i,s){return t(i,s)*1e6}}Me.prototype=new jt;Me.prototype.constructor=Me;var nn=Me,rt=F,Se=P;function Lt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Se.OnlyWhenNoObstacles:this.diagonalMovement=Se.IfAtMostOneObstacle:this.diagonalMovement=Se.Never)}Lt.prototype.findPath=function(e,t,i,s,n){var o=n.getNodeAt(e,t),a=n.getNodeAt(i,s),r=[],l=[],c,p,h,y=this.diagonalMovement,m=0,k=1,v,u;for(r.push(o),o.opened=!0,o.by=m,l.push(a),a.opened=!0,a.by=k;r.length&&l.length;){for(h=r.shift(),h.closed=!0,c=n.getNeighbors(h,y),v=0,u=c.length;v<u;++v)if(p=c[v],!p.closed){if(p.opened){if(p.by===k)return rt.biBacktrace(h,p);continue}r.push(p),p.parent=h,p.opened=!0,p.by=m}for(h=l.shift(),h.closed=!0,c=n.getNeighbors(h,y),v=0,u=c.length;v<u;++v)if(p=c[v],!p.closed){if(p.opened){if(p.by===m)return rt.biBacktrace(p,h);continue}l.push(p),p.parent=h,p.opened=!0,p.by=k}}return[]};var sn=Lt,Rt=He;function ke(e){Rt.call(this,e),this.heuristic=function(t,i){return 0}}ke.prototype=new Rt;ke.prototype.constructor=ke;var on=ke,Te=ie,lt=Le,ce=P;function Jt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||Te.manhattan,this.weight=e.weight||1,this.trackRecursion=e.trackRecursion||!1,this.timeLimit=e.timeLimit||1/0,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=ce.OnlyWhenNoObstacles:this.diagonalMovement=ce.IfAtMostOneObstacle:this.diagonalMovement=ce.Never),this.diagonalMovement===ce.Never?this.heuristic=e.heuristic||Te.manhattan:this.heuristic=e.heuristic||Te.octile}Jt.prototype.findPath=function(e,t,i,s,n){var o=new Date().getTime(),a=function(v,u){return this.heuristic(Math.abs(u.x-v.x),Math.abs(u.y-v.y))}.bind(this),r=function(v,u){return v.x===u.x||v.y===u.y?1:Math.SQRT2},l=function(v,u,d,g,b){if(this.timeLimit>0&&new Date().getTime()-o>this.timeLimit*1e3)return 1/0;var A=u+a(v,p)*this.weight;if(A>d)return A;if(v==p)return g[b]=[v.x,v.y],v;var M,x,N,W,D=n.getNeighbors(v,this.diagonalMovement);for(N=0,M=1/0;W=D[N];++N){if(this.trackRecursion&&(W.retainCount=W.retainCount+1||1,W.tested!==!0&&(W.tested=!0)),x=l(W,u+r(v,W),d,g,b+1),x instanceof lt)return g[b]=[v.x,v.y],x;this.trackRecursion&&--W.retainCount===0&&(W.tested=!1),x<M&&(M=x)}return M}.bind(this),c=n.getNodeAt(e,t),p=n.getNodeAt(i,s),h=a(c,p),y,m,k;for(y=0;;++y){if(m=[],k=l(c,0,h,m,0),k===1/0)return[];if(k instanceof lt)return m;h=k}return[]};var an=Jt,rn=te.exports,ct=F,Ht=ie;function Ue(e){e=e||{},this.heuristic=e.heuristic||Ht.manhattan,this.trackJumpRecursion=e.trackJumpRecursion||!1}Ue.prototype.findPath=function(e,t,i,s,n){var o=this.openList=new rn(function(c,p){return c.f-p.f}),a=this.startNode=n.getNodeAt(e,t),r=this.endNode=n.getNodeAt(i,s),l;for(this.grid=n,a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(l=o.pop(),l.closed=!0,l===r)return ct.expandPath(ct.backtrace(r));this._identifySuccessors(l)}return[]};Ue.prototype._identifySuccessors=function(e){var t=this.grid,i=this.heuristic,s=this.openList,n=this.endNode.x,o=this.endNode.y,a,r,l,c,p,h=e.x,y=e.y,m,k,v,u,d,g=Math.abs;for(a=this._findNeighbors(e),c=0,p=a.length;c<p;++c)if(r=a[c],l=this._jump(r[0],r[1],h,y),l){if(m=l[0],k=l[1],d=t.getNodeAt(m,k),d.closed)continue;v=Ht.octile(g(m-h),g(k-y)),u=e.g+v,(!d.opened||u<d.g)&&(d.g=u,d.h=d.h||i(g(m-n),g(k-o)),d.f=d.g+d.h,d.parent=e,d.opened?s.updateItem(d):(s.push(d),d.opened=!0))}};var Ae=Ue,Ut=Ae,ln=P;function q(e){Ut.call(this,e)}q.prototype=new Ut;q.prototype.constructor=q;q.prototype._jump=function(e,t,i,s){var n=this.grid,o=e-i,a=t-s;if(!n.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(n.getNodeAt(e,t).tested=!0),n.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0){if(n.isWalkableAt(e,t-1)&&!n.isWalkableAt(e-o,t-1)||n.isWalkableAt(e,t+1)&&!n.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0){if(n.isWalkableAt(e-1,t)&&!n.isWalkableAt(e-1,t-a)||n.isWalkableAt(e+1,t)&&!n.isWalkableAt(e+1,t-a))return[e,t];if(this._jump(e+1,t,e,t)||this._jump(e-1,t,e,t))return[e,t]}else throw new Error("Only horizontal and vertical movements are allowed");return this._jump(e+o,t+a,e,t)};q.prototype._findNeighbors=function(e){var t=e.parent,i=e.x,s=e.y,n=this.grid,o,a,r,l,c=[],p,h,y,m;if(t)o=t.x,a=t.y,r=(i-o)/Math.max(Math.abs(i-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0?(n.isWalkableAt(i,s-1)&&c.push([i,s-1]),n.isWalkableAt(i,s+1)&&c.push([i,s+1]),n.isWalkableAt(i+r,s)&&c.push([i+r,s])):l!==0&&(n.isWalkableAt(i-1,s)&&c.push([i-1,s]),n.isWalkableAt(i+1,s)&&c.push([i+1,s]),n.isWalkableAt(i,s+l)&&c.push([i,s+l]));else for(p=n.getNeighbors(e,ln.Never),y=0,m=p.length;y<m;++y)h=p[y],c.push([h.x,h.y]);return c};var cn=q,qt=Ae,un=P;function V(e){qt.call(this,e)}V.prototype=new qt;V.prototype.constructor=V;V.prototype._jump=function(e,t,i,s){var n=this.grid,o=e-i,a=t-s;if(!n.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(n.getNodeAt(e,t).tested=!0),n.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(n.isWalkableAt(e-o,t+a)&&!n.isWalkableAt(e-o,t)||n.isWalkableAt(e+o,t-a)&&!n.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(n.isWalkableAt(e+o,t+1)&&!n.isWalkableAt(e,t+1)||n.isWalkableAt(e+o,t-1)&&!n.isWalkableAt(e,t-1))return[e,t]}else if(n.isWalkableAt(e+1,t+a)&&!n.isWalkableAt(e+1,t)||n.isWalkableAt(e-1,t+a)&&!n.isWalkableAt(e-1,t))return[e,t];return this._jump(e+o,t+a,e,t)};V.prototype._findNeighbors=function(e){var t=e.parent,i=e.x,s=e.y,n=this.grid,o,a,r,l,c=[],p,h,y,m;if(t)o=t.x,a=t.y,r=(i-o)/Math.max(Math.abs(i-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0?(n.isWalkableAt(i,s+l)&&c.push([i,s+l]),n.isWalkableAt(i+r,s)&&c.push([i+r,s]),n.isWalkableAt(i+r,s+l)&&c.push([i+r,s+l]),n.isWalkableAt(i-r,s)||c.push([i-r,s+l]),n.isWalkableAt(i,s-l)||c.push([i+r,s-l])):r===0?(n.isWalkableAt(i,s+l)&&c.push([i,s+l]),n.isWalkableAt(i+1,s)||c.push([i+1,s+l]),n.isWalkableAt(i-1,s)||c.push([i-1,s+l])):(n.isWalkableAt(i+r,s)&&c.push([i+r,s]),n.isWalkableAt(i,s+1)||c.push([i+r,s+1]),n.isWalkableAt(i,s-1)||c.push([i+r,s-1]));else for(p=n.getNeighbors(e,un.Always),y=0,m=p.length;y<m;++y)h=p[y],c.push([h.x,h.y]);return c};var dn=V,Vt=Ae,fn=P;function G(e){Vt.call(this,e)}G.prototype=new Vt;G.prototype.constructor=G;G.prototype._jump=function(e,t,i,s){var n=this.grid,o=e-i,a=t-s;if(!n.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(n.getNodeAt(e,t).tested=!0),n.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(n.isWalkableAt(e,t-1)&&!n.isWalkableAt(e-o,t-1)||n.isWalkableAt(e,t+1)&&!n.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0&&(n.isWalkableAt(e-1,t)&&!n.isWalkableAt(e-1,t-a)||n.isWalkableAt(e+1,t)&&!n.isWalkableAt(e+1,t-a)))return[e,t];return n.isWalkableAt(e+o,t)&&n.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};G.prototype._findNeighbors=function(e){var t=e.parent,i=e.x,s=e.y,n=this.grid,o,a,r,l,c=[],p,h,y,m;if(t)if(o=t.x,a=t.y,r=(i-o)/Math.max(Math.abs(i-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0)n.isWalkableAt(i,s+l)&&c.push([i,s+l]),n.isWalkableAt(i+r,s)&&c.push([i+r,s]),n.isWalkableAt(i,s+l)&&n.isWalkableAt(i+r,s)&&c.push([i+r,s+l]);else{var k;if(r!==0){k=n.isWalkableAt(i+r,s);var v=n.isWalkableAt(i,s+1),u=n.isWalkableAt(i,s-1);k&&(c.push([i+r,s]),v&&c.push([i+r,s+1]),u&&c.push([i+r,s-1])),v&&c.push([i,s+1]),u&&c.push([i,s-1])}else if(l!==0){k=n.isWalkableAt(i,s+l);var d=n.isWalkableAt(i+1,s),g=n.isWalkableAt(i-1,s);k&&(c.push([i,s+l]),d&&c.push([i+1,s+l]),g&&c.push([i-1,s+l])),d&&c.push([i+1,s]),g&&c.push([i-1,s])}}else for(p=n.getNeighbors(e,fn.OnlyWhenNoObstacles),y=0,m=p.length;y<m;++y)h=p[y],c.push([h.x,h.y]);return c};var hn=G,Gt=Ae,pn=P;function z(e){Gt.call(this,e)}z.prototype=new Gt;z.prototype.constructor=z;z.prototype._jump=function(e,t,i,s){var n=this.grid,o=e-i,a=t-s;if(!n.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(n.getNodeAt(e,t).tested=!0),n.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(n.isWalkableAt(e-o,t+a)&&!n.isWalkableAt(e-o,t)||n.isWalkableAt(e+o,t-a)&&!n.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(n.isWalkableAt(e+o,t+1)&&!n.isWalkableAt(e,t+1)||n.isWalkableAt(e+o,t-1)&&!n.isWalkableAt(e,t-1))return[e,t]}else if(n.isWalkableAt(e+1,t+a)&&!n.isWalkableAt(e+1,t)||n.isWalkableAt(e-1,t+a)&&!n.isWalkableAt(e-1,t))return[e,t];return n.isWalkableAt(e+o,t)||n.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};z.prototype._findNeighbors=function(e){var t=e.parent,i=e.x,s=e.y,n=this.grid,o,a,r,l,c=[],p,h,y,m;if(t)o=t.x,a=t.y,r=(i-o)/Math.max(Math.abs(i-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0?(n.isWalkableAt(i,s+l)&&c.push([i,s+l]),n.isWalkableAt(i+r,s)&&c.push([i+r,s]),(n.isWalkableAt(i,s+l)||n.isWalkableAt(i+r,s))&&c.push([i+r,s+l]),!n.isWalkableAt(i-r,s)&&n.isWalkableAt(i,s+l)&&c.push([i-r,s+l]),!n.isWalkableAt(i,s-l)&&n.isWalkableAt(i+r,s)&&c.push([i+r,s-l])):r===0?n.isWalkableAt(i,s+l)&&(c.push([i,s+l]),n.isWalkableAt(i+1,s)||c.push([i+1,s+l]),n.isWalkableAt(i-1,s)||c.push([i-1,s+l])):n.isWalkableAt(i+r,s)&&(c.push([i+r,s]),n.isWalkableAt(i,s+1)||c.push([i+r,s+1]),n.isWalkableAt(i,s-1)||c.push([i+r,s-1]));else for(p=n.getNeighbors(e,pn.IfAtMostOneObstacle),y=0,m=p.length;y<m;++y)h=p[y],c.push([h.x,h.y]);return c};var gn=z,Fe=P,vn=cn,yn=dn,mn=hn,bn=gn;function wn(e){return e=e||{},e.diagonalMovement===Fe.Never?new vn(e):e.diagonalMovement===Fe.Always?new yn(e):e.diagonalMovement===Fe.OnlyWhenNoObstacles?new mn(e):new bn(e)}var Mn=wn,kn={Heap:te.exports,Node:Le,Grid:Ui,Util:F,DiagonalMovement:P,Heuristic:ie,AStarFinder:Je,BestFirstFinder:Xi,BreadthFirstFinder:en,DijkstraFinder:tn,BiAStarFinder:He,BiBestFirstFinder:nn,BiBreadthFirstFinder:sn,BiDijkstraFinder:on,IDAStarFinder:an,JumpPointFinder:Mn};(function(e){e.exports=kn})(Ft);const zt=ci(Ft.exports),An=new zt.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0}),qe=(e,t)=>{const{walkableTileMatrix:i}=f.tileMap,s=new zt.Grid(i);return An.findPath(e.y,e.x,t.y,t.x,s)},Yt=(e,t)=>{const{entityMap:i}=f;let s=null,n,o,a;e.isMoving=!1;const r=h=>{if(e.isMoving){const y=t*h,m=y*Math.cos(s),k=y*Math.sin(s);e.position.x+=m,e.position.y+=k;const v=n.x-e.position.x,u=n.y-e.position.y,d=v>0!==o,g=u>0!==a;(d||g)&&(e.position.x=n.x,e.position.y=n.y,e.path.length>1?(e.path.shift(),c()):e.isMoving=!1),i.removeEntity({tileIndex:e.tileIndex,id:e.id}),e.tileIndex=Ot({x:e.position.x+I/2,y:e.position.y+S/2}),i.addEntity({tileIndex:e.tileIndex,id:e.id,render:e.render})}},l=()=>{e.isMoving=!1,e.path=[]},c=()=>{const[h]=e.path,[y,m]=h,k={x:m,y};if(ge(k)){n=$(k);const v=n.x-e.position.x,u=n.y-e.position.y;o=v>0,a=u>0,s=Math.atan2(u,v)}else l()};return{move:r,requestMove:h=>{const y=qe(e.tileIndex,h),m=h.x===e.tileIndex.x&&h.y===e.tileIndex.y;!e.isMoving&&!m&&y.length&&(e.path=y,e.path.shift(),c(),e.isMoving=!0)},unsetPath:l}};class xn extends je{constructor(){super({sprite:E.playerTokens.angel,haloColor:"lime"}),this.path=[];const t=Yt(this,Wi),i={editMode:t.move,playMode:t.move};this.update=s=>{i[f.mode](s),this.redraw()},this.requestMove=t.requestMove,this.unsetPath=t.unsetPath}}class On extends je{constructor(t){super(t),this.path=[],this.pathFinder=Yt(this,Si)}pickPath=()=>{const{pathFinder:t,tileIndex:i}=this,s={x:nt(i.x,10),y:nt(i.y,10)};ge(s)&&t.requestMove(s)};update=t=>{const{pathFinder:i,pickPath:s,redraw:n,isMoving:o}=this;f.mode!=="editMode"&&(o||s(),i.move(t)),n()}}const Cn=e=>{const t={};t.entities=[];const{xTiles:i,yTiles:s}=e;for(let n=0;n<i;n++){t.entities[n]=[];for(let o=0;o<s;o++)t.entities[n][o]={}}return t.addEntity=({tileIndex:n,id:o,render:a})=>{t.entities[n.x][n.y][o]=a,Ye(n,1)},t.entityCheck=({x:n,y:o})=>{const a=t.entities[n][o];return Object.keys(a).length===0},t.removeEntity=({tileIndex:n,id:o})=>{const{x:a,y:r}=n,l=t.entities[a][r];if(delete l[o],Object.keys(l).length===0){const p=e.tiles[a][r].walkable;Ye(n,p)}},t},Ve=(e,t)=>{const{tileMap:i,entityMap:s}=f,n=i.tiles[e]?.[t];if(n){const{feature:o}=n,a=$({x:e,y:t}),r=s.entities[e][t];for(const l in r)r[l]();if(o){const{set:l,color:c,variant:p}=o,h=Be(l,c,p);f.entityCtx.drawImage(h.data,a.x,a.y-h.yOffset),f.entityCtx.globalAlpha=.5;for(const y in r)r[y]();f.entityCtx.globalAlpha=1}}},C={x:0,y:0,buttonCode:0,onMouseUp:null,onMouseMove:null,isDragged:!1,dragStart:{x:0,y:0},drag:{x:0,y:0}},Nn=e=>(e.addEventListener("contextmenu",t=>t.preventDefault()),e.onmousemove=t=>{const{translate:i}=f.view,{left:s,top:n}=t.target.getBoundingClientRect();C.x=t.clientX-s-i.x,C.y=t.clientY-n-i.y,C.buttonCode===1&&(C.isDragged=!0,C.drag.x=C.dragStart.x-C.x-i.x,C.drag.y=C.dragStart.y-C.y-i.y),C.onMouseMove&&C.onMouseMove()},e.onmousedown=t=>{t.preventDefault(),C.buttonCode=t.which,C.dragStart.x=C.x,C.dragStart.y=C.y,C.drag.x=0,C.drag.y=0},document.onmouseup=()=>{C.onMouseUp&&C.onMouseUp(),C.isDragged=!1,C.buttonCode=0},e.onmouseleave=()=>{C.isDragged=!1,C.buttonCode=0},C),ee={},Kt={keyDown:()=>{}};document.addEventListener("keydown",e=>{const{keyDown:t}=Kt;ee[e.code]=!0,t(e.code,e)});document.addEventListener("keyup",e=>{ee[e.code]=!1});const Wn=()=>{Object.keys(ee).forEach(e=>{ee[e]=!1})},Q=function(e){return ee[e]||!1},Sn=()=>w.h("div",{id:"ui"},f.mode==="editMode"?w.h(bi,null):null),Tn=()=>{ui.replaceWith(Sn())},Ge={},ue=()=>{};Ge.set=()=>{const{hoveredTile:e,mouse:t,player:i}=f;bt(),t.onMouseMove=()=>{t.buttonCode===1&&ei(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&i.requestMove(e.tileIndex),ki()},f.onFrameControls=s=>{Zt(s),e.tileIndex=Ct({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?f.canvas.style.cursor="grabbing":f.canvas.style.cursor="pointer",e.path=qe(i.tileIndex,e.tileIndex),t.buttonCode===3&&Mi(e.tileIndex)):f.canvas.style.cursor="default"},f.effectsMiddle=()=>{e.tileIndex&&e.path.forEach(s=>{X({x:s[1],y:s[0]},Oi)})},f.effectsTop=()=>{e.tileIndex&&(e.path.forEach(s=>{X({x:s[1],y:s[0]},Ci)}),X(e.tileIndex,pe))}};Ge.unset=()=>{const{mouse:e,player:t}=f;t.unsetPath(),e.onMouseMove=ue,e.onMouseUp=ue,f.effectsMiddle=ue,f.effectsTop=ue};const ze={},de=()=>{};ze.set=()=>{const{hoveredTile:e,mouse:t,player:i,ctx:s}=f;t.onMouseMove=()=>{t.buttonCode===1&&ei(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&i.requestMove(e.tileIndex)},f.onFrameControls=n=>{Zt(n),e.tileIndex=Ct({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?f.canvas.style.cursor="grabbing":f.canvas.style.cursor="pointer",e.path=qe(i.tileIndex,e.tileIndex)):f.canvas.style.cursor="default"},f.effectsMiddle=()=>{i.isMoving?oe(i.path,"lime"):e.tileIndex&&oe(e.path,"lime")},f.effectsTop=()=>{if(i.isMoving){if(oe(i.path,"rgba(50, 205, 50, 0.5)",!0,"lime"),e.tileIndex)if(ge(e.tileIndex)){const n=$(e.tileIndex);me(n,pe,Pe,s)}else X(e.tileIndex,pe)}else if(e.tileIndex&&(oe(e.path,"rgba(50, 205, 50, 0.5)"),e.tileIndex))if(ge(e.tileIndex)){const n=$(e.tileIndex);me(n,"lime",Pe,s)}else X(e.tileIndex,pe)}};ze.unset=()=>{const{mouse:e,player:t}=f;t.unsetPath(),e.onMouseMove=de,e.onMouseUp=de,f.effectsMiddle=de,f.effectsTop=de};const Qt=()=>{const{paused:e,stop:t,restart:i}=T;e?(i(),document.body.classList.remove("paused")):(t(),document.body.classList.add("paused"))},Fn=()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():canvasRoot.requestFullscreen()};Kt.keyDown=e=>{switch(e){case"Space":Qt();break;case"Enter":Q("ControlLeft")&&Fn();break;default:return}};document.addEventListener("visibilitychange",()=>{const{stop:e}=T;document.visibilityState==="hidden"?(e(),document.body.classList.add("paused")):document.visibilityState==="visible"&&Wn()});const ut={editMode:Ge,playMode:ze},Xt=e=>{ut[f.mode].unset(),f.mode=e,Tn(),ut[e].set()},Dn=()=>{const{view:e}=f,{xTiles:t,yTiles:i}=e;for(let s=t-1;s>-1;s--)for(let n=0;n<i;n++)Ii(s,n),Ve(s,n)},U=150,J=70,In=100,Pn=()=>{const e=document.createElement("canvas"),t=e.getContext("2d",{willReadFrequently:!0});e.classList.add("monitor"),e.width=U,e.height=J,canvasRoot.appendChild(e),t.strokeStyle="#ff0000";let i=t.getImageData(0,0,U,J);return s=>{t.clearRect(0,0,U,J),t.putImageData(i,-1,0);const n=J-s/In*J;t.beginPath(),t.moveTo(U,J),t.lineTo(U,n),t.stroke(),i=t.getImageData(0,0,U,J)}},f={};f.start=async e=>{f.canvas=document.createElement("canvas"),f.ctx=f.canvas.getContext("2d"),canvasRoot.appendChild(f.canvas),f.monitor=Pn(),f.floorCanvas=new OffscreenCanvas(0,0),f.floorCtx=f.floorCanvas.getContext("2d"),f.entityCanvas=new OffscreenCanvas(0,0),f.entityCtx=f.entityCanvas.getContext("2d"),f.effectsMiddle=()=>{},f.effectsTop=()=>{},f.mouse=Nn(f.canvas),f.view=Nt({xTiles:se,yTiles:se}),f.hoveredTile={path:null,tileIndex:null},f.mode="playMode",mode.onchange=()=>{const t=mode.elements.mode.value;Xt(t)},Bi();try{const t=await li(e);f.loadMap(t)}catch{const t=ai({xTiles:se,yTiles:se});f.loadMap(t)}T.start(Wt)};f.loadMap=e=>{const{entityList:t,unitStart:i={x:1,y:1}}=e;f.tileMap=e,f.entityMap=Cn(e),f.entities=[],f.player=new xn,f.player.addToScene(i),t&&t.forEach(s=>{const{name:n,tileIndex:o}=s;switch(n){case"entity":new je({}).addToScene(o);break;case"npc":new On({sprite:E.playerTokens.despoiler,haloColor:"red"}).addToScene(o);break}}),Xt(f.mode),f.view.setApertureSize(),Dn()};f.setView=Nt;let De=0,Ie=0;const Zt=e=>{const{translate:t}=f.view,i=Q("KeyW"),s=Q("KeyS"),n=Q("KeyD"),o=Q("KeyA");De+=it*e*(n-o),Ie+=it*e*(s-i),t.x-=De,t.y-=Ie,De*=tt,Ie*=tt,f.ctx.setTransform(1,0,0,1,t.x,t.y)},ei=(e,t)=>{const{translate:i}=f.view;i.x=e,i.y=t,f.ctx.setTransform(1,0,0,1,e,t)},Ee=I,$e=S*3,_n=S*1.5,dt=(e,t)=>{const{x:i,y:s}=t;e.save(),e.beginPath(),e.rect(i,s,Ee,$e),e.clip(),e.clearRect(i,s,Ee,$e)},En=e=>{const{floorCtx:t,entityCtx:i,tileMap:s}=f,n=$({x:e.x,y:e.y});n.y-=_n,dt(t,n),dt(i,n),jn.forEach(o=>{const a=o.x+e.x,r=o.y+e.y;if(s.tiles[a]?.[r]){const l=s.tiles[a][r];if(l.floor){const{set:c,color:p,variant:h}=l.floor;xt({x:a,y:r,image:Be(c,p,h)})}Ve(a,r)}}),i.restore(),t.restore()},$n=(e,t,i)=>{const{entityCtx:s}=f,n={x:Math.floor(Math.min(t.x,i.x)),y:Math.floor(Math.min(t.y,i.y)-S*2)},o=Math.ceil(Math.abs(t.x-i.x)+Ee),a=Math.ceil(Math.abs(t.y-i.y)+$e),{x:r,y:l}=n;s.save(),s.beginPath(),s.rect(r,l,o,a),s.clip(),s.clearRect(r,l,o,a),Bn.forEach(c=>{const p=c.x+e.x,h=c.y+e.y;Ve(p,h)}),s.restore()},Bn=[{x:3,y:-3},{x:3,y:-2},{x:3,y:-1},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:2,y:0},{x:1,y:-3},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:0},{x:-2,y:1},{x:-3,y:1},{x:-2,y:2},{x:-1,y:3},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],jn=[{x:3,y:-3},{x:3,y:-2},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:1},{x:-2,y:2},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Ln=()=>w.h("div",null,w.h("div",{id:"pauseMenu"},w.h("div",{class:"pause-menu-items"},w.h("p",null,"Paused"),w.h("ul",null,w.h("li",null,w.h("button",{onclick:Qt},"Resume")),w.h("li",null,w.h("button",{id:"loadButton"},"Load")),w.h("li",null,w.h("button",{class:"save",id:"saveButton"},"Save"),w.h("input",{type:"text",id:"saveName",value:"tile-map"})))))),Rn=()=>w.h("div",{class:"toolbar"},w.h("form",{id:"mode",name:"mode",class:"margin-right-10"},w.h("input",{type:"radio",id:"playRadio",value:"playMode",class:"margin-right-10",name:"mode",checked:!0}),w.h("label",{for:"playRadio"},"Play Mode"),w.h("input",{type:"radio",id:"editModeRadio",value:"editMode",class:"margin-left-10 margin-right-10",name:"mode"}),w.h("label",{for:"editModeRadio"},"Edit Mode"))),Jn=()=>w.h("div",{class:"wrapper"},w.h(Rn,null),w.h("div",{id:"canvasRoot"},w.h("div",{id:"ui"}),w.h(Ln,null)));root.replaceWith(Jn());f.start("vista");window.dump=()=>console.log(f);
