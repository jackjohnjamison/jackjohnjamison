var Un=Object.defineProperty;var Jn=(_,R,H)=>R in _?Un(_,R,{enumerable:!0,configurable:!0,writable:!0,value:H}):_[R]=H;var Y=(_,R,H)=>(Jn(_,typeof R!="symbol"?R+"":R,H),H);(async()=>{(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerpolicy&&(a.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?a.credentials="include":i.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const _=({x:t,y:e})=>{var i,a;const{tileMap:n}=p;return((a=(i=n.walkableTileMatrix)==null?void 0:i[t])==null?void 0:a[e])===0},R=({x:t,y:e},n)=>{const{tileMap:i}=p;i.walkableTileMatrix[t][e]=n},H="modulepreload",ni=function(t){return"/tiles/"+t},Yt={},ai=function(t,e,n){return!e||e.length===0?t():Promise.all(e.map(i=>{if(i=ni(i),i in Yt)return;Yt[i]=!0;const a=i.endsWith(".css"),o=a?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${o}`))return;const s=document.createElement("link");if(s.rel=a?"stylesheet":H,a||(s.as="script",s.crossOrigin=""),s.href=i,document.head.appendChild(s),a)return new Promise((r,l)=>{s.addEventListener("load",r),s.addEventListener("error",()=>l(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>t())},oi=(t,e)=>{const n=t[e];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((i,a)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(a.bind(null,new Error("Unknown variable dynamic import: "+e)))})},W=t=>new Promise(e=>{let n=new Image;n.onload=()=>e(n),n.src=t}),F={terracotta:[{yOffset:0,data:await W("../../images/terracotta1.png")},{yOffset:0,data:await W("../../images/terracotta2.png")},{yOffset:0,data:await W("../../images/terracotta3.png")},{yOffset:0,data:await W("../../images/terracotta4.png")}],cube:[{yOffset:33,data:await W("../../images/cube1.png")},{yOffset:33,data:await W("../../images/cube2.png")},{yOffset:33,data:await W("../../images/cube3.png")}],grass:[{yOffset:2,data:await W("../../images/grass1.png")},{yOffset:2,data:await W("../../images/grass2.png")},{yOffset:2,data:await W("../../images/grass3.png")},{yOffset:2,data:await W("../../images/grass4.png")}],water:[{yOffset:-3,data:await W("../../images/water1.png")},{yOffset:-3,data:await W("../../images/water2.png")}],mountain:[{yOffset:14,data:await W("../../images/mountain1.png")},{yOffset:12,data:await W("../../images/mountain2.png")},{yOffset:14,data:await W("../../images/mountain3.png")}],mountainTop:[{yOffset:14,data:await W("../../images/mountain1-top.png")},{yOffset:12,data:await W("../../images/mountain2-top.png")},{yOffset:14,data:await W("../../images/mountain3-top.png")}],forest:[{yOffset:15,data:await W("../../images/trees1.png")},{yOffset:15,data:await W("../../images/trees2.png")},{yOffset:15,data:await W("../../images/trees3.png")},{yOffset:15,data:await W("../../images/trees4.png")}],forestTop:[{yOffset:15,data:await W("../../images/trees1-top.png")},{yOffset:15,data:await W("../../images/trees2-top.png")},{yOffset:15,data:await W("../../images/trees3-top.png")},{yOffset:15,data:await W("../../images/trees4-top.png")}],playerTokens:{angel:{yOffset:51,data:await W("../../images/pt-angel.png")},despoiler:{yOffset:51,data:await W("../../images/pt-despoiler.png")},sheild:{yOffset:48,data:await W("../../images/pt-sheild.png")}}},rt=new OffscreenCanvas(0,0),Zt=rt.getContext("2d"),si=(t,e)=>{const{data:n,data:{width:i,height:a},yOffset:o}=t;rt.width=i,rt.height=a;const s=n;return Zt.filter=`hue-rotate(${e}deg)`,Zt.drawImage(s,0,0),{data:rt,yOffset:o}},Ot=(t,e,n)=>{const i=F[t][n];return si(i,e)},lt=t=>Math.floor(Math.random()*F[t].length),ri=({xTiles:t,yTiles:e})=>{const n={tiles:[],walkableTileMatrix:[],xTiles:t,yTiles:e};for(let i=0;i<t;i++){n.tiles[i]=[],n.walkableTileMatrix[i]=[];for(let a=0;a<e;a++)n.tiles[i][a]={}}for(let i=0;i<t;i++)for(let a=0;a<e;a++)te({x:i,y:a},n,"grass");return n},te=(t,e,n,i,a=null)=>{const{floor:o,feature:s,walkable:r,type:l}=U[n],{x:h,y:d}=t,f=e.tiles[h][d];switch(l){case"void":f.floor=null,f.feature=null;break;case"obstacle":case"floor":f.floor={set:o,variant:a||lt(o),color:(i==null?void 0:i[l])||0},f.feature=null;break;case"linked":const m=a||lt(o);f.floor={set:o,variant:m,color:(i==null?void 0:i.floor)||0},f.feature={set:s,variant:m,color:(i==null?void 0:i.feature)||0};break;case"feature":f.feature={set:s,variant:a||lt(s),color:(i==null?void 0:i.feature)||0},(f.type==="void"||f.type==="linked"||f.type==="obstacle")&&(f.floor={set:o,variant:lt(o),color:i==null?void 0:i.feature});break}f.type=l,f.walkable=r,e.walkableTileMatrix[h][d]=r},li=()=>{const{tileMap:t,entities:e}=p;return t.entityList=[],e.forEach(n=>{const{constructor:{name:i},tileIndex:a}=n;i==="unit"?t.unitStart=a:t.entityList.push({name:i,tileIndex:a})}),"data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))},hi=async t=>{const e=JSON.stringify(await oi(Object.assign({"../../maps/vista.json":()=>ai(()=>import("./vista.a258ec57.js"),[])}),`../../maps/${t}.json`));return ee(e)},ee=t=>JSON.parse(t);var Z=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ci(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var b={},ie={},$={};Object.defineProperty($,"__esModule",{value:!0}),$.isSvgTag=$.applyChildren=$.setElementStyle=void 0;function di(t,e){let n;const i=Object.keys(e);for(n of i)t.style[n]=e[n]}$.setElementStyle=di;function ne(t,e){e instanceof HTMLElement?t.appendChild(e):typeof e=="string"||typeof e=="number"?t.appendChild(document.createTextNode(e.toString())):console.warn("Unknown type to append: ",e)}function ae(t,e){for(const n of e)if(!(!n&&n!==0))if(Array.isArray(n))for(const i of n)Array.isArray(i)?ae(t,i):ne(t,i);else ne(t,n)}$.applyChildren=ae;function pi(t){return["a","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","path","pattern","polygon","polyline","radialGradient","rect","script","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"].includes(t)}$.isSvgTag=pi,function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.h=t.xlinkNS=void 0;const e=$;t.xlinkNS="http://www.w3.org/1999/xlink";function n(i,a,...o){if(typeof i=="function")return i(Object.assign(Object.assign({},a),{children:o}));const s=e.isSvgTag(i),r=s?document.createElementNS("http://www.w3.org/2000/svg",i):document.createElement(i);if(a){a.style&&typeof a.style!="string"&&(e.setElementStyle(r,a.style),delete a.style);for(const l of Object.keys(a)){const h=a[l];if(l.startsWith("on")){const d=l.replace(/Capture$/,""),f=l!==d,m=d.toLowerCase().substring(2);r.addEventListener(m,h,f)}else s&&l.startsWith("xlink:")?r.setAttributeNS(t.xlinkNS,l,h):h===!0?r.setAttribute(l,l):(h||h===0)&&r.setAttribute(l,h.toString())}}return e.applyChildren(r,o),r}t.h=n}(ie);var oe={};Object.defineProperty(oe,"__esModule",{value:!0}),function(t){var e=Z&&Z.__createBinding||(Object.create?function(i,a,o,s){s===void 0&&(s=o),Object.defineProperty(i,s,{enumerable:!0,get:function(){return a[o]}})}:function(i,a,o,s){s===void 0&&(s=o),i[s]=a[o]}),n=Z&&Z.__exportStar||function(i,a){for(var o in i)o!=="default"&&!Object.prototype.hasOwnProperty.call(a,o)&&e(a,i,o)};Object.defineProperty(t,"__esModule",{value:!0}),n(ie,t),n(oe,t)}(b);const fi=5,yi=6,ht=2,se=4,re={},le={};let[D]=Object.keys(U),tt=U[D].type,ct=F[D],q=[];const he=t=>{D=(t==null?void 0:t.target.value)||D,tt=U[D].type,ct=F[D],spriteDisplay.replaceWith(ce()),tt!=="void"&&ue()},ce=()=>{switch(tt){case"void":return b.h("div",{id:"spriteDisplay",class:"spriteDisplay--void"},b.h("div",{class:"brush"},b.h("div",{class:"void-brush"},"X"),b.h("span",null,"Delete tiles")));case"linked":const{floor:t,feature:e}=U[D];q={floor:t,feature:e};break;default:q={[tt]:D};break}return b.h("div",{id:"spriteDisplay"},b.h(vi,null))},gi=()=>le[D]={width:Math.max(...ct.map(t=>t.data.width))+fi,height:Math.max(...ct.map(t=>t.data.height))+yi},ue=()=>{const t=tilePainter.elements;Object.keys(q).forEach(e=>{const n=q[e],i=t[`${e}Hue`],a=document.getElementById(`${e}HueRotaion`),o=i.value;a.innerText=re[n]=o,F[n].forEach((s,r)=>{const l=document.getElementById(`tileCanv${r}`).getContext("2d");l.filter=`hue-rotate(${o}deg)`;const h=F[n][r].data;l.drawImage(h,se,se)})})},mi=t=>{const{tileSet:e,tiles:n,label:i,type:a}=t;return b.h("div",null,b.h("div",null,b.h("label",{for:`${a}Hue`},i,": "),b.h("span",{id:`${a}HueRotaion`},"0")),b.h("input",{id:`${a}Hue`,class:"hue-slider",type:"range",min:"-180",max:"180",step:"1","tile-type":a,value:re[e]||0,onInput:()=>{ue()}}))},xi=t=>{const{width:e,height:n,index:i}=t;return b.h("div",{class:"brush"},b.h("canvas",{id:`tileCanv${i}`,width:e+ht,height:n+ht}),b.h("input",{type:"radio",value:i,name:"tileVariant",style:{width:`${e}px`,height:`${n}px`}}))},vi=()=>{const{width:t,height:e}=le[D]||gi(),n=Object.keys(q);return b.h("div",null,b.h("div",{class:"sprite-brushes"},b.h("div",{class:"brush"},b.h("div",{class:"random-tile-brush",style:{width:`${t+ht}px`,height:`${e+ht}px`}},b.h("div",null,"?")),b.h("input",{checked:!0,type:"radio",value:"random",name:"tileVariant",style:{width:`${t}px`,height:`${e}px`}})),ct.map((i,a)=>b.h(xi,{width:t,height:e,index:a}))),n.map(i=>b.h(mi,{tileSet:q[i],label:n.length>1?i+" Hue":"Hue",tiles:q,type:i})))},bi=()=>b.h("form",{id:"tilePainter"},b.h("select",{id:"terrainType",name:"terrainType",onChange:he},Object.keys(U).map(t=>b.h("option",{selected:D===t,value:t},U[t].displayName))),b.h(ce,null)),wi=()=>{var a;const t=tilePainter.elements,e={};Object.keys(q).forEach(o=>{const s=t[`${o}Hue`];e[o]=(s==null?void 0:s.value)||null});let n=null;const i=(a=t.tileVariant)==null?void 0:a.value;return i!=="random"&&(n=i||null),{set:terrainType.value,type:tt,variant:n,colors:e}};let ut={};const ki=t=>{if(t.x!==ut.x||t.y!==ut.y){const{tileMap:e}=p,n=wi(),{set:i,colors:a,variant:o,type:s}=n,r=p.entityMap.entities[t.x][t.y];Object.keys(r).length!==0&&s!=="floor"||(te(t,e,i,a,o),Rn(t))}ut=t},Mi=()=>{ut={}},P=64,T=32,dt=32,Ai=32,de=128,Wi="rgba(255,255,255,0.1)",pt="rgba(255,255,0,0.6)",Ci="yellow",Oi="rgba(255,0,0,0.2)",Ni="yellow",pe=.8,fe=.12,Ti=.18,Ii=.08,ye=P/2,ge=T/2,Si=T/P,Pi=6.28319,Nt=20,Ei=({x:t,y:e,strokeColor:n,fillColor:i})=>{const{ctx:a}=p,o=L({x:t,y:e});a.strokeStyle=n,a.fillStyle=i,a.beginPath(),a.moveTo(o.x,o.y+T/2),a.lineTo(o.x+P/2,o.y),a.lineTo(o.x+P,o.y+T/2),a.lineTo(o.x+P/2,o.y+T),a.closePath(),a.fill(),a.stroke()},U={mountain:{displayName:"Mountains",walkable:1,floor:"mountain",feature:"mountainTop",type:"linked"},forest:{displayName:"Forest",walkable:0,floor:"forest",feature:"forestTop",type:"linked"},terracotta:{displayName:"Terracotta Floor",walkable:0,floor:"terracotta",type:"floor"},grass:{displayName:"Grass",walkable:0,floor:"grass",type:"floor"},cube:{displayName:"Cube",walkable:1,feature:"cube",floor:"terracotta",type:"feature"},water:{displayName:"Water",walkable:1,floor:"water",type:"obstacle"},void:{displayName:"Void",walkable:1,type:"void"}},me=({x:t,y:e,image:n})=>{const{floorCtx:i}=p,a=L({x:t,y:e});i.drawImage(n.data,a.x,a.y-n.yOffset)},ji=(t,e)=>{const{tileMap:n}=p,i=n.tiles[t][e];if(i.floor){const{set:a,color:o,variant:s}=i.floor;me({x:t,y:e,image:Ot(a,o,s)})}},xe=({x:t,y:e})=>{const{origin:n}=p.view;return{x:Math.floor((t-n.x)/P-(e-n.y-T/2)/T),y:Math.floor((e-n.y-T/2)/T+(t-n.x)/P)}},L=({x:t,y:e})=>{const{origin:n}=p.view;return{x:t*P/2+e*P/2+n.x,y:e*T/2-t*T/2+n.y}},ve=t=>{const{tileMap:e}=p,{x:n,y:i}=xe(t);return e.tiles[n]&&e.tiles[n][i]?{x:n,y:i}:null},et=(t,e)=>{const{x:n,y:i}=t;Ei({x:n,y:i,strokeColor:e,fillColor:Wi})},be=({xTiles:t,yTiles:e})=>{const{ctx:n,canvas:i}=p,a=(t+e)/2*T,o=(t+e)/2*P,s=a+Ai+de;p.floorCanvas.width=p.entityCanvas.width=o,p.floorCanvas.height=p.entityCanvas.height=s;const r=a/2-T/4*(e-t)-T/2+de,l={x:0,y:r},h={x:0,y:0},d=()=>{i.width=canvasRoot.clientWidth,i.height=canvasRoot.clientHeight,n.setTransform(1,0,0,1,h.x,h.y)};return onresize=()=>{d(),_i()},{origin:l,xTiles:t,yTiles:e,translate:h,setApertureSize:d}},Di=t=>{const{ctx:e,canvas:n,floorCanvas:i,entityCanvas:a,view:o,effectsMiddle:s,effectsTop:r}=p,{translate:l}=o;e.clearRect(-l.x,-l.y,n.width,n.height),e.drawImage(i,0,0),s(),p.entities.forEach(h=>{h.update(t)}),e.drawImage(a,0,0),r()},_i=()=>{const{ctx:t,canvas:e,floorCanvas:n,entityCanvas:i,view:a}=p,{translate:o}=a;t.clearRect(-o.x,-o.y,e.width,e.height),t.drawImage(n,0,0),t.drawImage(i,0,0)},we=t=>{const{onFrameControls:e}=p;e&&(e(t),p.monitor(t)),Di(t)},I={};let it=0,ke=0,Me;I.start=t=>{Me=t,ke=requestAnimationFrame(e=>{Ri(e,t)}),I.paused=!1},I.restart=()=>{I.start(Me),I.paused=!1},I.stop=()=>{window.cancelAnimationFrame(ke),it=0,I.paused=!0};const Ri=(t,e)=>{it||(it=t);const n=t-it;it=t,e(n),I.start(e)},Fi=t=>{I.stop(),delete p.entites,delete p.tileMap,delete p.entityMap;const{xTiles:e,yTiles:n}=t;p.view=p.setView({xTiles:e,yTiles:n}),p.loadMap(t),I.start(we)},Li=()=>{saveButton.onclick=()=>{const t=li(),e=document.createElement("a");e.setAttribute("href",t),e.setAttribute("download",saveName.value+".json"),saveButton.after(e),e.click(),e.remove()},loadButton.onclick=()=>{const t=document.createElement("input");t.type="file",loadButton.after(t),t.onchange=()=>{const e=new FileReader;e.onload=n=>{const i=ee(n.target.result);Fi(i)},e.readAsText(t.files[0])},t.click(),t.remove()}};let Bi=0;const $i=()=>Bi++,Ae=(t,e)=>{const n=t+(Math.random()*e-e/2);return Math.floor(n)},ft=(t,e,n,i)=>{const a=t.x+ye,o=t.y+ge;i.strokeStyle=e,i.beginPath(),i.ellipse(a,o,n,n*Si,0,0,Pi),i.stroke()},Tt=16,We=.86,qi="rgba(150, 150, 150, 0.8)",yt=(t,e,n,i)=>{const{ctx:a}=p,o=t.length;t.forEach((s,r)=>{const[l,h]=s,d=L({y:l,x:h});if(ft(d,e,Tt,a),n&&r===o-1){const f=d.x+ye,m=d.y+ge;a.beginPath(),a.moveTo(f,m),a.lineTo(f-Tt/3,m-T*We*1.5),a.lineTo(f,m-T*1.5),a.lineTo(f+Tt/3,m-T*We*1.5),a.closePath(),a.fillStyle=qi,a.strokeStyle=i,a.fill(),a.stroke()}})};class It{constructor({sprite:e,haloColor:n}){Y(this,"addToScene",e=>{const{entityMap:n}=p,{id:i,render:a,redraw:o}=this;this.tileIndex=e,this.position=L(e),this.positionPrevious=this.position,this.redrawEntities=Fn,n.addEntity({tileIndex:e,id:i,render:a}),p.entities.push(this),o()});Y(this,"render",()=>{const{entityCtx:e}=p,{sprite:n,position:i,haloColor:a}=this;ft(i,a,Nt,e),e.drawImage(n.data,Math.round(i.x),Math.round(i.y-n.yOffset))});Y(this,"redraw",()=>{const{tileIndex:e,position:n,positionPrevious:i}=this;this.redrawEntities(e,n,i),this.positionPrevious={x:n.x,y:n.y}});this.sprite=e||F.playerTokens.sheild,this.haloColor=n||Ni,this.id=$i(),this.position={x:0,y:0}}update(){}}var Ce={exports:{}},nt={exports:{}},Oe={exports:{}};(function(t){(function(){var e,n,i,a,o,s,r,l,h,d,f,m,x,k,g;i=Math.floor,d=Math.min,n=function(u,c){return u<c?-1:u>c?1:0},h=function(u,c,y,v,M){var w;if(y==null&&(y=0),M==null&&(M=n),y<0)throw new Error("lo must be non-negative");for(v==null&&(v=u.length);y<v;)w=i((y+v)/2),M(c,u[w])<0?v=w:y=w+1;return[].splice.apply(u,[y,y-y].concat(c)),c},s=function(u,c,y){return y==null&&(y=n),u.push(c),k(u,0,u.length-1,y)},o=function(u,c){var y,v;return c==null&&(c=n),y=u.pop(),u.length?(v=u[0],u[0]=y,g(u,0,c)):v=y,v},l=function(u,c,y){var v;return y==null&&(y=n),v=u[0],u[0]=c,g(u,0,y),v},r=function(u,c,y){var v;return y==null&&(y=n),u.length&&y(u[0],c)<0&&(v=[u[0],c],c=v[0],u[0]=v[1],g(u,0,y)),c},a=function(u,c){var y,v,M,w,A,O;for(c==null&&(c=n),w=function(){O=[];for(var N=0,j=i(u.length/2);0<=j?N<j:N>j;0<=j?N++:N--)O.push(N);return O}.apply(this).reverse(),A=[],v=0,M=w.length;v<M;v++)y=w[v],A.push(g(u,y,c));return A},x=function(u,c,y){var v;if(y==null&&(y=n),v=u.indexOf(c),v!==-1)return k(u,0,v,y),g(u,v,y)},f=function(u,c,y){var v,M,w,A,O;if(y==null&&(y=n),M=u.slice(0,c),!M.length)return M;for(a(M,y),O=u.slice(c),w=0,A=O.length;w<A;w++)v=O[w],r(M,v,y);return M.sort(y).reverse()},m=function(u,c,y){var v,M,w,A,O,N,j,V,Xt;if(y==null&&(y=n),c*10<=u.length){if(w=u.slice(0,c).sort(y),!w.length)return w;for(M=w[w.length-1],j=u.slice(c),A=0,N=j.length;A<N;A++)v=j[A],y(v,M)<0&&(h(w,v,0,null,y),w.pop(),M=w[w.length-1]);return w}for(a(u,y),Xt=[],O=0,V=d(c,u.length);0<=V?O<V:O>V;0<=V?++O:--O)Xt.push(o(u,y));return Xt},k=function(u,c,y,v){var M,w,A;for(v==null&&(v=n),M=u[y];y>c;){if(A=y-1>>1,w=u[A],v(M,w)<0){u[y]=w,y=A;continue}break}return u[y]=M},g=function(u,c,y){var v,M,w,A,O;for(y==null&&(y=n),M=u.length,O=c,w=u[c],v=2*c+1;v<M;)A=v+1,A<M&&!(y(u[v],u[A])<0)&&(v=A),u[c]=u[v],c=v,v=2*c+1;return u[c]=w,k(u,O,c,y)},e=function(){u.push=s,u.pop=o,u.replace=l,u.pushpop=r,u.heapify=a,u.updateItem=x,u.nlargest=f,u.nsmallest=m;function u(c){this.cmp=c!=null?c:n,this.nodes=[]}return u.prototype.push=function(c){return s(this.nodes,c,this.cmp)},u.prototype.pop=function(){return o(this.nodes,this.cmp)},u.prototype.peek=function(){return this.nodes[0]},u.prototype.contains=function(c){return this.nodes.indexOf(c)!==-1},u.prototype.replace=function(c){return l(this.nodes,c,this.cmp)},u.prototype.pushpop=function(c){return r(this.nodes,c,this.cmp)},u.prototype.heapify=function(){return a(this.nodes,this.cmp)},u.prototype.updateItem=function(c){return x(this.nodes,c,this.cmp)},u.prototype.clear=function(){return this.nodes=[]},u.prototype.empty=function(){return this.nodes.length===0},u.prototype.size=function(){return this.nodes.length},u.prototype.clone=function(){var c;return c=new u,c.nodes=this.nodes.slice(0),c},u.prototype.toArray=function(){return this.nodes.slice(0)},u.prototype.insert=u.prototype.push,u.prototype.top=u.prototype.peek,u.prototype.front=u.prototype.peek,u.prototype.has=u.prototype.contains,u.prototype.copy=u.prototype.clone,u}(),t!==null&&t.exports?t.exports=e:window.Heap=e}).call(Z)})(Oe),function(t){t.exports=Oe.exports}(nt);function Hi(t,e,n){this.x=t,this.y=e,this.walkable=n===void 0?!0:n}var St=Hi,Ui={Always:1,Never:2,IfAtMostOneObstacle:3,OnlyWhenNoObstacles:4},E=Ui,Ne=St,gt=E;function B(t,e,n){var i;typeof t!="object"?i=t:(e=t.length,i=t[0].length,n=t),this.width=i,this.height=e,this.nodes=this._buildNodes(i,e,n)}B.prototype._buildNodes=function(t,e,n){var i,a,o=new Array(e);for(i=0;i<e;++i)for(o[i]=new Array(t),a=0;a<t;++a)o[i][a]=new Ne(a,i);if(n===void 0)return o;if(n.length!==e||n[0].length!==t)throw new Error("Matrix size does not fit");for(i=0;i<e;++i)for(a=0;a<t;++a)n[i][a]&&(o[i][a].walkable=!1);return o},B.prototype.getNodeAt=function(t,e){return this.nodes[e][t]},B.prototype.isWalkableAt=function(t,e){return this.isInside(t,e)&&this.nodes[e][t].walkable},B.prototype.isInside=function(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height},B.prototype.setWalkableAt=function(t,e,n){this.nodes[e][t].walkable=n},B.prototype.getNeighbors=function(t,e){var n=t.x,i=t.y,a=[],o=!1,s=!1,r=!1,l=!1,h=!1,d=!1,f=!1,m=!1,x=this.nodes;if(this.isWalkableAt(n,i-1)&&(a.push(x[i-1][n]),o=!0),this.isWalkableAt(n+1,i)&&(a.push(x[i][n+1]),r=!0),this.isWalkableAt(n,i+1)&&(a.push(x[i+1][n]),h=!0),this.isWalkableAt(n-1,i)&&(a.push(x[i][n-1]),f=!0),e===gt.Never)return a;if(e===gt.OnlyWhenNoObstacles)s=f&&o,l=o&&r,d=r&&h,m=h&&f;else if(e===gt.IfAtMostOneObstacle)s=f||o,l=o||r,d=r||h,m=h||f;else if(e===gt.Always)s=!0,l=!0,d=!0,m=!0;else throw new Error("Incorrect value of diagonalMovement");return s&&this.isWalkableAt(n-1,i-1)&&a.push(x[i-1][n-1]),l&&this.isWalkableAt(n+1,i-1)&&a.push(x[i-1][n+1]),d&&this.isWalkableAt(n+1,i+1)&&a.push(x[i+1][n+1]),m&&this.isWalkableAt(n-1,i+1)&&a.push(x[i+1][n-1]),a},B.prototype.clone=function(){var t,e,n=this.width,i=this.height,a=this.nodes,o=new B(n,i),s=new Array(i);for(t=0;t<i;++t)for(s[t]=new Array(n),e=0;e<n;++e)s[t][e]=new Ne(e,t,a[t][e].walkable);return o.nodes=s,o};var Ji=B,S={};function Pt(t){for(var e=[[t.x,t.y]];t.parent;)t=t.parent,e.push([t.x,t.y]);return e.reverse()}S.backtrace=Pt;function Vi(t,e){var n=Pt(t),i=Pt(e);return n.concat(i.reverse())}S.biBacktrace=Vi;function Gi(t){var e,n=0,i,a,o,s;for(e=1;e<t.length;++e)i=t[e-1],a=t[e],o=i[0]-a[0],s=i[1]-a[1],n+=Math.sqrt(o*o+s*s);return n}S.pathLength=Gi;function Et(t,e,n,i){var a=Math.abs,o=[],s,r,l,h,d,f;for(l=a(n-t),h=a(i-e),s=t<n?1:-1,r=e<i?1:-1,d=l-h;o.push([t,e]),!(t===n&&e===i);)f=2*d,f>-h&&(d=d-h,t=t+s),f<l&&(d=d+l,e=e+r);return o}S.interpolate=Et;function zi(t){var e=[],n=t.length,i,a,o,s,r,l;if(n<2)return e;for(r=0;r<n-1;++r)for(i=t[r],a=t[r+1],o=Et(i[0],i[1],a[0],a[1]),s=o.length,l=0;l<s-1;++l)e.push(o[l]);return e.push(t[n-1]),e}S.expandPath=zi;function Ki(t,e){var n=e.length,i=e[0][0],a=e[0][1],o=e[n-1][0],s=e[n-1][1],r,l,h,d,f,m,x,k,g,u,c;for(r=i,l=a,f=[[r,l]],m=2;m<n;++m){for(k=e[m],h=k[0],d=k[1],g=Et(r,l,h,d),c=!1,x=1;x<g.length;++x)if(u=g[x],!t.isWalkableAt(u[0],u[1])){c=!0;break}c&&(lastValidCoord=e[m-1],f.push(lastValidCoord),r=lastValidCoord[0],l=lastValidCoord[1])}return f.push([o,s]),f}S.smoothenPath=Ki;function Qi(t){if(t.length<3)return t;var e=[],n=t[0][0],i=t[0][1],a=t[1][0],o=t[1][1],s=a-n,r=o-i,l,h,d,f,m,x;for(m=Math.sqrt(s*s+r*r),s/=m,r/=m,e.push([n,i]),x=2;x<t.length;x++)l=a,h=o,d=s,f=r,a=t[x][0],o=t[x][1],s=a-l,r=o-h,m=Math.sqrt(s*s+r*r),s/=m,r/=m,(s!==d||r!==f)&&e.push([l,h]);return e.push([a,o]),e}S.compressPath=Qi;var at={manhattan:function(t,e){return t+e},euclidean:function(t,e){return Math.sqrt(t*t+e*e)},octile:function(t,e){var n=Math.SQRT2-1;return t<e?n*t+e:n*e+t},chebyshev:function(t,e){return Math.max(t,e)}},Xi=nt.exports,Yi=S,jt=at,mt=E;function Te(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.heuristic=t.heuristic||jt.manhattan,this.weight=t.weight||1,this.diagonalMovement=t.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=mt.OnlyWhenNoObstacles:this.diagonalMovement=mt.IfAtMostOneObstacle:this.diagonalMovement=mt.Never),this.diagonalMovement===mt.Never?this.heuristic=t.heuristic||jt.manhattan:this.heuristic=t.heuristic||jt.octile}Te.prototype.findPath=function(t,e,n,i,a){var o=new Xi(function(w,A){return w.f-A.f}),s=a.getNodeAt(t,e),r=a.getNodeAt(n,i),l=this.heuristic,h=this.diagonalMovement,d=this.weight,f=Math.abs,m=Math.SQRT2,x,k,g,u,c,y,v,M;for(s.g=0,s.f=0,o.push(s),s.opened=!0;!o.empty();){if(x=o.pop(),x.closed=!0,x===r)return Yi.backtrace(r);for(k=a.getNeighbors(x,h),u=0,c=k.length;u<c;++u)g=k[u],!g.closed&&(y=g.x,v=g.y,M=x.g+(y-x.x===0||v-x.y===0?1:m),(!g.opened||M<g.g)&&(g.g=M,g.h=g.h||d*l(f(y-n),f(v-i)),g.f=g.g+g.h,g.parent=x,g.opened?o.updateItem(g):(o.push(g),g.opened=!0)))}return[]};var Dt=Te,Ie=Dt;function xt(t){Ie.call(this,t);var e=this.heuristic;this.heuristic=function(n,i){return e(n,i)*1e6}}xt.prototype=new Ie,xt.prototype.constructor=xt;var Zi=xt,tn=S,_t=E;function Se(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=_t.OnlyWhenNoObstacles:this.diagonalMovement=_t.IfAtMostOneObstacle:this.diagonalMovement=_t.Never)}Se.prototype.findPath=function(t,e,n,i,a){var o=[],s=this.diagonalMovement,r=a.getNodeAt(t,e),l=a.getNodeAt(n,i),h,d,f,m,x;for(o.push(r),r.opened=!0;o.length;){if(f=o.shift(),f.closed=!0,f===l)return tn.backtrace(l);for(h=a.getNeighbors(f,s),m=0,x=h.length;m<x;++m)d=h[m],!(d.closed||d.opened)&&(o.push(d),d.opened=!0,d.parent=f)}return[]};var en=Se,Pe=Dt;function vt(t){Pe.call(this,t),this.heuristic=function(e,n){return 0}}vt.prototype=new Pe,vt.prototype.constructor=vt;var nn=vt,Ee=nt.exports,je=S,Rt=at,bt=E;function De(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.heuristic=t.heuristic||Rt.manhattan,this.weight=t.weight||1,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=bt.OnlyWhenNoObstacles:this.diagonalMovement=bt.IfAtMostOneObstacle:this.diagonalMovement=bt.Never),this.diagonalMovement===bt.Never?this.heuristic=t.heuristic||Rt.manhattan:this.heuristic=t.heuristic||Rt.octile}De.prototype.findPath=function(t,e,n,i,a){var o=function(j,V){return j.f-V.f},s=new Ee(o),r=new Ee(o),l=a.getNodeAt(t,e),h=a.getNodeAt(n,i),d=this.heuristic,f=this.diagonalMovement,m=this.weight,x=Math.abs,k=Math.SQRT2,g,u,c,y,v,M,w,A,O=1,N=2;for(l.g=0,l.f=0,s.push(l),l.opened=O,h.g=0,h.f=0,r.push(h),h.opened=N;!s.empty()&&!r.empty();){for(g=s.pop(),g.closed=!0,u=a.getNeighbors(g,f),y=0,v=u.length;y<v;++y)if(c=u[y],!c.closed){if(c.opened===N)return je.biBacktrace(g,c);M=c.x,w=c.y,A=g.g+(M-g.x===0||w-g.y===0?1:k),(!c.opened||A<c.g)&&(c.g=A,c.h=c.h||m*d(x(M-n),x(w-i)),c.f=c.g+c.h,c.parent=g,c.opened?s.updateItem(c):(s.push(c),c.opened=O))}for(g=r.pop(),g.closed=!0,u=a.getNeighbors(g,f),y=0,v=u.length;y<v;++y)if(c=u[y],!c.closed){if(c.opened===O)return je.biBacktrace(c,g);M=c.x,w=c.y,A=g.g+(M-g.x===0||w-g.y===0?1:k),(!c.opened||A<c.g)&&(c.g=A,c.h=c.h||m*d(x(M-t),x(w-e)),c.f=c.g+c.h,c.parent=g,c.opened?r.updateItem(c):(r.push(c),c.opened=N))}}return[]};var Ft=De,_e=Ft;function wt(t){_e.call(this,t);var e=this.heuristic;this.heuristic=function(n,i){return e(n,i)*1e6}}wt.prototype=new _e,wt.prototype.constructor=wt;var an=wt,Re=S,Lt=E;function Fe(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Lt.OnlyWhenNoObstacles:this.diagonalMovement=Lt.IfAtMostOneObstacle:this.diagonalMovement=Lt.Never)}Fe.prototype.findPath=function(t,e,n,i,a){var o=a.getNodeAt(t,e),s=a.getNodeAt(n,i),r=[],l=[],h,d,f,m=this.diagonalMovement,x=0,k=1,g,u;for(r.push(o),o.opened=!0,o.by=x,l.push(s),s.opened=!0,s.by=k;r.length&&l.length;){for(f=r.shift(),f.closed=!0,h=a.getNeighbors(f,m),g=0,u=h.length;g<u;++g)if(d=h[g],!d.closed){if(d.opened){if(d.by===k)return Re.biBacktrace(f,d);continue}r.push(d),d.parent=f,d.opened=!0,d.by=x}for(f=l.shift(),f.closed=!0,h=a.getNeighbors(f,m),g=0,u=h.length;g<u;++g)if(d=h[g],!d.closed){if(d.opened){if(d.by===x)return Re.biBacktrace(d,f);continue}l.push(d),d.parent=f,d.opened=!0,d.by=k}}return[]};var on=Fe,Le=Ft;function kt(t){Le.call(this,t),this.heuristic=function(e,n){return 0}}kt.prototype=new Le,kt.prototype.constructor=kt;var sn=kt,Bt=at,Be=St,Mt=E;function $e(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.heuristic=t.heuristic||Bt.manhattan,this.weight=t.weight||1,this.trackRecursion=t.trackRecursion||!1,this.timeLimit=t.timeLimit||1/0,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Mt.OnlyWhenNoObstacles:this.diagonalMovement=Mt.IfAtMostOneObstacle:this.diagonalMovement=Mt.Never),this.diagonalMovement===Mt.Never?this.heuristic=t.heuristic||Bt.manhattan:this.heuristic=t.heuristic||Bt.octile}$e.prototype.findPath=function(t,e,n,i,a){var o=new Date().getTime(),s=function(g,u){return this.heuristic(Math.abs(u.x-g.x),Math.abs(u.y-g.y))}.bind(this),r=function(g,u){return g.x===u.x||g.y===u.y?1:Math.SQRT2},l=function(g,u,c,y,v){if(this.timeLimit>0&&new Date().getTime()-o>this.timeLimit*1e3)return 1/0;var M=u+s(g,d)*this.weight;if(M>c)return M;if(g==d)return y[v]=[g.x,g.y],g;var w,A,O,N,j=a.getNeighbors(g,this.diagonalMovement);for(O=0,w=1/0;N=j[O];++O){if(this.trackRecursion&&(N.retainCount=N.retainCount+1||1,N.tested!==!0&&(N.tested=!0)),A=l(N,u+r(g,N),c,y,v+1),A instanceof Be)return y[v]=[g.x,g.y],A;this.trackRecursion&&--N.retainCount===0&&(N.tested=!1),A<w&&(w=A)}return w}.bind(this),h=a.getNodeAt(t,e),d=a.getNodeAt(n,i),f=s(h,d),m,x,k;for(m=0;;++m){if(x=[],k=l(h,0,f,x,0),k===1/0)return[];if(k instanceof Be)return x;f=k}return[]};var rn=$e,ln=nt.exports,qe=S,He=at;function $t(t){t=t||{},this.heuristic=t.heuristic||He.manhattan,this.trackJumpRecursion=t.trackJumpRecursion||!1}$t.prototype.findPath=function(t,e,n,i,a){var o=this.openList=new ln(function(h,d){return h.f-d.f}),s=this.startNode=a.getNodeAt(t,e),r=this.endNode=a.getNodeAt(n,i),l;for(this.grid=a,s.g=0,s.f=0,o.push(s),s.opened=!0;!o.empty();){if(l=o.pop(),l.closed=!0,l===r)return qe.expandPath(qe.backtrace(r));this._identifySuccessors(l)}return[]},$t.prototype._identifySuccessors=function(t){var e=this.grid,n=this.heuristic,i=this.openList,a=this.endNode.x,o=this.endNode.y,s,r,l,h,d,f=t.x,m=t.y,x,k,g,u,c,y=Math.abs;for(s=this._findNeighbors(t),h=0,d=s.length;h<d;++h)if(r=s[h],l=this._jump(r[0],r[1],f,m),l){if(x=l[0],k=l[1],c=e.getNodeAt(x,k),c.closed)continue;g=He.octile(y(x-f),y(k-m)),u=t.g+g,(!c.opened||u<c.g)&&(c.g=u,c.h=c.h||n(y(x-a),y(k-o)),c.f=c.g+c.h,c.parent=t,c.opened?i.updateItem(c):(i.push(c),c.opened=!0))}};var At=$t,Ue=At,hn=E;function G(t){Ue.call(this,t)}G.prototype=new Ue,G.prototype.constructor=G,G.prototype._jump=function(t,e,n,i){var a=this.grid,o=t-n,s=e-i;if(!a.isWalkableAt(t,e))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(t,e).tested=!0),a.getNodeAt(t,e)===this.endNode)return[t,e];if(o!==0){if(a.isWalkableAt(t,e-1)&&!a.isWalkableAt(t-o,e-1)||a.isWalkableAt(t,e+1)&&!a.isWalkableAt(t-o,e+1))return[t,e]}else if(s!==0){if(a.isWalkableAt(t-1,e)&&!a.isWalkableAt(t-1,e-s)||a.isWalkableAt(t+1,e)&&!a.isWalkableAt(t+1,e-s))return[t,e];if(this._jump(t+1,e,t,e)||this._jump(t-1,e,t,e))return[t,e]}else throw new Error("Only horizontal and vertical movements are allowed");return this._jump(t+o,e+s,t,e)},G.prototype._findNeighbors=function(t){var e=t.parent,n=t.x,i=t.y,a=this.grid,o,s,r,l,h=[],d,f,m,x;if(e)o=e.x,s=e.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-s)/Math.max(Math.abs(i-s),1),r!==0?(a.isWalkableAt(n,i-1)&&h.push([n,i-1]),a.isWalkableAt(n,i+1)&&h.push([n,i+1]),a.isWalkableAt(n+r,i)&&h.push([n+r,i])):l!==0&&(a.isWalkableAt(n-1,i)&&h.push([n-1,i]),a.isWalkableAt(n+1,i)&&h.push([n+1,i]),a.isWalkableAt(n,i+l)&&h.push([n,i+l]));else for(d=a.getNeighbors(t,hn.Never),m=0,x=d.length;m<x;++m)f=d[m],h.push([f.x,f.y]);return h};var cn=G,Je=At,un=E;function z(t){Je.call(this,t)}z.prototype=new Je,z.prototype.constructor=z,z.prototype._jump=function(t,e,n,i){var a=this.grid,o=t-n,s=e-i;if(!a.isWalkableAt(t,e))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(t,e).tested=!0),a.getNodeAt(t,e)===this.endNode)return[t,e];if(o!==0&&s!==0){if(a.isWalkableAt(t-o,e+s)&&!a.isWalkableAt(t-o,e)||a.isWalkableAt(t+o,e-s)&&!a.isWalkableAt(t,e-s))return[t,e];if(this._jump(t+o,e,t,e)||this._jump(t,e+s,t,e))return[t,e]}else if(o!==0){if(a.isWalkableAt(t+o,e+1)&&!a.isWalkableAt(t,e+1)||a.isWalkableAt(t+o,e-1)&&!a.isWalkableAt(t,e-1))return[t,e]}else if(a.isWalkableAt(t+1,e+s)&&!a.isWalkableAt(t+1,e)||a.isWalkableAt(t-1,e+s)&&!a.isWalkableAt(t-1,e))return[t,e];return this._jump(t+o,e+s,t,e)},z.prototype._findNeighbors=function(t){var e=t.parent,n=t.x,i=t.y,a=this.grid,o,s,r,l,h=[],d,f,m,x;if(e)o=e.x,s=e.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-s)/Math.max(Math.abs(i-s),1),r!==0&&l!==0?(a.isWalkableAt(n,i+l)&&h.push([n,i+l]),a.isWalkableAt(n+r,i)&&h.push([n+r,i]),a.isWalkableAt(n+r,i+l)&&h.push([n+r,i+l]),a.isWalkableAt(n-r,i)||h.push([n-r,i+l]),a.isWalkableAt(n,i-l)||h.push([n+r,i-l])):r===0?(a.isWalkableAt(n,i+l)&&h.push([n,i+l]),a.isWalkableAt(n+1,i)||h.push([n+1,i+l]),a.isWalkableAt(n-1,i)||h.push([n-1,i+l])):(a.isWalkableAt(n+r,i)&&h.push([n+r,i]),a.isWalkableAt(n,i+1)||h.push([n+r,i+1]),a.isWalkableAt(n,i-1)||h.push([n+r,i-1]));else for(d=a.getNeighbors(t,un.Always),m=0,x=d.length;m<x;++m)f=d[m],h.push([f.x,f.y]);return h};var dn=z,Ve=At,pn=E;function K(t){Ve.call(this,t)}K.prototype=new Ve,K.prototype.constructor=K,K.prototype._jump=function(t,e,n,i){var a=this.grid,o=t-n,s=e-i;if(!a.isWalkableAt(t,e))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(t,e).tested=!0),a.getNodeAt(t,e)===this.endNode)return[t,e];if(o!==0&&s!==0){if(this._jump(t+o,e,t,e)||this._jump(t,e+s,t,e))return[t,e]}else if(o!==0){if(a.isWalkableAt(t,e-1)&&!a.isWalkableAt(t-o,e-1)||a.isWalkableAt(t,e+1)&&!a.isWalkableAt(t-o,e+1))return[t,e]}else if(s!==0&&(a.isWalkableAt(t-1,e)&&!a.isWalkableAt(t-1,e-s)||a.isWalkableAt(t+1,e)&&!a.isWalkableAt(t+1,e-s)))return[t,e];return a.isWalkableAt(t+o,e)&&a.isWalkableAt(t,e+s)?this._jump(t+o,e+s,t,e):null},K.prototype._findNeighbors=function(t){var e=t.parent,n=t.x,i=t.y,a=this.grid,o,s,r,l,h=[],d,f,m,x;if(e)if(o=e.x,s=e.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-s)/Math.max(Math.abs(i-s),1),r!==0&&l!==0)a.isWalkableAt(n,i+l)&&h.push([n,i+l]),a.isWalkableAt(n+r,i)&&h.push([n+r,i]),a.isWalkableAt(n,i+l)&&a.isWalkableAt(n+r,i)&&h.push([n+r,i+l]);else{var k;if(r!==0){k=a.isWalkableAt(n+r,i);var g=a.isWalkableAt(n,i+1),u=a.isWalkableAt(n,i-1);k&&(h.push([n+r,i]),g&&h.push([n+r,i+1]),u&&h.push([n+r,i-1])),g&&h.push([n,i+1]),u&&h.push([n,i-1])}else if(l!==0){k=a.isWalkableAt(n,i+l);var c=a.isWalkableAt(n+1,i),y=a.isWalkableAt(n-1,i);k&&(h.push([n,i+l]),c&&h.push([n+1,i+l]),y&&h.push([n-1,i+l])),c&&h.push([n+1,i]),y&&h.push([n-1,i])}}else for(d=a.getNeighbors(t,pn.OnlyWhenNoObstacles),m=0,x=d.length;m<x;++m)f=d[m],h.push([f.x,f.y]);return h};var fn=K,Ge=At,yn=E;function Q(t){Ge.call(this,t)}Q.prototype=new Ge,Q.prototype.constructor=Q,Q.prototype._jump=function(t,e,n,i){var a=this.grid,o=t-n,s=e-i;if(!a.isWalkableAt(t,e))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(t,e).tested=!0),a.getNodeAt(t,e)===this.endNode)return[t,e];if(o!==0&&s!==0){if(a.isWalkableAt(t-o,e+s)&&!a.isWalkableAt(t-o,e)||a.isWalkableAt(t+o,e-s)&&!a.isWalkableAt(t,e-s))return[t,e];if(this._jump(t+o,e,t,e)||this._jump(t,e+s,t,e))return[t,e]}else if(o!==0){if(a.isWalkableAt(t+o,e+1)&&!a.isWalkableAt(t,e+1)||a.isWalkableAt(t+o,e-1)&&!a.isWalkableAt(t,e-1))return[t,e]}else if(a.isWalkableAt(t+1,e+s)&&!a.isWalkableAt(t+1,e)||a.isWalkableAt(t-1,e+s)&&!a.isWalkableAt(t-1,e))return[t,e];return a.isWalkableAt(t+o,e)||a.isWalkableAt(t,e+s)?this._jump(t+o,e+s,t,e):null},Q.prototype._findNeighbors=function(t){var e=t.parent,n=t.x,i=t.y,a=this.grid,o,s,r,l,h=[],d,f,m,x;if(e)o=e.x,s=e.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(i-s)/Math.max(Math.abs(i-s),1),r!==0&&l!==0?(a.isWalkableAt(n,i+l)&&h.push([n,i+l]),a.isWalkableAt(n+r,i)&&h.push([n+r,i]),(a.isWalkableAt(n,i+l)||a.isWalkableAt(n+r,i))&&h.push([n+r,i+l]),!a.isWalkableAt(n-r,i)&&a.isWalkableAt(n,i+l)&&h.push([n-r,i+l]),!a.isWalkableAt(n,i-l)&&a.isWalkableAt(n+r,i)&&h.push([n+r,i-l])):r===0?a.isWalkableAt(n,i+l)&&(h.push([n,i+l]),a.isWalkableAt(n+1,i)||h.push([n+1,i+l]),a.isWalkableAt(n-1,i)||h.push([n-1,i+l])):a.isWalkableAt(n+r,i)&&(h.push([n+r,i]),a.isWalkableAt(n,i+1)||h.push([n+r,i+1]),a.isWalkableAt(n,i-1)||h.push([n+r,i-1]));else for(d=a.getNeighbors(t,yn.IfAtMostOneObstacle),m=0,x=d.length;m<x;++m)f=d[m],h.push([f.x,f.y]);return h};var gn=Q,qt=E,mn=cn,xn=dn,vn=fn,bn=gn;function wn(t){return t=t||{},t.diagonalMovement===qt.Never?new mn(t):t.diagonalMovement===qt.Always?new xn(t):t.diagonalMovement===qt.OnlyWhenNoObstacles?new vn(t):new bn(t)}var kn=wn,Mn={Heap:nt.exports,Node:St,Grid:Ji,Util:S,DiagonalMovement:E,Heuristic:at,AStarFinder:Dt,BestFirstFinder:Zi,BreadthFirstFinder:en,DijkstraFinder:nn,BiAStarFinder:Ft,BiBestFirstFinder:an,BiBreadthFirstFinder:on,BiDijkstraFinder:sn,IDAStarFinder:rn,JumpPointFinder:kn};(function(t){t.exports=Mn})(Ce);const ze=ci(Ce.exports),An=new ze.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0}),Ht=(t,e)=>{const{walkableTileMatrix:n}=p.tileMap,i=new ze.Grid(n);return An.findPath(t.y,t.x,e.y,e.x,i)},Ke=(t,e)=>{const{entityMap:n}=p;let i=null,a,o,s;t.isMoving=!1;const r=d=>{if(t.isMoving){const f=e*d,m=f*Math.cos(i),x=f*Math.sin(i);t.position.x+=m,t.position.y+=x;const k=a.x-t.position.x,g=a.y-t.position.y,u=k>0!==o,c=g>0!==s;(u||c)&&(t.position.x=a.x,t.position.y=a.y,t.path.length>1?(t.path.shift(),h()):t.isMoving=!1),n.removeEntity({tileIndex:t.tileIndex,id:t.id}),t.tileIndex=xe({x:t.position.x+P/2,y:t.position.y+T/2}),n.addEntity({tileIndex:t.tileIndex,id:t.id,render:t.render})}},l=()=>{t.isMoving=!1,t.path=[]},h=()=>{const[d]=t.path,[f,m]=d,x={x:m,y:f};if(_(x)){a=L(x);const k=a.x-t.position.x,g=a.y-t.position.y;o=k>0,s=g>0,i=Math.atan2(g,k)}else l()};return{move:r,requestMove:d=>{const f=Ht(t.tileIndex,d),m=d.x===t.tileIndex.x&&d.y===t.tileIndex.y;!t.isMoving&&!m&&f.length&&(t.path=f,t.path.shift(),h(),t.isMoving=!0)},unsetPath:l}};class Wn extends It{constructor(){super({sprite:F.playerTokens.angel,haloColor:"lime"}),this.path=[];const e=Ke(this,Ti),n={editMode:e.move,playMode:e.move};this.update=i=>{n[p.mode](i),this.redraw()},this.requestMove=e.requestMove,this.unsetPath=e.unsetPath}}class Cn extends It{constructor(n){super(n);Y(this,"pickPath",()=>{const{pathFinder:n,tileIndex:i}=this,a={x:Ae(i.x,10),y:Ae(i.y,10)};_(a)&&n.requestMove(a)});Y(this,"update",n=>{const{pathFinder:i,pickPath:a,redraw:o,isMoving:s}=this;p.mode!=="editMode"&&(s||a(),i.move(n)),o()});this.path=[],this.pathFinder=Ke(this,Ii)}}const On=t=>{const e={};e.entities=[];const{xTiles:n,yTiles:i}=t;for(let a=0;a<n;a++){e.entities[a]=[];for(let o=0;o<i;o++)e.entities[a][o]={}}return e.addEntity=({tileIndex:a,id:o,render:s})=>{e.entities[a.x][a.y][o]=s,R(a,1)},e.entityCheck=({x:a,y:o})=>{const s=e.entities[a][o];return Object.keys(s).length===0},e.removeEntity=({tileIndex:a,id:o})=>{const{x:s,y:r}=a,l=e.entities[s][r];if(delete l[o],Object.keys(l).length===0){const h=t.tiles[s][r].walkable;R(a,h)}},e},Ut=(t,e)=>{var o;const{tileMap:n,entityMap:i}=p,a=(o=n.tiles[t])==null?void 0:o[e];if(a){const{feature:s}=a,r=L({x:t,y:e}),l=i.entities[t][e];for(const h in l)l[h]();if(s){const{set:h,color:d,variant:f}=s,m=Ot(h,d,f);p.entityCtx.drawImage(m.data,r.x,r.y-m.yOffset),p.entityCtx.globalAlpha=.5;for(const x in l)l[x]();p.entityCtx.globalAlpha=1}}},C={x:0,y:0,buttonCode:0,onMouseUp:null,onMouseMove:null,isDragged:!1,dragStart:{x:0,y:0},drag:{x:0,y:0}},Nn=t=>(t.addEventListener("contextmenu",e=>e.preventDefault()),t.onmousemove=e=>{const{translate:n}=p.view,{left:i,top:a}=e.target.getBoundingClientRect();C.x=e.clientX-i-n.x,C.y=e.clientY-a-n.y,C.buttonCode===1&&(C.isDragged=!0,C.drag.x=C.dragStart.x-C.x-n.x,C.drag.y=C.dragStart.y-C.y-n.y),C.onMouseMove&&C.onMouseMove()},t.onmousedown=e=>{e.preventDefault(),C.buttonCode=e.which,C.dragStart.x=C.x,C.dragStart.y=C.y,C.drag.x=0,C.drag.y=0},document.onmouseup=()=>{C.onMouseUp&&C.onMouseUp(),C.isDragged=!1,C.buttonCode=0},t.onmouseleave=()=>{C.isDragged=!1,C.buttonCode=0},C),ot={},Qe={keyDown:()=>{}};document.addEventListener("keydown",t=>{const{keyDown:e}=Qe;ot[t.code]=!0,e(t.code,t)}),document.addEventListener("keyup",t=>{ot[t.code]=!1});const Tn=()=>{Object.keys(ot).forEach(t=>{ot[t]=!1})},st=function(t){return ot[t]||!1},In=()=>b.h("div",{id:"ui"},p.mode==="editMode"?b.h(bi,null):null),Sn=()=>{ui.replaceWith(In())},Jt={},Wt=()=>{};Jt.set=()=>{const{hoveredTile:t,mouse:e,player:n}=p;he(),e.onMouseMove=()=>{e.buttonCode===1&&ei(-e.drag.x,-e.drag.y)},e.onMouseUp=()=>{e.buttonCode===1&&t.tileIndex&&!e.isDragged&&n.requestMove(t.tileIndex),Mi()},p.onFrameControls=i=>{ti(i),t.tileIndex=ve({x:e.x,y:e.y}),t.tileIndex?(e.isDragged?p.canvas.style.cursor="grabbing":p.canvas.style.cursor="pointer",t.path=Ht(n.tileIndex,t.tileIndex),e.buttonCode===3&&ki(t.tileIndex)):p.canvas.style.cursor="default"},p.effectsMiddle=()=>{t.tileIndex&&t.path.forEach(i=>{et({x:i[1],y:i[0]},Ci)})},p.effectsTop=()=>{t.tileIndex&&(t.path.forEach(i=>{et({x:i[1],y:i[0]},Oi)}),et(t.tileIndex,pt))}},Jt.unset=()=>{const{mouse:t,player:e}=p;e.unsetPath(),t.onMouseMove=Wt,t.onMouseUp=Wt,p.effectsMiddle=Wt,p.effectsTop=Wt};const Vt={},Ct=()=>{};Vt.set=()=>{const{hoveredTile:t,mouse:e,player:n,ctx:i}=p;e.onMouseMove=()=>{e.buttonCode===1&&ei(-e.drag.x,-e.drag.y)},e.onMouseUp=()=>{e.buttonCode===1&&t.tileIndex&&!e.isDragged&&n.requestMove(t.tileIndex)},p.onFrameControls=a=>{ti(a),t.tileIndex=ve({x:e.x,y:e.y}),t.tileIndex?(e.isDragged?p.canvas.style.cursor="grabbing":p.canvas.style.cursor="pointer",t.path=Ht(n.tileIndex,t.tileIndex)):p.canvas.style.cursor="default"},p.effectsMiddle=()=>{n.isMoving?yt(n.path,"lime"):t.tileIndex&&yt(t.path,"lime")},p.effectsTop=()=>{if(n.isMoving){if(yt(n.path,"rgba(50, 205, 50, 0.5)",!0,"lime"),t.tileIndex)if(_(t.tileIndex)){const a=L(t.tileIndex);ft(a,pt,Nt,i)}else et(t.tileIndex,pt)}else if(t.tileIndex&&(yt(t.path,"rgba(50, 205, 50, 0.5)"),t.tileIndex))if(_(t.tileIndex)){const a=L(t.tileIndex);ft(a,"lime",Nt,i)}else et(t.tileIndex,pt)}},Vt.unset=()=>{const{mouse:t,player:e}=p;e.unsetPath(),t.onMouseMove=Ct,t.onMouseUp=Ct,p.effectsMiddle=Ct,p.effectsTop=Ct};const Xe=()=>{const{paused:t,stop:e,restart:n}=I;t?(n(),document.body.classList.remove("paused")):(e(),document.body.classList.add("paused"))},Pn=()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():canvasRoot.requestFullscreen()};Qe.keyDown=t=>{switch(t){case"Space":Xe();break;case"Enter":st("ControlLeft")&&Pn();break;default:return}},document.addEventListener("visibilitychange",()=>{const{stop:t}=I;document.visibilityState==="hidden"?(t(),document.body.classList.add("paused")):document.visibilityState==="visible"&&Tn()});const Ye={editMode:Jt,playMode:Vt},Ze=t=>{Ye[p.mode].unset(),p.mode=t,Sn(),Ye[t].set()},En=()=>{const{view:t}=p,{xTiles:e,yTiles:n}=t;for(let i=e-1;i>-1;i--)for(let a=0;a<n;a++)ji(i,a),Ut(i,a)},X=150,J=70,jn=100,Dn=()=>{const t=document.createElement("canvas"),e=t.getContext("2d",{willReadFrequently:!0});t.classList.add("monitor"),t.width=X,t.height=J,canvasRoot.appendChild(t),e.strokeStyle="#ff0000";let n=e.getImageData(0,0,X,J);return i=>{e.clearRect(0,0,X,J),e.putImageData(n,-1,0);const a=J-i/jn*J;e.beginPath(),e.moveTo(X,J),e.lineTo(X,a),e.stroke(),n=e.getImageData(0,0,X,J)}},p={};p.start=async t=>{p.canvas=document.createElement("canvas"),p.ctx=p.canvas.getContext("2d"),canvasRoot.appendChild(p.canvas),p.monitor=Dn(),p.floorCanvas=new OffscreenCanvas(0,0),p.floorCtx=p.floorCanvas.getContext("2d"),p.entityCanvas=new OffscreenCanvas(0,0),p.entityCtx=p.entityCanvas.getContext("2d"),p.effectsMiddle=()=>{},p.effectsTop=()=>{},p.mouse=Nn(p.canvas),p.view=be({xTiles:dt,yTiles:dt}),p.hoveredTile={path:null,tileIndex:null},p.mode="playMode",mode.onchange=()=>{const e=mode.elements.mode.value;Ze(e)},Li();try{const e=await hi(t);p.loadMap(e)}catch{const e=ri({xTiles:dt,yTiles:dt});p.loadMap(e)}I.start(we)},p.loadMap=t=>{const{entityList:e,unitStart:n={x:1,y:1}}=t;p.tileMap=t,p.entityMap=On(t),p.entities=[],p.player=new Wn,p.player.addToScene(n),e&&e.forEach(i=>{const{name:a,tileIndex:o}=i;switch(a){case"entity":new It({}).addToScene(o);break;case"npc":new Cn({sprite:F.playerTokens.despoiler,haloColor:"red"}).addToScene(o);break}}),Ze(p.mode),p.view.setApertureSize(),En()},p.setView=be;let Gt=0,zt=0;const ti=t=>{const{translate:e}=p.view,n=st("KeyW"),i=st("KeyS"),a=st("KeyD"),o=st("KeyA");Gt+=fe*t*(a-o),zt+=fe*t*(i-n),e.x-=Gt,e.y-=zt,Gt*=pe,zt*=pe,p.ctx.setTransform(1,0,0,1,e.x,e.y)},ei=(t,e)=>{const{translate:n}=p.view;n.x=t,n.y=e,p.ctx.setTransform(1,0,0,1,t,e)},Kt=P,Qt=T*3,_n=T*1.5,ii=(t,e)=>{const{x:n,y:i}=e;t.save(),t.beginPath(),t.rect(n,i,Kt,Qt),t.clip(),t.clearRect(n,i,Kt,Qt)},Rn=t=>{const{floorCtx:e,entityCtx:n,tileMap:i}=p,a=L({x:t.x,y:t.y});a.y-=_n,ii(e,a),ii(n,a),Bn.forEach(o=>{var l;const s=o.x+t.x,r=o.y+t.y;if((l=i.tiles[s])!=null&&l[r]){const h=i.tiles[s][r];if(h.floor){const{set:d,color:f,variant:m}=h.floor;me({x:s,y:r,image:Ot(d,f,m)})}Ut(s,r)}}),n.restore(),e.restore()},Fn=(t,e,n)=>{const{entityCtx:i}=p,a={x:Math.floor(Math.min(e.x,n.x)),y:Math.floor(Math.min(e.y,n.y)-T*2)},o=Math.ceil(Math.abs(e.x-n.x)+Kt),s=Math.ceil(Math.abs(e.y-n.y)+Qt),{x:r,y:l}=a;i.save(),i.beginPath(),i.rect(r,l,o,s),i.clip(),i.clearRect(r,l,o,s),Ln.forEach(h=>{const d=h.x+t.x,f=h.y+t.y;Ut(d,f)}),i.restore()},Ln=[{x:3,y:-3},{x:3,y:-2},{x:3,y:-1},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:2,y:0},{x:1,y:-3},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:0},{x:-2,y:1},{x:-3,y:1},{x:-2,y:2},{x:-1,y:3},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Bn=[{x:3,y:-3},{x:3,y:-2},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:1},{x:-2,y:2},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],$n=()=>b.h("div",null,b.h("div",{id:"pauseMenu"},b.h("div",{class:"pause-menu-items"},b.h("p",null,"Paused"),b.h("ul",null,b.h("li",null,b.h("button",{onclick:Xe},"Resume")),b.h("li",null,b.h("button",{id:"loadButton"},"Load")),b.h("li",null,b.h("button",{class:"save",id:"saveButton"},"Save"),b.h("input",{type:"text",id:"saveName",value:"tile-map"})))))),qn=()=>b.h("div",{class:"toolbar"},b.h("form",{id:"mode",name:"mode",class:"margin-right-10"},b.h("input",{type:"radio",id:"playRadio",value:"playMode",class:"margin-right-10",name:"mode",checked:!0}),b.h("label",{for:"playRadio"},"Play Mode"),b.h("input",{type:"radio",id:"editModeRadio",value:"editMode",class:"margin-left-10 margin-right-10",name:"mode"}),b.h("label",{for:"editModeRadio"},"Edit Mode"))),Hn=()=>b.h("div",{class:"wrapper"},b.h(qn,null),b.h("div",{id:"canvasRoot"},b.h("div",{id:"ui"}),b.h($n,null)));root.replaceWith(Hn()),p.start("vista"),window.dump=()=>console.log(p)})();
