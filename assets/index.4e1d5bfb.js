var sn=Object.defineProperty;var on=(e,t,n)=>t in e?sn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var q=(e,t,n)=>(on(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();var X=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function an(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var w={},pt={},L={};Object.defineProperty(L,"__esModule",{value:!0});L.isSvgTag=L.applyChildren=L.setElementStyle=void 0;function rn(e,t){let n;const s=Object.keys(t);for(n of s)e.style[n]=t[n]}L.setElementStyle=rn;function Qe(e,t){t instanceof HTMLElement?e.appendChild(t):typeof t=="string"||typeof t=="number"?e.appendChild(document.createTextNode(t.toString())):console.warn("Unknown type to append: ",t)}function gt(e,t){for(const n of t)if(!(!n&&n!==0))if(Array.isArray(n))for(const s of n)Array.isArray(s)?gt(e,s):Qe(e,s);else Qe(e,n)}L.applyChildren=gt;function ln(e){return["a","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","path","pattern","polygon","polyline","radialGradient","rect","script","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"].includes(e)}L.isSvgTag=ln;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.h=e.xlinkNS=void 0;const t=L;e.xlinkNS="http://www.w3.org/1999/xlink";function n(s,i,...o){if(typeof s=="function")return s(Object.assign(Object.assign({},i),{children:o}));const a=t.isSvgTag(s),r=a?document.createElementNS("http://www.w3.org/2000/svg",s):document.createElement(s);if(i){i.style&&typeof i.style!="string"&&(t.setElementStyle(r,i.style),delete i.style);for(const l of Object.keys(i)){const u=i[l];if(l.startsWith("on")){const h=l.replace(/Capture$/,""),p=l!==h,v=h.toLowerCase().substring(2);r.addEventListener(v,u,p)}else a&&l.startsWith("xlink:")?r.setAttributeNS(e.xlinkNS,l,u):u===!0?r.setAttribute(l,l):(u||u===0)&&r.setAttribute(l,u.toString())}}return t.applyChildren(r,o),r}e.h=n})(pt);var vt={};Object.defineProperty(vt,"__esModule",{value:!0});(function(e){var t=X&&X.__createBinding||(Object.create?function(s,i,o,a){a===void 0&&(a=o),Object.defineProperty(s,a,{enumerable:!0,get:function(){return i[o]}})}:function(s,i,o,a){a===void 0&&(a=o),s[a]=i[o]}),n=X&&X.__exportStar||function(s,i){for(var o in s)o!=="default"&&!Object.prototype.hasOwnProperty.call(i,o)&&t(i,s,o)};Object.defineProperty(e,"__esModule",{value:!0}),n(pt,e),n(vt,e)})(w);const me=({x:e,y:t})=>{var s,i;const{tileMap:n}=f;return((i=(s=n.walkableTileMatrix)==null?void 0:s[e])==null?void 0:i[t])===0},Xe=({x:e,y:t},n)=>{const{tileMap:s}=f;s.walkableTileMatrix[e][t]=n},un="modulepreload",cn=function(e){return"/tiles/"+e},Ze={},dn=function(t,n,s){return!n||n.length===0?t():Promise.all(n.map(i=>{if(i=cn(i),i in Ze)return;Ze[i]=!0;const o=i.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${a}`))return;const r=document.createElement("link");if(r.rel=o?"stylesheet":un,o||(r.as="script",r.crossOrigin=""),r.href=i,document.head.appendChild(r),o)return new Promise((l,u)=>{r.addEventListener("load",l),r.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${i}`)))})})).then(()=>t())},fn=(e,t)=>{const n=e[t];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((s,i)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(i.bind(null,new Error("Unknown variable dynamic import: "+t)))})},O=e=>new Promise(t=>{let n=new Image;n.onload=()=>t(n),n.src=e}),F={},C="/tiles/src/images/";F.load=async()=>{F.terracotta=[{yOffset:0,data:await O(`${C}terracotta1.png`)},{yOffset:0,data:await O(`${C}terracotta2.png`)},{yOffset:0,data:await O(`${C}terracotta3.png`)},{yOffset:0,data:await O(`${C}terracotta4.png`)}],F.cube=[{yOffset:33,data:await O(`${C}cube1.png`)},{yOffset:33,data:await O(`${C}cube2.png`)},{yOffset:33,data:await O(`${C}cube3.png`)}],F.grass=[{yOffset:2,data:await O(`${C}grass1.png`)},{yOffset:2,data:await O(`${C}grass2.png`)},{yOffset:2,data:await O(`${C}grass3.png`)},{yOffset:2,data:await O(`${C}grass4.png`)}],F.water=[{yOffset:-3,data:await O(`${C}water1.png`)},{yOffset:-3,data:await O(`${C}water2.png`)}],F.mountain=[{yOffset:14,data:await O(`${C}mountain1.png`)},{yOffset:12,data:await O(`${C}mountain2.png`)},{yOffset:14,data:await O(`${C}mountain3.png`)}],F.mountainTop=[{yOffset:14,data:await O(`${C}mountain1-top.png`)},{yOffset:12,data:await O(`${C}mountain2-top.png`)},{yOffset:14,data:await O(`${C}mountain3-top.png`)}],F.forest=[{yOffset:15,data:await O(`${C}trees1.png`)},{yOffset:15,data:await O(`${C}trees2.png`)},{yOffset:15,data:await O(`${C}trees3.png`)},{yOffset:15,data:await O(`${C}trees4.png`)}],F.forestTop=[{yOffset:15,data:await O(`${C}trees1-top.png`)},{yOffset:15,data:await O(`${C}trees2-top.png`)},{yOffset:15,data:await O(`${C}trees3-top.png`)},{yOffset:15,data:await O(`${C}trees4-top.png`)}],F.playerTokens={angel:{yOffset:51,data:await O(`${C}pt-angel.png`)},despoiler:{yOffset:51,data:await O(`${C}pt-despoiler.png`)},sheild:{yOffset:48,data:await O(`${C}pt-sheild.png`)}}};const ge=new OffscreenCanvas(0,0),et=ge.getContext("2d"),hn=(e,t)=>{const{data:n,data:{width:s,height:i},yOffset:o}=e;ge.width=s,ge.height=i;const a=n;return et.filter=`hue-rotate(${t}deg)`,et.drawImage(a,0,0),{data:ge,yOffset:o}},Le=(e,t,n)=>{const s=F[e][n];return hn(s,t)},ae=e=>Math.floor(Math.random()*F[e].length),pn=({xTiles:e,yTiles:t})=>{const n={tiles:[],walkableTileMatrix:[],xTiles:e,yTiles:t};for(let s=0;s<e;s++){n.tiles[s]=[],n.walkableTileMatrix[s]=[];for(let i=0;i<t;i++)n.tiles[s][i]={}}for(let s=0;s<e;s++)for(let i=0;i<t;i++)yt({x:s,y:i},n,"grass");return n},yt=(e,t,n,s,i=null)=>{const{floor:o,feature:a,walkable:r,type:l}=U[n],{x:u,y:h}=e,p=t.tiles[u][h];switch(l){case"void":p.floor=null,p.feature=null;break;case"obstacle":case"floor":p.floor={set:o,variant:i||ae(o),color:(s==null?void 0:s[l])||0},p.feature=null;break;case"linked":const v=i||ae(o);p.floor={set:o,variant:v,color:(s==null?void 0:s.floor)||0},p.feature={set:a,variant:v,color:(s==null?void 0:s.feature)||0};break;case"feature":p.feature={set:a,variant:i||ae(a),color:(s==null?void 0:s.feature)||0},(p.type==="void"||p.type==="linked"||p.type==="obstacle")&&(p.floor={set:o,variant:ae(o),color:s==null?void 0:s.feature});break}p.type=l,p.walkable=r,t.walkableTileMatrix[u][h]=r},gn=()=>{const{tileMap:e,entities:t}=f;return e.entityList=[],t.forEach(n=>{const{constructor:{name:s},tileIndex:i}=n;s==="unit"?e.unitStart=i:e.entityList.push({name:s,tileIndex:i})}),"data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e))},vn=async e=>{const t=JSON.stringify(await fn(Object.assign({"../../maps/vista.json":()=>dn(()=>import("./vista.a258ec57.js"),[])}),`../../maps/${e}.json`));return mt(t)},mt=e=>JSON.parse(e);let ve={};const yn=e=>{if(e.x!==ve.x||e.y!==ve.y){const{tileMap:t}=f,n=En(),{set:s,colors:i,variant:o,type:a}=n,r=f.entityMap.entities[e.x][e.y];Object.keys(r).length!==0&&a!=="floor"||(yt(e,t,s,i,o),Hi(e))}ve=e},mn=()=>{ve={}},P=64,T=32,re=32,bn=32,tt=128,wn="rgba(255,255,255,0.1)",ye="rgba(255,255,0,0.6)",Mn="yellow",kn="rgba(255,0,0,0.2)",An="yellow",nt=.8,it=.12,xn=.18,On=.08,bt=P/2,wt=T/2,Cn=T/P,Nn=6.28319,_e=20,Wn=({x:e,y:t,strokeColor:n,fillColor:s})=>{const{ctx:i}=f,o=B({x:e,y:t});i.strokeStyle=n,i.fillStyle=s,i.beginPath(),i.moveTo(o.x,o.y+T/2),i.lineTo(o.x+P/2,o.y),i.lineTo(o.x+P,o.y+T/2),i.lineTo(o.x+P/2,o.y+T),i.closePath(),i.fill(),i.stroke()},U={mountain:{displayName:"Mountains",walkable:1,floor:"mountain",feature:"mountainTop",type:"linked"},forest:{displayName:"Forest",walkable:0,floor:"forest",feature:"forestTop",type:"linked"},terracotta:{displayName:"Terracotta Floor",walkable:0,floor:"terracotta",type:"floor"},grass:{displayName:"Grass",walkable:0,floor:"grass",type:"floor"},cube:{displayName:"Cube",walkable:1,feature:"cube",floor:"terracotta",type:"feature"},water:{displayName:"Water",walkable:1,floor:"water",type:"obstacle"},void:{displayName:"Void",walkable:1,type:"void"}},Mt=({x:e,y:t,image:n})=>{const{floorCtx:s}=f,i=B({x:e,y:t});s.drawImage(n.data,i.x,i.y-n.yOffset)},Sn=(e,t)=>{const{tileMap:n}=f,s=n.tiles[e][t];if(s.floor){const{set:i,color:o,variant:a}=s.floor;Mt({x:e,y:t,image:Le(i,o,a)})}},kt=({x:e,y:t})=>{const{origin:n}=f.view;return{x:Math.floor((e-n.x)/P-(t-n.y-T/2)/T),y:Math.floor((t-n.y-T/2)/T+(e-n.x)/P)}},B=({x:e,y:t})=>{const{origin:n}=f.view;return{x:e*P/2+t*P/2+n.x,y:t*T/2-e*T/2+n.y}},At=e=>{const{tileMap:t}=f,{x:n,y:s}=kt(e);return t.tiles[n]&&t.tiles[n][s]?{x:n,y:s}:null},te=(e,t)=>{const{x:n,y:s}=e;Wn({x:n,y:s,strokeColor:t,fillColor:wn})},Tn=5,Fn=6,be=2,st=4,xt={},Ot={};let[E]=Object.keys(U),ne=U[E].type,G;console.log(G);let R=[];const Ct=e=>{E=(e==null?void 0:e.target.value)||E,ne=U[E].type,G=F[E],spriteDisplay.replaceWith(Nt()),ne!=="void"&&Wt()},Nt=()=>{switch(ne){case"void":return w.h("div",{id:"spriteDisplay",class:"spriteDisplay--void"},w.h("div",{class:"brush"},w.h("div",{class:"void-brush"},"X"),w.h("span",null,"Delete tiles")));case"linked":const{floor:e,feature:t}=U[E];R={floor:e,feature:t};break;default:R={[ne]:E};break}return w.h("div",{id:"spriteDisplay"},w.h(Pn,null))},Dn=()=>Ot[E]={width:Math.max(...G.map(e=>e.data.width))+Tn,height:Math.max(...G.map(e=>e.data.height))+Fn},Wt=()=>{const e=tilePainter.elements;Object.keys(R).forEach(t=>{const n=R[t],s=e[`${t}Hue`],i=document.getElementById(`${t}HueRotaion`),o=s.value;i.innerText=xt[n]=o,F[n].forEach((a,r)=>{const u=document.getElementById(`tileCanv${r}`).getContext("2d");u.filter=`hue-rotate(${o}deg)`;const h=F[n][r].data;u.drawImage(h,st,st)})})},$n=e=>{const{tileSet:t,tiles:n,label:s,type:i}=e;return w.h("div",null,w.h("div",null,w.h("label",{for:`${i}Hue`},s,": "),w.h("span",{id:`${i}HueRotaion`},"0")),w.h("input",{id:`${i}Hue`,class:"hue-slider",type:"range",min:"-180",max:"180",step:"1","tile-type":i,value:xt[t]||0,onInput:()=>{Wt()}}))},In=e=>{const{width:t,height:n,index:s}=e;return w.h("div",{class:"brush"},w.h("canvas",{id:`tileCanv${s}`,width:t+be,height:n+be}),w.h("input",{type:"radio",value:s,name:"tileVariant",style:{width:`${t}px`,height:`${n}px`}}))},Pn=()=>{const{width:e,height:t}=Ot[E]||Dn(),n=Object.keys(R);return w.h("div",null,w.h("div",{class:"sprite-brushes"},w.h("div",{class:"brush"},w.h("div",{class:"random-tile-brush",style:{width:`${e+be}px`,height:`${t+be}px`}},w.h("div",null,"?")),w.h("input",{checked:!0,type:"radio",value:"random",name:"tileVariant",style:{width:`${e}px`,height:`${t}px`}})),G.map((s,i)=>w.h(In,{width:e,height:t,index:i}))),n.map(s=>w.h($n,{tileSet:R[s],label:n.length>1?s+" Hue":"Hue",tiles:R,type:s})))},_n=()=>(G=F[E],w.h("form",{id:"tilePainter"},w.h("select",{id:"terrainType",name:"terrainType",onChange:Ct},Object.keys(U).map(e=>w.h("option",{selected:E===e,value:e},U[e].displayName))),w.h(Nt,null))),En=()=>{var i;const e=tilePainter.elements,t={};Object.keys(R).forEach(o=>{const a=e[`${o}Hue`];t[o]=(a==null?void 0:a.value)||null});let n=null;const s=(i=e.tileVariant)==null?void 0:i.value;return s!=="random"&&(n=s||null),{set:terrainType.value,type:ne,variant:n,colors:t}},Bn=()=>w.h("div",{id:"ui"},f.mode==="editMode"?w.h(_n,null):null),jn=()=>{ui.replaceWith(Bn())},ie={},St={keyDown:()=>{}};document.addEventListener("keydown",e=>{const{keyDown:t}=St;ie[e.code]=!0,t(e.code,e)});document.addEventListener("keyup",e=>{ie[e.code]=!1});const Ln=()=>{Object.keys(ie).forEach(e=>{ie[e]=!1})},Z=function(e){return ie[e]||!1};var Tt={exports:{}},se={exports:{}},Ft={exports:{}};(function(e){(function(){var t,n,s,i,o,a,r,l,u,h,p,v,m,k,y;s=Math.floor,h=Math.min,n=function(c,d){return c<d?-1:c>d?1:0},u=function(c,d,g,b,A){var M;if(g==null&&(g=0),A==null&&(A=n),g<0)throw new Error("lo must be non-negative");for(b==null&&(b=c.length);g<b;)M=s((g+b)/2),A(d,c[M])<0?b=M:g=M+1;return[].splice.apply(c,[g,g-g].concat(d)),d},a=function(c,d,g){return g==null&&(g=n),c.push(d),k(c,0,c.length-1,g)},o=function(c,d){var g,b;return d==null&&(d=n),g=c.pop(),c.length?(b=c[0],c[0]=g,y(c,0,d)):b=g,b},l=function(c,d,g){var b;return g==null&&(g=n),b=c[0],c[0]=d,y(c,0,g),b},r=function(c,d,g){var b;return g==null&&(g=n),c.length&&g(c[0],d)<0&&(b=[c[0],d],d=b[0],c[0]=b[1],y(c,0,g)),d},i=function(c,d){var g,b,A,M,x,W;for(d==null&&(d=n),M=function(){W=[];for(var S=0,I=s(c.length/2);0<=I?S<I:S>I;0<=I?S++:S--)W.push(S);return W}.apply(this).reverse(),x=[],b=0,A=M.length;b<A;b++)g=M[b],x.push(y(c,g,d));return x},m=function(c,d,g){var b;if(g==null&&(g=n),b=c.indexOf(d),b!==-1)return k(c,0,b,g),y(c,b,g)},p=function(c,d,g){var b,A,M,x,W;if(g==null&&(g=n),A=c.slice(0,d),!A.length)return A;for(i(A,g),W=c.slice(d),M=0,x=W.length;M<x;M++)b=W[M],r(A,b,g);return A.sort(g).reverse()},v=function(c,d,g){var b,A,M,x,W,S,I,J,Ce;if(g==null&&(g=n),d*10<=c.length){if(M=c.slice(0,d).sort(g),!M.length)return M;for(A=M[M.length-1],I=c.slice(d),x=0,S=I.length;x<S;x++)b=I[x],g(b,A)<0&&(u(M,b,0,null,g),M.pop(),A=M[M.length-1]);return M}for(i(c,g),Ce=[],W=0,J=h(d,c.length);0<=J?W<J:W>J;0<=J?++W:--W)Ce.push(o(c,g));return Ce},k=function(c,d,g,b){var A,M,x;for(b==null&&(b=n),A=c[g];g>d;){if(x=g-1>>1,M=c[x],b(A,M)<0){c[g]=M,g=x;continue}break}return c[g]=A},y=function(c,d,g){var b,A,M,x,W;for(g==null&&(g=n),A=c.length,W=d,M=c[d],b=2*d+1;b<A;)x=b+1,x<A&&!(g(c[b],c[x])<0)&&(b=x),c[d]=c[b],d=b,b=2*d+1;return c[d]=M,k(c,W,d,g)},t=function(){c.push=a,c.pop=o,c.replace=l,c.pushpop=r,c.heapify=i,c.updateItem=m,c.nlargest=p,c.nsmallest=v;function c(d){this.cmp=d!=null?d:n,this.nodes=[]}return c.prototype.push=function(d){return a(this.nodes,d,this.cmp)},c.prototype.pop=function(){return o(this.nodes,this.cmp)},c.prototype.peek=function(){return this.nodes[0]},c.prototype.contains=function(d){return this.nodes.indexOf(d)!==-1},c.prototype.replace=function(d){return l(this.nodes,d,this.cmp)},c.prototype.pushpop=function(d){return r(this.nodes,d,this.cmp)},c.prototype.heapify=function(){return i(this.nodes,this.cmp)},c.prototype.updateItem=function(d){return m(this.nodes,d,this.cmp)},c.prototype.clear=function(){return this.nodes=[]},c.prototype.empty=function(){return this.nodes.length===0},c.prototype.size=function(){return this.nodes.length},c.prototype.clone=function(){var d;return d=new c,d.nodes=this.nodes.slice(0),d},c.prototype.toArray=function(){return this.nodes.slice(0)},c.prototype.insert=c.prototype.push,c.prototype.top=c.prototype.peek,c.prototype.front=c.prototype.peek,c.prototype.has=c.prototype.contains,c.prototype.copy=c.prototype.clone,c}(),e!==null&&e.exports?e.exports=t:window.Heap=t}).call(X)})(Ft);(function(e){e.exports=Ft.exports})(se);function Rn(e,t,n){this.x=e,this.y=t,this.walkable=n===void 0?!0:n}var Re=Rn,Jn={Always:1,Never:2,IfAtMostOneObstacle:3,OnlyWhenNoObstacles:4},_=Jn,Dt=Re,le=_;function j(e,t,n){var s;typeof e!="object"?s=e:(t=e.length,s=e[0].length,n=e),this.width=s,this.height=t,this.nodes=this._buildNodes(s,t,n)}j.prototype._buildNodes=function(e,t,n){var s,i,o=new Array(t);for(s=0;s<t;++s)for(o[s]=new Array(e),i=0;i<e;++i)o[s][i]=new Dt(i,s);if(n===void 0)return o;if(n.length!==t||n[0].length!==e)throw new Error("Matrix size does not fit");for(s=0;s<t;++s)for(i=0;i<e;++i)n[s][i]&&(o[s][i].walkable=!1);return o};j.prototype.getNodeAt=function(e,t){return this.nodes[t][e]};j.prototype.isWalkableAt=function(e,t){return this.isInside(e,t)&&this.nodes[t][e].walkable};j.prototype.isInside=function(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height};j.prototype.setWalkableAt=function(e,t,n){this.nodes[t][e].walkable=n};j.prototype.getNeighbors=function(e,t){var n=e.x,s=e.y,i=[],o=!1,a=!1,r=!1,l=!1,u=!1,h=!1,p=!1,v=!1,m=this.nodes;if(this.isWalkableAt(n,s-1)&&(i.push(m[s-1][n]),o=!0),this.isWalkableAt(n+1,s)&&(i.push(m[s][n+1]),r=!0),this.isWalkableAt(n,s+1)&&(i.push(m[s+1][n]),u=!0),this.isWalkableAt(n-1,s)&&(i.push(m[s][n-1]),p=!0),t===le.Never)return i;if(t===le.OnlyWhenNoObstacles)a=p&&o,l=o&&r,h=r&&u,v=u&&p;else if(t===le.IfAtMostOneObstacle)a=p||o,l=o||r,h=r||u,v=u||p;else if(t===le.Always)a=!0,l=!0,h=!0,v=!0;else throw new Error("Incorrect value of diagonalMovement");return a&&this.isWalkableAt(n-1,s-1)&&i.push(m[s-1][n-1]),l&&this.isWalkableAt(n+1,s-1)&&i.push(m[s-1][n+1]),h&&this.isWalkableAt(n+1,s+1)&&i.push(m[s+1][n+1]),v&&this.isWalkableAt(n-1,s+1)&&i.push(m[s+1][n-1]),i};j.prototype.clone=function(){var e,t,n=this.width,s=this.height,i=this.nodes,o=new j(n,s),a=new Array(s);for(e=0;e<s;++e)for(a[e]=new Array(n),t=0;t<n;++t)a[e][t]=new Dt(t,e,i[e][t].walkable);return o.nodes=a,o};var Hn=j,$={};function Ee(e){for(var t=[[e.x,e.y]];e.parent;)e=e.parent,t.push([e.x,e.y]);return t.reverse()}$.backtrace=Ee;function Un(e,t){var n=Ee(e),s=Ee(t);return n.concat(s.reverse())}$.biBacktrace=Un;function qn(e){var t,n=0,s,i,o,a;for(t=1;t<e.length;++t)s=e[t-1],i=e[t],o=s[0]-i[0],a=s[1]-i[1],n+=Math.sqrt(o*o+a*a);return n}$.pathLength=qn;function Je(e,t,n,s){var i=Math.abs,o=[],a,r,l,u,h,p;for(l=i(n-e),u=i(s-t),a=e<n?1:-1,r=t<s?1:-1,h=l-u;o.push([e,t]),!(e===n&&t===s);)p=2*h,p>-u&&(h=h-u,e=e+a),p<l&&(h=h+l,t=t+r);return o}$.interpolate=Je;function Vn(e){var t=[],n=e.length,s,i,o,a,r,l;if(n<2)return t;for(r=0;r<n-1;++r)for(s=e[r],i=e[r+1],o=Je(s[0],s[1],i[0],i[1]),a=o.length,l=0;l<a-1;++l)t.push(o[l]);return t.push(e[n-1]),t}$.expandPath=Vn;function Gn(e,t){var n=t.length,s=t[0][0],i=t[0][1],o=t[n-1][0],a=t[n-1][1],r,l,u,h,p,v,m,k,y,c,d;for(r=s,l=i,p=[[r,l]],v=2;v<n;++v){for(k=t[v],u=k[0],h=k[1],y=Je(r,l,u,h),d=!1,m=1;m<y.length;++m)if(c=y[m],!e.isWalkableAt(c[0],c[1])){d=!0;break}d&&(lastValidCoord=t[v-1],p.push(lastValidCoord),r=lastValidCoord[0],l=lastValidCoord[1])}return p.push([o,a]),p}$.smoothenPath=Gn;function zn(e){if(e.length<3)return e;var t=[],n=e[0][0],s=e[0][1],i=e[1][0],o=e[1][1],a=i-n,r=o-s,l,u,h,p,v,m;for(v=Math.sqrt(a*a+r*r),a/=v,r/=v,t.push([n,s]),m=2;m<e.length;m++)l=i,u=o,h=a,p=r,i=e[m][0],o=e[m][1],a=i-l,r=o-u,v=Math.sqrt(a*a+r*r),a/=v,r/=v,(a!==h||r!==p)&&t.push([l,u]);return t.push([i,o]),t}$.compressPath=zn;var oe={manhattan:function(e,t){return e+t},euclidean:function(e,t){return Math.sqrt(e*e+t*t)},octile:function(e,t){var n=Math.SQRT2-1;return e<t?n*e+t:n*t+e},chebyshev:function(e,t){return Math.max(e,t)}},Yn=se.exports,Kn=$,Ne=oe,ue=_;function $t(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.heuristic=e.heuristic||Ne.manhattan,this.weight=e.weight||1,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=ue.OnlyWhenNoObstacles:this.diagonalMovement=ue.IfAtMostOneObstacle:this.diagonalMovement=ue.Never),this.diagonalMovement===ue.Never?this.heuristic=e.heuristic||Ne.manhattan:this.heuristic=e.heuristic||Ne.octile}$t.prototype.findPath=function(e,t,n,s,i){var o=new Yn(function(M,x){return M.f-x.f}),a=i.getNodeAt(e,t),r=i.getNodeAt(n,s),l=this.heuristic,u=this.diagonalMovement,h=this.weight,p=Math.abs,v=Math.SQRT2,m,k,y,c,d,g,b,A;for(a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(m=o.pop(),m.closed=!0,m===r)return Kn.backtrace(r);for(k=i.getNeighbors(m,u),c=0,d=k.length;c<d;++c)y=k[c],!y.closed&&(g=y.x,b=y.y,A=m.g+(g-m.x===0||b-m.y===0?1:v),(!y.opened||A<y.g)&&(y.g=A,y.h=y.h||h*l(p(g-n),p(b-s)),y.f=y.g+y.h,y.parent=m,y.opened?o.updateItem(y):(o.push(y),y.opened=!0)))}return[]};var He=$t,It=He;function we(e){It.call(this,e);var t=this.heuristic;this.heuristic=function(n,s){return t(n,s)*1e6}}we.prototype=new It;we.prototype.constructor=we;var Qn=we,Xn=$,We=_;function Pt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=We.OnlyWhenNoObstacles:this.diagonalMovement=We.IfAtMostOneObstacle:this.diagonalMovement=We.Never)}Pt.prototype.findPath=function(e,t,n,s,i){var o=[],a=this.diagonalMovement,r=i.getNodeAt(e,t),l=i.getNodeAt(n,s),u,h,p,v,m;for(o.push(r),r.opened=!0;o.length;){if(p=o.shift(),p.closed=!0,p===l)return Xn.backtrace(l);for(u=i.getNeighbors(p,a),v=0,m=u.length;v<m;++v)h=u[v],!(h.closed||h.opened)&&(o.push(h),h.opened=!0,h.parent=p)}return[]};var Zn=Pt,_t=He;function Me(e){_t.call(this,e),this.heuristic=function(t,n){return 0}}Me.prototype=new _t;Me.prototype.constructor=Me;var ei=Me,ot=se.exports,at=$,Se=oe,ce=_;function Et(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||Se.manhattan,this.weight=e.weight||1,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=ce.OnlyWhenNoObstacles:this.diagonalMovement=ce.IfAtMostOneObstacle:this.diagonalMovement=ce.Never),this.diagonalMovement===ce.Never?this.heuristic=e.heuristic||Se.manhattan:this.heuristic=e.heuristic||Se.octile}Et.prototype.findPath=function(e,t,n,s,i){var o=function(I,J){return I.f-J.f},a=new ot(o),r=new ot(o),l=i.getNodeAt(e,t),u=i.getNodeAt(n,s),h=this.heuristic,p=this.diagonalMovement,v=this.weight,m=Math.abs,k=Math.SQRT2,y,c,d,g,b,A,M,x,W=1,S=2;for(l.g=0,l.f=0,a.push(l),l.opened=W,u.g=0,u.f=0,r.push(u),u.opened=S;!a.empty()&&!r.empty();){for(y=a.pop(),y.closed=!0,c=i.getNeighbors(y,p),g=0,b=c.length;g<b;++g)if(d=c[g],!d.closed){if(d.opened===S)return at.biBacktrace(y,d);A=d.x,M=d.y,x=y.g+(A-y.x===0||M-y.y===0?1:k),(!d.opened||x<d.g)&&(d.g=x,d.h=d.h||v*h(m(A-n),m(M-s)),d.f=d.g+d.h,d.parent=y,d.opened?a.updateItem(d):(a.push(d),d.opened=W))}for(y=r.pop(),y.closed=!0,c=i.getNeighbors(y,p),g=0,b=c.length;g<b;++g)if(d=c[g],!d.closed){if(d.opened===W)return at.biBacktrace(d,y);A=d.x,M=d.y,x=y.g+(A-y.x===0||M-y.y===0?1:k),(!d.opened||x<d.g)&&(d.g=x,d.h=d.h||v*h(m(A-e),m(M-t)),d.f=d.g+d.h,d.parent=y,d.opened?r.updateItem(d):(r.push(d),d.opened=S))}}return[]};var Ue=Et,Bt=Ue;function ke(e){Bt.call(this,e);var t=this.heuristic;this.heuristic=function(n,s){return t(n,s)*1e6}}ke.prototype=new Bt;ke.prototype.constructor=ke;var ti=ke,rt=$,Te=_;function jt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Te.OnlyWhenNoObstacles:this.diagonalMovement=Te.IfAtMostOneObstacle:this.diagonalMovement=Te.Never)}jt.prototype.findPath=function(e,t,n,s,i){var o=i.getNodeAt(e,t),a=i.getNodeAt(n,s),r=[],l=[],u,h,p,v=this.diagonalMovement,m=0,k=1,y,c;for(r.push(o),o.opened=!0,o.by=m,l.push(a),a.opened=!0,a.by=k;r.length&&l.length;){for(p=r.shift(),p.closed=!0,u=i.getNeighbors(p,v),y=0,c=u.length;y<c;++y)if(h=u[y],!h.closed){if(h.opened){if(h.by===k)return rt.biBacktrace(p,h);continue}r.push(h),h.parent=p,h.opened=!0,h.by=m}for(p=l.shift(),p.closed=!0,u=i.getNeighbors(p,v),y=0,c=u.length;y<c;++y)if(h=u[y],!h.closed){if(h.opened){if(h.by===m)return rt.biBacktrace(h,p);continue}l.push(h),h.parent=p,h.opened=!0,h.by=k}}return[]};var ni=jt,Lt=Ue;function Ae(e){Lt.call(this,e),this.heuristic=function(t,n){return 0}}Ae.prototype=new Lt;Ae.prototype.constructor=Ae;var ii=Ae,Fe=oe,lt=Re,de=_;function Rt(e){e=e||{},this.allowDiagonal=e.allowDiagonal,this.dontCrossCorners=e.dontCrossCorners,this.diagonalMovement=e.diagonalMovement,this.heuristic=e.heuristic||Fe.manhattan,this.weight=e.weight||1,this.trackRecursion=e.trackRecursion||!1,this.timeLimit=e.timeLimit||1/0,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=de.OnlyWhenNoObstacles:this.diagonalMovement=de.IfAtMostOneObstacle:this.diagonalMovement=de.Never),this.diagonalMovement===de.Never?this.heuristic=e.heuristic||Fe.manhattan:this.heuristic=e.heuristic||Fe.octile}Rt.prototype.findPath=function(e,t,n,s,i){var o=new Date().getTime(),a=function(y,c){return this.heuristic(Math.abs(c.x-y.x),Math.abs(c.y-y.y))}.bind(this),r=function(y,c){return y.x===c.x||y.y===c.y?1:Math.SQRT2},l=function(y,c,d,g,b){if(this.timeLimit>0&&new Date().getTime()-o>this.timeLimit*1e3)return 1/0;var A=c+a(y,h)*this.weight;if(A>d)return A;if(y==h)return g[b]=[y.x,y.y],y;var M,x,W,S,I=i.getNeighbors(y,this.diagonalMovement);for(W=0,M=1/0;S=I[W];++W){if(this.trackRecursion&&(S.retainCount=S.retainCount+1||1,S.tested!==!0&&(S.tested=!0)),x=l(S,c+r(y,S),d,g,b+1),x instanceof lt)return g[b]=[y.x,y.y],x;this.trackRecursion&&--S.retainCount===0&&(S.tested=!1),x<M&&(M=x)}return M}.bind(this),u=i.getNodeAt(e,t),h=i.getNodeAt(n,s),p=a(u,h),v,m,k;for(v=0;;++v){if(m=[],k=l(u,0,p,m,0),k===1/0)return[];if(k instanceof lt)return m;p=k}return[]};var si=Rt,oi=se.exports,ut=$,Jt=oe;function qe(e){e=e||{},this.heuristic=e.heuristic||Jt.manhattan,this.trackJumpRecursion=e.trackJumpRecursion||!1}qe.prototype.findPath=function(e,t,n,s,i){var o=this.openList=new oi(function(u,h){return u.f-h.f}),a=this.startNode=i.getNodeAt(e,t),r=this.endNode=i.getNodeAt(n,s),l;for(this.grid=i,a.g=0,a.f=0,o.push(a),a.opened=!0;!o.empty();){if(l=o.pop(),l.closed=!0,l===r)return ut.expandPath(ut.backtrace(r));this._identifySuccessors(l)}return[]};qe.prototype._identifySuccessors=function(e){var t=this.grid,n=this.heuristic,s=this.openList,i=this.endNode.x,o=this.endNode.y,a,r,l,u,h,p=e.x,v=e.y,m,k,y,c,d,g=Math.abs;for(a=this._findNeighbors(e),u=0,h=a.length;u<h;++u)if(r=a[u],l=this._jump(r[0],r[1],p,v),l){if(m=l[0],k=l[1],d=t.getNodeAt(m,k),d.closed)continue;y=Jt.octile(g(m-p),g(k-v)),c=e.g+y,(!d.opened||c<d.g)&&(d.g=c,d.h=d.h||n(g(m-i),g(k-o)),d.f=d.g+d.h,d.parent=e,d.opened?s.updateItem(d):(s.push(d),d.opened=!0))}};var Oe=qe,Ht=Oe,ai=_;function z(e){Ht.call(this,e)}z.prototype=new Ht;z.prototype.constructor=z;z.prototype._jump=function(e,t,n,s){var i=this.grid,o=e-n,a=t-s;if(!i.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(i.getNodeAt(e,t).tested=!0),i.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0){if(i.isWalkableAt(e,t-1)&&!i.isWalkableAt(e-o,t-1)||i.isWalkableAt(e,t+1)&&!i.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0){if(i.isWalkableAt(e-1,t)&&!i.isWalkableAt(e-1,t-a)||i.isWalkableAt(e+1,t)&&!i.isWalkableAt(e+1,t-a))return[e,t];if(this._jump(e+1,t,e,t)||this._jump(e-1,t,e,t))return[e,t]}else throw new Error("Only horizontal and vertical movements are allowed");return this._jump(e+o,t+a,e,t)};z.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,s=e.y,i=this.grid,o,a,r,l,u=[],h,p,v,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0?(i.isWalkableAt(n,s-1)&&u.push([n,s-1]),i.isWalkableAt(n,s+1)&&u.push([n,s+1]),i.isWalkableAt(n+r,s)&&u.push([n+r,s])):l!==0&&(i.isWalkableAt(n-1,s)&&u.push([n-1,s]),i.isWalkableAt(n+1,s)&&u.push([n+1,s]),i.isWalkableAt(n,s+l)&&u.push([n,s+l]));else for(h=i.getNeighbors(e,ai.Never),v=0,m=h.length;v<m;++v)p=h[v],u.push([p.x,p.y]);return u};var ri=z,Ut=Oe,li=_;function Y(e){Ut.call(this,e)}Y.prototype=new Ut;Y.prototype.constructor=Y;Y.prototype._jump=function(e,t,n,s){var i=this.grid,o=e-n,a=t-s;if(!i.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(i.getNodeAt(e,t).tested=!0),i.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(i.isWalkableAt(e-o,t+a)&&!i.isWalkableAt(e-o,t)||i.isWalkableAt(e+o,t-a)&&!i.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(i.isWalkableAt(e+o,t+1)&&!i.isWalkableAt(e,t+1)||i.isWalkableAt(e+o,t-1)&&!i.isWalkableAt(e,t-1))return[e,t]}else if(i.isWalkableAt(e+1,t+a)&&!i.isWalkableAt(e+1,t)||i.isWalkableAt(e-1,t+a)&&!i.isWalkableAt(e-1,t))return[e,t];return this._jump(e+o,t+a,e,t)};Y.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,s=e.y,i=this.grid,o,a,r,l,u=[],h,p,v,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0?(i.isWalkableAt(n,s+l)&&u.push([n,s+l]),i.isWalkableAt(n+r,s)&&u.push([n+r,s]),i.isWalkableAt(n+r,s+l)&&u.push([n+r,s+l]),i.isWalkableAt(n-r,s)||u.push([n-r,s+l]),i.isWalkableAt(n,s-l)||u.push([n+r,s-l])):r===0?(i.isWalkableAt(n,s+l)&&u.push([n,s+l]),i.isWalkableAt(n+1,s)||u.push([n+1,s+l]),i.isWalkableAt(n-1,s)||u.push([n-1,s+l])):(i.isWalkableAt(n+r,s)&&u.push([n+r,s]),i.isWalkableAt(n,s+1)||u.push([n+r,s+1]),i.isWalkableAt(n,s-1)||u.push([n+r,s-1]));else for(h=i.getNeighbors(e,li.Always),v=0,m=h.length;v<m;++v)p=h[v],u.push([p.x,p.y]);return u};var ci=Y,qt=Oe,di=_;function K(e){qt.call(this,e)}K.prototype=new qt;K.prototype.constructor=K;K.prototype._jump=function(e,t,n,s){var i=this.grid,o=e-n,a=t-s;if(!i.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(i.getNodeAt(e,t).tested=!0),i.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(i.isWalkableAt(e,t-1)&&!i.isWalkableAt(e-o,t-1)||i.isWalkableAt(e,t+1)&&!i.isWalkableAt(e-o,t+1))return[e,t]}else if(a!==0&&(i.isWalkableAt(e-1,t)&&!i.isWalkableAt(e-1,t-a)||i.isWalkableAt(e+1,t)&&!i.isWalkableAt(e+1,t-a)))return[e,t];return i.isWalkableAt(e+o,t)&&i.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};K.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,s=e.y,i=this.grid,o,a,r,l,u=[],h,p,v,m;if(t)if(o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0)i.isWalkableAt(n,s+l)&&u.push([n,s+l]),i.isWalkableAt(n+r,s)&&u.push([n+r,s]),i.isWalkableAt(n,s+l)&&i.isWalkableAt(n+r,s)&&u.push([n+r,s+l]);else{var k;if(r!==0){k=i.isWalkableAt(n+r,s);var y=i.isWalkableAt(n,s+1),c=i.isWalkableAt(n,s-1);k&&(u.push([n+r,s]),y&&u.push([n+r,s+1]),c&&u.push([n+r,s-1])),y&&u.push([n,s+1]),c&&u.push([n,s-1])}else if(l!==0){k=i.isWalkableAt(n,s+l);var d=i.isWalkableAt(n+1,s),g=i.isWalkableAt(n-1,s);k&&(u.push([n,s+l]),d&&u.push([n+1,s+l]),g&&u.push([n-1,s+l])),d&&u.push([n+1,s]),g&&u.push([n-1,s])}}else for(h=i.getNeighbors(e,di.OnlyWhenNoObstacles),v=0,m=h.length;v<m;++v)p=h[v],u.push([p.x,p.y]);return u};var fi=K,Vt=Oe,hi=_;function Q(e){Vt.call(this,e)}Q.prototype=new Vt;Q.prototype.constructor=Q;Q.prototype._jump=function(e,t,n,s){var i=this.grid,o=e-n,a=t-s;if(!i.isWalkableAt(e,t))return null;if(this.trackJumpRecursion===!0&&(i.getNodeAt(e,t).tested=!0),i.getNodeAt(e,t)===this.endNode)return[e,t];if(o!==0&&a!==0){if(i.isWalkableAt(e-o,t+a)&&!i.isWalkableAt(e-o,t)||i.isWalkableAt(e+o,t-a)&&!i.isWalkableAt(e,t-a))return[e,t];if(this._jump(e+o,t,e,t)||this._jump(e,t+a,e,t))return[e,t]}else if(o!==0){if(i.isWalkableAt(e+o,t+1)&&!i.isWalkableAt(e,t+1)||i.isWalkableAt(e+o,t-1)&&!i.isWalkableAt(e,t-1))return[e,t]}else if(i.isWalkableAt(e+1,t+a)&&!i.isWalkableAt(e+1,t)||i.isWalkableAt(e-1,t+a)&&!i.isWalkableAt(e-1,t))return[e,t];return i.isWalkableAt(e+o,t)||i.isWalkableAt(e,t+a)?this._jump(e+o,t+a,e,t):null};Q.prototype._findNeighbors=function(e){var t=e.parent,n=e.x,s=e.y,i=this.grid,o,a,r,l,u=[],h,p,v,m;if(t)o=t.x,a=t.y,r=(n-o)/Math.max(Math.abs(n-o),1),l=(s-a)/Math.max(Math.abs(s-a),1),r!==0&&l!==0?(i.isWalkableAt(n,s+l)&&u.push([n,s+l]),i.isWalkableAt(n+r,s)&&u.push([n+r,s]),(i.isWalkableAt(n,s+l)||i.isWalkableAt(n+r,s))&&u.push([n+r,s+l]),!i.isWalkableAt(n-r,s)&&i.isWalkableAt(n,s+l)&&u.push([n-r,s+l]),!i.isWalkableAt(n,s-l)&&i.isWalkableAt(n+r,s)&&u.push([n+r,s-l])):r===0?i.isWalkableAt(n,s+l)&&(u.push([n,s+l]),i.isWalkableAt(n+1,s)||u.push([n+1,s+l]),i.isWalkableAt(n-1,s)||u.push([n-1,s+l])):i.isWalkableAt(n+r,s)&&(u.push([n+r,s]),i.isWalkableAt(n,s+1)||u.push([n+r,s+1]),i.isWalkableAt(n,s-1)||u.push([n+r,s-1]));else for(h=i.getNeighbors(e,hi.IfAtMostOneObstacle),v=0,m=h.length;v<m;++v)p=h[v],u.push([p.x,p.y]);return u};var pi=Q,De=_,gi=ri,vi=ci,yi=fi,mi=pi;function bi(e){return e=e||{},e.diagonalMovement===De.Never?new gi(e):e.diagonalMovement===De.Always?new vi(e):e.diagonalMovement===De.OnlyWhenNoObstacles?new yi(e):new mi(e)}var wi=bi,Mi={Heap:se.exports,Node:Re,Grid:Hn,Util:$,DiagonalMovement:_,Heuristic:oe,AStarFinder:He,BestFirstFinder:Qn,BreadthFirstFinder:Zn,DijkstraFinder:ei,BiAStarFinder:Ue,BiBestFirstFinder:ti,BiBreadthFirstFinder:ni,BiDijkstraFinder:ii,IDAStarFinder:si,JumpPointFinder:wi};(function(e){e.exports=Mi})(Tt);const Gt=an(Tt.exports),ki=new Gt.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0}),Ve=(e,t)=>{const{walkableTileMatrix:n}=f.tileMap,s=new Gt.Grid(n);return ki.findPath(e.y,e.x,t.y,t.x,s)},Ge={},fe=()=>{};Ge.set=()=>{const{hoveredTile:e,mouse:t,player:n}=f;Ct(),t.onMouseMove=()=>{t.buttonCode===1&&nn(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&n.requestMove(e.tileIndex),mn()},f.onFrameControls=s=>{tn(s),e.tileIndex=At({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?f.canvas.style.cursor="grabbing":f.canvas.style.cursor="pointer",e.path=Ve(n.tileIndex,e.tileIndex),t.buttonCode===3&&yn(e.tileIndex)):f.canvas.style.cursor="default"},f.effectsMiddle=()=>{e.tileIndex&&e.path.forEach(s=>{te({x:s[1],y:s[0]},Mn)})},f.effectsTop=()=>{e.tileIndex&&(e.path.forEach(s=>{te({x:s[1],y:s[0]},kn)}),te(e.tileIndex,ye))}};Ge.unset=()=>{const{mouse:e,player:t}=f;t.unsetPath(),e.onMouseMove=fe,e.onMouseUp=fe,f.effectsMiddle=fe,f.effectsTop=fe};const xe=(e,t,n,s)=>{const i=e.x+bt,o=e.y+wt;s.strokeStyle=t,s.beginPath(),s.ellipse(i,o,n,n*Cn,0,0,Nn),s.stroke()},$e=16,ct=.86,Ai="rgba(150, 150, 150, 0.8)",he=(e,t,n,s)=>{const{ctx:i}=f,o=e.length;e.forEach((a,r)=>{const[l,u]=a,h=B({y:l,x:u});if(xe(h,t,$e,i),n&&r===o-1){const p=h.x+bt,v=h.y+wt;i.beginPath(),i.moveTo(p,v),i.lineTo(p-$e/3,v-T*ct*1.5),i.lineTo(p,v-T*1.5),i.lineTo(p+$e/3,v-T*ct*1.5),i.closePath(),i.fillStyle=Ai,i.strokeStyle=s,i.fill(),i.stroke()}})},ze={},pe=()=>{};ze.set=()=>{const{hoveredTile:e,mouse:t,player:n,ctx:s}=f;t.onMouseMove=()=>{t.buttonCode===1&&nn(-t.drag.x,-t.drag.y)},t.onMouseUp=()=>{t.buttonCode===1&&e.tileIndex&&!t.isDragged&&n.requestMove(e.tileIndex)},f.onFrameControls=i=>{tn(i),e.tileIndex=At({x:t.x,y:t.y}),e.tileIndex?(t.isDragged?f.canvas.style.cursor="grabbing":f.canvas.style.cursor="pointer",e.path=Ve(n.tileIndex,e.tileIndex)):f.canvas.style.cursor="default"},f.effectsMiddle=()=>{n.isMoving?he(n.path,"lime"):e.tileIndex&&he(e.path,"lime")},f.effectsTop=()=>{if(n.isMoving){if(he(n.path,"rgba(50, 205, 50, 0.5)",!0,"lime"),e.tileIndex)if(me(e.tileIndex)){const i=B(e.tileIndex);xe(i,ye,_e,s)}else te(e.tileIndex,ye)}else if(e.tileIndex&&(he(e.path,"rgba(50, 205, 50, 0.5)"),e.tileIndex))if(me(e.tileIndex)){const i=B(e.tileIndex);xe(i,"lime",_e,s)}else te(e.tileIndex,ye)}};ze.unset=()=>{const{mouse:e,player:t}=f;t.unsetPath(),e.onMouseMove=pe,e.onMouseUp=pe,f.effectsMiddle=pe,f.effectsTop=pe};const zt=()=>{const{paused:e,stop:t,restart:n}=D;e?(n(),document.body.classList.remove("paused")):(t(),document.body.classList.add("paused"))},xi=()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():canvasRoot.requestFullscreen()};St.keyDown=e=>{switch(e){case"Space":zt();break;case"Enter":Z("ControlLeft")&&xi();break;default:return}};document.addEventListener("visibilitychange",()=>{const{stop:e}=D;document.visibilityState==="hidden"?(e(),document.body.classList.add("paused")):document.visibilityState==="visible"&&Ln()});const dt={editMode:Ge,playMode:ze},Yt=e=>{dt[f.mode].unset(),f.mode=e,jn(),dt[e].set()},Oi=()=>w.h("div",null,w.h("div",{id:"pauseMenu"},w.h("div",{class:"pause-menu-items"},w.h("p",null,"Paused"),w.h("ul",null,w.h("li",null,w.h("button",{onclick:zt},"Resume")),w.h("li",null,w.h("button",{id:"loadButton"},"Load")),w.h("li",null,w.h("button",{class:"save",id:"saveButton"},"Save"),w.h("input",{type:"text",id:"saveName",value:"tile-map"})))))),Ci=()=>w.h("div",{class:"toolbar"},w.h("form",{id:"mode",name:"mode",class:"margin-right-10"},w.h("input",{type:"radio",id:"playRadio",value:"playMode",class:"margin-right-10",name:"mode",checked:!0}),w.h("label",{for:"playRadio"},"Play Mode"),w.h("input",{type:"radio",id:"editModeRadio",value:"editMode",class:"margin-left-10 margin-right-10",name:"mode"}),w.h("label",{for:"editModeRadio"},"Edit Mode"))),Ni=()=>w.h("div",{class:"wrapper"},w.h(Ci,null),w.h("div",{id:"canvasRoot"},w.h("div",{id:"ui"}),w.h(Oi,null))),Kt=({xTiles:e,yTiles:t})=>{const{ctx:n,canvas:s}=f,i=(e+t)/2*T,o=(e+t)/2*P,a=i+bn+tt;f.floorCanvas.width=f.entityCanvas.width=o,f.floorCanvas.height=f.entityCanvas.height=a;const r=i/2-T/4*(t-e)-T/2+tt,l={x:0,y:r},u={x:0,y:0},h=()=>{s.width=canvasRoot.clientWidth,s.height=canvasRoot.clientHeight,n.setTransform(1,0,0,1,u.x,u.y)};return onresize=()=>{h(),Si()},{origin:l,xTiles:e,yTiles:t,translate:u,setApertureSize:h}},Wi=e=>{const{ctx:t,canvas:n,floorCanvas:s,entityCanvas:i,view:o,effectsMiddle:a,effectsTop:r}=f,{translate:l}=o;t.clearRect(-l.x,-l.y,n.width,n.height),t.drawImage(s,0,0),a(),f.entities.forEach(u=>{u.update(e)}),t.drawImage(i,0,0),r()},Si=()=>{const{ctx:e,canvas:t,floorCanvas:n,entityCanvas:s,view:i}=f,{translate:o}=i;e.clearRect(-o.x,-o.y,t.width,t.height),e.drawImage(n,0,0),e.drawImage(s,0,0)},Qt=e=>{const{onFrameControls:t}=f;t&&(t(e),f.monitor(e)),Wi(e)},D={};let ee=0,Xt=0,Zt;D.start=e=>{Zt=e,Xt=requestAnimationFrame(t=>{Ti(t,e)}),D.paused=!1};D.restart=()=>{D.start(Zt),D.paused=!1};D.stop=()=>{window.cancelAnimationFrame(Xt),ee=0,D.paused=!0};const Ti=(e,t)=>{ee||(ee=e);const n=e-ee;ee=e,t(n),D.start(t)},Fi=e=>{D.stop(),delete f.entites,delete f.tileMap,delete f.entityMap;const{xTiles:t,yTiles:n}=e;f.view=f.setView({xTiles:t,yTiles:n}),f.loadMap(e),D.start(Qt)},Di=()=>{saveButton.onclick=()=>{const e=gn(),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",saveName.value+".json"),saveButton.after(t),t.click(),t.remove()},loadButton.onclick=()=>{const e=document.createElement("input");e.type="file",loadButton.after(e),e.onchange=()=>{const t=new FileReader;t.onload=n=>{const s=mt(n.target.result);Fi(s)},t.readAsText(e.files[0])},e.click(),e.remove()}};let $i=0;const Ii=()=>$i++,ft=(e,t)=>{const n=e+(Math.random()*t-t/2);return Math.floor(n)};class Ye{constructor({sprite:t,haloColor:n}){q(this,"addToScene",t=>{const{entityMap:n}=f,{id:s,render:i,redraw:o}=this;this.tileIndex=t,this.position=B(t),this.positionPrevious=this.position,this.redrawEntities=Ui,n.addEntity({tileIndex:t,id:s,render:i}),f.entities.push(this),o()});q(this,"render",()=>{const{entityCtx:t}=f,{sprite:n,position:s,haloColor:i}=this;xe(s,i,_e,t),t.drawImage(n.data,Math.round(s.x),Math.round(s.y-n.yOffset))});q(this,"redraw",()=>{const{tileIndex:t,position:n,positionPrevious:s}=this;this.redrawEntities(t,n,s),this.positionPrevious={x:n.x,y:n.y}});this.sprite=t||F.playerTokens.sheild,this.haloColor=n||An,this.id=Ii(),this.position={x:0,y:0}}update(){}}const en=(e,t)=>{const{entityMap:n}=f;let s=null,i,o,a;e.isMoving=!1;const r=p=>{if(e.isMoving){const v=t*p,m=v*Math.cos(s),k=v*Math.sin(s);e.position.x+=m,e.position.y+=k;const y=i.x-e.position.x,c=i.y-e.position.y,d=y>0!==o,g=c>0!==a;(d||g)&&(e.position.x=i.x,e.position.y=i.y,e.path.length>1?(e.path.shift(),u()):e.isMoving=!1),n.removeEntity({tileIndex:e.tileIndex,id:e.id}),e.tileIndex=kt({x:e.position.x+P/2,y:e.position.y+T/2}),n.addEntity({tileIndex:e.tileIndex,id:e.id,render:e.render})}},l=()=>{e.isMoving=!1,e.path=[]},u=()=>{const[p]=e.path,[v,m]=p,k={x:m,y:v};if(me(k)){i=B(k);const y=i.x-e.position.x,c=i.y-e.position.y;o=y>0,a=c>0,s=Math.atan2(c,y)}else l()};return{move:r,requestMove:p=>{const v=Ve(e.tileIndex,p),m=p.x===e.tileIndex.x&&p.y===e.tileIndex.y;!e.isMoving&&!m&&v.length&&(e.path=v,e.path.shift(),u(),e.isMoving=!0)},unsetPath:l}};class Pi extends Ye{constructor(){super({sprite:F.playerTokens.angel,haloColor:"lime"}),this.path=[];const t=en(this,xn),n={editMode:t.move,playMode:t.move};this.update=s=>{n[f.mode](s),this.redraw()},this.requestMove=t.requestMove,this.unsetPath=t.unsetPath}}class _i extends Ye{constructor(n){super(n);q(this,"pickPath",()=>{const{pathFinder:n,tileIndex:s}=this,i={x:ft(s.x,10),y:ft(s.y,10)};me(i)&&n.requestMove(i)});q(this,"update",n=>{const{pathFinder:s,pickPath:i,redraw:o,isMoving:a}=this;f.mode!=="editMode"&&(a||i(),s.move(n)),o()});this.path=[],this.pathFinder=en(this,On)}}const Ei=e=>{const t={};t.entities=[];const{xTiles:n,yTiles:s}=e;for(let i=0;i<n;i++){t.entities[i]=[];for(let o=0;o<s;o++)t.entities[i][o]={}}return t.addEntity=({tileIndex:i,id:o,render:a})=>{t.entities[i.x][i.y][o]=a,Xe(i,1)},t.entityCheck=({x:i,y:o})=>{const a=t.entities[i][o];return Object.keys(a).length===0},t.removeEntity=({tileIndex:i,id:o})=>{const{x:a,y:r}=i,l=t.entities[a][r];if(delete l[o],Object.keys(l).length===0){const h=e.tiles[a][r].walkable;Xe(i,h)}},t},Ke=(e,t)=>{var o;const{tileMap:n,entityMap:s}=f,i=(o=n.tiles[e])==null?void 0:o[t];if(i){const{feature:a}=i,r=B({x:e,y:t}),l=s.entities[e][t];for(const u in l)l[u]();if(a){const{set:u,color:h,variant:p}=a,v=Le(u,h,p);f.entityCtx.drawImage(v.data,r.x,r.y-v.yOffset),f.entityCtx.globalAlpha=.5;for(const m in l)l[m]();f.entityCtx.globalAlpha=1}}},N={x:0,y:0,buttonCode:0,onMouseUp:null,onMouseMove:null,isDragged:!1,dragStart:{x:0,y:0},drag:{x:0,y:0}},Bi=e=>(e.addEventListener("contextmenu",t=>t.preventDefault()),e.onmousemove=t=>{const{translate:n}=f.view,{left:s,top:i}=t.target.getBoundingClientRect();N.x=t.clientX-s-n.x,N.y=t.clientY-i-n.y,N.buttonCode===1&&(N.isDragged=!0,N.drag.x=N.dragStart.x-N.x-n.x,N.drag.y=N.dragStart.y-N.y-n.y),N.onMouseMove&&N.onMouseMove()},e.onmousedown=t=>{t.preventDefault(),N.buttonCode=t.which,N.dragStart.x=N.x,N.dragStart.y=N.y,N.drag.x=0,N.drag.y=0},document.onmouseup=()=>{N.onMouseUp&&N.onMouseUp(),N.isDragged=!1,N.buttonCode=0},e.onmouseleave=()=>{N.isDragged=!1,N.buttonCode=0},N),ji=()=>{const{view:e}=f,{xTiles:t,yTiles:n}=e;for(let s=t-1;s>-1;s--)for(let i=0;i<n;i++)Sn(s,i),Ke(s,i)},V=150,H=70,Li=100,Ri=()=>{const e=document.createElement("canvas"),t=e.getContext("2d",{willReadFrequently:!0});e.classList.add("monitor"),e.width=V,e.height=H,canvasRoot.appendChild(e),t.strokeStyle="#ff0000";let n=t.getImageData(0,0,V,H);return s=>{t.clearRect(0,0,V,H),t.putImageData(n,-1,0);const i=H-s/Li*H;t.beginPath(),t.moveTo(V,H),t.lineTo(V,i),t.stroke(),n=t.getImageData(0,0,V,H)}},f={};f.start=async e=>{document.getElementById("root").replaceWith(Ni()),f.canvas=document.createElement("canvas"),f.ctx=f.canvas.getContext("2d"),canvasRoot.appendChild(f.canvas),f.monitor=Ri(),f.floorCanvas=new OffscreenCanvas(0,0),f.floorCtx=f.floorCanvas.getContext("2d"),f.entityCanvas=new OffscreenCanvas(0,0),f.entityCtx=f.entityCanvas.getContext("2d"),f.effectsMiddle=()=>{},f.effectsTop=()=>{},f.mouse=Bi(f.canvas),f.view=Kt({xTiles:re,yTiles:re}),f.hoveredTile={path:null,tileIndex:null},f.mode="playMode",mode.onchange=()=>{const n=mode.elements.mode.value;Yt(n)},Di();try{const n=await vn(e);f.loadMap(n)}catch{const n=pn({xTiles:re,yTiles:re});f.loadMap(n)}D.start(Qt)};f.loadMap=e=>{const{entityList:t,unitStart:n={x:1,y:1}}=e;f.tileMap=e,f.entityMap=Ei(e),f.entities=[],f.player=new Pi,f.player.addToScene(n),t&&t.forEach(s=>{const{name:i,tileIndex:o}=s;switch(i){case"entity":new Ye({}).addToScene(o);break;case"npc":new _i({sprite:F.playerTokens.despoiler,haloColor:"red"}).addToScene(o);break}}),Yt(f.mode),f.view.setApertureSize(),ji()};f.setView=Kt;let Ie=0,Pe=0;const tn=e=>{const{translate:t}=f.view,n=Z("KeyW"),s=Z("KeyS"),i=Z("KeyD"),o=Z("KeyA");Ie+=it*e*(i-o),Pe+=it*e*(s-n),t.x-=Ie,t.y-=Pe,Ie*=nt,Pe*=nt,f.ctx.setTransform(1,0,0,1,t.x,t.y)},nn=(e,t)=>{const{translate:n}=f.view;n.x=e,n.y=t},Be=P,je=T*3,Ji=T*1.5,ht=(e,t)=>{const{x:n,y:s}=t;e.save(),e.beginPath(),e.rect(n,s,Be,je),e.clip(),e.clearRect(n,s,Be,je)},Hi=e=>{const{floorCtx:t,entityCtx:n,tileMap:s}=f,i=B({x:e.x,y:e.y});i.y-=Ji,ht(t,i),ht(n,i),Vi.forEach(o=>{var l;const a=o.x+e.x,r=o.y+e.y;if((l=s.tiles[a])!=null&&l[r]){const u=s.tiles[a][r];if(u.floor){const{set:h,color:p,variant:v}=u.floor;Mt({x:a,y:r,image:Le(h,p,v)})}Ke(a,r)}}),n.restore(),t.restore()},Ui=(e,t,n)=>{const{entityCtx:s}=f,i={x:Math.floor(Math.min(t.x,n.x)),y:Math.floor(Math.min(t.y,n.y)-T*2)},o=Math.ceil(Math.abs(t.x-n.x)+Be),a=Math.ceil(Math.abs(t.y-n.y)+je),{x:r,y:l}=i;s.save(),s.beginPath(),s.rect(r,l,o,a),s.clip(),s.clearRect(r,l,o,a),qi.forEach(u=>{const h=u.x+e.x,p=u.y+e.y;Ke(h,p)}),s.restore()},qi=[{x:3,y:-3},{x:3,y:-2},{x:3,y:-1},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:2,y:0},{x:1,y:-3},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:0},{x:-2,y:1},{x:-3,y:1},{x:-2,y:2},{x:-1,y:3},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Vi=[{x:3,y:-3},{x:3,y:-2},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:1},{x:-2,y:2},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Gi=async()=>{await F.load(),f.start("vista"),window.dump=()=>console.log(f)};Gi();
