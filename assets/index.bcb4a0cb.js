var Vi=Object.defineProperty;var Ji=(_,R,U)=>R in _?Vi(_,R,{enumerable:!0,configurable:!0,writable:!0,value:U}):_[R]=U;var Z=(_,R,U)=>(Ji(_,typeof R!="symbol"?R+"":R,U),U);(async()=>{(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerpolicy&&(a.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?a.credentials="include":n.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();const _=({x:t,y:e})=>{var n,a;const{tileMap:i}=p;return((a=(n=i.walkableTileMatrix)==null?void 0:n[t])==null?void 0:a[e])===0},R=({x:t,y:e},i)=>{const{tileMap:n}=p;n.walkableTileMatrix[t][e]=i},U="modulepreload",on=function(t){return"/tiles/"+t},Zt={},sn=function(t,e,i){return!e||e.length===0?t():Promise.all(e.map(n=>{if(n=on(n),n in Zt)return;Zt[n]=!0;const a=n.endsWith(".css"),o=a?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${n}"]${o}`))return;const s=document.createElement("link");if(s.rel=a?"stylesheet":U,a||(s.as="script",s.crossOrigin=""),s.href=n,document.head.appendChild(s),a)return new Promise((r,l)=>{s.addEventListener("load",r),s.addEventListener("error",()=>l(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>t())},rn=(t,e)=>{const i=t[e];return i?typeof i=="function"?i():Promise.resolve(i):new Promise((n,a)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(a.bind(null,new Error("Unknown variable dynamic import: "+e)))})},W=t=>new Promise(e=>{let i=new Image;i.onload=()=>e(i),i.src=t}),C="/tiles/src/images/";console.log("AM I DEV???",!1);const F={terracotta:[{yOffset:0,data:await W(`${C}terracotta1.png`)},{yOffset:0,data:await W(`${C}terracotta2.png`)},{yOffset:0,data:await W(`${C}terracotta3.png`)},{yOffset:0,data:await W(`${C}terracotta4.png`)}],cube:[{yOffset:33,data:await W(`${C}cube1.png`)},{yOffset:33,data:await W(`${C}cube2.png`)},{yOffset:33,data:await W(`${C}cube3.png`)}],grass:[{yOffset:2,data:await W(`${C}grass1.png`)},{yOffset:2,data:await W(`${C}grass2.png`)},{yOffset:2,data:await W(`${C}grass3.png`)},{yOffset:2,data:await W(`${C}grass4.png`)}],water:[{yOffset:-3,data:await W(`${C}water1.png`)},{yOffset:-3,data:await W(`${C}water2.png`)}],mountain:[{yOffset:14,data:await W(`${C}mountain1.png`)},{yOffset:12,data:await W(`${C}mountain2.png`)},{yOffset:14,data:await W(`${C}mountain3.png`)}],mountainTop:[{yOffset:14,data:await W(`${C}mountain1-top.png`)},{yOffset:12,data:await W(`${C}mountain2-top.png`)},{yOffset:14,data:await W(`${C}mountain3-top.png`)}],forest:[{yOffset:15,data:await W(`${C}trees1.png`)},{yOffset:15,data:await W(`${C}trees2.png`)},{yOffset:15,data:await W(`${C}trees3.png`)},{yOffset:15,data:await W(`${C}trees4.png`)}],forestTop:[{yOffset:15,data:await W(`${C}trees1-top.png`)},{yOffset:15,data:await W(`${C}trees2-top.png`)},{yOffset:15,data:await W(`${C}trees3-top.png`)},{yOffset:15,data:await W(`${C}trees4-top.png`)}],playerTokens:{angel:{yOffset:51,data:await W(`${C}pt-angel.png`)},despoiler:{yOffset:51,data:await W(`${C}pt-despoiler.png`)},sheild:{yOffset:48,data:await W(`${C}pt-sheild.png`)}}},lt=new OffscreenCanvas(0,0),te=lt.getContext("2d"),ln=(t,e)=>{const{data:i,data:{width:n,height:a},yOffset:o}=t;lt.width=n,lt.height=a;const s=i;return te.filter=`hue-rotate(${e}deg)`,te.drawImage(s,0,0),{data:lt,yOffset:o}},Nt=(t,e,i)=>{const n=F[t][i];return ln(n,e)},ht=t=>Math.floor(Math.random()*F[t].length),hn=({xTiles:t,yTiles:e})=>{const i={tiles:[],walkableTileMatrix:[],xTiles:t,yTiles:e};for(let n=0;n<t;n++){i.tiles[n]=[],i.walkableTileMatrix[n]=[];for(let a=0;a<e;a++)i.tiles[n][a]={}}for(let n=0;n<t;n++)for(let a=0;a<e;a++)ee({x:n,y:a},i,"grass");return i},ee=(t,e,i,n,a=null)=>{const{floor:o,feature:s,walkable:r,type:l}=V[i],{x:h,y:d}=t,f=e.tiles[h][d];switch(l){case"void":f.floor=null,f.feature=null;break;case"obstacle":case"floor":f.floor={set:o,variant:a||ht(o),color:(n==null?void 0:n[l])||0},f.feature=null;break;case"linked":const m=a||ht(o);f.floor={set:o,variant:m,color:(n==null?void 0:n.floor)||0},f.feature={set:s,variant:m,color:(n==null?void 0:n.feature)||0};break;case"feature":f.feature={set:s,variant:a||ht(s),color:(n==null?void 0:n.feature)||0},(f.type==="void"||f.type==="linked"||f.type==="obstacle")&&(f.floor={set:o,variant:ht(o),color:n==null?void 0:n.feature});break}f.type=l,f.walkable=r,e.walkableTileMatrix[h][d]=r},cn=()=>{const{tileMap:t,entities:e}=p;return t.entityList=[],e.forEach(i=>{const{constructor:{name:n},tileIndex:a}=i;n==="unit"?t.unitStart=a:t.entityList.push({name:n,tileIndex:a})}),"data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))},un=async t=>{const e=JSON.stringify(await rn(Object.assign({"../../maps/vista.json":()=>sn(()=>import("./vista.a258ec57.js"),[])}),`../../maps/${t}.json`));return ne(e)},ne=t=>JSON.parse(t);var tt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function dn(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var b={},ie={},q={};Object.defineProperty(q,"__esModule",{value:!0}),q.isSvgTag=q.applyChildren=q.setElementStyle=void 0;function pn(t,e){let i;const n=Object.keys(e);for(i of n)t.style[i]=e[i]}q.setElementStyle=pn;function ae(t,e){e instanceof HTMLElement?t.appendChild(e):typeof e=="string"||typeof e=="number"?t.appendChild(document.createTextNode(e.toString())):console.warn("Unknown type to append: ",e)}function oe(t,e){for(const i of e)if(!(!i&&i!==0))if(Array.isArray(i))for(const n of i)Array.isArray(n)?oe(t,n):ae(t,n);else ae(t,i)}q.applyChildren=oe;function fn(t){return["a","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","path","pattern","polygon","polyline","radialGradient","rect","script","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"].includes(t)}q.isSvgTag=fn,function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.h=t.xlinkNS=void 0;const e=q;t.xlinkNS="http://www.w3.org/1999/xlink";function i(n,a,...o){if(typeof n=="function")return n(Object.assign(Object.assign({},a),{children:o}));const s=e.isSvgTag(n),r=s?document.createElementNS("http://www.w3.org/2000/svg",n):document.createElement(n);if(a){a.style&&typeof a.style!="string"&&(e.setElementStyle(r,a.style),delete a.style);for(const l of Object.keys(a)){const h=a[l];if(l.startsWith("on")){const d=l.replace(/Capture$/,""),f=l!==d,m=d.toLowerCase().substring(2);r.addEventListener(m,h,f)}else s&&l.startsWith("xlink:")?r.setAttributeNS(t.xlinkNS,l,h):h===!0?r.setAttribute(l,l):(h||h===0)&&r.setAttribute(l,h.toString())}}return e.applyChildren(r,o),r}t.h=i}(ie);var se={};Object.defineProperty(se,"__esModule",{value:!0}),function(t){var e=tt&&tt.__createBinding||(Object.create?function(n,a,o,s){s===void 0&&(s=o),Object.defineProperty(n,s,{enumerable:!0,get:function(){return a[o]}})}:function(n,a,o,s){s===void 0&&(s=o),n[s]=a[o]}),i=tt&&tt.__exportStar||function(n,a){for(var o in n)o!=="default"&&!Object.prototype.hasOwnProperty.call(a,o)&&e(a,n,o)};Object.defineProperty(t,"__esModule",{value:!0}),i(ie,t),i(se,t)}(b);const yn=5,gn=6,ct=2,re=4,le={},he={};let[j]=Object.keys(V),et=V[j].type,ut=F[j],H=[];const ce=t=>{j=(t==null?void 0:t.target.value)||j,et=V[j].type,ut=F[j],spriteDisplay.replaceWith(ue()),et!=="void"&&de()},ue=()=>{switch(et){case"void":return b.h("div",{id:"spriteDisplay",class:"spriteDisplay--void"},b.h("div",{class:"brush"},b.h("div",{class:"void-brush"},"X"),b.h("span",null,"Delete tiles")));case"linked":const{floor:t,feature:e}=V[j];H={floor:t,feature:e};break;default:H={[et]:j};break}return b.h("div",{id:"spriteDisplay"},b.h(bn,null))},mn=()=>he[j]={width:Math.max(...ut.map(t=>t.data.width))+yn,height:Math.max(...ut.map(t=>t.data.height))+gn},de=()=>{const t=tilePainter.elements;Object.keys(H).forEach(e=>{const i=H[e],n=t[`${e}Hue`],a=document.getElementById(`${e}HueRotaion`),o=n.value;a.innerText=le[i]=o,F[i].forEach((s,r)=>{const l=document.getElementById(`tileCanv${r}`).getContext("2d");l.filter=`hue-rotate(${o}deg)`;const h=F[i][r].data;l.drawImage(h,re,re)})})},xn=t=>{const{tileSet:e,tiles:i,label:n,type:a}=t;return b.h("div",null,b.h("div",null,b.h("label",{for:`${a}Hue`},n,": "),b.h("span",{id:`${a}HueRotaion`},"0")),b.h("input",{id:`${a}Hue`,class:"hue-slider",type:"range",min:"-180",max:"180",step:"1","tile-type":a,value:le[e]||0,onInput:()=>{de()}}))},vn=t=>{const{width:e,height:i,index:n}=t;return b.h("div",{class:"brush"},b.h("canvas",{id:`tileCanv${n}`,width:e+ct,height:i+ct}),b.h("input",{type:"radio",value:n,name:"tileVariant",style:{width:`${e}px`,height:`${i}px`}}))},bn=()=>{const{width:t,height:e}=he[j]||mn(),i=Object.keys(H);return b.h("div",null,b.h("div",{class:"sprite-brushes"},b.h("div",{class:"brush"},b.h("div",{class:"random-tile-brush",style:{width:`${t+ct}px`,height:`${e+ct}px`}},b.h("div",null,"?")),b.h("input",{checked:!0,type:"radio",value:"random",name:"tileVariant",style:{width:`${t}px`,height:`${e}px`}})),ut.map((n,a)=>b.h(vn,{width:t,height:e,index:a}))),i.map(n=>b.h(xn,{tileSet:H[n],label:i.length>1?n+" Hue":"Hue",tiles:H,type:n})))},wn=()=>b.h("form",{id:"tilePainter"},b.h("select",{id:"terrainType",name:"terrainType",onChange:ce},Object.keys(V).map(t=>b.h("option",{selected:j===t,value:t},V[t].displayName))),b.h(ue,null)),kn=()=>{var a;const t=tilePainter.elements,e={};Object.keys(H).forEach(o=>{const s=t[`${o}Hue`];e[o]=(s==null?void 0:s.value)||null});let i=null;const n=(a=t.tileVariant)==null?void 0:a.value;return n!=="random"&&(i=n||null),{set:terrainType.value,type:et,variant:i,colors:e}};let dt={};const Mn=t=>{if(t.x!==dt.x||t.y!==dt.y){const{tileMap:e}=p,i=kn(),{set:n,colors:a,variant:o,type:s}=i,r=p.entityMap.entities[t.x][t.y];Object.keys(r).length!==0&&s!=="floor"||(ee(t,e,n,a,o),Ri(t))}dt=t},An=()=>{dt={}},E=64,I=32,pt=32,Wn=32,pe=128,Cn="rgba(255,255,255,0.1)",ft="rgba(255,255,0,0.6)",On="yellow",Nn="rgba(255,0,0,0.2)",Tn="yellow",fe=.8,ye=.12,In=.18,Sn=.08,ge=E/2,me=I/2,Pn=I/E,En=6.28319,Tt=20,$n=({x:t,y:e,strokeColor:i,fillColor:n})=>{const{ctx:a}=p,o=L({x:t,y:e});a.strokeStyle=i,a.fillStyle=n,a.beginPath(),a.moveTo(o.x,o.y+I/2),a.lineTo(o.x+E/2,o.y),a.lineTo(o.x+E,o.y+I/2),a.lineTo(o.x+E/2,o.y+I),a.closePath(),a.fill(),a.stroke()},V={mountain:{displayName:"Mountains",walkable:1,floor:"mountain",feature:"mountainTop",type:"linked"},forest:{displayName:"Forest",walkable:0,floor:"forest",feature:"forestTop",type:"linked"},terracotta:{displayName:"Terracotta Floor",walkable:0,floor:"terracotta",type:"floor"},grass:{displayName:"Grass",walkable:0,floor:"grass",type:"floor"},cube:{displayName:"Cube",walkable:1,feature:"cube",floor:"terracotta",type:"feature"},water:{displayName:"Water",walkable:1,floor:"water",type:"obstacle"},void:{displayName:"Void",walkable:1,type:"void"}},xe=({x:t,y:e,image:i})=>{const{floorCtx:n}=p,a=L({x:t,y:e});n.drawImage(i.data,a.x,a.y-i.yOffset)},Dn=(t,e)=>{const{tileMap:i}=p,n=i.tiles[t][e];if(n.floor){const{set:a,color:o,variant:s}=n.floor;xe({x:t,y:e,image:Nt(a,o,s)})}},ve=({x:t,y:e})=>{const{origin:i}=p.view;return{x:Math.floor((t-i.x)/E-(e-i.y-I/2)/I),y:Math.floor((e-i.y-I/2)/I+(t-i.x)/E)}},L=({x:t,y:e})=>{const{origin:i}=p.view;return{x:t*E/2+e*E/2+i.x,y:e*I/2-t*I/2+i.y}},be=t=>{const{tileMap:e}=p,{x:i,y:n}=ve(t);return e.tiles[i]&&e.tiles[i][n]?{x:i,y:n}:null},nt=(t,e)=>{const{x:i,y:n}=t;$n({x:i,y:n,strokeColor:e,fillColor:Cn})},we=({xTiles:t,yTiles:e})=>{const{ctx:i,canvas:n}=p,a=(t+e)/2*I,o=(t+e)/2*E,s=a+Wn+pe;p.floorCanvas.width=p.entityCanvas.width=o,p.floorCanvas.height=p.entityCanvas.height=s;const r=a/2-I/4*(e-t)-I/2+pe,l={x:0,y:r},h={x:0,y:0},d=()=>{n.width=canvasRoot.clientWidth,n.height=canvasRoot.clientHeight,i.setTransform(1,0,0,1,h.x,h.y)};return onresize=()=>{d(),_n()},{origin:l,xTiles:t,yTiles:e,translate:h,setApertureSize:d}},jn=t=>{const{ctx:e,canvas:i,floorCanvas:n,entityCanvas:a,view:o,effectsMiddle:s,effectsTop:r}=p,{translate:l}=o;e.clearRect(-l.x,-l.y,i.width,i.height),e.drawImage(n,0,0),s(),p.entities.forEach(h=>{h.update(t)}),e.drawImage(a,0,0),r()},_n=()=>{const{ctx:t,canvas:e,floorCanvas:i,entityCanvas:n,view:a}=p,{translate:o}=a;t.clearRect(-o.x,-o.y,e.width,e.height),t.drawImage(i,0,0),t.drawImage(n,0,0)},ke=t=>{const{onFrameControls:e}=p;e&&(e(t),p.monitor(t)),jn(t)},S={};let it=0,Me=0,Ae;S.start=t=>{Ae=t,Me=requestAnimationFrame(e=>{Rn(e,t)}),S.paused=!1},S.restart=()=>{S.start(Ae),S.paused=!1},S.stop=()=>{window.cancelAnimationFrame(Me),it=0,S.paused=!0};const Rn=(t,e)=>{it||(it=t);const i=t-it;it=t,e(i),S.start(e)},Fn=t=>{S.stop(),delete p.entites,delete p.tileMap,delete p.entityMap;const{xTiles:e,yTiles:i}=t;p.view=p.setView({xTiles:e,yTiles:i}),p.loadMap(t),S.start(ke)},Ln=()=>{saveButton.onclick=()=>{const t=cn(),e=document.createElement("a");e.setAttribute("href",t),e.setAttribute("download",saveName.value+".json"),saveButton.after(e),e.click(),e.remove()},loadButton.onclick=()=>{const t=document.createElement("input");t.type="file",loadButton.after(t),t.onchange=()=>{const e=new FileReader;e.onload=i=>{const n=ne(i.target.result);Fn(n)},e.readAsText(t.files[0])},t.click(),t.remove()}};let Bn=0;const qn=()=>Bn++,We=(t,e)=>{const i=t+(Math.random()*e-e/2);return Math.floor(i)},yt=(t,e,i,n)=>{const a=t.x+ge,o=t.y+me;n.strokeStyle=e,n.beginPath(),n.ellipse(a,o,i,i*Pn,0,0,En),n.stroke()},It=16,Ce=.86,Hn="rgba(150, 150, 150, 0.8)",gt=(t,e,i,n)=>{const{ctx:a}=p,o=t.length;t.forEach((s,r)=>{const[l,h]=s,d=L({y:l,x:h});if(yt(d,e,It,a),i&&r===o-1){const f=d.x+ge,m=d.y+me;a.beginPath(),a.moveTo(f,m),a.lineTo(f-It/3,m-I*Ce*1.5),a.lineTo(f,m-I*1.5),a.lineTo(f+It/3,m-I*Ce*1.5),a.closePath(),a.fillStyle=Hn,a.strokeStyle=n,a.fill(),a.stroke()}})};class St{constructor({sprite:e,haloColor:i}){Z(this,"addToScene",e=>{const{entityMap:i}=p,{id:n,render:a,redraw:o}=this;this.tileIndex=e,this.position=L(e),this.positionPrevious=this.position,this.redrawEntities=Fi,i.addEntity({tileIndex:e,id:n,render:a}),p.entities.push(this),o()});Z(this,"render",()=>{const{entityCtx:e}=p,{sprite:i,position:n,haloColor:a}=this;yt(n,a,Tt,e),e.drawImage(i.data,Math.round(n.x),Math.round(n.y-i.yOffset))});Z(this,"redraw",()=>{const{tileIndex:e,position:i,positionPrevious:n}=this;this.redrawEntities(e,i,n),this.positionPrevious={x:i.x,y:i.y}});this.sprite=e||F.playerTokens.sheild,this.haloColor=i||Tn,this.id=qn(),this.position={x:0,y:0}}update(){}}var Oe={exports:{}},at={exports:{}},Ne={exports:{}};(function(t){(function(){var e,i,n,a,o,s,r,l,h,d,f,m,x,k,g;n=Math.floor,d=Math.min,i=function(u,c){return u<c?-1:u>c?1:0},h=function(u,c,y,v,M){var w;if(y==null&&(y=0),M==null&&(M=i),y<0)throw new Error("lo must be non-negative");for(v==null&&(v=u.length);y<v;)w=n((y+v)/2),M(c,u[w])<0?v=w:y=w+1;return[].splice.apply(u,[y,y-y].concat(c)),c},s=function(u,c,y){return y==null&&(y=i),u.push(c),k(u,0,u.length-1,y)},o=function(u,c){var y,v;return c==null&&(c=i),y=u.pop(),u.length?(v=u[0],u[0]=y,g(u,0,c)):v=y,v},l=function(u,c,y){var v;return y==null&&(y=i),v=u[0],u[0]=c,g(u,0,y),v},r=function(u,c,y){var v;return y==null&&(y=i),u.length&&y(u[0],c)<0&&(v=[u[0],c],c=v[0],u[0]=v[1],g(u,0,y)),c},a=function(u,c){var y,v,M,w,A,N;for(c==null&&(c=i),w=function(){N=[];for(var T=0,D=n(u.length/2);0<=D?T<D:T>D;0<=D?T++:T--)N.push(T);return N}.apply(this).reverse(),A=[],v=0,M=w.length;v<M;v++)y=w[v],A.push(g(u,y,c));return A},x=function(u,c,y){var v;if(y==null&&(y=i),v=u.indexOf(c),v!==-1)return k(u,0,v,y),g(u,v,y)},f=function(u,c,y){var v,M,w,A,N;if(y==null&&(y=i),M=u.slice(0,c),!M.length)return M;for(a(M,y),N=u.slice(c),w=0,A=N.length;w<A;w++)v=N[w],r(M,v,y);return M.sort(y).reverse()},m=function(u,c,y){var v,M,w,A,N,T,D,G,Yt;if(y==null&&(y=i),c*10<=u.length){if(w=u.slice(0,c).sort(y),!w.length)return w;for(M=w[w.length-1],D=u.slice(c),A=0,T=D.length;A<T;A++)v=D[A],y(v,M)<0&&(h(w,v,0,null,y),w.pop(),M=w[w.length-1]);return w}for(a(u,y),Yt=[],N=0,G=d(c,u.length);0<=G?N<G:N>G;0<=G?++N:--N)Yt.push(o(u,y));return Yt},k=function(u,c,y,v){var M,w,A;for(v==null&&(v=i),M=u[y];y>c;){if(A=y-1>>1,w=u[A],v(M,w)<0){u[y]=w,y=A;continue}break}return u[y]=M},g=function(u,c,y){var v,M,w,A,N;for(y==null&&(y=i),M=u.length,N=c,w=u[c],v=2*c+1;v<M;)A=v+1,A<M&&!(y(u[v],u[A])<0)&&(v=A),u[c]=u[v],c=v,v=2*c+1;return u[c]=w,k(u,N,c,y)},e=function(){u.push=s,u.pop=o,u.replace=l,u.pushpop=r,u.heapify=a,u.updateItem=x,u.nlargest=f,u.nsmallest=m;function u(c){this.cmp=c!=null?c:i,this.nodes=[]}return u.prototype.push=function(c){return s(this.nodes,c,this.cmp)},u.prototype.pop=function(){return o(this.nodes,this.cmp)},u.prototype.peek=function(){return this.nodes[0]},u.prototype.contains=function(c){return this.nodes.indexOf(c)!==-1},u.prototype.replace=function(c){return l(this.nodes,c,this.cmp)},u.prototype.pushpop=function(c){return r(this.nodes,c,this.cmp)},u.prototype.heapify=function(){return a(this.nodes,this.cmp)},u.prototype.updateItem=function(c){return x(this.nodes,c,this.cmp)},u.prototype.clear=function(){return this.nodes=[]},u.prototype.empty=function(){return this.nodes.length===0},u.prototype.size=function(){return this.nodes.length},u.prototype.clone=function(){var c;return c=new u,c.nodes=this.nodes.slice(0),c},u.prototype.toArray=function(){return this.nodes.slice(0)},u.prototype.insert=u.prototype.push,u.prototype.top=u.prototype.peek,u.prototype.front=u.prototype.peek,u.prototype.has=u.prototype.contains,u.prototype.copy=u.prototype.clone,u}(),t!==null&&t.exports?t.exports=e:window.Heap=e}).call(tt)})(Ne),function(t){t.exports=Ne.exports}(at);function Un(t,e,i){this.x=t,this.y=e,this.walkable=i===void 0?!0:i}var Pt=Un,Vn={Always:1,Never:2,IfAtMostOneObstacle:3,OnlyWhenNoObstacles:4},$=Vn,Te=Pt,mt=$;function B(t,e,i){var n;typeof t!="object"?n=t:(e=t.length,n=t[0].length,i=t),this.width=n,this.height=e,this.nodes=this._buildNodes(n,e,i)}B.prototype._buildNodes=function(t,e,i){var n,a,o=new Array(e);for(n=0;n<e;++n)for(o[n]=new Array(t),a=0;a<t;++a)o[n][a]=new Te(a,n);if(i===void 0)return o;if(i.length!==e||i[0].length!==t)throw new Error("Matrix size does not fit");for(n=0;n<e;++n)for(a=0;a<t;++a)i[n][a]&&(o[n][a].walkable=!1);return o},B.prototype.getNodeAt=function(t,e){return this.nodes[e][t]},B.prototype.isWalkableAt=function(t,e){return this.isInside(t,e)&&this.nodes[e][t].walkable},B.prototype.isInside=function(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height},B.prototype.setWalkableAt=function(t,e,i){this.nodes[e][t].walkable=i},B.prototype.getNeighbors=function(t,e){var i=t.x,n=t.y,a=[],o=!1,s=!1,r=!1,l=!1,h=!1,d=!1,f=!1,m=!1,x=this.nodes;if(this.isWalkableAt(i,n-1)&&(a.push(x[n-1][i]),o=!0),this.isWalkableAt(i+1,n)&&(a.push(x[n][i+1]),r=!0),this.isWalkableAt(i,n+1)&&(a.push(x[n+1][i]),h=!0),this.isWalkableAt(i-1,n)&&(a.push(x[n][i-1]),f=!0),e===mt.Never)return a;if(e===mt.OnlyWhenNoObstacles)s=f&&o,l=o&&r,d=r&&h,m=h&&f;else if(e===mt.IfAtMostOneObstacle)s=f||o,l=o||r,d=r||h,m=h||f;else if(e===mt.Always)s=!0,l=!0,d=!0,m=!0;else throw new Error("Incorrect value of diagonalMovement");return s&&this.isWalkableAt(i-1,n-1)&&a.push(x[n-1][i-1]),l&&this.isWalkableAt(i+1,n-1)&&a.push(x[n-1][i+1]),d&&this.isWalkableAt(i+1,n+1)&&a.push(x[n+1][i+1]),m&&this.isWalkableAt(i-1,n+1)&&a.push(x[n+1][i-1]),a},B.prototype.clone=function(){var t,e,i=this.width,n=this.height,a=this.nodes,o=new B(i,n),s=new Array(n);for(t=0;t<n;++t)for(s[t]=new Array(i),e=0;e<i;++e)s[t][e]=new Te(e,t,a[t][e].walkable);return o.nodes=s,o};var Jn=B,P={};function Et(t){for(var e=[[t.x,t.y]];t.parent;)t=t.parent,e.push([t.x,t.y]);return e.reverse()}P.backtrace=Et;function Gn(t,e){var i=Et(t),n=Et(e);return i.concat(n.reverse())}P.biBacktrace=Gn;function zn(t){var e,i=0,n,a,o,s;for(e=1;e<t.length;++e)n=t[e-1],a=t[e],o=n[0]-a[0],s=n[1]-a[1],i+=Math.sqrt(o*o+s*s);return i}P.pathLength=zn;function $t(t,e,i,n){var a=Math.abs,o=[],s,r,l,h,d,f;for(l=a(i-t),h=a(n-e),s=t<i?1:-1,r=e<n?1:-1,d=l-h;o.push([t,e]),!(t===i&&e===n);)f=2*d,f>-h&&(d=d-h,t=t+s),f<l&&(d=d+l,e=e+r);return o}P.interpolate=$t;function Kn(t){var e=[],i=t.length,n,a,o,s,r,l;if(i<2)return e;for(r=0;r<i-1;++r)for(n=t[r],a=t[r+1],o=$t(n[0],n[1],a[0],a[1]),s=o.length,l=0;l<s-1;++l)e.push(o[l]);return e.push(t[i-1]),e}P.expandPath=Kn;function Qn(t,e){var i=e.length,n=e[0][0],a=e[0][1],o=e[i-1][0],s=e[i-1][1],r,l,h,d,f,m,x,k,g,u,c;for(r=n,l=a,f=[[r,l]],m=2;m<i;++m){for(k=e[m],h=k[0],d=k[1],g=$t(r,l,h,d),c=!1,x=1;x<g.length;++x)if(u=g[x],!t.isWalkableAt(u[0],u[1])){c=!0;break}c&&(lastValidCoord=e[m-1],f.push(lastValidCoord),r=lastValidCoord[0],l=lastValidCoord[1])}return f.push([o,s]),f}P.smoothenPath=Qn;function Xn(t){if(t.length<3)return t;var e=[],i=t[0][0],n=t[0][1],a=t[1][0],o=t[1][1],s=a-i,r=o-n,l,h,d,f,m,x;for(m=Math.sqrt(s*s+r*r),s/=m,r/=m,e.push([i,n]),x=2;x<t.length;x++)l=a,h=o,d=s,f=r,a=t[x][0],o=t[x][1],s=a-l,r=o-h,m=Math.sqrt(s*s+r*r),s/=m,r/=m,(s!==d||r!==f)&&e.push([l,h]);return e.push([a,o]),e}P.compressPath=Xn;var ot={manhattan:function(t,e){return t+e},euclidean:function(t,e){return Math.sqrt(t*t+e*e)},octile:function(t,e){var i=Math.SQRT2-1;return t<e?i*t+e:i*e+t},chebyshev:function(t,e){return Math.max(t,e)}},Yn=at.exports,Zn=P,Dt=ot,xt=$;function Ie(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.heuristic=t.heuristic||Dt.manhattan,this.weight=t.weight||1,this.diagonalMovement=t.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=xt.OnlyWhenNoObstacles:this.diagonalMovement=xt.IfAtMostOneObstacle:this.diagonalMovement=xt.Never),this.diagonalMovement===xt.Never?this.heuristic=t.heuristic||Dt.manhattan:this.heuristic=t.heuristic||Dt.octile}Ie.prototype.findPath=function(t,e,i,n,a){var o=new Yn(function(w,A){return w.f-A.f}),s=a.getNodeAt(t,e),r=a.getNodeAt(i,n),l=this.heuristic,h=this.diagonalMovement,d=this.weight,f=Math.abs,m=Math.SQRT2,x,k,g,u,c,y,v,M;for(s.g=0,s.f=0,o.push(s),s.opened=!0;!o.empty();){if(x=o.pop(),x.closed=!0,x===r)return Zn.backtrace(r);for(k=a.getNeighbors(x,h),u=0,c=k.length;u<c;++u)g=k[u],!g.closed&&(y=g.x,v=g.y,M=x.g+(y-x.x===0||v-x.y===0?1:m),(!g.opened||M<g.g)&&(g.g=M,g.h=g.h||d*l(f(y-i),f(v-n)),g.f=g.g+g.h,g.parent=x,g.opened?o.updateItem(g):(o.push(g),g.opened=!0)))}return[]};var jt=Ie,Se=jt;function vt(t){Se.call(this,t);var e=this.heuristic;this.heuristic=function(i,n){return e(i,n)*1e6}}vt.prototype=new Se,vt.prototype.constructor=vt;var ti=vt,ei=P,_t=$;function Pe(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=_t.OnlyWhenNoObstacles:this.diagonalMovement=_t.IfAtMostOneObstacle:this.diagonalMovement=_t.Never)}Pe.prototype.findPath=function(t,e,i,n,a){var o=[],s=this.diagonalMovement,r=a.getNodeAt(t,e),l=a.getNodeAt(i,n),h,d,f,m,x;for(o.push(r),r.opened=!0;o.length;){if(f=o.shift(),f.closed=!0,f===l)return ei.backtrace(l);for(h=a.getNeighbors(f,s),m=0,x=h.length;m<x;++m)d=h[m],!(d.closed||d.opened)&&(o.push(d),d.opened=!0,d.parent=f)}return[]};var ni=Pe,Ee=jt;function bt(t){Ee.call(this,t),this.heuristic=function(e,i){return 0}}bt.prototype=new Ee,bt.prototype.constructor=bt;var ii=bt,$e=at.exports,De=P,Rt=ot,wt=$;function je(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.heuristic=t.heuristic||Rt.manhattan,this.weight=t.weight||1,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=wt.OnlyWhenNoObstacles:this.diagonalMovement=wt.IfAtMostOneObstacle:this.diagonalMovement=wt.Never),this.diagonalMovement===wt.Never?this.heuristic=t.heuristic||Rt.manhattan:this.heuristic=t.heuristic||Rt.octile}je.prototype.findPath=function(t,e,i,n,a){var o=function(D,G){return D.f-G.f},s=new $e(o),r=new $e(o),l=a.getNodeAt(t,e),h=a.getNodeAt(i,n),d=this.heuristic,f=this.diagonalMovement,m=this.weight,x=Math.abs,k=Math.SQRT2,g,u,c,y,v,M,w,A,N=1,T=2;for(l.g=0,l.f=0,s.push(l),l.opened=N,h.g=0,h.f=0,r.push(h),h.opened=T;!s.empty()&&!r.empty();){for(g=s.pop(),g.closed=!0,u=a.getNeighbors(g,f),y=0,v=u.length;y<v;++y)if(c=u[y],!c.closed){if(c.opened===T)return De.biBacktrace(g,c);M=c.x,w=c.y,A=g.g+(M-g.x===0||w-g.y===0?1:k),(!c.opened||A<c.g)&&(c.g=A,c.h=c.h||m*d(x(M-i),x(w-n)),c.f=c.g+c.h,c.parent=g,c.opened?s.updateItem(c):(s.push(c),c.opened=N))}for(g=r.pop(),g.closed=!0,u=a.getNeighbors(g,f),y=0,v=u.length;y<v;++y)if(c=u[y],!c.closed){if(c.opened===N)return De.biBacktrace(c,g);M=c.x,w=c.y,A=g.g+(M-g.x===0||w-g.y===0?1:k),(!c.opened||A<c.g)&&(c.g=A,c.h=c.h||m*d(x(M-t),x(w-e)),c.f=c.g+c.h,c.parent=g,c.opened?r.updateItem(c):(r.push(c),c.opened=T))}}return[]};var Ft=je,_e=Ft;function kt(t){_e.call(this,t);var e=this.heuristic;this.heuristic=function(i,n){return e(i,n)*1e6}}kt.prototype=new _e,kt.prototype.constructor=kt;var ai=kt,Re=P,Lt=$;function Fe(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=Lt.OnlyWhenNoObstacles:this.diagonalMovement=Lt.IfAtMostOneObstacle:this.diagonalMovement=Lt.Never)}Fe.prototype.findPath=function(t,e,i,n,a){var o=a.getNodeAt(t,e),s=a.getNodeAt(i,n),r=[],l=[],h,d,f,m=this.diagonalMovement,x=0,k=1,g,u;for(r.push(o),o.opened=!0,o.by=x,l.push(s),s.opened=!0,s.by=k;r.length&&l.length;){for(f=r.shift(),f.closed=!0,h=a.getNeighbors(f,m),g=0,u=h.length;g<u;++g)if(d=h[g],!d.closed){if(d.opened){if(d.by===k)return Re.biBacktrace(f,d);continue}r.push(d),d.parent=f,d.opened=!0,d.by=x}for(f=l.shift(),f.closed=!0,h=a.getNeighbors(f,m),g=0,u=h.length;g<u;++g)if(d=h[g],!d.closed){if(d.opened){if(d.by===x)return Re.biBacktrace(d,f);continue}l.push(d),d.parent=f,d.opened=!0,d.by=k}}return[]};var oi=Fe,Le=Ft;function Mt(t){Le.call(this,t),this.heuristic=function(e,i){return 0}}Mt.prototype=new Le,Mt.prototype.constructor=Mt;var si=Mt,Bt=ot,Be=Pt,At=$;function qe(t){t=t||{},this.allowDiagonal=t.allowDiagonal,this.dontCrossCorners=t.dontCrossCorners,this.diagonalMovement=t.diagonalMovement,this.heuristic=t.heuristic||Bt.manhattan,this.weight=t.weight||1,this.trackRecursion=t.trackRecursion||!1,this.timeLimit=t.timeLimit||1/0,this.diagonalMovement||(this.allowDiagonal?this.dontCrossCorners?this.diagonalMovement=At.OnlyWhenNoObstacles:this.diagonalMovement=At.IfAtMostOneObstacle:this.diagonalMovement=At.Never),this.diagonalMovement===At.Never?this.heuristic=t.heuristic||Bt.manhattan:this.heuristic=t.heuristic||Bt.octile}qe.prototype.findPath=function(t,e,i,n,a){var o=new Date().getTime(),s=function(g,u){return this.heuristic(Math.abs(u.x-g.x),Math.abs(u.y-g.y))}.bind(this),r=function(g,u){return g.x===u.x||g.y===u.y?1:Math.SQRT2},l=function(g,u,c,y,v){if(this.timeLimit>0&&new Date().getTime()-o>this.timeLimit*1e3)return 1/0;var M=u+s(g,d)*this.weight;if(M>c)return M;if(g==d)return y[v]=[g.x,g.y],g;var w,A,N,T,D=a.getNeighbors(g,this.diagonalMovement);for(N=0,w=1/0;T=D[N];++N){if(this.trackRecursion&&(T.retainCount=T.retainCount+1||1,T.tested!==!0&&(T.tested=!0)),A=l(T,u+r(g,T),c,y,v+1),A instanceof Be)return y[v]=[g.x,g.y],A;this.trackRecursion&&--T.retainCount===0&&(T.tested=!1),A<w&&(w=A)}return w}.bind(this),h=a.getNodeAt(t,e),d=a.getNodeAt(i,n),f=s(h,d),m,x,k;for(m=0;;++m){if(x=[],k=l(h,0,f,x,0),k===1/0)return[];if(k instanceof Be)return x;f=k}return[]};var ri=qe,li=at.exports,He=P,Ue=ot;function qt(t){t=t||{},this.heuristic=t.heuristic||Ue.manhattan,this.trackJumpRecursion=t.trackJumpRecursion||!1}qt.prototype.findPath=function(t,e,i,n,a){var o=this.openList=new li(function(h,d){return h.f-d.f}),s=this.startNode=a.getNodeAt(t,e),r=this.endNode=a.getNodeAt(i,n),l;for(this.grid=a,s.g=0,s.f=0,o.push(s),s.opened=!0;!o.empty();){if(l=o.pop(),l.closed=!0,l===r)return He.expandPath(He.backtrace(r));this._identifySuccessors(l)}return[]},qt.prototype._identifySuccessors=function(t){var e=this.grid,i=this.heuristic,n=this.openList,a=this.endNode.x,o=this.endNode.y,s,r,l,h,d,f=t.x,m=t.y,x,k,g,u,c,y=Math.abs;for(s=this._findNeighbors(t),h=0,d=s.length;h<d;++h)if(r=s[h],l=this._jump(r[0],r[1],f,m),l){if(x=l[0],k=l[1],c=e.getNodeAt(x,k),c.closed)continue;g=Ue.octile(y(x-f),y(k-m)),u=t.g+g,(!c.opened||u<c.g)&&(c.g=u,c.h=c.h||i(y(x-a),y(k-o)),c.f=c.g+c.h,c.parent=t,c.opened?n.updateItem(c):(n.push(c),c.opened=!0))}};var Wt=qt,Ve=Wt,hi=$;function z(t){Ve.call(this,t)}z.prototype=new Ve,z.prototype.constructor=z,z.prototype._jump=function(t,e,i,n){var a=this.grid,o=t-i,s=e-n;if(!a.isWalkableAt(t,e))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(t,e).tested=!0),a.getNodeAt(t,e)===this.endNode)return[t,e];if(o!==0){if(a.isWalkableAt(t,e-1)&&!a.isWalkableAt(t-o,e-1)||a.isWalkableAt(t,e+1)&&!a.isWalkableAt(t-o,e+1))return[t,e]}else if(s!==0){if(a.isWalkableAt(t-1,e)&&!a.isWalkableAt(t-1,e-s)||a.isWalkableAt(t+1,e)&&!a.isWalkableAt(t+1,e-s))return[t,e];if(this._jump(t+1,e,t,e)||this._jump(t-1,e,t,e))return[t,e]}else throw new Error("Only horizontal and vertical movements are allowed");return this._jump(t+o,e+s,t,e)},z.prototype._findNeighbors=function(t){var e=t.parent,i=t.x,n=t.y,a=this.grid,o,s,r,l,h=[],d,f,m,x;if(e)o=e.x,s=e.y,r=(i-o)/Math.max(Math.abs(i-o),1),l=(n-s)/Math.max(Math.abs(n-s),1),r!==0?(a.isWalkableAt(i,n-1)&&h.push([i,n-1]),a.isWalkableAt(i,n+1)&&h.push([i,n+1]),a.isWalkableAt(i+r,n)&&h.push([i+r,n])):l!==0&&(a.isWalkableAt(i-1,n)&&h.push([i-1,n]),a.isWalkableAt(i+1,n)&&h.push([i+1,n]),a.isWalkableAt(i,n+l)&&h.push([i,n+l]));else for(d=a.getNeighbors(t,hi.Never),m=0,x=d.length;m<x;++m)f=d[m],h.push([f.x,f.y]);return h};var ci=z,Je=Wt,di=$;function K(t){Je.call(this,t)}K.prototype=new Je,K.prototype.constructor=K,K.prototype._jump=function(t,e,i,n){var a=this.grid,o=t-i,s=e-n;if(!a.isWalkableAt(t,e))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(t,e).tested=!0),a.getNodeAt(t,e)===this.endNode)return[t,e];if(o!==0&&s!==0){if(a.isWalkableAt(t-o,e+s)&&!a.isWalkableAt(t-o,e)||a.isWalkableAt(t+o,e-s)&&!a.isWalkableAt(t,e-s))return[t,e];if(this._jump(t+o,e,t,e)||this._jump(t,e+s,t,e))return[t,e]}else if(o!==0){if(a.isWalkableAt(t+o,e+1)&&!a.isWalkableAt(t,e+1)||a.isWalkableAt(t+o,e-1)&&!a.isWalkableAt(t,e-1))return[t,e]}else if(a.isWalkableAt(t+1,e+s)&&!a.isWalkableAt(t+1,e)||a.isWalkableAt(t-1,e+s)&&!a.isWalkableAt(t-1,e))return[t,e];return this._jump(t+o,e+s,t,e)},K.prototype._findNeighbors=function(t){var e=t.parent,i=t.x,n=t.y,a=this.grid,o,s,r,l,h=[],d,f,m,x;if(e)o=e.x,s=e.y,r=(i-o)/Math.max(Math.abs(i-o),1),l=(n-s)/Math.max(Math.abs(n-s),1),r!==0&&l!==0?(a.isWalkableAt(i,n+l)&&h.push([i,n+l]),a.isWalkableAt(i+r,n)&&h.push([i+r,n]),a.isWalkableAt(i+r,n+l)&&h.push([i+r,n+l]),a.isWalkableAt(i-r,n)||h.push([i-r,n+l]),a.isWalkableAt(i,n-l)||h.push([i+r,n-l])):r===0?(a.isWalkableAt(i,n+l)&&h.push([i,n+l]),a.isWalkableAt(i+1,n)||h.push([i+1,n+l]),a.isWalkableAt(i-1,n)||h.push([i-1,n+l])):(a.isWalkableAt(i+r,n)&&h.push([i+r,n]),a.isWalkableAt(i,n+1)||h.push([i+r,n+1]),a.isWalkableAt(i,n-1)||h.push([i+r,n-1]));else for(d=a.getNeighbors(t,di.Always),m=0,x=d.length;m<x;++m)f=d[m],h.push([f.x,f.y]);return h};var pi=K,Ge=Wt,fi=$;function Q(t){Ge.call(this,t)}Q.prototype=new Ge,Q.prototype.constructor=Q,Q.prototype._jump=function(t,e,i,n){var a=this.grid,o=t-i,s=e-n;if(!a.isWalkableAt(t,e))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(t,e).tested=!0),a.getNodeAt(t,e)===this.endNode)return[t,e];if(o!==0&&s!==0){if(this._jump(t+o,e,t,e)||this._jump(t,e+s,t,e))return[t,e]}else if(o!==0){if(a.isWalkableAt(t,e-1)&&!a.isWalkableAt(t-o,e-1)||a.isWalkableAt(t,e+1)&&!a.isWalkableAt(t-o,e+1))return[t,e]}else if(s!==0&&(a.isWalkableAt(t-1,e)&&!a.isWalkableAt(t-1,e-s)||a.isWalkableAt(t+1,e)&&!a.isWalkableAt(t+1,e-s)))return[t,e];return a.isWalkableAt(t+o,e)&&a.isWalkableAt(t,e+s)?this._jump(t+o,e+s,t,e):null},Q.prototype._findNeighbors=function(t){var e=t.parent,i=t.x,n=t.y,a=this.grid,o,s,r,l,h=[],d,f,m,x;if(e)if(o=e.x,s=e.y,r=(i-o)/Math.max(Math.abs(i-o),1),l=(n-s)/Math.max(Math.abs(n-s),1),r!==0&&l!==0)a.isWalkableAt(i,n+l)&&h.push([i,n+l]),a.isWalkableAt(i+r,n)&&h.push([i+r,n]),a.isWalkableAt(i,n+l)&&a.isWalkableAt(i+r,n)&&h.push([i+r,n+l]);else{var k;if(r!==0){k=a.isWalkableAt(i+r,n);var g=a.isWalkableAt(i,n+1),u=a.isWalkableAt(i,n-1);k&&(h.push([i+r,n]),g&&h.push([i+r,n+1]),u&&h.push([i+r,n-1])),g&&h.push([i,n+1]),u&&h.push([i,n-1])}else if(l!==0){k=a.isWalkableAt(i,n+l);var c=a.isWalkableAt(i+1,n),y=a.isWalkableAt(i-1,n);k&&(h.push([i,n+l]),c&&h.push([i+1,n+l]),y&&h.push([i-1,n+l])),c&&h.push([i+1,n]),y&&h.push([i-1,n])}}else for(d=a.getNeighbors(t,fi.OnlyWhenNoObstacles),m=0,x=d.length;m<x;++m)f=d[m],h.push([f.x,f.y]);return h};var yi=Q,ze=Wt,gi=$;function X(t){ze.call(this,t)}X.prototype=new ze,X.prototype.constructor=X,X.prototype._jump=function(t,e,i,n){var a=this.grid,o=t-i,s=e-n;if(!a.isWalkableAt(t,e))return null;if(this.trackJumpRecursion===!0&&(a.getNodeAt(t,e).tested=!0),a.getNodeAt(t,e)===this.endNode)return[t,e];if(o!==0&&s!==0){if(a.isWalkableAt(t-o,e+s)&&!a.isWalkableAt(t-o,e)||a.isWalkableAt(t+o,e-s)&&!a.isWalkableAt(t,e-s))return[t,e];if(this._jump(t+o,e,t,e)||this._jump(t,e+s,t,e))return[t,e]}else if(o!==0){if(a.isWalkableAt(t+o,e+1)&&!a.isWalkableAt(t,e+1)||a.isWalkableAt(t+o,e-1)&&!a.isWalkableAt(t,e-1))return[t,e]}else if(a.isWalkableAt(t+1,e+s)&&!a.isWalkableAt(t+1,e)||a.isWalkableAt(t-1,e+s)&&!a.isWalkableAt(t-1,e))return[t,e];return a.isWalkableAt(t+o,e)||a.isWalkableAt(t,e+s)?this._jump(t+o,e+s,t,e):null},X.prototype._findNeighbors=function(t){var e=t.parent,i=t.x,n=t.y,a=this.grid,o,s,r,l,h=[],d,f,m,x;if(e)o=e.x,s=e.y,r=(i-o)/Math.max(Math.abs(i-o),1),l=(n-s)/Math.max(Math.abs(n-s),1),r!==0&&l!==0?(a.isWalkableAt(i,n+l)&&h.push([i,n+l]),a.isWalkableAt(i+r,n)&&h.push([i+r,n]),(a.isWalkableAt(i,n+l)||a.isWalkableAt(i+r,n))&&h.push([i+r,n+l]),!a.isWalkableAt(i-r,n)&&a.isWalkableAt(i,n+l)&&h.push([i-r,n+l]),!a.isWalkableAt(i,n-l)&&a.isWalkableAt(i+r,n)&&h.push([i+r,n-l])):r===0?a.isWalkableAt(i,n+l)&&(h.push([i,n+l]),a.isWalkableAt(i+1,n)||h.push([i+1,n+l]),a.isWalkableAt(i-1,n)||h.push([i-1,n+l])):a.isWalkableAt(i+r,n)&&(h.push([i+r,n]),a.isWalkableAt(i,n+1)||h.push([i+r,n+1]),a.isWalkableAt(i,n-1)||h.push([i+r,n-1]));else for(d=a.getNeighbors(t,gi.IfAtMostOneObstacle),m=0,x=d.length;m<x;++m)f=d[m],h.push([f.x,f.y]);return h};var mi=X,Ht=$,xi=ci,vi=pi,bi=yi,wi=mi;function ki(t){return t=t||{},t.diagonalMovement===Ht.Never?new xi(t):t.diagonalMovement===Ht.Always?new vi(t):t.diagonalMovement===Ht.OnlyWhenNoObstacles?new bi(t):new wi(t)}var Mi=ki,Ai={Heap:at.exports,Node:Pt,Grid:Jn,Util:P,DiagonalMovement:$,Heuristic:ot,AStarFinder:jt,BestFirstFinder:ti,BreadthFirstFinder:ni,DijkstraFinder:ii,BiAStarFinder:Ft,BiBestFirstFinder:ai,BiBreadthFirstFinder:oi,BiDijkstraFinder:si,IDAStarFinder:ri,JumpPointFinder:Mi};(function(t){t.exports=Ai})(Oe);const Ke=dn(Oe.exports),Wi=new Ke.AStarFinder({allowDiagonal:!0,dontCrossCorners:!0}),Ut=(t,e)=>{const{walkableTileMatrix:i}=p.tileMap,n=new Ke.Grid(i);return Wi.findPath(t.y,t.x,e.y,e.x,n)},Qe=(t,e)=>{const{entityMap:i}=p;let n=null,a,o,s;t.isMoving=!1;const r=d=>{if(t.isMoving){const f=e*d,m=f*Math.cos(n),x=f*Math.sin(n);t.position.x+=m,t.position.y+=x;const k=a.x-t.position.x,g=a.y-t.position.y,u=k>0!==o,c=g>0!==s;(u||c)&&(t.position.x=a.x,t.position.y=a.y,t.path.length>1?(t.path.shift(),h()):t.isMoving=!1),i.removeEntity({tileIndex:t.tileIndex,id:t.id}),t.tileIndex=ve({x:t.position.x+E/2,y:t.position.y+I/2}),i.addEntity({tileIndex:t.tileIndex,id:t.id,render:t.render})}},l=()=>{t.isMoving=!1,t.path=[]},h=()=>{const[d]=t.path,[f,m]=d,x={x:m,y:f};if(_(x)){a=L(x);const k=a.x-t.position.x,g=a.y-t.position.y;o=k>0,s=g>0,n=Math.atan2(g,k)}else l()};return{move:r,requestMove:d=>{const f=Ut(t.tileIndex,d),m=d.x===t.tileIndex.x&&d.y===t.tileIndex.y;!t.isMoving&&!m&&f.length&&(t.path=f,t.path.shift(),h(),t.isMoving=!0)},unsetPath:l}};class Ci extends St{constructor(){super({sprite:F.playerTokens.angel,haloColor:"lime"}),this.path=[];const e=Qe(this,In),i={editMode:e.move,playMode:e.move};this.update=n=>{i[p.mode](n),this.redraw()},this.requestMove=e.requestMove,this.unsetPath=e.unsetPath}}class Oi extends St{constructor(i){super(i);Z(this,"pickPath",()=>{const{pathFinder:i,tileIndex:n}=this,a={x:We(n.x,10),y:We(n.y,10)};_(a)&&i.requestMove(a)});Z(this,"update",i=>{const{pathFinder:n,pickPath:a,redraw:o,isMoving:s}=this;p.mode!=="editMode"&&(s||a(),n.move(i)),o()});this.path=[],this.pathFinder=Qe(this,Sn)}}const Ni=t=>{const e={};e.entities=[];const{xTiles:i,yTiles:n}=t;for(let a=0;a<i;a++){e.entities[a]=[];for(let o=0;o<n;o++)e.entities[a][o]={}}return e.addEntity=({tileIndex:a,id:o,render:s})=>{e.entities[a.x][a.y][o]=s,R(a,1)},e.entityCheck=({x:a,y:o})=>{const s=e.entities[a][o];return Object.keys(s).length===0},e.removeEntity=({tileIndex:a,id:o})=>{const{x:s,y:r}=a,l=e.entities[s][r];if(delete l[o],Object.keys(l).length===0){const h=t.tiles[s][r].walkable;R(a,h)}},e},Vt=(t,e)=>{var o;const{tileMap:i,entityMap:n}=p,a=(o=i.tiles[t])==null?void 0:o[e];if(a){const{feature:s}=a,r=L({x:t,y:e}),l=n.entities[t][e];for(const h in l)l[h]();if(s){const{set:h,color:d,variant:f}=s,m=Nt(h,d,f);p.entityCtx.drawImage(m.data,r.x,r.y-m.yOffset),p.entityCtx.globalAlpha=.5;for(const x in l)l[x]();p.entityCtx.globalAlpha=1}}},O={x:0,y:0,buttonCode:0,onMouseUp:null,onMouseMove:null,isDragged:!1,dragStart:{x:0,y:0},drag:{x:0,y:0}},Ti=t=>(t.addEventListener("contextmenu",e=>e.preventDefault()),t.onmousemove=e=>{const{translate:i}=p.view,{left:n,top:a}=e.target.getBoundingClientRect();O.x=e.clientX-n-i.x,O.y=e.clientY-a-i.y,O.buttonCode===1&&(O.isDragged=!0,O.drag.x=O.dragStart.x-O.x-i.x,O.drag.y=O.dragStart.y-O.y-i.y),O.onMouseMove&&O.onMouseMove()},t.onmousedown=e=>{e.preventDefault(),O.buttonCode=e.which,O.dragStart.x=O.x,O.dragStart.y=O.y,O.drag.x=0,O.drag.y=0},document.onmouseup=()=>{O.onMouseUp&&O.onMouseUp(),O.isDragged=!1,O.buttonCode=0},t.onmouseleave=()=>{O.isDragged=!1,O.buttonCode=0},O),st={},Xe={keyDown:()=>{}};document.addEventListener("keydown",t=>{const{keyDown:e}=Xe;st[t.code]=!0,e(t.code,t)}),document.addEventListener("keyup",t=>{st[t.code]=!1});const Ii=()=>{Object.keys(st).forEach(t=>{st[t]=!1})},rt=function(t){return st[t]||!1},Si=()=>b.h("div",{id:"ui"},p.mode==="editMode"?b.h(wn,null):null),Pi=()=>{ui.replaceWith(Si())},Jt={},Ct=()=>{};Jt.set=()=>{const{hoveredTile:t,mouse:e,player:i}=p;ce(),e.onMouseMove=()=>{e.buttonCode===1&&nn(-e.drag.x,-e.drag.y)},e.onMouseUp=()=>{e.buttonCode===1&&t.tileIndex&&!e.isDragged&&i.requestMove(t.tileIndex),An()},p.onFrameControls=n=>{en(n),t.tileIndex=be({x:e.x,y:e.y}),t.tileIndex?(e.isDragged?p.canvas.style.cursor="grabbing":p.canvas.style.cursor="pointer",t.path=Ut(i.tileIndex,t.tileIndex),e.buttonCode===3&&Mn(t.tileIndex)):p.canvas.style.cursor="default"},p.effectsMiddle=()=>{t.tileIndex&&t.path.forEach(n=>{nt({x:n[1],y:n[0]},On)})},p.effectsTop=()=>{t.tileIndex&&(t.path.forEach(n=>{nt({x:n[1],y:n[0]},Nn)}),nt(t.tileIndex,ft))}},Jt.unset=()=>{const{mouse:t,player:e}=p;e.unsetPath(),t.onMouseMove=Ct,t.onMouseUp=Ct,p.effectsMiddle=Ct,p.effectsTop=Ct};const Gt={},Ot=()=>{};Gt.set=()=>{const{hoveredTile:t,mouse:e,player:i,ctx:n}=p;e.onMouseMove=()=>{e.buttonCode===1&&nn(-e.drag.x,-e.drag.y)},e.onMouseUp=()=>{e.buttonCode===1&&t.tileIndex&&!e.isDragged&&i.requestMove(t.tileIndex)},p.onFrameControls=a=>{en(a),t.tileIndex=be({x:e.x,y:e.y}),t.tileIndex?(e.isDragged?p.canvas.style.cursor="grabbing":p.canvas.style.cursor="pointer",t.path=Ut(i.tileIndex,t.tileIndex)):p.canvas.style.cursor="default"},p.effectsMiddle=()=>{i.isMoving?gt(i.path,"lime"):t.tileIndex&&gt(t.path,"lime")},p.effectsTop=()=>{if(i.isMoving){if(gt(i.path,"rgba(50, 205, 50, 0.5)",!0,"lime"),t.tileIndex)if(_(t.tileIndex)){const a=L(t.tileIndex);yt(a,ft,Tt,n)}else nt(t.tileIndex,ft)}else if(t.tileIndex&&(gt(t.path,"rgba(50, 205, 50, 0.5)"),t.tileIndex))if(_(t.tileIndex)){const a=L(t.tileIndex);yt(a,"lime",Tt,n)}else nt(t.tileIndex,ft)}},Gt.unset=()=>{const{mouse:t,player:e}=p;e.unsetPath(),t.onMouseMove=Ot,t.onMouseUp=Ot,p.effectsMiddle=Ot,p.effectsTop=Ot};const Ye=()=>{const{paused:t,stop:e,restart:i}=S;t?(i(),document.body.classList.remove("paused")):(e(),document.body.classList.add("paused"))},Ei=()=>{document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():canvasRoot.requestFullscreen()};Xe.keyDown=t=>{switch(t){case"Space":Ye();break;case"Enter":rt("ControlLeft")&&Ei();break;default:return}},document.addEventListener("visibilitychange",()=>{const{stop:t}=S;document.visibilityState==="hidden"?(t(),document.body.classList.add("paused")):document.visibilityState==="visible"&&Ii()});const Ze={editMode:Jt,playMode:Gt},tn=t=>{Ze[p.mode].unset(),p.mode=t,Pi(),Ze[t].set()},$i=()=>{const{view:t}=p,{xTiles:e,yTiles:i}=t;for(let n=e-1;n>-1;n--)for(let a=0;a<i;a++)Dn(n,a),Vt(n,a)},Y=150,J=70,Di=100,ji=()=>{const t=document.createElement("canvas"),e=t.getContext("2d",{willReadFrequently:!0});t.classList.add("monitor"),t.width=Y,t.height=J,canvasRoot.appendChild(t),e.strokeStyle="#ff0000";let i=e.getImageData(0,0,Y,J);return n=>{e.clearRect(0,0,Y,J),e.putImageData(i,-1,0);const a=J-n/Di*J;e.beginPath(),e.moveTo(Y,J),e.lineTo(Y,a),e.stroke(),i=e.getImageData(0,0,Y,J)}},p={};p.start=async t=>{p.canvas=document.createElement("canvas"),p.ctx=p.canvas.getContext("2d"),canvasRoot.appendChild(p.canvas),p.monitor=ji(),p.floorCanvas=new OffscreenCanvas(0,0),p.floorCtx=p.floorCanvas.getContext("2d"),p.entityCanvas=new OffscreenCanvas(0,0),p.entityCtx=p.entityCanvas.getContext("2d"),p.effectsMiddle=()=>{},p.effectsTop=()=>{},p.mouse=Ti(p.canvas),p.view=we({xTiles:pt,yTiles:pt}),p.hoveredTile={path:null,tileIndex:null},p.mode="playMode",mode.onchange=()=>{const e=mode.elements.mode.value;tn(e)},Ln();try{const e=await un(t);p.loadMap(e)}catch{const e=hn({xTiles:pt,yTiles:pt});p.loadMap(e)}S.start(ke)},p.loadMap=t=>{const{entityList:e,unitStart:i={x:1,y:1}}=t;p.tileMap=t,p.entityMap=Ni(t),p.entities=[],p.player=new Ci,p.player.addToScene(i),e&&e.forEach(n=>{const{name:a,tileIndex:o}=n;switch(a){case"entity":new St({}).addToScene(o);break;case"npc":new Oi({sprite:F.playerTokens.despoiler,haloColor:"red"}).addToScene(o);break}}),tn(p.mode),p.view.setApertureSize(),$i()},p.setView=we;let zt=0,Kt=0;const en=t=>{const{translate:e}=p.view,i=rt("KeyW"),n=rt("KeyS"),a=rt("KeyD"),o=rt("KeyA");zt+=ye*t*(a-o),Kt+=ye*t*(n-i),e.x-=zt,e.y-=Kt,zt*=fe,Kt*=fe,p.ctx.setTransform(1,0,0,1,e.x,e.y)},nn=(t,e)=>{const{translate:i}=p.view;i.x=t,i.y=e,p.ctx.setTransform(1,0,0,1,t,e)},Qt=E,Xt=I*3,_i=I*1.5,an=(t,e)=>{const{x:i,y:n}=e;t.save(),t.beginPath(),t.rect(i,n,Qt,Xt),t.clip(),t.clearRect(i,n,Qt,Xt)},Ri=t=>{const{floorCtx:e,entityCtx:i,tileMap:n}=p,a=L({x:t.x,y:t.y});a.y-=_i,an(e,a),an(i,a),Bi.forEach(o=>{var l;const s=o.x+t.x,r=o.y+t.y;if((l=n.tiles[s])!=null&&l[r]){const h=n.tiles[s][r];if(h.floor){const{set:d,color:f,variant:m}=h.floor;xe({x:s,y:r,image:Nt(d,f,m)})}Vt(s,r)}}),i.restore(),e.restore()},Fi=(t,e,i)=>{const{entityCtx:n}=p,a={x:Math.floor(Math.min(e.x,i.x)),y:Math.floor(Math.min(e.y,i.y)-I*2)},o=Math.ceil(Math.abs(e.x-i.x)+Qt),s=Math.ceil(Math.abs(e.y-i.y)+Xt),{x:r,y:l}=a;n.save(),n.beginPath(),n.rect(r,l,o,s),n.clip(),n.clearRect(r,l,o,s),Li.forEach(h=>{const d=h.x+t.x,f=h.y+t.y;Vt(d,f)}),n.restore()},Li=[{x:3,y:-3},{x:3,y:-2},{x:3,y:-1},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:2,y:0},{x:1,y:-3},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:-2},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:0},{x:-2,y:1},{x:-3,y:1},{x:-2,y:2},{x:-1,y:3},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],Bi=[{x:3,y:-3},{x:3,y:-2},{x:2,y:-3},{x:2,y:-2},{x:2,y:-1},{x:1,y:-2},{x:1,y:-1},{x:1,y:0},{x:0,y:-1},{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1},{x:-1,y:2},{x:-2,y:1},{x:-2,y:2},{x:-3,y:2},{x:-2,y:3},{x:-3,y:3}],qi=()=>b.h("div",null,b.h("div",{id:"pauseMenu"},b.h("div",{class:"pause-menu-items"},b.h("p",null,"Paused"),b.h("ul",null,b.h("li",null,b.h("button",{onclick:Ye},"Resume")),b.h("li",null,b.h("button",{id:"loadButton"},"Load")),b.h("li",null,b.h("button",{class:"save",id:"saveButton"},"Save"),b.h("input",{type:"text",id:"saveName",value:"tile-map"})))))),Hi=()=>b.h("div",{class:"toolbar"},b.h("form",{id:"mode",name:"mode",class:"margin-right-10"},b.h("input",{type:"radio",id:"playRadio",value:"playMode",class:"margin-right-10",name:"mode",checked:!0}),b.h("label",{for:"playRadio"},"Play Mode"),b.h("input",{type:"radio",id:"editModeRadio",value:"editMode",class:"margin-left-10 margin-right-10",name:"mode"}),b.h("label",{for:"editModeRadio"},"Edit Mode"))),Ui=()=>b.h("div",{class:"wrapper"},b.h(Hi,null),b.h("div",{id:"canvasRoot"},b.h("div",{id:"ui"}),b.h(qi,null)));console.log("AM I PROD???",!0),root.replaceWith(Ui()),p.start("vista"),window.dump=()=>console.log(p)})();
